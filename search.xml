<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>汇编语言与逆向工程入门指南</title>
      <link href="/2025/10/24/article19_asm_reverse_engineering/"/>
      <url>/2025/10/24/article19_asm_reverse_engineering/</url>
      
        <content type="html"><![CDATA[<h2 id="为什么要对汇编有一定入门"><a href="#为什么要对汇编有一定入门" class="headerlink" title="为什么要对汇编有一定入门"></a>为什么要对汇编有一定入门</h2><p>现在基本上都是Python，Java，JavaScript等高级编程语言，很少人回去关注汇编语言，去研究一下算是理解计算机底层原理、进行逆向工程和安全研究的必要技能吧，至少能帮助自己更好的理解逻辑底层</p><h2 id="I-汇编语言概述"><a href="#I-汇编语言概述" class="headerlink" title="I. 汇编语言概述"></a>I. 汇编语言概述</h2><h3 id="1-什么是汇编语言"><a href="#1-什么是汇编语言" class="headerlink" title="1. 什么是汇编语言"></a>1. 什么是汇编语言</h3><p>汇编语言就是用助记符（比如MOV、ADD）来表示机器指令的低级编程语言。它比直接写二进制机器码要容易理解，但比高级语言更接近硬件。</p><p><strong>主要特点：</strong></p><ul><li>直接控制CPU和内存</li><li>执行效率高</li><li>依赖具体的CPU架构</li></ul><p><strong>常见用途：</strong></p><ul><li>系统底层开发（内核、驱动）</li><li>逆向分析和安全研究</li><li>性能关键代码的优化</li></ul><span id="more"></span><h3 id="2-汇编语言也有不同“方言”"><a href="#2-汇编语言也有不同“方言”" class="headerlink" title="2. 汇编语言也有不同“方言”"></a>2. 汇编语言也有不同“方言”</h3><p>就像人类语言有不同方言一样，汇编语言也根据硬件和书写习惯分为几种。</p><p>按CPU架构分</p><ul><li><strong>x86&#x2F;x86-64</strong>: 主要用于个人电脑和服务器，如Intel 和AMD 的CPU。 </li><li><strong>ARM&#x2F;ARM64</strong>: 广泛应用于手机、平板电脑等移动设备和嵌入式系统。 </li><li><strong>MIPS&#x2F;RISC-V</strong>: 常用于学术研究和某些精简指令集场景。 </li><li><strong>其他</strong>: 如用于单片机的AVR 架构，或PowerPC 等。</li></ul><p>按书写语法分<br>​- <strong>Intel语法</strong>​：常见于Windows平台和Intel官方文档，格式是 指令 目标, 源。<br>​- <strong>AT&amp;T语法​</strong>：在Unix&#x2F;Linux世界里更流行，格式是 指令 源, 目标。</p><h3 id="3-寄存器和内存的通信（关键词的介绍）"><a href="#3-寄存器和内存的通信（关键词的介绍）" class="headerlink" title="3. 寄存器和内存的通信（关键词的介绍）"></a>3. 寄存器和内存的通信（关键词的介绍）</h3><p>汇编的作用就是操作CPU进行计算，CPU在计算的时候需要存储计算的值，这些值的存储位置就是CPU的寄存器，复杂的计算还需要内存辅助数据的存储，这里看下内存与CPU寄存器的配合方式。</p><h4 id="a-关于寄存器"><a href="#a-关于寄存器" class="headerlink" title="a. 关于寄存器"></a>a. 关于寄存器</h4><p>CPU的通用寄存器有eax、ebx、ecx、edx等，不同架构提供的通用寄存器数量和名称有区别，这些通用寄存器就是可以给用户侧（汇编代码）自由使用的寄存器，其他的非通用寄存器如eip、esp、eflags等是为了CPU实现一些功能用的，不会开放给用户侧使用。</p><p>其中寄存器eax通常会当作返回值使用，比如我们的可执行文件执行完成返回的值（echo $?）其实就是执行完成后寄存器eax当时的值。</p><table><thead><tr><th>寄存器</th><th>含义</th><th>用途</th><th>包含寄存器</th></tr></thead><tbody><tr><td>EAX</td><td>累加(Accumulator)寄存器</td><td>常用于乘、除法和函数返回值</td><td>AX(AH、AL)</td></tr><tr><td>EBX</td><td>基址(Base)寄存器</td><td>常做内存数据的指针, 或者说常以它为基址来访问内存.</td><td>BX(BH、BL)</td></tr><tr><td>ECX</td><td>计数器(Counter)寄存器</td><td>常做字符串和循环操作中的计数器</td><td>CX(CH、CL)</td></tr><tr><td>EDX</td><td>数据(Data)寄存器</td><td>常用于乘、除法和 I&#x2F;O 指针</td><td>DX(DH、DL)</td></tr><tr><td>ESI</td><td>来源索引(Source Index)寄存器</td><td>常做内存数据指针和源字符串指针</td><td>SI</td></tr><tr><td>EDI</td><td>目的索引(Destination Index)寄存器</td><td>常做内存数据指针和目的字符串指针</td><td>DI</td></tr><tr><td>ESP</td><td>堆栈指针(Stack Point)寄存器</td><td>只做堆栈的栈顶指针; 不能用于算术运算与数据传送</td><td>SP</td></tr><tr><td>EBP</td><td>基址指针(Base Point)寄存器</td><td>只做堆栈指针, 可以访问堆栈内任意地址, 经常用于中转 ESP 中的数据, 也常以它为基址来访问堆栈; 不能用于算术运算与数据传送</td><td>BP</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">; 一个简单的汇编代码，运行结果是28</span><br><span class="line">global main</span><br><span class="line">main:</span><br><span class="line">    mov eax, 20    ; 给eax寄存器赋值</span><br><span class="line">    add eax, 8     ; 给eax的值+8</span><br><span class="line">    ret            ; 结束，返回了eax中的值</span><br></pre></td></tr></table></figure><p>看到这里其实可以看出汇编部分的计算逻辑就是将内存中的数据读入到寄存器中，进行计算，然后将结果写回内存。</p><h4 id="b-内存操作方式"><a href="#b-内存操作方式" class="headerlink" title="b. 内存操作方式"></a>b. 内存操作方式</h4><table><thead><tr><th>操作类型</th><th>语法格式</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>立即数到寄存器</td><td><code>mov reg, 立即数</code></td><td>将常数直接赋值给寄存器</td><td><code>mov eax, 20</code></td></tr><tr><td>寄存器到寄存器</td><td><code>mov reg1, reg2</code></td><td>寄存器间数据传递</td><td><code>mov ebx, eax</code></td></tr><tr><td>内存到寄存器</td><td><code>mov reg, [地址]</code></td><td>从内存读取数据到寄存器</td><td><code>mov eax, [myvar]</code></td></tr><tr><td>寄存器到内存</td><td><code>mov [地址], reg</code></td><td>将寄存器数据写入内存</td><td><code>mov [esi], eax</code></td></tr><tr><td>间接寻址</td><td><code>mov reg, [reg]</code></td><td>通过寄存器间接访问内存</td><td><code>mov eax, [esi]</code></td></tr><tr><td>基址变址</td><td><code>mov reg, [base+index*scale]</code></td><td>数组访问的标准形式</td><td><code>mov eax, [ebx+ecx*4]</code></td></tr></tbody></table><h4 id="c-内存定义方式"><a href="#c-内存定义方式" class="headerlink" title="c. 内存定义方式"></a>c. 内存定义方式</h4><table><thead><tr><th>定义指令</th><th>含义</th><th>占用空间</th><th>示例</th></tr></thead><tbody><tr><td><code>db</code></td><td>define byte</td><td>1字节</td><td><code>db 0x41</code></td></tr><tr><td><code>dw</code></td><td>define word</td><td>2字节</td><td><code>dw 1234</code></td></tr><tr><td><code>dd</code></td><td>define double word</td><td>4字节</td><td><code>dd 0x12345678</code></td></tr><tr><td><code>dq</code></td><td>define quad word</td><td>8字节</td><td><code>dq 0x123456789ABCDEF0</code></td></tr></tbody></table><h4 id="d-栈操作指令"><a href="#d-栈操作指令" class="headerlink" title="d. 栈操作指令"></a>d. 栈操作指令</h4><table><thead><tr><th>指令</th><th>功能</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>push</code></td><td>压栈</td><td>将数据压入栈顶</td><td><code>push eax</code></td></tr><tr><td><code>pop</code></td><td>弹栈</td><td>从栈顶弹出数据</td><td><code>pop ebx</code></td></tr><tr><td><code>call</code></td><td>调用函数</td><td>将返回地址压栈并跳转</td><td><code>call function</code></td></tr><tr><td><code>ret</code></td><td>返回</td><td>从栈中弹出返回地址</td><td><code>ret</code></td></tr></tbody></table><h4 id="e-寻址模式对比"><a href="#e-寻址模式对比" class="headerlink" title="e. 寻址模式对比"></a>e. 寻址模式对比</h4><table><thead><tr><th>寻址模式</th><th>语法</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td>直接寻址</td><td><code>[地址]</code></td><td>直接访问固定地址</td><td><code>mov eax, [0x1000]</code></td></tr><tr><td>寄存器间接</td><td><code>[reg]</code></td><td>通过寄存器指向的地址</td><td><code>mov eax, [esi]</code></td></tr><tr><td>基址寻址</td><td><code>[base+offset]</code></td><td>基址加偏移量</td><td><code>mov eax, [ebp+8]</code></td></tr><tr><td>变址寻址</td><td><code>[index*scale]</code></td><td>索引乘以比例因子</td><td><code>mov eax, [ecx*4]</code></td></tr><tr><td>基址变址</td><td><code>[base+index*scale]</code></td><td>组合寻址，用于数组</td><td><code>mov eax, [ebx+ecx*4]</code></td></tr></tbody></table><h2 id="II-汇编指令详解"><a href="#II-汇编指令详解" class="headerlink" title="II. 汇编指令详解"></a>II. 汇编指令详解</h2><h3 id="1-数据传送指令"><a href="#1-数据传送指令" class="headerlink" title="1. 数据传送指令"></a>1. 数据传送指令</h3><p>数据传送指令用于在寄存器、内存和立即数之间传递数据，是最基础的汇编指令。</p><h4 id="a-MOV指令（mov）"><a href="#a-MOV指令（mov）" class="headerlink" title="a. MOV指令（mov）"></a>a. MOV指令（mov）</h4><p>MOV指令用于将数据从一个位置复制到另一个位置。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">; Intel语法示例</span><br><span class="line">mov eax, 123          ; 将立即数123传送到EAX寄存器</span><br><span class="line">mov ebx, eax          ; 将EAX寄存器的值传送到EBX寄存器</span><br><span class="line">mov [esi], eax        ; 将EAX寄存器的值传送到ESI指向的内存地址</span><br><span class="line">mov eax, [ebx+4]      ; 将EBX+4地址处的值传送到EAX寄存器</span><br></pre></td></tr></table></figure><h4 id="b-LEA指令（lea）"><a href="#b-LEA指令（lea）" class="headerlink" title="b. LEA指令（lea）"></a>b. LEA指令（lea）</h4><p>LEA指令用于计算地址并加载到寄存器中，常用于地址计算。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; LEA指令示例</span><br><span class="line">lea eax, [ebx+ecx*4]  ; 计算EBX+ECX*4的地址并加载到EAX</span><br><span class="line">lea esi, [ebp-8]      ; 计算EBP-8的地址并加载到ESI</span><br></pre></td></tr></table></figure><h3 id="2-算术运算指令"><a href="#2-算术运算指令" class="headerlink" title="2. 算术运算指令"></a>2. 算术运算指令</h3><p>算术运算指令用于执行基本的数学运算，包括加法、减法、乘法和除法。</p><h4 id="a-加法指令（add、adc）"><a href="#a-加法指令（add、adc）" class="headerlink" title="a. 加法指令（add、adc）"></a>a. 加法指令（add、adc）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; ADD指令示例</span><br><span class="line">add eax, ebx          ; EAX = EAX + EBX</span><br><span class="line">add eax, 10           ; EAX = EAX + 10</span><br><span class="line">add [esi], eax        ; [ESI] = [ESI] + EAX</span><br><span class="line"></span><br><span class="line">; ADC指令示例（带进位加法）</span><br><span class="line">adc eax, ebx          ; EAX = EAX + EBX + CF</span><br></pre></td></tr></table></figure><h4 id="b-减法指令（sub、sbb）"><a href="#b-减法指令（sub、sbb）" class="headerlink" title="b. 减法指令（sub、sbb）"></a>b. 减法指令（sub、sbb）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">; SUB指令示例</span><br><span class="line">sub eax, ebx          ; EAX = EAX - EBX</span><br><span class="line">sub eax, 5            ; EAX = EAX - 5</span><br><span class="line"></span><br><span class="line">; SBB指令示例（带借位减法）</span><br><span class="line">sbb eax, ebx          ; EAX = EAX - EBX - CF</span><br></pre></td></tr></table></figure><h4 id="c-乘法指令（mul、imul）"><a href="#c-乘法指令（mul、imul）" class="headerlink" title="c. 乘法指令（mul、imul）"></a>c. 乘法指令（mul、imul）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">; MUL指令示例（无符号乘法）</span><br><span class="line">mul ebx              ; EDX:EAX = EAX * EBX</span><br><span class="line"></span><br><span class="line">; IMUL指令示例（有符号乘法）</span><br><span class="line">imul eax, ebx        ; EAX = EAX * EBX</span><br><span class="line">imul eax, ebx, 10    ; EAX = EBX * 10</span><br></pre></td></tr></table></figure><h4 id="d-除法指令（div、idiv）"><a href="#d-除法指令（div、idiv）" class="headerlink" title="d. 除法指令（div、idiv）"></a>d. 除法指令（div、idiv）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">; DIV指令示例（无符号除法）</span><br><span class="line">div ebx              ; EAX = EDX:EAX / EBX, EDX = 余数</span><br><span class="line"></span><br><span class="line">; IDIV指令示例（有符号除法）</span><br><span class="line">idiv ebx             ; EAX = EDX:EAX / EBX, EDX = 余数</span><br></pre></td></tr></table></figure><h3 id="3-逻辑运算指令"><a href="#3-逻辑运算指令" class="headerlink" title="3. 逻辑运算指令"></a>3. 逻辑运算指令</h3><p>逻辑运算指令用于执行位运算操作，包括与、或、异或、非等操作。</p><h4 id="a-位运算指令（and、or、xor、not）"><a href="#a-位运算指令（and、or、xor、not）" class="headerlink" title="a. 位运算指令（and、or、xor、not）"></a>a. 位运算指令（and、or、xor、not）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">; AND指令示例</span><br><span class="line">and eax, ebx         ; EAX = EAX &amp; EBX</span><br><span class="line">and eax, 0xFF        ; EAX = EAX &amp; 0xFF</span><br><span class="line"></span><br><span class="line">; OR指令示例</span><br><span class="line">or eax, ebx          ; EAX = EAX | EBX</span><br><span class="line">or eax, 0x80         ; EAX = EAX | 0x80</span><br><span class="line"></span><br><span class="line">; XOR指令示例</span><br><span class="line">xor eax, ebx         ; EAX = EAX ^ EBX</span><br><span class="line">xor eax, eax         ; EAX = 0（清零操作）</span><br><span class="line"></span><br><span class="line">; NOT指令示例</span><br><span class="line">not eax              ; EAX = ~EAX</span><br></pre></td></tr></table></figure><h4 id="b-移位指令（shl、shr、sar）"><a href="#b-移位指令（shl、shr、sar）" class="headerlink" title="b. 移位指令（shl、shr、sar）"></a>b. 移位指令（shl、shr、sar）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; 左移指令</span><br><span class="line">shl eax, 1           ; EAX = EAX &lt;&lt; 1</span><br><span class="line">shl eax, cl          ; EAX = EAX &lt;&lt; CL</span><br><span class="line"></span><br><span class="line">; 右移指令</span><br><span class="line">shr eax, 1           ; EAX = EAX &gt;&gt; 1（逻辑右移）</span><br><span class="line">sar eax, 1           ; EAX = EAX &gt;&gt; 1（算术右移）</span><br></pre></td></tr></table></figure><h3 id="4-比较和跳转指令"><a href="#4-比较和跳转指令" class="headerlink" title="4. 比较和跳转指令"></a>4. 比较和跳转指令</h3><p>比较和跳转指令用于实现程序的控制流，是汇编语言中实现条件判断和循环的关键。</p><h4 id="a-比较指令（cmp）"><a href="#a-比较指令（cmp）" class="headerlink" title="a. 比较指令（cmp）"></a>a. 比较指令（cmp）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; CMP指令示例</span><br><span class="line">cmp eax, ebx         ; 比较EAX和EBX，设置标志位</span><br><span class="line">cmp eax, 0           ; 比较EAX和0</span><br><span class="line">cmp [esi], eax       ; 比较[ESI]和EAX</span><br></pre></td></tr></table></figure><h4 id="b-跳转指令（jmp、je、jne、jl、jg、jz、jnz）"><a href="#b-跳转指令（jmp、je、jne、jl、jg、jz、jnz）" class="headerlink" title="b. 跳转指令（jmp、je、jne、jl、jg、jz、jnz）"></a>b. 跳转指令（jmp、je、jne、jl、jg、jz、jnz）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">; 无条件跳转</span><br><span class="line">jmp label            ; 跳转到label</span><br><span class="line"></span><br><span class="line">; 条件跳转</span><br><span class="line">je label             ; 相等时跳转（ZF=1）</span><br><span class="line">jne label            ; 不相等时跳转（ZF=0）</span><br><span class="line">jl label             ; 小于时跳转（SF≠OF）</span><br><span class="line">jg label             ; 大于时跳转（SF=OF且ZF=0）</span><br><span class="line">jz label             ; 零标志位为1时跳转</span><br><span class="line">jnz label            ; 零标志位为0时跳转</span><br></pre></td></tr></table></figure><h3 id="5-栈操作指令"><a href="#5-栈操作指令" class="headerlink" title="5. 栈操作指令"></a>5. 栈操作指令</h3><p>栈操作指令用于管理函数调用和局部变量，是函数调用约定的重要组成部分。</p><h4 id="a-栈操作指令（push、pop）"><a href="#a-栈操作指令（push、pop）" class="headerlink" title="a. 栈操作指令（push、pop）"></a>a. 栈操作指令（push、pop）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; PUSH指令示例</span><br><span class="line">push eax             ; 将EAX压入栈</span><br><span class="line">push 123             ; 将立即数123压入栈</span><br><span class="line"></span><br><span class="line">; POP指令示例</span><br><span class="line">pop eax              ; 将栈顶元素弹出到EAX</span><br><span class="line">pop ebx              ; 将栈顶元素弹出到EBX</span><br></pre></td></tr></table></figure><h4 id="b-栈指针操作（add、sub）"><a href="#b-栈指针操作（add、sub）" class="headerlink" title="b. 栈指针操作（add、sub）"></a>b. 栈指针操作（add、sub）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; 栈指针调整</span><br><span class="line">sub esp, 16          ; 分配16字节的栈空间</span><br><span class="line">add esp, 16          ; 释放16字节的栈空间</span><br></pre></td></tr></table></figure><h2 id="III-反汇编技术详解"><a href="#III-反汇编技术详解" class="headerlink" title="III. 反汇编技术详解"></a>III. 反汇编技术详解</h2><h3 id="1-反汇编基础"><a href="#1-反汇编基础" class="headerlink" title="1. 反汇编基础"></a>1. 反汇编基础</h3><p>反汇编是将机器码转换为汇编代码的过程，是逆向工程的核心技术之一。通过反汇编，我们可以分析程序的逻辑结构、理解算法实现、发现安全漏洞。</p><h4 id="a-反汇编原理"><a href="#a-反汇编原理" class="headerlink" title="a. 反汇编原理"></a>a. 反汇编原理</h4><p><strong>工作原理：</strong></p><ol><li>读取二进制文件的机器码</li><li>根据指令集规范解析指令格式</li><li>将机器码转换为对应的汇编助记符</li><li>分析指令参数和寻址模式</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">; 机器码示例</span><br><span class="line">55 8B EC 83 EC 10 8B 45 08 03 45 0C 8B E5 5D C3</span><br><span class="line"></span><br><span class="line">; 对应的汇编代码</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">sub     esp, 10h</span><br><span class="line">mov     eax, [ebp+8]</span><br><span class="line">add     eax, [ebp+0Ch]</span><br><span class="line">mov     esp, ebp</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br></pre></td></tr></table></figure><p><strong>实际操作：</strong></p><ul><li>使用十六进制编辑器查看原始机器码</li><li>对照指令集手册手动解析（学习用）</li><li>使用反汇编工具自动转换</li></ul><h4 id="b-反汇编工具分类"><a href="#b-反汇编工具分类" class="headerlink" title="b. 反汇编工具分类"></a>b. 反汇编工具分类</h4><p><strong>静态反汇编器（不运行程序）：</strong></p><ul><li><strong>IDA Pro</strong>：最强大的商业反汇编器<ul><li>操作：File → Open → 选择目标文件</li><li>特点：支持多种架构，插件丰富</li></ul></li><li><strong>Ghidra</strong>：NSA开源的免费工具<ul><li>操作：创建项目 → Import → 选择文件</li><li>特点：功能强大，完全免费</li></ul></li><li><strong>Radare2</strong>：命令行反汇编器<ul><li>操作：<code>r2 -A 目标文件</code> → <code>aa</code>（分析）</li><li>特点：轻量级，脚本化</li></ul></li></ul><p><strong>动态反汇编器（运行时分析）：</strong></p><ul><li><strong>x64dbg</strong>：Windows下的调试器<ul><li>操作：File → Open → 选择可执行文件</li><li>特点：支持x86&#x2F;x64，界面友好</li></ul></li><li><strong>OllyDbg</strong>：经典的32位调试器<ul><li>操作：File → Open → 选择PE文件</li><li>特点：插件丰富，适合学习</li></ul></li><li><strong>GDB</strong>：Linux下的调试器<ul><li>操作：<code>gdb 程序名</code> → <code>run</code> → <code>disassemble</code></li><li>特点：功能强大，命令行操作</li></ul></li></ul><h3 id="2-静态反汇编技术"><a href="#2-静态反汇编技术" class="headerlink" title="2. 静态反汇编技术"></a>2. 静态反汇编技术</h3><p>静态反汇编是在不运行程序的情况下分析程序结构，通过分析二进制文件来理解程序逻辑。</p><h4 id="a-函数识别"><a href="#a-函数识别" class="headerlink" title="a. 函数识别"></a>a. 函数识别</h4><p><strong>识别方法：</strong></p><ol><li>查找函数序言模式（push ebp; mov ebp, esp）</li><li>查找函数尾声模式（mov esp, ebp; pop ebp; ret）</li><li>分析调用约定和参数传递</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">; 函数序言（Function Prologue）</span><br><span class="line">.text:00401000 push    ebp            ; 保存旧的栈帧指针</span><br><span class="line">.text:00401001 mov     ebp, esp       ; 设置新的栈帧指针</span><br><span class="line">.text:00401003 sub     esp, 20h       ; 分配局部变量空间</span><br><span class="line"></span><br><span class="line">; 函数尾声（Function Epilogue）</span><br><span class="line">.text:00401020 mov     esp, ebp       ; 恢复栈指针</span><br><span class="line">.text:00401021 pop     ebp            ; 恢复旧的栈帧指针</span><br><span class="line">.text:00401022 retn                   ; 返回</span><br></pre></td></tr></table></figure><p><strong>IDA Pro操作：</strong></p><ul><li>按<code>P</code>键创建函数</li><li>按<code>F5</code>查看伪代码</li><li>右键选择”Create Function”</li></ul><h4 id="b-控制流分析"><a href="#b-控制流分析" class="headerlink" title="b. 控制流分析"></a>b. 控制流分析</h4><p><strong>分析方法：</strong></p><ol><li>识别条件跳转指令（jz, jnz, jl, jg等）</li><li>分析跳转目标和条件</li><li>重构程序的控制流图</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">; 条件分支示例</span><br><span class="line">.text:00401000 cmp     eax, 0</span><br><span class="line">.text:00401003 jz      short loc_401010</span><br><span class="line">.text:00401005 mov     eax, 1</span><br><span class="line">.text:0040100A jmp     short loc_401015</span><br><span class="line">.text:00401010 loc_401010:</span><br><span class="line">.text:00401010 mov     eax, 0</span><br><span class="line">.text:00401015 loc_401015:</span><br><span class="line">.text:00401015 retn</span><br></pre></td></tr></table></figure><p><strong>IDA Pro操作：</strong></p><ul><li>按<code>空格键</code>切换图形视图</li><li>按<code>Ctrl+Enter</code>查看交叉引用</li><li>使用<code>Xrefs to</code>分析函数调用关系</li></ul><h4 id="c-字符串分析"><a href="#c-字符串分析" class="headerlink" title="c. 字符串分析"></a>c. 字符串分析</h4><p><strong>分析方法：</strong></p><ol><li>查找字符串常量</li><li>分析字符串的引用位置</li><li>理解字符串的用途</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; 字符串引用示例</span><br><span class="line">.text:00401000 push    offset aEnterPassword ; &quot;Enter password: &quot;</span><br><span class="line">.text:00401005 call    printf</span><br><span class="line">.text:0040100A add     esp, 4</span><br></pre></td></tr></table></figure><p><strong>IDA Pro操作：</strong></p><ul><li>按<code>Shift+F12</code>打开字符串窗口</li><li>双击字符串跳转到引用位置</li><li>按<code>X</code>查看字符串的交叉引用</li></ul><h3 id="3-动态反汇编技术"><a href="#3-动态反汇编技术" class="headerlink" title="3. 动态反汇编技术"></a>3. 动态反汇编技术</h3><p>动态反汇编是在程序运行时分析其行为，可以获取程序的真实执行信息。</p><h4 id="a-调试器使用"><a href="#a-调试器使用" class="headerlink" title="a. 调试器使用"></a>a. 调试器使用</h4><p><strong>基本操作流程：</strong></p><ol><li>加载目标程序到调试器</li><li>设置断点暂停程序执行</li><li>单步执行观察寄存器变化</li><li>分析内存内容和程序状态</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">; 调试器中的寄存器状态</span><br><span class="line">EAX = 00000001</span><br><span class="line">EBX = 00000002</span><br><span class="line">ECX = 00000003</span><br><span class="line">EDX = 00000000</span><br><span class="line">ESP = 0012FF80</span><br><span class="line">EBP = 0012FF88</span><br><span class="line">EIP = 00401000</span><br></pre></td></tr></table></figure><p><strong>x64dbg操作：</strong></p><ul><li><code>F2</code>：设置&#x2F;取消断点</li><li><code>F7</code>：单步步入（Step Into）</li><li><code>F8</code>：单步跳过（Step Over）</li><li><code>F9</code>：继续执行（Run）</li><li><code>Ctrl+G</code>：跳转到地址</li></ul><h4 id="b-内存分析"><a href="#b-内存分析" class="headerlink" title="b. 内存分析"></a>b. 内存分析</h4><p><strong>分析方法：</strong></p><ol><li>查看程序的内存布局</li><li>分析堆栈和堆的内容</li><li>监控内存读写操作</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; 内存转储示例</span><br><span class="line">00401000: 55 8B EC 83 EC 10 8B 45 08 03 45 0C 8B E5 5D C3</span><br><span class="line">00401010: 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90</span><br></pre></td></tr></table></figure><p><strong>x64dbg操作：</strong></p><ul><li><code>Ctrl+M</code>：打开内存窗口</li><li><code>Ctrl+Shift+M</code>：打开内存映射</li><li><code>Ctrl+Shift+H</code>：打开句柄窗口</li><li>右键内存 → “Follow in Dump”</li></ul><h4 id="c-断点设置"><a href="#c-断点设置" class="headerlink" title="c. 断点设置"></a>c. 断点设置</h4><p><strong>断点类型：</strong></p><ol><li>软件断点（0xCC指令）</li><li>硬件断点（CPU调试寄存器）</li><li>内存断点（访问特定内存）</li><li>条件断点（满足条件时触发）</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; 断点设置示例</span><br><span class="line">.text:00401000 int3                   ; 软件断点</span><br><span class="line">.text:00401001 mov     eax, [ebp+8]   ; 断点后的代码</span><br></pre></td></tr></table></figure><p><strong>x64dbg断点操作：</strong></p><ul><li><code>F2</code>：在当前位置设置断点</li><li><code>Ctrl+F2</code>：设置条件断点</li><li><code>Alt+F2</code>：设置内存断点</li><li><code>Shift+F2</code>：设置硬件断点</li></ul><h3 id="4-反汇编技巧与案例"><a href="#4-反汇编技巧与案例" class="headerlink" title="4. 反汇编技巧与案例"></a>4. 反汇编技巧与案例</h3><h4 id="a-代码混淆识别"><a href="#a-代码混淆识别" class="headerlink" title="a. 代码混淆识别"></a>a. 代码混淆识别</h4><p><strong>控制流平坦化识别：</strong></p><ol><li>查找状态变量（通常是寄存器或内存变量）</li><li>识别大量的无条件跳转（jmp指令）</li><li>观察代码块之间的跳转关系</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">; 控制流平坦化示例</span><br><span class="line">.text:00401000 mov     eax, 0         ; 状态变量</span><br><span class="line">.text:00401005 jmp     short loc_401020</span><br><span class="line">.text:00401010 loc_401010:</span><br><span class="line">.text:00401010 mov     eax, 1</span><br><span class="line">.text:00401015 jmp     short loc_401020</span><br><span class="line">.text:00401020 loc_401020:</span><br><span class="line">.text:00401020 cmp     eax, 0</span><br><span class="line">.text:00401025 jz      short loc_401010</span><br><span class="line">.text:00401030 retn</span><br></pre></td></tr></table></figure><p><strong>识别方法：</strong></p><ul><li>在IDA Pro中查看控制流图，如果看到大量分散的代码块</li><li>查找循环中的状态变量和跳转表</li><li>使用脚本自动化识别跳转模式</li></ul><h4 id="b-加密算法识别"><a href="#b-加密算法识别" class="headerlink" title="b. 加密算法识别"></a>b. 加密算法识别</h4><p><strong>AES算法特征识别：</strong></p><ol><li>查找S-Box查找表（通常包含256个字节的常量）</li><li>识别轮密钥扩展函数</li><li>查找MixColumns、SubBytes等变换</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">; AES加密识别示例</span><br><span class="line">.text:00401000 mov     eax, [ebp+8]    ; 输入数据</span><br><span class="line">.text:00401003 mov     ebx, [ebp+0Ch]   ; 密钥</span><br><span class="line">.text:00401006 call    aes_encrypt     ; AES加密函数</span><br><span class="line">.text:0040100B mov     [ebp+10h], eax  ; 输出结果</span><br></pre></td></tr></table></figure><p><strong>具体识别步骤：</strong></p><ul><li>搜索字符串中的”S-Box”、”AES”等关键词</li><li>查找0x63, 0x7C, 0x77等AES S-Box特征字节</li><li>分析函数调用关系，找到加密&#x2F;解密入口点</li><li>使用工具如PEiD、Detect It Easy识别加密库</li></ul><h4 id="c-反调试技术识别"><a href="#c-反调试技术识别" class="headerlink" title="c. 反调试技术识别"></a>c. 反调试技术识别</h4><p><strong>调试器检测识别：</strong></p><ol><li>查找IsDebuggerPresent、CheckRemoteDebuggerPresent等API调用</li><li>识别时间检测（GetTickCount、QueryPerformanceCounter）</li><li>查找异常处理相关的反调试代码</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">; 反调试检测示例</span><br><span class="line">.text:00401000 call    GetCurrentProcess</span><br><span class="line">.text:00401005 push    eax</span><br><span class="line">.text:00401006 call    IsDebuggerPresent</span><br><span class="line">.text:0040100B test    eax, eax</span><br><span class="line">.text:0040100D jnz     short loc_401020</span><br><span class="line">.text:0040100F mov     eax, 1</span><br><span class="line">.text:00401014 jmp     short loc_401025</span><br><span class="line">.text:00401020 loc_401020:</span><br><span class="line">.text:00401020 mov     eax, 0</span><br><span class="line">.text:00401025 loc_401025:</span><br><span class="line">.text:00401025 retn</span><br></pre></td></tr></table></figure><p><strong>绕过方法：</strong></p><ul><li>使用调试器插件（如ScyllaHide）自动绕过</li><li>手动修改跳转指令（jnz改为jz）</li><li>Hook相关API返回假值</li><li>使用虚拟机或沙箱环境</li></ul><h4 id="d-简单CrackMe分析"><a href="#d-简单CrackMe分析" class="headerlink" title="d. 简单CrackMe分析"></a>d. 简单CrackMe分析</h4><p><strong>分析步骤：</strong></p><ol><li>使用IDA Pro加载程序，查看字符串引用</li><li>定位主函数和关键函数</li><li>分析密码验证逻辑</li><li>找到正确的密码或绕过验证</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">; 主函数分析</span><br><span class="line">.text:00401000 push    ebp</span><br><span class="line">.text:00401001 mov     ebp, esp</span><br><span class="line">.text:00401003 push    offset aEnterPassword ; &quot;Enter password: &quot;</span><br><span class="line">.text:00401008 call    printf</span><br><span class="line">.text:0040100D add     esp, 4</span><br><span class="line">.text:00401010 push    offset password_buffer</span><br><span class="line">.text:00401015 call    scanf</span><br><span class="line">.text:0040101A add     esp, 8</span><br><span class="line">.text:0040101D push    offset password_buffer</span><br><span class="line">.text:00401022 call    check_password</span><br><span class="line">.text:00401027 add     esp, 4</span><br><span class="line">.text:0040102A test    eax, eax</span><br><span class="line">.text:0040102C jz      short loc_401040</span><br><span class="line">.text:0040102E push    offset aCorrect      ; &quot;Correct!&quot;</span><br><span class="line">.text:00401033 call    printf</span><br><span class="line">.text:00401038 jmp     short loc_40104E</span><br><span class="line">.text:00401040 loc_401040:</span><br><span class="line">.text:00401040 push    offset aWrong        ; &quot;Wrong!&quot;</span><br><span class="line">.text:00401045 call    printf</span><br><span class="line">.text:0040104E loc_40104E:</span><br><span class="line">.text:0040104E pop     ebp</span><br><span class="line">.text:0040104F retn</span><br></pre></td></tr></table></figure><p><strong>具体操作：</strong></p><ul><li>在IDA中按Shift+F12查看字符串</li><li>双击”Enter password”跳转到引用位置</li><li>按F5查看伪代码，理解程序流程</li><li>在check_password函数设置断点</li></ul><h4 id="e-密码检查函数"><a href="#e-密码检查函数" class="headerlink" title="e. 密码检查函数"></a>e. 密码检查函数</h4><p><strong>分析密码验证逻辑：</strong></p><ol><li>查看字符串比较指令（cmpsb、strcmp等）</li><li>分析比较的目标字符串</li><li>理解返回值逻辑</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">; 密码检查函数</span><br><span class="line">.text:00401050 push    ebp</span><br><span class="line">.text:00401051 mov     ebp, esp</span><br><span class="line">.text:00401053 mov     esi, [ebp+8]    ; 输入密码</span><br><span class="line">.text:00401056 mov     edi, offset correct_password ; 正确密码</span><br><span class="line">.text:0040105B mov     ecx, 8          ; 密码长度</span><br><span class="line">.text:00401060 repe cmpsb              ; 逐字节比较</span><br><span class="line">.text:00401062 jz      short loc_401070</span><br><span class="line">.text:00401064 mov     eax, 0          ; 返回0（错误）</span><br><span class="line">.text:00401069 jmp     short loc_401075</span><br><span class="line">.text:00401070 loc_401070:</span><br><span class="line">.text:00401070 mov     eax, 1          ; 返回1（正确）</span><br><span class="line">.text:00401075 loc_401075:</span><br><span class="line">.text:00401075 pop     ebp</span><br><span class="line">.text:00401076 retn</span><br></pre></td></tr></table></figure><p><strong>破解方法：</strong></p><ul><li>查看correct_password的内容（双击跳转）</li><li>修改jz为jnz绕过验证</li><li>直接修改返回值（mov eax, 1）</li><li>使用十六进制编辑器修改机器码</li></ul><h2 id="IV-C代码与汇编对照"><a href="#IV-C代码与汇编对照" class="headerlink" title="IV. C代码与汇编对照"></a>IV. C代码与汇编对照</h2><h3 id="1-基本运算对照"><a href="#1-基本运算对照" class="headerlink" title="1. 基本运算对照"></a>1. 基本运算对照</h3><h4 id="a-加法运算"><a href="#a-加法运算" class="headerlink" title="a. 加法运算"></a>a. 加法运算</h4><p><strong>C代码：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>对应的汇编代码：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">; 函数序言</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line"></span><br><span class="line">; 函数体</span><br><span class="line">mov     eax, [ebp+8]    ; 获取参数a</span><br><span class="line">add     eax, [ebp+0Ch]  ; 加上参数b，结果存在EAX中</span><br><span class="line"></span><br><span class="line">; 函数尾声</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br></pre></td></tr></table></figure><h4 id="b-条件判断"><a href="#b-条件判断" class="headerlink" title="b. 条件判断"></a>b. 条件判断</h4><p><strong>C代码：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">max</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>对应的汇编代码：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">; 函数序言</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line"></span><br><span class="line">; 比较a和b</span><br><span class="line">mov     eax, [ebp+8]    ; 获取参数a</span><br><span class="line">cmp     eax, [ebp+0Ch]  ; 比较a和b</span><br><span class="line">jg      short loc_401010 ; 如果a&gt;b，跳转到loc_401010</span><br><span class="line"></span><br><span class="line">; a &lt;= b的情况</span><br><span class="line">mov     eax, [ebp+0Ch]  ; 返回b</span><br><span class="line">jmp     short loc_401015</span><br><span class="line"></span><br><span class="line">; a &gt; b的情况</span><br><span class="line">loc_401010:</span><br><span class="line">mov     eax, [ebp+8]    ; 返回a</span><br><span class="line"></span><br><span class="line">loc_401015:</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br></pre></td></tr></table></figure><h3 id="2-循环结构对照"><a href="#2-循环结构对照" class="headerlink" title="2. 循环结构对照"></a>2. 循环结构对照</h3><h4 id="a-for循环"><a href="#a-for循环" class="headerlink" title="a. for循环"></a>a. for循环</h4><p><strong>C代码：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sum</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        result += i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>对应的汇编代码：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">; 函数序言</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">sub     esp, 8          ; 分配局部变量空间</span><br><span class="line"></span><br><span class="line">; 初始化</span><br><span class="line">mov     dword ptr [ebp-4], 0  ; result = 0</span><br><span class="line">mov     dword ptr [ebp-8], 1  ; i = 1</span><br><span class="line"></span><br><span class="line">; 循环开始</span><br><span class="line">loc_401010:</span><br><span class="line">mov     eax, [ebp-8]         ; 获取i的值</span><br><span class="line">cmp     eax, [ebp+8]         ; 比较i和n</span><br><span class="line">jg      short loc_401025      ; 如果i&gt;n，跳出循环</span><br><span class="line"></span><br><span class="line">; 循环体</span><br><span class="line">mov     eax, [ebp-4]         ; 获取result</span><br><span class="line">add     eax, [ebp-8]         ; result += i</span><br><span class="line">mov     [ebp-4], eax         ; 保存result</span><br><span class="line"></span><br><span class="line">; 循环增量</span><br><span class="line">inc     dword ptr [ebp-8]    ; i++</span><br><span class="line">jmp     short loc_401010     ; 跳回循环开始</span><br><span class="line"></span><br><span class="line">; 循环结束</span><br><span class="line">loc_401025:</span><br><span class="line">mov     eax, [ebp-4]         ; 返回result</span><br><span class="line">mov     esp, ebp</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br></pre></td></tr></table></figure><h4 id="b-while循环"><a href="#b-while循环" class="headerlink" title="b. while循环"></a>b. while循环</h4><p><strong>C代码：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">factorial</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span> result = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (n &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        result *= n;</span><br><span class="line">        n--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>对应的汇编代码：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">; 函数序言</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">sub     esp, 4          ; 分配局部变量空间</span><br><span class="line"></span><br><span class="line">; 初始化</span><br><span class="line">mov     dword ptr [ebp-4], 1  ; result = 1</span><br><span class="line"></span><br><span class="line">; 循环开始</span><br><span class="line">loc_401010:</span><br><span class="line">cmp     dword ptr [ebp+8], 1  ; 比较n和1</span><br><span class="line">jle     short loc_401025      ; 如果n&lt;=1，跳出循环</span><br><span class="line"></span><br><span class="line">; 循环体</span><br><span class="line">mov     eax, [ebp-4]         ; 获取result</span><br><span class="line">imul    eax, [ebp+8]         ; result *= n</span><br><span class="line">mov     [ebp-4], eax         ; 保存result</span><br><span class="line"></span><br><span class="line">; 循环减量</span><br><span class="line">dec     dword ptr [ebp+8]    ; n--</span><br><span class="line">jmp     short loc_401010     ; 跳回循环开始</span><br><span class="line"></span><br><span class="line">; 循环结束</span><br><span class="line">loc_401025:</span><br><span class="line">mov     eax, [ebp-4]         ; 返回result</span><br><span class="line">mov     esp, ebp</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br></pre></td></tr></table></figure><h3 id="3-数组操作对照"><a href="#3-数组操作对照" class="headerlink" title="3. 数组操作对照"></a>3. 数组操作对照</h3><h4 id="a-数组访问"><a href="#a-数组访问" class="headerlink" title="a. 数组访问"></a>a. 数组访问</h4><p><strong>C代码：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">getArrayElement</span><span class="params">(<span class="type">int</span> arr[], <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> arr[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>对应的汇编代码：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">; 函数序言</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line"></span><br><span class="line">; 计算数组元素地址</span><br><span class="line">mov     eax, [ebp+8]         ; 获取数组首地址</span><br><span class="line">mov     ecx, [ebp+0Ch]       ; 获取索引</span><br><span class="line">mov     eax, [eax+ecx*4]     ; 计算arr[index]的地址并取值</span><br><span class="line"></span><br><span class="line">; 函数尾声</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br></pre></td></tr></table></figure><h4 id="b-数组赋值"><a href="#b-数组赋值" class="headerlink" title="b. 数组赋值"></a>b. 数组赋值</h4><p><strong>C代码：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">setArrayElement</span><span class="params">(<span class="type">int</span> arr[], <span class="type">int</span> index, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">    arr[index] = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>对应的汇编代码：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">; 函数序言</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line"></span><br><span class="line">; 计算数组元素地址并赋值</span><br><span class="line">mov     eax, [ebp+8]         ; 获取数组首地址</span><br><span class="line">mov     ecx, [ebp+0Ch]       ; 获取索引</span><br><span class="line">mov     edx, [ebp+10h]       ; 获取值</span><br><span class="line">mov     [eax+ecx*4], edx     ; arr[index] = value</span><br><span class="line"></span><br><span class="line">; 函数尾声</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br></pre></td></tr></table></figure><h3 id="4-函数调用对照"><a href="#4-函数调用对照" class="headerlink" title="4. 函数调用对照"></a>4. 函数调用对照</h3><h4 id="a-函数调用"><a href="#a-函数调用" class="headerlink" title="a. 函数调用"></a>a. 函数调用</h4><p><strong>C代码：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> result = add(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>对应的汇编代码：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">; add函数</span><br><span class="line">add:</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">mov     eax, [ebp+8]    ; 获取参数a</span><br><span class="line">add     eax, [ebp+0Ch]  ; 加上参数b</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br><span class="line"></span><br><span class="line">; main函数</span><br><span class="line">main:</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">sub     esp, 4          ; 分配局部变量空间</span><br><span class="line"></span><br><span class="line">; 调用add函数</span><br><span class="line">push    20              ; 第二个参数</span><br><span class="line">push    10              ; 第一个参数</span><br><span class="line">call    add             ; 调用add函数</span><br><span class="line">add     esp, 8          ; 清理栈参数</span><br><span class="line"></span><br><span class="line">mov     [ebp-4], eax    ; 保存返回值到result</span><br><span class="line">mov     eax, [ebp-4]    ; 返回result</span><br><span class="line">mov     esp, ebp</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br></pre></td></tr></table></figure><h3 id="5-指针操作对照"><a href="#5-指针操作对照" class="headerlink" title="5. 指针操作对照"></a>5. 指针操作对照</h3><h4 id="a-指针解引用"><a href="#a-指针解引用" class="headerlink" title="a. 指针解引用"></a>a. 指针解引用</h4><p><strong>C代码：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">getValue</span><span class="params">(<span class="type">int</span> *ptr)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>对应的汇编代码：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">; 函数序言</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line"></span><br><span class="line">; 指针解引用</span><br><span class="line">mov     eax, [ebp+8]    ; 获取指针值</span><br><span class="line">mov     eax, [eax]      ; 解引用指针，获取指向的值</span><br><span class="line"></span><br><span class="line">; 函数尾声</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br></pre></td></tr></table></figure><h4 id="b-指针赋值"><a href="#b-指针赋值" class="headerlink" title="b. 指针赋值"></a>b. 指针赋值</h4><p><strong>C代码：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">setValue</span><span class="params">(<span class="type">int</span> *ptr, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">    *ptr = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>对应的汇编代码：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">; 函数序言</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line"></span><br><span class="line">; 指针赋值</span><br><span class="line">mov     eax, [ebp+8]    ; 获取指针值</span><br><span class="line">mov     edx, [ebp+0Ch]  ; 获取要赋的值</span><br><span class="line">mov     [eax], edx      ; 将值赋给指针指向的地址</span><br><span class="line"></span><br><span class="line">; 函数尾声</span><br><span class="line">pop     ebp</span><br><span class="line">retn</span><br></pre></td></tr></table></figure><h2 id="V-结语"><a href="#V-结语" class="headerlink" title="V. 结语"></a>V. 结语</h2><p><strong>本篇核心知识点总结：</strong></p><ul><li>汇编指令是机器指令的助记符，与机器指令是一一对应的</li><li>AT&amp;T的汇编语法格式和Intel汇编语法格式的是不同的</li><li>常用寄存器：EAX 、EBX、ECX、EDX、EDI、ESI、EBP、ESP</li><li>存取速度从高到低分别是: 寄存器 &gt; 1级缓存 &gt; 2级缓存 &gt; 3级缓存 &gt; 内存 &gt; 硬盘</li><li>常用的汇编指令：mov、je、jmp、call、add、sub、inc、dec、and、or</li></ul><p><strong>AI辅助汇编分析设想：</strong><br>随着现在AI大模型的不断发展和各类出圈表现，在二进制逆向工程中的也能够扮演重要的辅助角色，能够提升反编译代码的可读性与分析效率，未来随着多模态模型（结合代码、控制流图、动态执行轨迹）的发展，这一领域有望实现更高效的自动化重构。</p><p>近期发的一些文章也收到了一些想看的case，还在努力整理中<br>还有个别问我一些面试题的。后面如果多了，也可以汇总一下发出来（当然我说的不一定对哈哈哈）</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 汇编语言 </tag>
            
            <tag> 逆向工程 </tag>
            
            <tag> 安全研究 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Frida特征检测及对应的绕过技术解析</title>
      <link href="/2025/10/15/article18_frida_detection_bypass/"/>
      <url>/2025/10/15/article18_frida_detection_bypass/</url>
      
        <content type="html"><![CDATA[<h2 id="I-Frida检测机制概述"><a href="#I-Frida检测机制概述" class="headerlink" title="I. Frida检测机制概述"></a>I. Frida检测机制概述</h2><h3 id="1-为什么要检测Frida"><a href="#1-为什么要检测Frida" class="headerlink" title="1. 为什么要检测Frida"></a>1. 为什么要检测Frida</h3><h4 id="a-安全威胁分析"><a href="#a-安全威胁分析" class="headerlink" title="a. 安全威胁分析"></a>a. 安全威胁分析</h4><ul><li><strong>动态分析风险</strong>：Frida可以实时修改应用行为，绕过安全机制</li><li><strong>数据泄露风险</strong>：通过Hook可以获取敏感数据和API调用</li><li><strong>逆向工程风险</strong>：Frida使得应用逻辑完全暴露给攻击者</li></ul><h4 id="b-检测目标"><a href="#b-检测目标" class="headerlink" title="b. 检测目标"></a>b. 检测目标</h4><ul><li><strong>防止调试</strong>：阻止安全研究人员分析应用</li><li><strong>保护知识产权</strong>：防止核心算法被逆向</li><li><strong>合规要求</strong>：满足金融、支付等行业的合规标准</li></ul><span id="more"></span><h3 id="2-Frida检测分类"><a href="#2-Frida检测分类" class="headerlink" title="2. Frida检测分类"></a>2. Frida检测分类</h3><h4 id="a-按检测层次分类"><a href="#a-按检测层次分类" class="headerlink" title="a. 按检测层次分类"></a>a. 按检测层次分类</h4><ul><li><strong>Java层检测</strong>：检测Frida Java API调用</li><li><strong>Native层检测</strong>：检测Frida Native Hook</li><li><strong>系统层检测</strong>：检测Frida进程和文件</li></ul><h4 id="b-按检测方式分类"><a href="#b-按检测方式分类" class="headerlink" title="b. 按检测方式分类"></a>b. 按检测方式分类</h4><ul><li><strong>静态检测</strong>：检测Frida相关文件和特征</li><li><strong>动态检测</strong>：运行时检测Frida行为</li><li><strong>混合检测</strong>：结合多种检测方式</li></ul><h2 id="II-Frida常见检测特征"><a href="#II-Frida常见检测特征" class="headerlink" title="II. Frida常见检测特征"></a>II. Frida常见检测特征</h2><h3 id="1-进程和文件检测"><a href="#1-进程和文件检测" class="headerlink" title="1. 进程和文件检测"></a>1. 进程和文件检测</h3><p>进程和文件检测是最基础的Frida检测方式，通过检查系统中是否存在Frida相关的进程和文件来判断是否被Hook。这种检测方式简单直接，但容易被绕过。</p><h4 id="a-Frida进程检测"><a href="#a-Frida进程检测" class="headerlink" title="a. Frida进程检测"></a>a. Frida进程检测</h4><p>Frida进程检测通过执行<code>ps</code>命令来查看当前运行的进程，寻找包含”frida”或”gadget”关键字的进程。这是最常见的检测方式之一。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测Frida进程</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectFridaProcess</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;ps&quot;</span>);</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;frida&quot;</span>) || line.contains(<span class="string">&quot;gadget&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="b-Frida文件检测"><a href="#b-Frida文件检测" class="headerlink" title="b. Frida文件检测"></a>b. Frida文件检测</h4><p>Frida文件检测通过检查特定路径下是否存在Frida相关的文件，如frida-server、gadget等。这些文件通常位于<code>/data/local/tmp/</code>或<code>/system/lib/</code>目录下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测Frida相关文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectFridaFiles</span><span class="params">()</span> &#123;</span><br><span class="line">    String[] fridaFiles = &#123;</span><br><span class="line">        <span class="string">&quot;/data/local/tmp/frida-server&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/data/local/tmp/gadget&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/lib/libfrida-gadget.so&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/lib64/libfrida-gadget.so&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (String file : fridaFiles) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">File</span>(file).exists()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-端口和网络检测"><a href="#2-端口和网络检测" class="headerlink" title="2. 端口和网络检测"></a>2. 端口和网络检测</h3><p>端口和网络检测通过检查Frida默认端口27042是否被占用，以及网络连接中是否存在可疑的Frida通信。这种检测方式相对隐蔽，但可以通过端口随机化来绕过。</p><h4 id="a-Frida端口检测"><a href="#a-Frida端口检测" class="headerlink" title="a. Frida端口检测"></a>a. Frida端口检测</h4><p>Frida默认使用27042端口进行通信，检测程序会尝试连接这个端口来判断是否有Frida在运行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测Frida默认端口</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectFridaPort</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>();</span><br><span class="line">        socket.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">27042</span>), <span class="number">1000</span>);</span><br><span class="line">        socket.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="b-网络连接检测"><a href="#b-网络连接检测" class="headerlink" title="b. 网络连接检测"></a>b. 网络连接检测</h4><p>网络连接检测通过执行<code>netstat</code>命令来查看当前网络连接，寻找包含Frida端口或相关关键字的连接。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测可疑网络连接</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectSuspiciousConnections</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;netstat -an&quot;</span>);</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;27042&quot;</span>) || line.contains(<span class="string">&quot;frida&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-Hook检测"><a href="#3-Hook检测" class="headerlink" title="3. Hook检测"></a>3. Hook检测</h3><p>Hook检测是检测Frida最直接的方式，通过检查关键方法是否被Hook，以及异常堆栈中是否包含Frida相关信息来判断。这种检测方式精度较高，但需要深入了解Hook机制。</p><h4 id="a-Java层Hook检测"><a href="#a-Java层Hook检测" class="headerlink" title="a. Java层Hook检测"></a>a. Java层Hook检测</h4><p>Java层Hook检测通过检查关键方法的声明类是否被修改，以及异常堆栈中是否包含Frida相关的类名来判断是否被Hook。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测Java层Hook</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectJavaHook</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 检测关键方法是否被Hook</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> String.class.getMethod(<span class="string">&quot;equals&quot;</span>, Object.class);</span><br><span class="line">        <span class="keyword">if</span> (method.getDeclaringClass() != String.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测异常处理</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            StackTraceElement[] stack = e.getStackTrace();</span><br><span class="line">            <span class="keyword">for</span> (StackTraceElement element : stack) &#123;</span><br><span class="line">                <span class="keyword">if</span> (element.getClassName().contains(<span class="string">&quot;frida&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="b-Native层Hook检测"><a href="#b-Native层Hook检测" class="headerlink" title="b. Native层Hook检测"></a>b. Native层Hook检测</h4><p>Native层Hook检测通过检查关键函数的入口点是否被修改，通常Hook会在函数开头插入JMP指令来跳转到Hook函数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Native层Hook检测</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">detectNativeHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检测关键函数是否被Hook</span></span><br><span class="line">    <span class="type">void</span>* target_func = <span class="built_in">dlsym</span>(RTLD_DEFAULT, <span class="string">&quot;strlen&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (target_func == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检测函数入口点</span></span><br><span class="line">    <span class="type">uint8_t</span>* func_start = (<span class="type">uint8_t</span>*)target_func;</span><br><span class="line">    <span class="keyword">if</span> (func_start[<span class="number">0</span>] == <span class="number">0xE9</span> || func_start[<span class="number">0</span>] == <span class="number">0xEB</span>) &#123; <span class="comment">// JMP指令</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-线程检测"><a href="#4-线程检测" class="headerlink" title="4. 线程检测"></a>4. 线程检测</h3><p>线程检测通过检查当前运行的线程中是否存在Frida相关的线程名，以及线程数量是否异常来判断是否被Hook。Frida会创建多个工作线程来处理Hook逻辑。</p><h4 id="a-Frida线程检测"><a href="#a-Frida线程检测" class="headerlink" title="a. Frida线程检测"></a>a. Frida线程检测</h4><p>Frida会创建多个线程来处理不同的任务，如gum-js-loop线程用于执行JavaScript代码，检测程序会枚举所有线程并检查线程名。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测Frida相关线程</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectFridaThreads</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> <span class="title class_">Thread</span>[Thread.activeCount()];</span><br><span class="line">        Thread.enumerate(threads);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">            <span class="keyword">if</span> (thread != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">threadName</span> <span class="operator">=</span> thread.getName();</span><br><span class="line">                <span class="keyword">if</span> (threadName.contains(<span class="string">&quot;frida&quot;</span>) || </span><br><span class="line">                    threadName.contains(<span class="string">&quot;gadget&quot;</span>) ||</span><br><span class="line">                    threadName.contains(<span class="string">&quot;gum-js-loop&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="b-线程数量异常检测"><a href="#b-线程数量异常检测" class="headerlink" title="b. 线程数量异常检测"></a>b. 线程数量异常检测</h4><p>正常应用的线程数量通常在10-50个之间，如果线程数量异常增多，可能存在Frida等调试工具在运行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测线程数量异常</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectThreadCountAnomaly</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">threadCount</span> <span class="operator">=</span> Thread.activeCount();</span><br><span class="line">    <span class="comment">// 正常应用线程数通常在10-50之间</span></span><br><span class="line">    <span class="keyword">if</span> (threadCount &gt; <span class="number">100</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 可能存在Frida线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-文件描述符检测"><a href="#5-文件描述符检测" class="headerlink" title="5. 文件描述符检测"></a>5. 文件描述符检测</h3><p>文件描述符检测通过检查进程的文件描述符中是否存在Frida相关的文件或网络连接。这种检测方式相对隐蔽，但可以通过Hook文件系统调用来绕过。</p><h4 id="a-fd检测"><a href="#a-fd检测" class="headerlink" title="a. fd检测"></a>a. fd检测</h4><p>通过读取<code>/proc/self/fd</code>目录来查看当前进程打开的所有文件描述符，寻找Frida相关的文件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测文件描述符</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectFridaFD</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;ls -la /proc/self/fd&quot;</span>);</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;frida&quot;</span>) || line.contains(<span class="string">&quot;gadget&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="b-网络连接fd检测"><a href="#b-网络连接fd检测" class="headerlink" title="b. 网络连接fd检测"></a>b. 网络连接fd检测</h4><p>通过<code>lsof</code>命令查看当前进程的网络连接，检查是否存在连接到Frida端口的TCP连接。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测网络连接文件描述符</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectNetworkFD</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;lsof -p &quot;</span> + android.os.Process.myPid());</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;TCP&quot;</span>) &amp;&amp; line.contains(<span class="string">&quot;27042&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 检测到Frida端口连接</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-Trace状态检查"><a href="#6-Trace状态检查" class="headerlink" title="6. Trace状态检查"></a>6. Trace状态检查</h3><p>Trace状态检查通过检查进程的调试状态来判断是否被调试器附加。这是检测Frida最直接的方式之一，因为Frida本质上就是一个调试器。</p><h4 id="a-Trace检测"><a href="#a-Trace检测" class="headerlink" title="a. Trace检测"></a>a. Trace检测</h4><p>通过读取<code>/proc/self/status</code>文件中的TracerPid字段来判断是否有调试器在跟踪当前进程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测Trace状态</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectTraceStatus</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 检测ptrace状态</span></span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;cat /proc/self/status&quot;</span>);</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (line.startsWith(<span class="string">&quot;TracerPid:&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">tracerPid</span> <span class="operator">=</span> line.split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>].trim();</span><br><span class="line">                <span class="keyword">if</span> (!tracerPid.equals(<span class="string">&quot;0&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 被调试器跟踪</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="b-调试器附加检测"><a href="#b-调试器附加检测" class="headerlink" title="b. 调试器附加检测"></a>b. 调试器附加检测</h4><p>通过检查<code>/proc/self/wchan</code>文件来判断当前进程是否在等待ptrace相关的系统调用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测调试器附加</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectDebuggerAttach</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 使用ptrace检测</span></span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;cat /proc/self/wchan&quot;</span>);</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">        <span class="type">String</span> <span class="variable">wchan</span> <span class="operator">=</span> reader.readLine();</span><br><span class="line">        <span class="keyword">if</span> (wchan != <span class="literal">null</span> &amp;&amp; wchan.contains(<span class="string">&quot;ptrace&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-内存检测"><a href="#7-内存检测" class="headerlink" title="7. 内存检测"></a>7. 内存检测</h3><p>内存检测通过检查内存映射和内存完整性来判断是否被Hook。这种检测方式相对复杂，但检测精度较高。</p><h4 id="a-内存映射检测"><a href="#a-内存映射检测" class="headerlink" title="a. 内存映射检测"></a>a. 内存映射检测</h4><p>通过读取<code>/proc/self/maps</code>文件来查看当前进程的内存映射，寻找Frida相关的内存区域。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测内存映射</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">detectMemoryMapping</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;cat /proc/self/maps&quot;</span>);</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;frida&quot;</span>) || line.contains(<span class="string">&quot;gadget&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="b-内存完整性检测"><a href="#b-内存完整性检测" class="headerlink" title="b. 内存完整性检测"></a>b. 内存完整性检测</h4><p>通过计算关键代码段的哈希值来判断代码是否被修改，这是检测Hook最直接的方式。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存完整性检测</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">detectMemoryIntegrity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检测关键代码段是否被修改</span></span><br><span class="line">    <span class="type">uint8_t</span>* code_start = (<span class="type">uint8_t</span>*)<span class="number">0x400000</span>; <span class="comment">// 假设的代码段地址</span></span><br><span class="line">    <span class="type">uint32_t</span> expected_hash = <span class="built_in">calculateHash</span>(code_start, <span class="number">1024</span>);</span><br><span class="line">    <span class="type">uint32_t</span> current_hash = <span class="built_in">calculateHash</span>(code_start, <span class="number">1024</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> expected_hash != current_hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="III-Frida绕过方法详解"><a href="#III-Frida绕过方法详解" class="headerlink" title="III. Frida绕过方法详解"></a>III. Frida绕过方法详解</h2><h3 id="1-进程和文件绕过"><a href="#1-进程和文件绕过" class="headerlink" title="1. 进程和文件绕过"></a>1. 进程和文件绕过</h3><p>进程和文件绕过主要通过伪装进程名、隐藏文件路径和动态加载等方式来避免被检测。这些方法相对简单，但需要Root权限支持。</p><h4 id="a-进程名伪装"><a href="#a-进程名伪装" class="headerlink" title="a. 进程名伪装"></a>a. 进程名伪装</h4><p>通过修改Frida进程的名称来避免被进程检测发现，这是最基础的绕过方式。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改Frida进程名</span></span><br><span class="line">frida-server -D -l script.js --name <span class="string">&quot;com.example.app&quot;</span></span><br></pre></td></tr></table></figure><h4 id="b-文件路径绕过"><a href="#b-文件路径绕过" class="headerlink" title="b. 文件路径绕过"></a>b. 文件路径绕过</h4><p>通过将Frida文件放置在非标准路径下，或者使用应用私有目录来避免被文件检测发现。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用非标准路径</span></span><br><span class="line">frida_server_path = <span class="string">&quot;/data/data/com.example.app/lib/libfrida.so&quot;</span></span><br></pre></td></tr></table></figure><h4 id="c-动态加载绕过"><a href="#c-动态加载绕过" class="headerlink" title="c. 动态加载绕过"></a>c. 动态加载绕过</h4><p>通过动态加载Frida代码来避免静态文件检测，这种方式更加隐蔽，但实现复杂度较高。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 动态加载Frida</span></span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_frida_dynamically</span>():</span><br><span class="line">    <span class="comment"># 从内存中加载Frida</span></span><br><span class="line">    frida_code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Java.perform(function() &#123;</span></span><br><span class="line"><span class="string">        // Frida代码</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> frida_code</span><br></pre></td></tr></table></figure><h3 id="2-端口和网络绕过"><a href="#2-端口和网络绕过" class="headerlink" title="2. 端口和网络绕过"></a>2. 端口和网络绕过</h3><p>端口和网络绕过主要通过端口随机化、网络代理和本地通信等方式来避免被检测。这些方法可以有效绕过端口检测，但需要修改Frida的通信方式。</p><h4 id="a-端口随机化"><a href="#a-端口随机化" class="headerlink" title="a. 端口随机化"></a>a. 端口随机化</h4><p>通过使用随机端口来避免被默认端口检测发现，这是最常用的绕过方式。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 随机端口绕过</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_random_port</span>():</span><br><span class="line">    <span class="keyword">return</span> random.randint(<span class="number">30000</span>, <span class="number">60000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用随机端口</span></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">session = device.attach(<span class="string">&quot;com.example.app&quot;</span>)</span><br><span class="line">script = session.create_script(js_code)</span><br></pre></td></tr></table></figure><h4 id="b-网络代理绕过"><a href="#b-网络代理绕过" class="headerlink" title="b. 网络代理绕过"></a>b. 网络代理绕过</h4><p>通过代理服务器来转发Frida通信，避免直接连接被检测。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过代理连接</span></span><br><span class="line">device = frida.get_device_manager().add_remote_device(<span class="string">&quot;192.168.1.100:27042&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="c-本地通信绕过"><a href="#c-本地通信绕过" class="headerlink" title="c. 本地通信绕过"></a>c. 本地通信绕过</h4><p>通过文件系统或其他本地通信方式来避免网络检测，这种方式更加隐蔽。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用本地通信</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">local_communication</span>():</span><br><span class="line">    <span class="comment"># 通过文件系统通信</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/data/local/tmp/frida_comm&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;command&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="3-Hook检测绕过"><a href="#3-Hook检测绕过" class="headerlink" title="3. Hook检测绕过"></a>3. Hook检测绕过</h3><p>Hook检测绕过主要通过Hook检测函数本身来返回虚假结果，这是最有效的绕过方式，但需要深入了解检测机制。</p><h4 id="a-Java层Hook绕过"><a href="#a-Java层Hook绕过" class="headerlink" title="a. Java层Hook绕过"></a>a. Java层Hook绕过</h4><p>通过Hook Java层的检测函数来返回虚假结果，避免被Hook检测发现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过Java层Hook检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook检测函数</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Process</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Process&quot;</span>);</span><br><span class="line">    <span class="title class_">Process</span>.<span class="property">exec</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">cmd</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cmd.<span class="title function_">includes</span>(<span class="string">&quot;ps&quot;</span>) || cmd.<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// 返回空结果</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">exec</span>(cmd);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook文件检测</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">File</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.File&quot;</span>);</span><br><span class="line">    <span class="title class_">File</span>.<span class="property">exists</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> path = <span class="variable language_">this</span>.<span class="title function_">getAbsolutePath</span>();</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>) || path.<span class="title function_">includes</span>(<span class="string">&quot;gadget&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 返回不存在</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">exists</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="b-Native层Hook绕过"><a href="#b-Native层Hook绕过" class="headerlink" title="b. Native层Hook绕过"></a>b. Native层Hook绕过</h4><p>通过恢复原始函数或使用更隐蔽的Hook方式来避免被Native层检测发现。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Native层Hook绕过</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bypassNativeDetection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 恢复原始函数</span></span><br><span class="line">    <span class="type">void</span>* original_func = <span class="built_in">get_original_function</span>();</span><br><span class="line">    <span class="built_in">memcpy</span>(hooked_func, original_func, <span class="number">5</span>); <span class="comment">// 恢复前5字节</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用更隐蔽的Hook方式</span></span><br><span class="line">    <span class="built_in">install_inline_hook</span>(target_func, hook_func);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-线程检测绕过"><a href="#4-线程检测绕过" class="headerlink" title="4. 线程检测绕过"></a>4. 线程检测绕过</h3><p>线程检测绕过主要通过伪装线程名和控制线程数量来避免被检测。这些方法相对简单，但需要Hook线程相关的API。</p><h4 id="a-线程名伪装"><a href="#a-线程名伪装" class="headerlink" title="a. 线程名伪装"></a>a. 线程名伪装</h4><p>通过Hook线程创建和枚举函数来伪装线程名，避免被线程检测发现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过线程检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook线程创建</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Thread</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Thread&quot;</span>);</span><br><span class="line">    <span class="title class_">Thread</span>.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">name</span>) &#123;</span><br><span class="line">        <span class="comment">// 伪装线程名</span></span><br><span class="line">        <span class="keyword">if</span> (name.<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>) || name.<span class="title function_">includes</span>(<span class="string">&quot;gadget&quot;</span>)) &#123;</span><br><span class="line">            name = <span class="string">&quot;system-thread-&quot;</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.$init(name);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook线程枚举</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">ThreadGroup</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.ThreadGroup&quot;</span>);</span><br><span class="line">    <span class="title class_">ThreadGroup</span>.<span class="property">enumerate</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">threads</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">enumerate</span>(threads);</span><br><span class="line">        <span class="comment">// 过滤掉Frida相关线程</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; threads.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (threads[i] &amp;&amp; threads[i].<span class="title function_">getName</span>().<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>)) &#123;</span><br><span class="line">                threads[i] = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="b-线程数量控制"><a href="#b-线程数量控制" class="headerlink" title="b. 线程数量控制"></a>b. 线程数量控制</h4><p>通过Hook线程计数函数来返回正常的线程数量，避免被线程数量异常检测发现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制线程数量</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Thread</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Thread&quot;</span>);</span><br><span class="line">    <span class="title class_">Thread</span>.<span class="property">activeCount</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> count = <span class="variable language_">this</span>.<span class="title function_">activeCount</span>();</span><br><span class="line">        <span class="comment">// 限制线程数量在正常范围内</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">50</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">30</span>; <span class="comment">// 返回正常线程数</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="5-文件描述符检测绕过"><a href="#5-文件描述符检测绕过" class="headerlink" title="5. 文件描述符检测绕过"></a>5. 文件描述符检测绕过</h3><p>文件描述符检测绕过主要通过Hook文件系统调用来过滤Frida相关的内容，这是绕过fd检测的主要方式。</p><h4 id="a-fd检测绕过"><a href="#a-fd检测绕过" class="headerlink" title="a. fd检测绕过"></a>a. fd检测绕过</h4><p>通过Hook文件描述符读取函数来过滤Frida相关内容，避免被fd检测发现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过fd检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook文件描述符读取</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">FileInputStream</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.FileInputStream&quot;</span>);</span><br><span class="line">    <span class="title class_">FileInputStream</span>.<span class="property">read</span>.<span class="title function_">overload</span>(<span class="string">&quot;[B&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">buffer</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">read</span>(buffer);</span><br><span class="line">        <span class="keyword">var</span> content = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, buffer);</span><br><span class="line">        <span class="keyword">var</span> str = <span class="title class_">String</span>.<span class="property">fromCharCode</span>.<span class="title function_">apply</span>(<span class="literal">null</span>, content);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (str.<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>) || str.<span class="title function_">includes</span>(<span class="string">&quot;gadget&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 过滤掉Frida相关内容</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook lsof命令</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Runtime</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">    <span class="title class_">Runtime</span>.<span class="property">exec</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">cmd</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cmd.<span class="title function_">includes</span>(<span class="string">&quot;lsof&quot;</span>) &amp;&amp; cmd.<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 返回空结果</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">exec</span>(cmd);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="b-网络连接fd绕过"><a href="#b-网络连接fd绕过" class="headerlink" title="b. 网络连接fd绕过"></a>b. 网络连接fd绕过</h4><p>通过Hook网络连接相关函数来伪装网络连接，避免被网络连接fd检测发现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过网络连接fd检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook网络连接检测</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Socket</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.net.Socket&quot;</span>);</span><br><span class="line">    <span class="title class_">Socket</span>.<span class="property">getInputStream</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> inputStream = <span class="variable language_">this</span>.<span class="title function_">getInputStream</span>();</span><br><span class="line">        <span class="comment">// 伪装网络连接</span></span><br><span class="line">        <span class="keyword">return</span> inputStream;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="6-Trace状态检测绕过"><a href="#6-Trace状态检测绕过" class="headerlink" title="6. Trace状态检测绕过"></a>6. Trace状态检测绕过</h3><p>Trace状态检测绕过主要通过Hook状态文件读取函数来修改调试状态信息，这是绕过Trace检测的主要方式。</p><h4 id="a-Trace状态绕过"><a href="#a-Trace状态绕过" class="headerlink" title="a. Trace状态绕过"></a>a. Trace状态绕过</h4><p>通过Hook状态文件读取函数来修改TracerPid和wchan信息，避免被Trace状态检测发现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过Trace状态检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook状态文件读取</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">FileInputStream</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.FileInputStream&quot;</span>);</span><br><span class="line">    <span class="title class_">FileInputStream</span>.<span class="property">read</span>.<span class="title function_">overload</span>(<span class="string">&quot;[B&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">buffer</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">read</span>(buffer);</span><br><span class="line">        <span class="keyword">var</span> content = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, buffer);</span><br><span class="line">        <span class="keyword">var</span> str = <span class="title class_">String</span>.<span class="property">fromCharCode</span>.<span class="title function_">apply</span>(<span class="literal">null</span>, content);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (str.<span class="title function_">includes</span>(<span class="string">&quot;TracerPid:&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 修改TracerPid为0</span></span><br><span class="line">            <span class="keyword">var</span> modifiedContent = str.<span class="title function_">replace</span>(<span class="regexp">/TracerPid:\s*\d+/</span>, <span class="string">&quot;TracerPid: 0&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> modifiedBytes = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, modifiedContent.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">c</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> c.<span class="title function_">charCodeAt</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;));</span><br><span class="line">            buffer.<span class="property">length</span> = modifiedBytes.<span class="property">length</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; modifiedBytes.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                buffer[i] = modifiedBytes[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> modifiedBytes.<span class="property">length</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook wchan检测</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">FileInputStream</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.FileInputStream&quot;</span>);</span><br><span class="line">    <span class="title class_">FileInputStream</span>.<span class="property">read</span>.<span class="title function_">overload</span>(<span class="string">&quot;[B&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">buffer</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">read</span>(buffer);</span><br><span class="line">        <span class="keyword">var</span> content = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, buffer);</span><br><span class="line">        <span class="keyword">var</span> str = <span class="title class_">String</span>.<span class="property">fromCharCode</span>.<span class="title function_">apply</span>(<span class="literal">null</span>, content);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (str.<span class="title function_">includes</span>(<span class="string">&quot;ptrace&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 替换ptrace相关内容</span></span><br><span class="line">            <span class="keyword">var</span> modifiedContent = str.<span class="title function_">replace</span>(<span class="string">&quot;ptrace&quot;</span>, <span class="string">&quot;sys_epoll_wait&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> modifiedBytes = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, modifiedContent.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">c</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> c.<span class="title function_">charCodeAt</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;));</span><br><span class="line">            buffer.<span class="property">length</span> = modifiedBytes.<span class="property">length</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; modifiedBytes.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                buffer[i] = modifiedBytes[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> modifiedBytes.<span class="property">length</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="b-调试器附加绕过"><a href="#b-调试器附加绕过" class="headerlink" title="b. 调试器附加绕过"></a>b. 调试器附加绕过</h4><p>通过Hook调试器检测函数来返回虚假结果，避免被调试器附加检测发现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过调试器附加检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook调试器检测函数</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Debug</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.os.Debug&quot;</span>);</span><br><span class="line">    <span class="title class_">Debug</span>.<span class="property">isDebuggerConnected</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 始终返回false</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook进程状态检测</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Process</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.os.Process&quot;</span>);</span><br><span class="line">    <span class="title class_">Process</span>.<span class="property">isDebuggerAttached</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="7-内存检测绕过"><a href="#7-内存检测绕过" class="headerlink" title="7. 内存检测绕过"></a>7. 内存检测绕过</h3><p>内存检测绕过主要通过Hook内存读取函数来过滤Frida相关内容，这是绕过内存检测的主要方式。</p><h4 id="a-内存映射绕过"><a href="#a-内存映射绕过" class="headerlink" title="a. 内存映射绕过"></a>a. 内存映射绕过</h4><p>通过Hook内存映射读取函数来过滤Frida相关内容，避免被内存映射检测发现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过内存映射检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook内存映射读取</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">FileInputStream</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.FileInputStream&quot;</span>);</span><br><span class="line">    <span class="title class_">FileInputStream</span>.<span class="property">read</span>.<span class="title function_">overload</span>(<span class="string">&quot;[B&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">buffer</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">read</span>(buffer);</span><br><span class="line">        <span class="keyword">var</span> content = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, buffer);</span><br><span class="line">        <span class="keyword">var</span> str = <span class="title class_">String</span>.<span class="property">fromCharCode</span>.<span class="title function_">apply</span>(<span class="literal">null</span>, content);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (str.<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>) || str.<span class="title function_">includes</span>(<span class="string">&quot;gadget&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 过滤掉Frida相关内容</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="b-内存完整性绕过"><a href="#b-内存完整性绕过" class="headerlink" title="b. 内存完整性绕过"></a>b. 内存完整性绕过</h4><p>通过动态修改检测逻辑和使用内存保护来避免被内存完整性检测发现。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存完整性绕过</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bypassMemoryIntegrity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 动态修改检测逻辑</span></span><br><span class="line">    <span class="built_in">patch_detection_function</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用内存保护</span></span><br><span class="line">    <span class="built_in">protect_memory_region</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="IV-进阶绕过技术"><a href="#IV-进阶绕过技术" class="headerlink" title="IV. 进阶绕过技术"></a>IV. 进阶绕过技术</h2><p>进阶绕过技术主要针对更复杂的检测机制，包括反反调试技术和动态对抗技术。需要更深入的系统知识和更复杂的实现方式。</p><h3 id="1-反反调试技术"><a href="#1-反反调试技术" class="headerlink" title="1. 反反调试技术"></a>1. 反反调试技术</h3><p>反反调试技术主要针对应用的反调试机制，通过Hook调试器检测函数来绕过反调试保护。需要深入了解Android系统的调试机制。</p><h4 id="a-调试器检测绕过"><a href="#a-调试器检测绕过" class="headerlink" title="a. 调试器检测绕过"></a>a. 调试器检测绕过</h4><p>通过HookAndroid系统提供的调试器检测函数来返回虚假结果，避免被反调试机制发现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过调试器检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook调试器检测</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Debug</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.os.Debug&quot;</span>);</span><br><span class="line">    <span class="title class_">Debug</span>.<span class="property">isDebuggerConnected</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 始终返回false</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook调试器附加检测</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Process</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.os.Process&quot;</span>);</span><br><span class="line">    <span class="title class_">Process</span>.<span class="property">isDebuggerAttached</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="b-时间检测绕过"><a href="#b-时间检测绕过" class="headerlink" title="b. 时间检测绕过"></a>b. 时间检测绕过</h4><p>通过Hook时间相关函数来模拟正常的时间间隔，避免被基于时间差的反调试机制发现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过时间检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook时间相关函数</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">System</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.System&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> originalTime = <span class="title class_">System</span>.<span class="property">currentTimeMillis</span>;</span><br><span class="line">    <span class="keyword">var</span> lastTime = originalTime.<span class="title function_">call</span>(<span class="title class_">System</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">System</span>.<span class="property">currentTimeMillis</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> currentTime = originalTime.<span class="title function_">call</span>(<span class="title class_">System</span>);</span><br><span class="line">        <span class="keyword">if</span> (currentTime - lastTime &lt; <span class="number">100</span>) &#123; <span class="comment">// 检测到时间异常</span></span><br><span class="line">            lastTime += <span class="number">100</span>; <span class="comment">// 增加时间间隔</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lastTime = currentTime;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lastTime;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="2-动态对抗技术"><a href="#2-动态对抗技术" class="headerlink" title="2. 动态对抗技术"></a>2. 动态对抗技术</h3><p>动态对抗技术主要针对应用在运行时的动态检测机制，通过检测Hook并动态调整行为来避免被发现。需要实时监控和动态响应。</p><h4 id="a-动态Hook检测"><a href="#a-动态Hook检测" class="headerlink" title="a. 动态Hook检测"></a>a. 动态Hook检测</h4><p>通过检测Hook并动态调整行为来避免被动态检测机制发现，这是一种高级的对抗技术。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态Hook检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 检测Hook并动态调整</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Thread</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Thread&quot;</span>);</span><br><span class="line">    <span class="title class_">Thread</span>.<span class="property">sleep</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">millis</span>) &#123;</span><br><span class="line">        <span class="comment">// 检测到Hook，调整行为</span></span><br><span class="line">        <span class="keyword">if</span> (millis &lt; <span class="number">1000</span>) &#123;</span><br><span class="line">            millis = <span class="number">1000</span>; <span class="comment">// 增加睡眠时间</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">sleep</span>(millis);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="b-行为模拟"><a href="#b-行为模拟" class="headerlink" title="b. 行为模拟"></a>b. 行为模拟</h4><p>通过模拟正常应用的行为来避免被行为分析检测发现，这是一种更加隐蔽的对抗技术。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟正常应用行为</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 模拟正常的网络请求</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">URL</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line">    <span class="variable constant_">URL</span>.<span class="property">openConnection</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 添加正常的请求头</span></span><br><span class="line">        <span class="keyword">var</span> connection = <span class="variable language_">this</span>.<span class="title function_">openConnection</span>();</span><br><span class="line">        connection.<span class="title function_">setRequestProperty</span>(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="V-检测与绕过流程图"><a href="#V-检测与绕过流程图" class="headerlink" title="V. 检测与绕过流程图"></a>V. 检测与绕过流程图</h2><p>检测与绕过流程图展示了Frida检测与绕过的完整攻防流程，包括各种检测方式和对应的绕过技术。通过这个流程图可以清晰地理解攻防对抗的全貌。</p><pre class="mermaid">flowchart TD    A[应用启动] --> B{检测Frida}    B --> C[进程检测]    B --> D[文件检测]    B --> E[端口检测]    B --> F[Hook检测]    B --> G[线程检测]    B --> H[fd检测]    B --> I[Trace状态检查]    B --> J[内存检测]        C --> K{检测到Frida?}    D --> K    E --> K    F --> K    G --> K    H --> K    I --> K    J --> K        K -->|是| L[触发防护机制]    K -->|否| M[正常运行]        L --> N[退出应用]    L --> O[显示警告]    L --> P[限制功能]        Q[绕过技术] --> R[进程伪装]    Q --> S[文件隐藏]    Q --> T[端口随机]    Q --> U[Hook绕过]    Q --> V[线程伪装]    Q --> W[fd隐藏]    Q --> X[Trace绕过]    Q --> Y[内存保护]        R --> Z[绕过成功]    S --> Z    T --> Z    U --> Z    V --> Z    W --> Z    X --> Z    Y --> Z        Z --> M</pre><h2 id="VI-自编译Frida与开源方案"><a href="#VI-自编译Frida与开源方案" class="headerlink" title="VI. 自编译Frida与开源方案"></a>VI. 自编译Frida与开源方案</h2><p>自编译Frida和开源方案是绕过Frida检测的重要技术手段，通过修改Frida源码或使用开源替代方案来避免被检测。这些方案需要一定的技术基础，但绕过效果显著。</p><h3 id="1-自编译Frida"><a href="#1-自编译Frida" class="headerlink" title="1. 自编译Frida"></a>1. 自编译Frida</h3><p>自编译Frida通过修改Frida源码来改变其特征，避免被检测发现。这是最有效的绕过方式之一，但需要深入了解Frida的架构。</p><h4 id="a-简单列举一些源码修改的要点"><a href="#a-简单列举一些源码修改的要点" class="headerlink" title="a. 简单列举一些源码修改的要点"></a>a. 简单列举一些源码修改的要点</h4><p>自编译Frida需要修改的关键点包括进程名、端口号、文件路径、线程名等特征信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改Frida源码中的特征</span></span><br><span class="line"><span class="comment"># 1. 修改默认端口</span></span><br><span class="line">sed -i <span class="string">&#x27;s/27042/12345/g&#x27;</span> frida-core/src/frida-core.vala</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 修改进程名</span></span><br><span class="line">sed -i <span class="string">&#x27;s/frida-server/myapp/g&#x27;</span> frida-core/src/frida-server.vala</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 修改线程名</span></span><br><span class="line">sed -i <span class="string">&#x27;s/gum-js-loop/system-loop/g&#x27;</span> gum/gumjs/gumscriptbackend.cpp</span><br></pre></td></tr></table></figure><h4 id="b-编译配置"><a href="#b-编译配置" class="headerlink" title="b. 编译配置"></a>b. 编译配置</h4><p>编译时需要配置特定的编译选项来优化绕过效果。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译配置</span></span><br><span class="line">./configure --enable-static --disable-shared --with-pic</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h3 id="2-开源绕过方案"><a href="#2-开源绕过方案" class="headerlink" title="2. 开源绕过方案"></a>2. 开源绕过方案</h3><p>网络上存在多种开源的Frida绕过方案，这些方案通常针对特定的检测机制设计，具有很好的实用性。</p><h4 id="a-Frida-Anti-Detection"><a href="#a-Frida-Anti-Detection" class="headerlink" title="a. Frida-Anti-Detection"></a>a. Frida-Anti-Detection</h4><p>Frida-Anti-Detection是一个专门用于绕过Frida检测的开源项目，集成了多种绕过技术。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装Frida-Anti-Detection</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/darvincisec/Frida-Anti-Detection.git</span><br><span class="line"><span class="built_in">cd</span> Frida-Anti-Detection</span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><h4 id="b-Frida-Hook-Libart"><a href="#b-Frida-Hook-Libart" class="headerlink" title="b. Frida-Hook-Libart"></a>b. Frida-Hook-Libart</h4><p>Frida-Hook-Libart专门针对Android系统的libart库进行Hook，绕过ART虚拟机的检测。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用Frida-Hook-Libart</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook ART虚拟机检测函数</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">ArtMethod</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;art.ArtMethod&quot;</span>);</span><br><span class="line">    <span class="title class_">ArtMethod</span>.<span class="property">invoke</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">thread, args</span>) &#123;</span><br><span class="line">        <span class="comment">// 绕过ART检测</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">invoke</span>(thread, args);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="3-Frida衍生工具"><a href="#3-Frida衍生工具" class="headerlink" title="3. Frida衍生工具"></a>3. Frida衍生工具</h3><p>除了官方Frida，还有许多基于Frida开发的衍生工具，这些工具在特定场景下具有更好的绕过效果。</p><h4 id="a-Frida-Scripts"><a href="#a-Frida-Scripts" class="headerlink" title="a. Frida-Scripts"></a>a. Frida-Scripts</h4><p>Frida-Scripts是一个收集了大量Frida脚本的开源项目，包含多种绕过脚本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用Frida-Scripts</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/0xdea/frida-scripts.git</span><br><span class="line">frida -U -f com.target.app -l frida-scripts/android/anti-frida.js</span><br></pre></td></tr></table></figure><h4 id="b-Frida-Gadget"><a href="#b-Frida-Gadget" class="headerlink" title="b. Frida-Gadget"></a>b. Frida-Gadget</h4><p>Frida-Gadget是Frida的嵌入式版本，可以集成到应用中，避免外部检测。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 集成Frida-Gadget</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;frida-gadget.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化Frida-Gadget</span></span><br><span class="line">    <span class="built_in">frida_gadget_init</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载脚本</span></span><br><span class="line">    <span class="built_in">frida_gadget_load_script</span>(<span class="string">&quot;bypass.js&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="c-Frida-Inject"><a href="#c-Frida-Inject" class="headerlink" title="c. Frida-Inject"></a>c. Frida-Inject</h4><p>Frida-Inject是一个轻量级的Frida注入工具，专门用于绕过检测。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用Frida-Inject</span></span><br><span class="line"><span class="keyword">from</span> frida_inject <span class="keyword">import</span> FridaInject</span><br><span class="line"></span><br><span class="line">injector = FridaInject()</span><br><span class="line">injector.attach(<span class="string">&quot;com.target.app&quot;</span>)</span><br><span class="line">injector.load_script(<span class="string">&quot;anti_detection.js&quot;</span>)</span><br><span class="line">injector.resume()</span><br></pre></td></tr></table></figure><h2 id="VII-结语"><a href="#VII-结语" class="headerlink" title="VII. 结语"></a>VII. 结语</h2><p>在实际应用中，建议采用多层防护策略，结合静态检测、动态检测和行为分析，同时不断更新检测规则和绕过方法，形成良性的攻防对抗循环。同时也要注意合规使用，避免用于非法目的。</p><p><strong>同类工具推荐</strong>：Xposed框架、Substrate、Cydia Substrate等Hook框架也面临类似的检测与绕过问题，可以借鉴Frida的检测绕过思路。</p><p>最后简单推荐几个开源的<strong>frida脚本集合</strong>：<br><a href="https://github.com/deathmemory/FridaContainer">https://github.com/deathmemory/FridaContainer</a><br><a href="https://github.com/dweinstein/awesome-frida">https://github.com/dweinstein/awesome-frida</a><br><a href="https://github.com/0xdea/frida-scripts">https://github.com/0xdea/frida-scripts</a></p><p>非果子开源，只是编写文章过程和实际使用过程中有参考到其中的内容</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Frida </tag>
            
            <tag> 绕过技术 </tag>
            
            <tag> 特征检测 </tag>
            
            <tag> 解析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VMP、JSVMP、OLLVM、WASM技术解析：从虚拟机保护到字节码混淆</title>
      <link href="/2025/09/29/article17_vmp_ollvm_wasm_guide/"/>
      <url>/2025/09/29/article17_vmp_ollvm_wasm_guide/</url>
      
        <content type="html"><![CDATA[<h2 id="一、技术概述"><a href="#一、技术概述" class="headerlink" title="一、技术概述"></a>一、技术概述</h2><h3 id="1-VMP（VMProtect）"><a href="#1-VMP（VMProtect）" class="headerlink" title="1. VMP（VMProtect）"></a>1. VMP（VMProtect）</h3><p><strong>VMP</strong>是一款商业化的代码保护工具，通过虚拟机技术将原始代码转换为虚拟机字节码，实现代码的加密和混淆保护。</p><p><strong>核心特性</strong>：</p><ul><li><strong>虚拟机保护</strong>：将x86&#x2F;x64指令转换为虚拟机字节码</li><li><strong>代码加密</strong>：运行时动态解密执行</li><li><strong>反调试</strong>：内置多种反调试机制</li><li><strong>完整性校验</strong>：防止代码被篡改<span id="more"></span></li></ul><h3 id="2-JSVMP（JavaScript-Virtual-Machine-Protection）"><a href="#2-JSVMP（JavaScript-Virtual-Machine-Protection）" class="headerlink" title="2. JSVMP（JavaScript Virtual Machine Protection）"></a>2. JSVMP（JavaScript Virtual Machine Protection）</h3><p><strong>JSVMP</strong>是专门针对JavaScript代码的虚拟机保护技术，通过将JavaScript代码转换为自定义的虚拟机字节码来保护代码逻辑。</p><p><strong>核心特性</strong>：</p><ul><li><strong>JavaScript虚拟机</strong>：专门为JS代码设计的虚拟机</li><li><strong>字节码转换</strong>：将JS代码转换为虚拟机字节码</li><li><strong>反调试保护</strong>：检测浏览器调试工具</li><li><strong>代码混淆</strong>：结合传统混淆技术</li></ul><h3 id="3-OLLVM（Obfuscator-LLVM）"><a href="#3-OLLVM（Obfuscator-LLVM）" class="headerlink" title="3. OLLVM（Obfuscator-LLVM）"></a>3. OLLVM（Obfuscator-LLVM）</h3><p><strong>OLLVM</strong>是基于LLVM编译器的开源代码混淆框架，在编译时对代码进行混淆处理。</p><p><strong>核心特性</strong>：</p><ul><li><strong>控制流平坦化</strong>：将复杂的控制流转换为平坦结构</li><li><strong>指令替换</strong>：用等价的复杂指令替换简单指令</li><li><strong>虚假控制流</strong>：插入虚假的分支和跳转</li><li><strong>函数分割</strong>：将函数拆分为多个片段</li></ul><h3 id="4-WASM（WebAssembly）"><a href="#4-WASM（WebAssembly）" class="headerlink" title="4. WASM（WebAssembly）"></a>4. WASM（WebAssembly）</h3><p><strong>WASM</strong>是一种低级的二进制指令格式，为Web应用提供接近原生的执行性能。</p><p><strong>核心特性</strong>：</p><ul><li><strong>跨平台执行</strong>：支持多种操作系统和架构</li><li><strong>高性能</strong>：接近原生代码的执行效率</li><li><strong>安全性</strong>：沙箱执行环境，内存安全</li><li><strong>可移植性</strong>：统一的二进制格式</li></ul><h3 id="5-技术对比图"><a href="#5-技术对比图" class="headerlink" title="5. 技术对比图"></a>5. 技术对比图</h3><pre class="mermaid">graph TB    A[代码保护技术] --> B[VMP虚拟机保护]    A --> C[JSVMP JS保护]    A --> D[OLLVM编译混淆]    A --> E[WASM字节码]        B --> F[运行时保护]    B --> G[动态解密]    B --> H[反调试机制]        C --> I[JS虚拟机]    C --> J[字节码转换]    C --> K[浏览器反调试]        D --> L[编译时混淆]    D --> M[控制流平坦化]    D --> N[指令替换]        E --> O[静态编译]    E --> P[沙箱执行]    E --> Q[跨平台支持]        R[保护强度] --> S[VMP: 高]    R --> T[JSVMP: 高]    R --> U[OLLVM: 中]    R --> V[WASM: 中]        W[性能开销] --> X[VMP: 高]    W --> Y[JSVMP: 中]    W --> Z[OLLVM: 低]    W --> AA[WASM: 低]</pre><h2 id="二、VMP与JSVMP技术原理"><a href="#二、VMP与JSVMP技术原理" class="headerlink" title="二、VMP与JSVMP技术原理"></a>二、VMP与JSVMP技术原理</h2><h3 id="1-VMP虚拟机架构"><a href="#1-VMP虚拟机架构" class="headerlink" title="1. VMP虚拟机架构"></a>1. VMP虚拟机架构</h3><p>VMP采用自定义的虚拟机架构，将原始指令转换为虚拟机字节码执行。</p><h4 id="a-VMP虚拟机架构图"><a href="#a-VMP虚拟机架构图" class="headerlink" title="a. VMP虚拟机架构图"></a>a. VMP虚拟机架构图</h4><pre class="mermaid">sequenceDiagram    participant App as 原始应用    participant VMP as VMP保护器    participant VM as 虚拟机引擎    participant Memory as 虚拟内存        App->>VMP: 加载受保护代码    VMP->>VM: 初始化虚拟机    VMP->>Memory: 分配虚拟内存空间        App->>VM: 调用受保护函数    VM->>VM: 解析虚拟机字节码    VM->>Memory: 访问虚拟寄存器    VM->>VM: 执行虚拟机指令    VM->>App: 返回执行结果        Note over VM: 虚拟机指令集    VM->>VM: MOV, ADD, SUB, JMP等    VM->>VM: CALL, RET, PUSH, POP等</pre><p><strong>虚拟机组件</strong>：</p><ul><li><strong>指令解码器</strong>：解析虚拟机字节码</li><li><strong>寄存器模拟</strong>：模拟CPU寄存器</li><li><strong>内存管理</strong>：管理虚拟内存空间</li><li><strong>执行引擎</strong>：执行虚拟机指令</li></ul><h3 id="2-JSVMP虚拟机架构"><a href="#2-JSVMP虚拟机架构" class="headerlink" title="2. JSVMP虚拟机架构"></a>2. JSVMP虚拟机架构</h3><p>JSVMP专门为JavaScript代码设计，将JS代码转换为自定义的虚拟机字节码执行。</p><h4 id="a-JSVMP虚拟机架构图"><a href="#a-JSVMP虚拟机架构图" class="headerlink" title="a. JSVMP虚拟机架构图"></a>a. JSVMP虚拟机架构图</h4><pre class="mermaid">sequenceDiagram    participant JS as JavaScript代码    participant Parser as JS解析器    participant VM as JSVMP虚拟机    participant Browser as 浏览器环境        JS->>Parser: 解析JavaScript代码    Parser->>VM: 转换为虚拟机字节码    VM->>Browser: 初始化浏览器环境        Browser->>VM: 调用受保护函数    VM->>VM: 解析虚拟机字节码    VM->>VM: 执行虚拟机指令    VM->>Browser: 返回执行结果        Note over VM: JSVMP指令集    VM->>VM: LOAD, STORE, CALL等    VM->>VM: ADD, SUB, MUL, DIV等    VM->>VM: JMP, JZ, JNZ等</pre><p><strong>JSVMP组件</strong>：</p><ul><li><strong>JS解析器</strong>：解析JavaScript代码</li><li><strong>字节码生成器</strong>：生成虚拟机字节码</li><li><strong>虚拟机引擎</strong>：执行字节码指令</li><li><strong>浏览器接口</strong>：与浏览器环境交互</li></ul><h3 id="3-VMP保护机制"><a href="#3-VMP保护机制" class="headerlink" title="3. VMP保护机制"></a>3. VMP保护机制</h3><h4 id="a-代码加密流程"><a href="#a-代码加密流程" class="headerlink" title="a. 代码加密流程"></a>a. 代码加密流程</h4><pre class="mermaid">flowchart TD    A[原始代码] --> B[指令分析]    B --> C[虚拟机指令转换]    C --> D[字节码生成]    D --> E[加密处理]    E --> F[完整性校验]    F --> G[保护后代码]        H[运行时] --> I[动态解密]    I --> J[虚拟机执行]    J --> K[结果返回]        L[反调试检测] --> M[调试器检测]    L --> N[断点检测]    L --> O[内存检测]</pre><p><strong>保护特点</strong>：</p><ul><li><strong>动态解密</strong>：代码在运行时才解密</li><li><strong>完整性校验</strong>：检测代码是否被修改</li><li><strong>反调试</strong>：检测调试器存在</li><li><strong>时间检测</strong>：检测执行时间异常</li></ul><h3 id="4-JSVMP保护机制"><a href="#4-JSVMP保护机制" class="headerlink" title="4. JSVMP保护机制"></a>4. JSVMP保护机制</h3><h4 id="a-JSVMP保护流程"><a href="#a-JSVMP保护流程" class="headerlink" title="a. JSVMP保护流程"></a>a. JSVMP保护流程</h4><pre class="mermaid">flowchart TD    A[JavaScript代码] --> B[语法分析]    B --> C[字节码生成]    C --> D[代码混淆]    D --> E[反调试注入]    E --> F[保护后代码]        G[浏览器执行] --> H[虚拟机初始化]    H --> I[字节码解析]    I --> J[指令执行]    J --> K[结果返回]        L[反调试检测] --> M[DevTools检测]    L --> N[断点检测]    L --> O[时间检测]</pre><p><strong>JSVMP保护特点</strong>：</p><ul><li><strong>字节码保护</strong>：将JS代码转换为虚拟机字节码</li><li><strong>反调试检测</strong>：检测浏览器开发者工具</li><li><strong>代码混淆</strong>：结合传统JS混淆技术</li><li><strong>动态执行</strong>：运行时解析和执行字节码</li></ul><h3 id="5-VMP工作机制和原理"><a href="#5-VMP工作机制和原理" class="headerlink" title="5. VMP工作机制和原理"></a>5. VMP工作机制和原理</h3><h4 id="a-VMP伪代码示例"><a href="#a-VMP伪代码示例" class="headerlink" title="a. VMP伪代码示例"></a>a. VMP伪代码示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VMP虚拟机核心伪代码</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VMPVirtualMachine</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">uint8_t</span>* bytecode;           <span class="comment">// 虚拟机字节码</span></span><br><span class="line">    <span class="type">uint32_t</span>* registers;         <span class="comment">// 虚拟寄存器</span></span><br><span class="line">    <span class="type">uint8_t</span>* memory;             <span class="comment">// 虚拟内存</span></span><br><span class="line">    <span class="type">bool</span> isDebuggerPresent;      <span class="comment">// 反调试标志</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 初始化虚拟机</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 反调试检测</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">detectDebugger</span>()) &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 分配虚拟内存</span></span><br><span class="line">        memory = <span class="built_in">malloc</span>(VM_MEMORY_SIZE);</span><br><span class="line">        registers = <span class="built_in">malloc</span>(VM_REGISTER_COUNT * <span class="number">4</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解密字节码</span></span><br><span class="line">        bytecode = <span class="built_in">decryptBytecode</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行虚拟机指令</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">uint32_t</span> pc = <span class="number">0</span>;  <span class="comment">// 程序计数器</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (pc &lt; bytecodeSize) &#123;</span><br><span class="line">            <span class="comment">// 反调试检测</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">detectDebugger</span>()) &#123;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 解析指令</span></span><br><span class="line">            <span class="type">uint8_t</span> opcode = bytecode[pc++];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">                <span class="keyword">case</span> VM_LOAD:</span><br><span class="line">                    <span class="comment">// LOAD指令：加载数据到寄存器</span></span><br><span class="line">                    <span class="type">uint32_t</span> reg = bytecode[pc++];</span><br><span class="line">                    <span class="type">uint32_t</span> value = *(<span class="type">uint32_t</span>*)(bytecode + pc);</span><br><span class="line">                    registers[reg] = value;</span><br><span class="line">                    pc += <span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> VM_ADD:</span><br><span class="line">                    <span class="comment">// ADD指令：寄存器相加</span></span><br><span class="line">                    <span class="type">uint32_t</span> reg1 = bytecode[pc++];</span><br><span class="line">                    <span class="type">uint32_t</span> reg2 = bytecode[pc++];</span><br><span class="line">                    <span class="type">uint32_t</span> reg3 = bytecode[pc++];</span><br><span class="line">                    registers[reg3] = registers[reg1] + registers[reg2];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> VM_CALL:</span><br><span class="line">                    <span class="comment">// CALL指令：调用函数</span></span><br><span class="line">                    <span class="type">uint32_t</span> funcAddr = *(<span class="type">uint32_t</span>*)(bytecode + pc);</span><br><span class="line">                    <span class="built_in">callFunction</span>(funcAddr);</span><br><span class="line">                    pc += <span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> VM_RET:</span><br><span class="line">                    <span class="comment">// RET指令：返回</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 反调试检测</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">detectDebugger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 检测调试器</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">IsDebuggerPresent</span>()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测断点</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">checkBreakpoints</span>()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 时间检测</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">checkTiming</span>()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="b-VMP保护示例"><a href="#b-VMP保护示例" class="headerlink" title="b. VMP保护示例"></a>b. VMP保护示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始函数</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">calculateSum</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VMP保护后的伪代码</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">protected_calculateSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    VMPVirtualMachine vm;</span><br><span class="line">    vm.<span class="built_in">init</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 虚拟机字节码（伪代码）</span></span><br><span class="line">    <span class="type">uint8_t</span> bytecode[] = &#123;</span><br><span class="line">        VM_LOAD, <span class="number">0</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0A</span>,  <span class="comment">// 加载参数a到寄存器0</span></span><br><span class="line">        VM_LOAD, <span class="number">1</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x14</span>,  <span class="comment">// 加载参数b到寄存器1</span></span><br><span class="line">        VM_ADD, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>,                      <span class="comment">// 寄存器0+寄存器1，结果存到寄存器2</span></span><br><span class="line">        VM_RET                                <span class="comment">// 返回</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    vm.<span class="built_in">setBytecode</span>(bytecode);</span><br><span class="line">    vm.<span class="built_in">execute</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取结果</span></span><br><span class="line">    <span class="type">int</span> result = vm.<span class="built_in">getRegister</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始C++代码</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">calculateSum</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VMP保护后的伪代码</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">protected_calculateSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 虚拟机初始化</span></span><br><span class="line">    VMContext vm;</span><br><span class="line">    vm.<span class="built_in">init</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 动态解密字节码</span></span><br><span class="line">    <span class="type">uint8_t</span>* bytecode = <span class="built_in">decrypt_bytecode</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 虚拟机执行</span></span><br><span class="line">    vm.<span class="built_in">execute</span>(bytecode);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理痕迹</span></span><br><span class="line">    vm.<span class="built_in">cleanup</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="三、OLLVM技术原理"><a href="#三、OLLVM技术原理" class="headerlink" title="三、OLLVM技术原理"></a>三、OLLVM技术原理</h2><h3 id="1-编译时混淆"><a href="#1-编译时混淆" class="headerlink" title="1. 编译时混淆"></a>1. 编译时混淆</h3><p>OLLVM在LLVM编译过程中对代码进行混淆处理，不改变程序功能的前提下增加逆向难度。</p><h4 id="a-OLLVM混淆流程"><a href="#a-OLLVM混淆流程" class="headerlink" title="a. OLLVM混淆流程"></a>a. OLLVM混淆流程</h4><pre class="mermaid">graph LR    A[源代码] --> B[LLVM IR]    B --> C[混淆Pass]    C --> D[混淆后IR]    D --> E[目标代码]        F[混淆技术] --> G[控制流平坦化]    F --> H[指令替换]    F --> I[虚假控制流]    F --> J[函数分割]        G --> K[Switch-Case结构]    H --> L[复杂指令替换]    I --> M[虚假分支插入]    J --> N[函数片段化]</pre><p><strong>混淆Pass</strong>：</p><ul><li><strong>Flattening Pass</strong>：控制流平坦化</li><li><strong>Substitution Pass</strong>：指令替换</li><li><strong>Bogus Control Flow</strong>：虚假控制流</li><li><strong>Function Splitting</strong>：函数分割</li></ul><h3 id="2-控制流平坦化"><a href="#2-控制流平坦化" class="headerlink" title="2. 控制流平坦化"></a>2. 控制流平坦化</h3><h4 id="a-控制流平坦化原理"><a href="#a-控制流平坦化原理" class="headerlink" title="a. 控制流平坦化原理"></a>a. 控制流平坦化原理</h4><pre class="mermaid">flowchart TD    A[原始控制流] --> B[复杂分支结构]    B --> C[条件判断]    C --> D[多个执行路径]        E[平坦化后] --> F[Switch-Case结构]    F --> G[状态变量控制]    G --> H[统一执行流程]        I[状态机] --> J[状态0: 初始化]    I --> K[状态1: 处理A]    I --> L[状态2: 处理B]    I --> M[状态3: 结束]</pre><p><strong>平坦化特点</strong>：</p><ul><li><strong>统一入口</strong>：所有代码块通过统一入口</li><li><strong>状态控制</strong>：使用状态变量控制执行流程</li><li><strong>跳转表</strong>：使用Switch-Case实现跳转</li><li><strong>复杂度增加</strong>：大幅增加逆向分析难度</li></ul><h3 id="6-JSVMP工作机制和原理"><a href="#6-JSVMP工作机制和原理" class="headerlink" title="6. JSVMP工作机制和原理"></a>6. JSVMP工作机制和原理</h3><h4 id="a-JSVMP保护流程-1"><a href="#a-JSVMP保护流程-1" class="headerlink" title="a. JSVMP保护流程"></a>a. JSVMP保护流程</h4><pre class="mermaid">flowchart TD    A[JavaScript代码] --> B[语法分析]    B --> C[AST生成]    C --> D[字节码生成]    D --> E[代码混淆]    E --> F[反调试注入]    F --> G[保护后代码]        H[浏览器执行] --> I[虚拟机初始化]    I --> J[字节码解析]    J --> K[指令执行]    K --> L[结果返回]        M[反调试检测] --> N[DevTools检测]    M --> O[断点检测]    M --> P[时间检测]</pre><h4 id="b-JSVMP伪代码示例"><a href="#b-JSVMP伪代码示例" class="headerlink" title="b. JSVMP伪代码示例"></a>b. JSVMP伪代码示例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSVMP虚拟机核心伪代码</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JSVMPVirtualMachine</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bytecode</span> = <span class="literal">null</span>;        <span class="comment">// 虚拟机字节码</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stack</span> = [];             <span class="comment">// 执行栈</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">registers</span> = &#123;&#125;;         <span class="comment">// 虚拟寄存器</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">globalScope</span> = &#123;&#125;;       <span class="comment">// 全局作用域</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isDebuggerPresent</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化虚拟机</span></span><br><span class="line">    <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 反调试检测</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">detectDebugger</span>()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Debugger detected&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化执行环境</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setupEnvironment</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解密字节码</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bytecode</span> = <span class="variable language_">this</span>.<span class="title function_">decryptBytecode</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行虚拟机指令</span></span><br><span class="line">    <span class="title function_">execute</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> pc = <span class="number">0</span>;  <span class="comment">// 程序计数器</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (pc &lt; <span class="variable language_">this</span>.<span class="property">bytecode</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="comment">// 反调试检测</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">detectDebugger</span>()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Debugger detected&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 解析指令</span></span><br><span class="line">            <span class="keyword">const</span> opcode = <span class="variable language_">this</span>.<span class="property">bytecode</span>[pc++];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="attr">JSVM_LOAD_CONST</span>:</span><br><span class="line">                    <span class="comment">// 加载常量到栈</span></span><br><span class="line">                    <span class="keyword">const</span> constIndex = <span class="variable language_">this</span>.<span class="property">bytecode</span>[pc++];</span><br><span class="line">                    <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="property">constants</span>[constIndex];</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">push</span>(value);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="attr">JSVM_LOAD_VAR</span>:</span><br><span class="line">                    <span class="comment">// 加载变量到栈</span></span><br><span class="line">                    <span class="keyword">const</span> varName = <span class="variable language_">this</span>.<span class="property">bytecode</span>[pc++];</span><br><span class="line">                    <span class="keyword">const</span> varValue = <span class="variable language_">this</span>.<span class="title function_">getVariable</span>(varName);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">push</span>(varValue);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="attr">JSVM_ADD</span>:</span><br><span class="line">                    <span class="comment">// 栈顶两个值相加</span></span><br><span class="line">                    <span class="keyword">const</span> b = <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">pop</span>();</span><br><span class="line">                    <span class="keyword">const</span> a = <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">pop</span>();</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">push</span>(a + b);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="attr">JSVM_CALL</span>:</span><br><span class="line">                    <span class="comment">// 调用函数</span></span><br><span class="line">                    <span class="keyword">const</span> funcName = <span class="variable language_">this</span>.<span class="property">bytecode</span>[pc++];</span><br><span class="line">                    <span class="keyword">const</span> argCount = <span class="variable language_">this</span>.<span class="property">bytecode</span>[pc++];</span><br><span class="line">                    <span class="keyword">const</span> args = [];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; argCount; i++) &#123;</span><br><span class="line">                        args.<span class="title function_">unshift</span>(<span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">pop</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">callFunction</span>(funcName, args);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">push</span>(result);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="attr">JSVM_RETURN</span>:</span><br><span class="line">                    <span class="comment">// 返回</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 反调试检测</span></span><br><span class="line">    <span class="title function_">detectDebugger</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 检测开发者工具</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">outerHeight</span> - <span class="variable language_">window</span>.<span class="property">innerHeight</span> &gt; <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测断点</span></span><br><span class="line">        <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">        <span class="keyword">debugger</span>;</span><br><span class="line">        <span class="keyword">const</span> end = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">        <span class="keyword">if</span> (end - start &gt; <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测控制台</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">console</span> &amp;&amp; <span class="variable language_">window</span>.<span class="property">console</span>.<span class="property">clear</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用函数</span></span><br><span class="line">    <span class="title function_">callFunction</span>(<span class="params">name, args</span>) &#123;</span><br><span class="line">        <span class="comment">// 模拟函数调用</span></span><br><span class="line">        <span class="keyword">switch</span> (name) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;console.log&#x27;</span>:</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(...args);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;Math.max&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">max</span>(...args);</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">globalScope</span>[name](...args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="c-JSVMP保护示例"><a href="#c-JSVMP保护示例" class="headerlink" title="c. JSVMP保护示例"></a>c. JSVMP保护示例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始JavaScript代码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">calculateSum</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSVMP保护后的伪代码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">protected_calculateSum</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">JSVMPVirtualMachine</span>();</span><br><span class="line">    vm.<span class="title function_">init</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 虚拟机字节码（伪代码）</span></span><br><span class="line">    <span class="keyword">const</span> bytecode = [</span><br><span class="line">        <span class="variable constant_">JSVM_LOAD_VAR</span>, <span class="string">&#x27;a&#x27;</span>,           <span class="comment">// 加载变量a到栈</span></span><br><span class="line">        <span class="variable constant_">JSVM_LOAD_VAR</span>, <span class="string">&#x27;b&#x27;</span>,           <span class="comment">// 加载变量b到栈</span></span><br><span class="line">        <span class="variable constant_">JSVM_ADD</span>,                     <span class="comment">// 栈顶两个值相加</span></span><br><span class="line">        <span class="variable constant_">JSVM_RETURN</span>                   <span class="comment">// 返回结果</span></span><br><span class="line">    ];</span><br><span class="line">    </span><br><span class="line">    vm.<span class="title function_">setBytecode</span>(bytecode);</span><br><span class="line">    <span class="keyword">return</span> vm.<span class="title function_">execute</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-OLLVM工作机制和原理"><a href="#7-OLLVM工作机制和原理" class="headerlink" title="7. OLLVM工作机制和原理"></a>7. OLLVM工作机制和原理</h3><h4 id="a-控制流平坦化原理-1"><a href="#a-控制流平坦化原理-1" class="headerlink" title="a. 控制流平坦化原理"></a>a. 控制流平坦化原理</h4><pre class="mermaid">flowchart TD    A[原始控制流] --> B[复杂分支结构]    B --> C[条件判断]    C --> D[多个执行路径]        E[平坦化后] --> F[Switch-Case结构]    F --> G[状态变量控制]    G --> H[统一执行流程]        I[状态机] --> J[状态0: 初始化]    I --> K[状态1: 处理A]    I --> L[状态2: 处理B]    I --> M[状态3: 结束]</pre><h4 id="b-OLLVM伪代码示例"><a href="#b-OLLVM伪代码示例" class="headerlink" title="b. OLLVM伪代码示例"></a>b. OLLVM伪代码示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OLLVM控制流平坦化伪代码</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OLLVMFlattener</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> state;              <span class="comment">// 状态变量</span></span><br><span class="line">    <span class="type">int</span>* stateTable;        <span class="comment">// 状态跳转表</span></span><br><span class="line">    <span class="type">bool</span>* conditionFlags;   <span class="comment">// 条件标志</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 原始函数</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">originalFunction</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (y &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> x + y;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> x - y;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 平坦化后的函数</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">flattenedFunction</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">        state = <span class="number">0</span>;  <span class="comment">// 初始状态</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:  <span class="comment">// 初始化状态</span></span><br><span class="line">                    state = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:  <span class="comment">// 检查 x &gt; 0</span></span><br><span class="line">                    <span class="keyword">if</span> (x &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        state = <span class="number">2</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        state = <span class="number">4</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:  <span class="comment">// 检查 y &gt; 0</span></span><br><span class="line">                    <span class="keyword">if</span> (y &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        state = <span class="number">3</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        state = <span class="number">5</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:  <span class="comment">// 返回 x + y</span></span><br><span class="line">                    <span class="keyword">return</span> x + y;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:  <span class="comment">// 返回 0</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:  <span class="comment">// 返回 x - y</span></span><br><span class="line">                    <span class="keyword">return</span> x - y;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 指令替换示例</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">instructionSubstitution</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 原始指令：return a + b;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 替换后的复杂指令</span></span><br><span class="line">        <span class="type">int</span> temp1 = a;</span><br><span class="line">        <span class="type">int</span> temp2 = b;</span><br><span class="line">        <span class="type">int</span> temp3 = temp1 ^ temp2;</span><br><span class="line">        <span class="type">int</span> temp4 = temp1 &amp; temp2;</span><br><span class="line">        <span class="type">int</span> temp5 = temp4 &lt;&lt; <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> result = temp3 ^ temp5;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;  <span class="comment">// 等价于 a + b</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 虚假控制流示例</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">bogusControlFlow</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> dummy = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 虚假分支1</span></span><br><span class="line">        <span class="keyword">if</span> (dummy == <span class="number">0</span>) &#123;</span><br><span class="line">            dummy = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dummy = <span class="number">0</span>;  <span class="comment">// 永远不会执行</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 真实逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (x &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            result = x * <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 虚假分支2</span></span><br><span class="line">        <span class="keyword">if</span> (dummy == <span class="number">1</span>) &#123;</span><br><span class="line">            dummy = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dummy = <span class="number">1</span>;  <span class="comment">// 永远不会执行</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="c-OLLVM混淆示例"><a href="#c-OLLVM混淆示例" class="headerlink" title="c. OLLVM混淆示例"></a>c. OLLVM混淆示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始代码</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">checkPassword</span><span class="params">(<span class="type">char</span>* input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(input) &lt; <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input, <span class="string">&quot;password123&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OLLVM混淆后（伪代码）</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">obfuscated_checkPassword</span><span class="params">(<span class="type">char</span>* input)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> state = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:  <span class="comment">// 初始化</span></span><br><span class="line">                state = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:  <span class="comment">// 检查长度</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(input) &lt; <span class="number">8</span>) &#123;</span><br><span class="line">                    state = <span class="number">4</span>;  <span class="comment">// 失败</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    state = <span class="number">2</span>;  <span class="comment">// 继续检查</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:  <span class="comment">// 检查密码</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input, <span class="string">&quot;password123&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    state = <span class="number">3</span>;  <span class="comment">// 成功</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    state = <span class="number">4</span>;  <span class="comment">// 失败</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:  <span class="comment">// 返回成功</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:  <span class="comment">// 返回失败</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译命令</span></span><br><span class="line">clang -mllvm -fla -mllvm -sub -mllvm -bcf source.c -o obfuscated</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># -fla: 控制流平坦化</span></span><br><span class="line"><span class="comment"># -sub: 指令替换</span></span><br><span class="line"><span class="comment"># -bcf: 虚假控制流</span></span><br></pre></td></tr></table></figure><h4 id="b-混淆前后对比"><a href="#b-混淆前后对比" class="headerlink" title="b. 混淆前后对比"></a>b. 混淆前后对比</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始代码</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">checkPassword</span><span class="params">(<span class="type">char</span>* input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(input) &lt; <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input, <span class="string">&quot;password123&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OLLVM混淆后（伪代码）</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">checkPassword</span><span class="params">(<span class="type">char</span>* input)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> state = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(input) &lt; <span class="number">8</span>) &#123;</span><br><span class="line">                    state = <span class="number">3</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    state = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input, <span class="string">&quot;password123&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    state = <span class="number">2</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    state = <span class="number">3</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="四、WASM技术原理"><a href="#四、WASM技术原理" class="headerlink" title="四、WASM技术原理"></a>四、WASM技术原理</h2><h3 id="1-WebAssembly架构"><a href="#1-WebAssembly架构" class="headerlink" title="1. WebAssembly架构"></a>1. WebAssembly架构</h3><p>WASM采用栈式虚拟机架构，提供高效的二进制指令格式。</p><h4 id="a-WASM执行架构"><a href="#a-WASM执行架构" class="headerlink" title="a. WASM执行架构"></a>a. WASM执行架构</h4><pre class="mermaid">graph TB    A[WASM模块] --> B[二进制格式]    B --> C[验证器]    C --> D[编译器]    D --> E[机器码]        F[执行环境] --> G[JavaScript引擎]    F --> H[WASM运行时]    F --> I[系统API]        G --> J[V8引擎]    G --> K[SpiderMonkey]    G --> L[JavaScriptCore]        H --> M[线性内存]    H --> N[函数表]    H --> O[全局变量]</pre><p><strong>WASM组件</strong>：</p><ul><li><strong>模块系统</strong>：独立的编译单元</li><li><strong>线性内存</strong>：连续的内存空间</li><li><strong>函数表</strong>：间接函数调用</li><li><strong>导入导出</strong>：与宿主环境交互</li></ul><h3 id="2-安全特性"><a href="#2-安全特性" class="headerlink" title="2. 安全特性"></a>2. 安全特性</h3><h4 id="a-WASM安全模型"><a href="#a-WASM安全模型" class="headerlink" title="a. WASM安全模型"></a>a. WASM安全模型</h4><pre class="mermaid">flowchart TD    A[WASM安全模型] --> B[内存安全]    A --> C[控制流完整性]    A --> D[沙箱隔离]        B --> E[边界检查]    B --> F[类型安全]    B --> G[空指针检查]        C --> H[间接调用验证]    C --> I[返回地址保护]    C --> J[栈溢出保护]        D --> K[系统调用限制]    D --> L[文件访问控制]    D --> M[网络访问限制]</pre><p><strong>安全特点</strong>：</p><ul><li><strong>内存安全</strong>：防止缓冲区溢出</li><li><strong>控制流完整性</strong>：防止ROP攻击</li><li><strong>沙箱隔离</strong>：限制系统访问</li><li><strong>类型安全</strong>：严格的类型检查</li></ul><h3 id="8-WASM工作机制和原理"><a href="#8-WASM工作机制和原理" class="headerlink" title="8. WASM工作机制和原理"></a>8. WASM工作机制和原理</h3><h4 id="a-WASM执行架构-1"><a href="#a-WASM执行架构-1" class="headerlink" title="a. WASM执行架构"></a>a. WASM执行架构</h4><pre class="mermaid">graph TB    A[WASM模块] --> B[二进制格式]    B --> C[验证器]    C --> D[编译器]    D --> E[机器码]        F[执行环境] --> G[JavaScript引擎]    F --> H[WASM运行时]    F --> I[系统API]        G --> J[V8引擎]    G --> K[SpiderMonkey]    G --> L[JavaScriptCore]        H --> M[线性内存]    H --> N[函数表]    H --> O[全局变量]</pre><h4 id="b-WASM伪代码示例"><a href="#b-WASM伪代码示例" class="headerlink" title="b. WASM伪代码示例"></a>b. WASM伪代码示例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WASM虚拟机核心伪代码</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WASMVirtualMachine</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">memory</span> = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">1024</span> * <span class="number">1024</span>);  <span class="comment">// 1MB线性内存</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stack</span> = [];                              <span class="comment">// 执行栈</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">globals</span> = &#123;&#125;;                            <span class="comment">// 全局变量</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">functions</span> = [];                          <span class="comment">// 函数表</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pc</span> = <span class="number">0</span>;                                  <span class="comment">// 程序计数器</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载WASM模块</span></span><br><span class="line">    <span class="title function_">loadModule</span>(<span class="params">wasmBytes</span>) &#123;</span><br><span class="line">        <span class="comment">// 解析WASM二进制格式</span></span><br><span class="line">        <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="variable language_">this</span>.<span class="title function_">parseWASM</span>(wasmBytes);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 验证模块</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="title function_">validateModule</span>(<span class="variable language_">module</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Invalid WASM module&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化模块</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">initializeModule</span>(<span class="variable language_">module</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行WASM指令</span></span><br><span class="line">    <span class="title function_">execute</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="variable language_">this</span>.<span class="property">pc</span> &lt; <span class="variable language_">this</span>.<span class="property">instructions</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> instruction = <span class="variable language_">this</span>.<span class="property">instructions</span>[<span class="variable language_">this</span>.<span class="property">pc</span>++];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (instruction.<span class="property">opcode</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;i32.const&#x27;</span>:</span><br><span class="line">                    <span class="comment">// 加载32位整数常量</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">push</span>(instruction.<span class="property">value</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;i32.add&#x27;</span>:</span><br><span class="line">                    <span class="comment">// 32位整数相加</span></span><br><span class="line">                    <span class="keyword">const</span> b = <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">pop</span>();</span><br><span class="line">                    <span class="keyword">const</span> a = <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">pop</span>();</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">push</span>(a + b);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;local.get&#x27;</span>:</span><br><span class="line">                    <span class="comment">// 获取局部变量</span></span><br><span class="line">                    <span class="keyword">const</span> localIndex = instruction.<span class="property">index</span>;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">locals</span>[localIndex]);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;local.set&#x27;</span>:</span><br><span class="line">                    <span class="comment">// 设置局部变量</span></span><br><span class="line">                    <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">pop</span>();</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">locals</span>[instruction.<span class="property">index</span>] = value;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;call&#x27;</span>:</span><br><span class="line">                    <span class="comment">// 调用函数</span></span><br><span class="line">                    <span class="keyword">const</span> funcIndex = instruction.<span class="property">index</span>;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">callFunction</span>(funcIndex);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;return&#x27;</span>:</span><br><span class="line">                    <span class="comment">// 返回</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用函数</span></span><br><span class="line">    <span class="title function_">callFunction</span>(<span class="params">index</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> func = <span class="variable language_">this</span>.<span class="property">functions</span>[index];</span><br><span class="line">        <span class="keyword">const</span> args = [];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取参数</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; func.<span class="property">paramCount</span>; i++) &#123;</span><br><span class="line">            args.<span class="title function_">unshift</span>(<span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">pop</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行函数</span></span><br><span class="line">        <span class="keyword">const</span> result = func.<span class="title function_">execute</span>(args);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回结果</span></span><br><span class="line">        <span class="keyword">if</span> (result !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">stack</span>.<span class="title function_">push</span>(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内存操作</span></span><br><span class="line">    <span class="title function_">loadMemory</span>(<span class="params">offset, type</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(<span class="variable language_">this</span>.<span class="property">memory</span>);</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;i32&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> view.<span class="title function_">getInt32</span>(offset, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;f32&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> view.<span class="title function_">getFloat32</span>(offset, <span class="literal">true</span>);</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Unsupported type&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">storeMemory</span>(<span class="params">offset, value, type</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(<span class="variable language_">this</span>.<span class="property">memory</span>);</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;i32&#x27;</span>:</span><br><span class="line">                view.<span class="title function_">setInt32</span>(offset, value, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;f32&#x27;</span>:</span><br><span class="line">                view.<span class="title function_">setFloat32</span>(offset, value, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Unsupported type&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="c-WASM保护示例"><a href="#c-WASM保护示例" class="headerlink" title="c. WASM保护示例"></a>c. WASM保护示例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始JavaScript代码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fibonacci</span>(<span class="params">n</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">1</span>) <span class="keyword">return</span> n;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fibonacci</span>(n - <span class="number">1</span>) + <span class="title function_">fibonacci</span>(n - <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WASM保护后的伪代码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">protected_fibonacci</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">WASMVirtualMachine</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// WASM字节码（伪代码）</span></span><br><span class="line">    <span class="keyword">const</span> wasmBytes = [</span><br><span class="line">        <span class="comment">// 函数定义</span></span><br><span class="line">        &#123; <span class="attr">type</span>: <span class="string">&#x27;func&#x27;</span>, <span class="attr">params</span>: [<span class="string">&#x27;i32&#x27;</span>], <span class="attr">returns</span>: [<span class="string">&#x27;i32&#x27;</span>] &#125;,</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 指令序列</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;local.get&#x27;</span>, <span class="attr">index</span>: <span class="number">0</span> &#125;,      <span class="comment">// 获取参数n</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;i32.const&#x27;</span>, <span class="attr">value</span>: <span class="number">1</span> &#125;,      <span class="comment">// 加载常量1</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;i32.le_s&#x27;</span> &#125;,                 <span class="comment">// n &lt;= 1</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;if&#x27;</span>, <span class="attr">result</span>: <span class="string">&#x27;i32&#x27;</span> &#125;,        <span class="comment">// 条件判断</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;local.get&#x27;</span>, <span class="attr">index</span>: <span class="number">0</span> &#125;,      <span class="comment">// 获取参数n</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;return&#x27;</span> &#125;,                   <span class="comment">// 返回n</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;else&#x27;</span> &#125;,                     <span class="comment">// else分支</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;local.get&#x27;</span>, <span class="attr">index</span>: <span class="number">0</span> &#125;,      <span class="comment">// 获取参数n</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;i32.const&#x27;</span>, <span class="attr">value</span>: <span class="number">1</span> &#125;,      <span class="comment">// 加载常量1</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;i32.sub&#x27;</span> &#125;,                  <span class="comment">// n - 1</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;call&#x27;</span>, <span class="attr">index</span>: <span class="number">0</span> &#125;,           <span class="comment">// 递归调用</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;local.get&#x27;</span>, <span class="attr">index</span>: <span class="number">0</span> &#125;,      <span class="comment">// 获取参数n</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;i32.const&#x27;</span>, <span class="attr">value</span>: <span class="number">2</span> &#125;,      <span class="comment">// 加载常量2</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;i32.sub&#x27;</span> &#125;,                  <span class="comment">// n - 2</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;call&#x27;</span>, <span class="attr">index</span>: <span class="number">0</span> &#125;,           <span class="comment">// 递归调用</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;i32.add&#x27;</span> &#125;,                  <span class="comment">// 相加</span></span><br><span class="line">        &#123; <span class="attr">opcode</span>: <span class="string">&#x27;end&#x27;</span> &#125;                       <span class="comment">// 结束if</span></span><br><span class="line">    ];</span><br><span class="line">    </span><br><span class="line">    vm.<span class="title function_">loadModule</span>(wasmBytes);</span><br><span class="line">    <span class="keyword">return</span> vm.<span class="title function_">execute</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C++源代码</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;emscripten.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    <span class="function">EMSCRIPTEN_KEEPALIVE</span></span><br><span class="line"><span class="function">    <span class="type">int</span> <span class="title">fibonacci</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">1</span>) <span class="keyword">return</span> n;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">fibonacci</span>(n - <span class="number">1</span>) + <span class="built_in">fibonacci</span>(n - <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译命令</span></span><br><span class="line">emcc fibonacci.cpp -o fibonacci.wasm -s EXPORTED_FUNCTIONS=<span class="string">&quot;[&#x27;_fibonacci&#x27;]&quot;</span></span><br></pre></td></tr></table></figure><h4 id="b-JavaScript调用WASM"><a href="#b-JavaScript调用WASM" class="headerlink" title="b. JavaScript调用WASM"></a>b. JavaScript调用WASM</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载WASM模块</span></span><br><span class="line"><span class="title class_">WebAssembly</span>.<span class="title function_">instantiateStreaming</span>(<span class="title function_">fetch</span>(<span class="string">&#x27;fibonacci.wasm&#x27;</span>))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">obj</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> fibonacci = obj.<span class="property">instance</span>.<span class="property">exports</span>.<span class="property">fibonacci</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fibonacci</span>(<span class="number">10</span>)); <span class="comment">// 输出: 55</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h2 id="五、VMP与JSVMP对比分析"><a href="#五、VMP与JSVMP对比分析" class="headerlink" title="五、VMP与JSVMP对比分析"></a>五、VMP与JSVMP对比分析</h2><h3 id="1-技术对比表"><a href="#1-技术对比表" class="headerlink" title="1. 技术对比表"></a>1. 技术对比表</h3><table><thead><tr><th>特性</th><th>VMP</th><th>JSVMP</th></tr></thead><tbody><tr><td>保护对象</td><td>原生代码(x86&#x2F;x64)</td><td>JavaScript代码</td></tr><tr><td>虚拟机架构</td><td>自定义虚拟机</td><td>JavaScript虚拟机</td></tr><tr><td>保护强度</td><td>极高</td><td>高</td></tr><tr><td>性能开销</td><td>高</td><td>中等</td></tr><tr><td>兼容性</td><td>中</td><td>高</td></tr><tr><td>学习成本</td><td>高</td><td>中</td></tr><tr><td>适用场景</td><td>桌面应用</td><td>Web应用</td></tr><tr><td>逆向难度</td><td>极高</td><td>高</td></tr></tbody></table><h3 id="2-选择建议"><a href="#2-选择建议" class="headerlink" title="2. 选择建议"></a>2. 选择建议</h3><h4 id="a-VMP适用场景"><a href="#a-VMP适用场景" class="headerlink" title="a. VMP适用场景"></a>a. VMP适用场景</h4><ul><li><strong>桌面应用保护</strong>：需要高强度保护的桌面软件</li><li><strong>游戏保护</strong>：需要防止外挂的游戏应用</li><li><strong>商业软件</strong>：需要保护核心算法的商业软件</li><li><strong>金融软件</strong>：需要高安全性的金融应用</li></ul><h4 id="b-JSVMP适用场景"><a href="#b-JSVMP适用场景" class="headerlink" title="b. JSVMP适用场景"></a>b. JSVMP适用场景</h4><ul><li><strong>Web应用保护</strong>：需要保护前端逻辑的Web应用</li><li><strong>在线游戏</strong>：需要防止外挂的在线游戏</li><li><strong>金融Web应用</strong>：需要保护交易逻辑的金融应用</li><li><strong>API保护</strong>：需要保护接口逻辑的Web服务</li></ul><h2 id="六、技术对比与选择"><a href="#六、技术对比与选择" class="headerlink" title="六、技术对比与选择"></a>六、技术对比与选择</h2><h3 id="1-技术对比表-1"><a href="#1-技术对比表-1" class="headerlink" title="1. 技术对比表"></a>1. 技术对比表</h3><table><thead><tr><th>特性</th><th>VMP</th><th>JSVMP</th><th>OLLVM</th><th>WASM</th></tr></thead><tbody><tr><td>保护强度</td><td>极高</td><td>高</td><td>中</td><td>中</td></tr><tr><td>性能开销</td><td>高</td><td>中</td><td>低</td><td>低</td></tr><tr><td>兼容性</td><td>中</td><td>高</td><td>高</td><td>高</td></tr><tr><td>学习成本</td><td>高</td><td>中</td><td>中</td><td>低</td></tr><tr><td>适用场景</td><td>桌面应用</td><td>Web应用</td><td>开源项目</td><td>Web应用</td></tr><tr><td>逆向难度</td><td>极高</td><td>高</td><td>高</td><td>中</td></tr></tbody></table><h3 id="2-选择建议-1"><a href="#2-选择建议-1" class="headerlink" title="2. 选择建议"></a>2. 选择建议</h3><h4 id="a-VMP适用场景-1"><a href="#a-VMP适用场景-1" class="headerlink" title="a. VMP适用场景"></a>a. VMP适用场景</h4><ul><li><strong>桌面应用保护</strong>：需要高强度保护的桌面软件</li><li><strong>游戏保护</strong>：需要防止外挂的游戏应用</li><li><strong>商业软件</strong>：需要保护核心算法的商业软件</li><li><strong>金融软件</strong>：需要高安全性的金融应用</li></ul><h4 id="b-JSVMP适用场景-1"><a href="#b-JSVMP适用场景-1" class="headerlink" title="b. JSVMP适用场景"></a>b. JSVMP适用场景</h4><ul><li><strong>Web应用保护</strong>：需要保护前端逻辑的Web应用</li><li><strong>在线游戏</strong>：需要防止外挂的在线游戏</li><li><strong>金融Web应用</strong>：需要保护交易逻辑的金融应用</li><li><strong>API保护</strong>：需要保护接口逻辑的Web服务</li></ul><h4 id="c-OLLVM适用场景"><a href="#c-OLLVM适用场景" class="headerlink" title="c. OLLVM适用场景"></a>c. OLLVM适用场景</h4><ul><li><strong>开源项目</strong>：需要免费混淆方案</li><li><strong>性能敏感</strong>：对性能要求较高的应用</li><li><strong>跨平台支持</strong>：需要支持多种平台</li></ul><h4 id="d-WASM适用场景"><a href="#d-WASM适用场景" class="headerlink" title="d. WASM适用场景"></a>d. WASM适用场景</h4><ul><li><strong>Web应用</strong>：需要在浏览器中运行高性能代码</li><li><strong>跨平台部署</strong>：需要统一的部署方案</li><li><strong>安全要求</strong>：需要沙箱执行环境</li></ul><h2 id="七、结语"><a href="#七、结语" class="headerlink" title="七、结语"></a>七、结语</h2><p><strong>核心价值</strong>：<br>VMP、JSVMP、OLLVM、WASM代表了现代代码保护技术的四个重要方向：原生代码虚拟机保护、JavaScript虚拟机保护、编译时混淆和字节码技术。每种技术都有其独特的优势和应用场景，选择合适的保护方案需要根据具体需求进行权衡。</p><p><strong>同类工具推荐</strong>：<br>在代码保护领域，还有Themida（商业保护）、UPX（压缩保护）、ASProtect（加密保护）等工具。VMP在原生代码虚拟机保护方面具有独特优势，JSVMP在JavaScript保护领域具有重要价值，OLLVM在开源混淆领域占据主导地位，WASM在Web安全方面具有重要价值。</p><p><strong>学习建议</strong>：<br>掌握这些技术需要深入理解底层原理，建议从简单的混淆技术开始，逐步学习更复杂的保护机制。同时要关注技术发展趋势，及时了解新的保护和解密技术。</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VMP </tag>
            
            <tag> JSVMP </tag>
            
            <tag> OLLVM </tag>
            
            <tag> WASM </tag>
            
            <tag> 技术解析 </tag>
            
            <tag> 虚拟机保护 </tag>
            
            <tag> 字节码混淆 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unidbg入门指南：Android Native代码模拟利器</title>
      <link href="/2025/09/26/article16_unidbg_introduction/"/>
      <url>/2025/09/26/article16_unidbg_introduction/</url>
      
        <content type="html"><![CDATA[<h2 id="一、Unidbg概述"><a href="#一、Unidbg概述" class="headerlink" title="一、Unidbg概述"></a>一、Unidbg概述</h2><h3 id="1-Unidbg介绍"><a href="#1-Unidbg介绍" class="headerlink" title="1. Unidbg介绍"></a>1. Unidbg介绍</h3><p><strong>Unidbg</strong>是一个基于Unicorn引擎的Android Native代码模拟框架，它能够在PC端模拟Android Native代码的执行环境，无需真实的Android设备即可运行和分析Native代码。</p><span id="more"></span><h3 id="2-核心特性"><a href="#2-核心特性" class="headerlink" title="2. 核心特性"></a>2. 核心特性</h3><ul><li><strong>跨平台支持</strong>：支持Windows、Linux、macOS等主流操作系统</li><li><strong>JNI模拟</strong>：完整模拟Android JNI接口，支持Java与Native代码交互</li><li><strong>系统调用模拟</strong>：模拟Android系统调用，提供完整的系统环境</li><li><strong>内存管理</strong>：提供虚拟内存管理，支持动态内存分配</li><li><strong>调试支持</strong>：内置调试功能，支持断点、单步执行等调试操作</li><li><strong>Hook机制</strong>：支持函数Hook，可以拦截和修改函数调用</li></ul><h3 id="3-Unidbg架构图"><a href="#3-Unidbg架构图" class="headerlink" title="3. Unidbg架构图"></a>3. Unidbg架构图</h3><pre class="mermaid">graph TB    A[Unidbg框架] --> B[Unicorn引擎]    A --> C[JNI模拟层]    A --> D[系统调用模拟]    A --> E[内存管理]    A --> F[调试器]        B --> G[ARM指令模拟]    B --> H[Thumb指令模拟]    B --> I[ARM64指令模拟]        C --> J[Java虚拟机接口]    C --> K[Native方法调用]    C --> L[对象引用管理]        D --> M[文件系统模拟]    D --> N[网络接口模拟]    D --> O[进程管理模拟]        E --> P[虚拟内存映射]    E --> Q[动态内存分配]    E --> R[内存保护机制]        F --> S[断点调试]    F --> T[单步执行]    F --> U[寄存器查看]        V[Android APK] --> W[提取Native库]    W --> X[加载到Unidbg]    X --> Y[执行Native代码]</pre><h2 id="二、核心原理剖析"><a href="#二、核心原理剖析" class="headerlink" title="二、核心原理剖析"></a>二、核心原理剖析</h2><h3 id="1-Unicorn引擎基础"><a href="#1-Unicorn引擎基础" class="headerlink" title="1. Unicorn引擎基础"></a>1. Unicorn引擎基础</h3><p>Unidbg基于Unicorn引擎构建，Unicorn是一个轻量级的多架构CPU模拟器框架。</p><h4 id="a-Unicorn引擎工作原理"><a href="#a-Unicorn引擎工作原理" class="headerlink" title="a. Unicorn引擎工作原理"></a>a. Unicorn引擎工作原理</h4><pre class="mermaid">sequenceDiagram    participant App as 应用程序    participant Unidbg as Unidbg框架    participant Unicorn as Unicorn引擎    participant Memory as 虚拟内存    participant CPU as CPU模拟器        App->>Unidbg: 加载Native库    Unidbg->>Unicorn: 初始化模拟器    Unidbg->>Memory: 分配虚拟内存    Unidbg->>CPU: 设置CPU架构(ARM/ARM64)        App->>Unidbg: 调用Native函数    Unidbg->>Unicorn: 执行指令    Unicorn->>CPU: 解析ARM指令    CPU->>Memory: 访问内存    Memory->>CPU: 返回数据    CPU->>Unicorn: 执行结果    Unicorn->>Unidbg: 返回执行状态    Unidbg->>App: 返回函数结果</pre><p><strong>核心组件</strong>：</p><ul><li><strong>CPU模拟器</strong>：模拟ARM&#x2F;ARM64指令集</li><li><strong>内存管理</strong>：提供虚拟内存空间</li><li><strong>寄存器模拟</strong>：模拟CPU寄存器状态</li><li><strong>异常处理</strong>：处理指令执行异常</li></ul><h3 id="2-JNI模拟机制"><a href="#2-JNI模拟机制" class="headerlink" title="2. JNI模拟机制"></a>2. JNI模拟机制</h3><p>JNI（Java Native Interface）是Java与Native代码交互的桥梁，Unidbg需要完整模拟JNI环境。</p><h4 id="a-JNI模拟架构"><a href="#a-JNI模拟架构" class="headerlink" title="a. JNI模拟架构"></a>a. JNI模拟架构</h4><pre class="mermaid">graph LR    A[Java层] --> B[JNI接口]    B --> C[Native层]        D[Unidbg JNI模拟] --> E[JNI函数表]    D --> F[对象引用管理]    D --> G[方法调用转换]    D --> H[数据类型转换]        E --> I[FindClass]    E --> J[GetMethodID]    E --> K[CallObjectMethod]    E --> L[NewObject]        F --> M[全局引用]    F --> N[局部引用]    F --> O[弱引用]        G --> P[Java方法调用]    G --> Q[Native方法调用]        H --> R[基本类型转换]    H --> S[对象类型转换]    H --> T[数组类型转换]</pre><p><strong>JNI模拟核心功能</strong>：</p><ol><li><strong>类加载模拟</strong>：模拟Java类的加载过程</li><li><strong>方法调用模拟</strong>：支持Java方法与Native方法的相互调用</li><li><strong>对象管理</strong>：管理Java对象的生命周期</li><li><strong>异常处理</strong>：处理Java异常和Native异常</li></ol><h3 id="3-系统调用模拟"><a href="#3-系统调用模拟" class="headerlink" title="3. 系统调用模拟"></a>3. 系统调用模拟</h3><p>Android Native代码需要调用系统API，Unidbg需要模拟这些系统调用。</p><h4 id="a-系统调用模拟流程"><a href="#a-系统调用模拟流程" class="headerlink" title="a. 系统调用模拟流程"></a>a. 系统调用模拟流程</h4><pre class="mermaid">flowchart TD    A[Native代码] --> B[系统调用指令]    B --> C{调用类型}        C -->|文件操作| D[文件系统模拟]    C -->|网络操作| E[网络接口模拟]    C -->|进程操作| F[进程管理模拟]    C -->|内存操作| G[内存管理模拟]        D --> H[open/read/write/close]    E --> I[socket/connect/send/recv]    F --> J[fork/exec/wait/exit]    G --> K[mmap/munmap/mprotect]        H --> L[虚拟文件系统]    I --> M[网络栈模拟]    J --> N[进程调度器]    K --> O[虚拟内存管理]        L --> P[返回结果]    M --> P    N --> P    O --> P        P --> Q[更新寄存器状态]    Q --> R[继续执行]</pre><p><strong>系统调用模拟特点</strong>：</p><ul><li><strong>透明性</strong>：Native代码无需修改即可运行</li><li><strong>完整性</strong>：支持大部分常用系统调用</li><li><strong>可扩展性</strong>：可以自定义系统调用实现</li></ul><h3 id="4-内存管理机制"><a href="#4-内存管理机制" class="headerlink" title="4. 内存管理机制"></a>4. 内存管理机制</h3><p>Unidbg提供完整的虚拟内存管理，模拟Android系统的内存管理机制。</p><h4 id="a-内存管理架构"><a href="#a-内存管理架构" class="headerlink" title="a. 内存管理架构"></a>a. 内存管理架构</h4><pre class="mermaid">graph TB    A[虚拟内存空间] --> B[代码段]    A --> C[数据段]    A --> D[堆内存]    A --> E[栈内存]        B --> F[可执行代码]    C --> G[全局变量]    D --> H[动态分配内存]    E --> I[函数调用栈]        J[内存管理器] --> K[内存分配]    J --> L[内存释放]    J --> M[内存保护]    J --> N[内存映射]        K --> O[malloc/free]    L --> P[垃圾回收]    M --> Q[读写保护]    N --> R[mmap/munmap]        S[内存布局] --> T[低地址: 代码段]    S --> U[中地址: 数据段]    S --> V[高地址: 堆栈]</pre><h2 id="三、具体场景应用"><a href="#三、具体场景应用" class="headerlink" title="三、具体场景应用"></a>三、具体场景应用</h2><h3 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="1. 环境搭建"></a>1. 环境搭建</h3><h4 id="a-安装依赖"><a href="#a-安装依赖" class="headerlink" title="a. 安装依赖"></a>a. 安装依赖</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装Java开发环境</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install openjdk-8-jdk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Maven</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install maven</span><br><span class="line"></span><br><span class="line"><span class="comment"># 克隆Unidbg项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zhkl0228/unidbg.git</span><br><span class="line"><span class="built_in">cd</span> unidbg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译项目</span></span><br><span class="line">mvn clean package</span><br></pre></td></tr></table></figure><h4 id="b-创建测试项目"><a href="#b-创建测试项目" class="headerlink" title="b. 创建测试项目"></a>b. 创建测试项目</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建Maven项目</span></span><br><span class="line">mvn archetype:generate -DgroupId=com.example -DartifactId=unidbg-test -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=<span class="literal">false</span></span><br></pre></td></tr></table></figure><h4 id="c-简单使用"><a href="#c-简单使用" class="headerlink" title="c. 简单使用"></a>c. 简单使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆Unidbg项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zhkl0228/unidbg.git</span><br><span class="line"><span class="built_in">cd</span> unidbg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 粘贴复制自己的项目，跑通demo后即可</span></span><br></pre></td></tr></table></figure><h3 id="2-基础使用示例"><a href="#2-基础使用示例" class="headerlink" title="2. 基础使用示例"></a>2. 基础使用示例</h3><h4 id="a-加载Native库"><a href="#a-加载Native库" class="headerlink" title="a. 加载Native库"></a>a. 加载Native库</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.DalvikVM;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.VM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnidbgBasicExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建Android模拟器</span></span><br><span class="line">        <span class="type">AndroidEmulator</span> <span class="variable">emulator</span> <span class="operator">=</span> AndroidEmulatorBuilder.for32Bit()</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.example.test&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建虚拟机</span></span><br><span class="line">        <span class="type">VM</span> <span class="variable">vm</span> <span class="operator">=</span> emulator.createDalvikVM();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 加载APK</span></span><br><span class="line">        vm.loadLibrary(<span class="string">&quot;libnative.so&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取模块</span></span><br><span class="line">        <span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> vm.getModule(<span class="string">&quot;libnative.so&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用Native函数</span></span><br><span class="line">        <span class="type">Number</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1234</span>, <span class="string">&quot;test&quot;</span>, <span class="number">123</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;函数返回值: &quot;</span> + result);</span><br><span class="line">        </span><br><span class="line">        emulator.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="b-JNI函数调用"><a href="#b-JNI函数调用" class="headerlink" title="b. JNI函数调用"></a>b. JNI函数调用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNIExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AndroidEmulator</span> <span class="variable">emulator</span> <span class="operator">=</span> AndroidEmulatorBuilder.for32Bit()</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.example.jni&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">VM</span> <span class="variable">vm</span> <span class="operator">=</span> emulator.createDalvikVM();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 加载Native库</span></span><br><span class="line">        <span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> vm.loadLibrary(<span class="string">&quot;libjni.so&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建Java对象</span></span><br><span class="line">        DvmObject&lt;?&gt; context = vm.resolveClass(<span class="string">&quot;android/content/Context&quot;</span>).newObject(<span class="literal">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用JNI函数</span></span><br><span class="line">        DvmObject&lt;?&gt; result = <span class="keyword">module</span>.callFunction(emulator, <span class="string">&quot;Java_com_example_MainActivity_nativeMethod&quot;</span>, </span><br><span class="line">                context, <span class="string">&quot;test_string&quot;</span>, <span class="number">123</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;JNI调用结果: &quot;</span> + result);</span><br><span class="line">        </span><br><span class="line">        emulator.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-进阶应用"><a href="#3-进阶应用" class="headerlink" title="3. 进阶应用"></a>3. 进阶应用</h3><h4 id="a-Hook函数调用"><a href="#a-Hook函数调用" class="headerlink" title="a. Hook函数调用"></a>a. Hook函数调用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HookExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AndroidEmulator</span> <span class="variable">emulator</span> <span class="operator">=</span> AndroidEmulatorBuilder.for32Bit()</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.example.hook&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">VM</span> <span class="variable">vm</span> <span class="operator">=</span> emulator.createDalvikVM();</span><br><span class="line">        <span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> vm.loadLibrary(<span class="string">&quot;libtarget.so&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Hook函数</span></span><br><span class="line">        emulator.attach().addHook(<span class="keyword">new</span> <span class="title class_">CodeHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">(Backend backend, <span class="type">long</span> address, <span class="type">int</span> size, Object user)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Hook到函数调用: 0x&quot;</span> + Long.toHexString(address));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 打印寄存器状态</span></span><br><span class="line">                <span class="type">ARMRegisters</span> <span class="variable">regs</span> <span class="operator">=</span> emulator.getContext().getArmRegisters();</span><br><span class="line">                System.out.println(<span class="string">&quot;R0: 0x&quot;</span> + Long.toHexString(regs.getR0Long()));</span><br><span class="line">                System.out.println(<span class="string">&quot;R1: 0x&quot;</span> + Long.toHexString(regs.getR1Long()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">module</span>.getBase() + <span class="number">0x1000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行代码</span></span><br><span class="line">        <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x2000</span>);</span><br><span class="line">        </span><br><span class="line">        emulator.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="b-内存操作"><a href="#b-内存操作" class="headerlink" title="b. 内存操作"></a>b. 内存操作</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AndroidEmulator</span> <span class="variable">emulator</span> <span class="operator">=</span> AndroidEmulatorBuilder.for32Bit()</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.example.memory&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">VM</span> <span class="variable">vm</span> <span class="operator">=</span> emulator.createDalvikVM();</span><br><span class="line">        <span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> vm.loadLibrary(<span class="string">&quot;libmemory.so&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 分配内存</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">address</span> <span class="operator">=</span> emulator.getMemory().malloc(<span class="number">1024</span>, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 写入数据</span></span><br><span class="line">        <span class="type">byte</span>[] data = <span class="string">&quot;Hello Unidbg&quot;</span>.getBytes();</span><br><span class="line">        emulator.getMemory().pointer(address).write(<span class="number">0</span>, data, <span class="number">0</span>, data.length);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 读取数据</span></span><br><span class="line">        <span class="type">byte</span>[] result = emulator.getMemory().pointer(address).getByteArray(<span class="number">0</span>, data.length);</span><br><span class="line">        System.out.println(<span class="string">&quot;读取的数据: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(result));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 释放内存</span></span><br><span class="line">        emulator.getMemory().free(address);</span><br><span class="line">        </span><br><span class="line">        emulator.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-调试功能"><a href="#4-调试功能" class="headerlink" title="4. 调试功能"></a>4. 调试功能</h3><h4 id="a-断点调试"><a href="#a-断点调试" class="headerlink" title="a. 断点调试"></a>a. 断点调试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DebugExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AndroidEmulator</span> <span class="variable">emulator</span> <span class="operator">=</span> AndroidEmulatorBuilder.for32Bit()</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.example.debug&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">VM</span> <span class="variable">vm</span> <span class="operator">=</span> emulator.createDalvikVM();</span><br><span class="line">        <span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> vm.loadLibrary(<span class="string">&quot;libdebug.so&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置断点</span></span><br><span class="line">        emulator.attach().addBreakPoint(<span class="keyword">module</span>.getBase() + <span class="number">0x1000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 单步执行</span></span><br><span class="line">        emulator.attach().setStepMode(<span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行代码</span></span><br><span class="line">        <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x2000</span>);</span><br><span class="line">        </span><br><span class="line">        emulator.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="四、工具使用优缺点"><a href="#四、工具使用优缺点" class="headerlink" title="四、工具使用优缺点"></a>四、工具使用优缺点</h2><h3 id="1-优点"><a href="#1-优点" class="headerlink" title="1. 优点"></a>1. 优点</h3><ol><li><strong>跨平台支持</strong>：无需Android设备即可运行Native代码</li><li><strong>完整环境模拟</strong>：提供完整的Android运行环境</li><li><strong>调试友好</strong>：内置强大的调试功能</li><li><strong>扩展性强</strong>：支持自定义Hook和系统调用</li><li><strong>性能优化</strong>：基于Unicorn引擎，执行效率较高</li></ol><h3 id="2-缺点"><a href="#2-缺点" class="headerlink" title="2. 缺点"></a>2. 缺点</h3><ol><li><strong>兼容性问题</strong>：某些复杂的Native代码可能无法完美模拟</li><li><strong>性能开销</strong>：模拟执行比原生执行慢</li><li><strong>系统调用限制</strong>：部分系统调用可能无法完全模拟</li><li><strong>学习曲线</strong>：需要深入理解ARM指令集和Android系统</li></ol><h2 id="五、结语"><a href="#五、结语" class="headerlink" title="五、结语"></a>五、结语</h2><p><strong>核心价值</strong>：<br>Unidbg最大的价值在于它提供了在PC端运行Android Native代码的能力，它虽然不是万能的，但在合适的场景下，确实是一个非常强大的工具。</p><p><strong>同类工具推荐</strong></p><p>在Native代码模拟执行领域，还有QEMU User Mode（通用Native模拟）、Unicorn Engine（纯CPU模拟）、Radare2（综合逆向分析）、AndroidNativeEmu（Android Native模拟）等工具。Unidbg在Android Native模拟方面具有独特优势，是Android安全研究的首选工具。</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Unidbg </tag>
            
            <tag> 入门指南 </tag>
            
            <tag> Native代码模拟 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android App抓包防护与绕过技术</title>
      <link href="/2025/09/25/article15_android_app_capture_protection/"/>
      <url>/2025/09/25/article15_android_app_capture_protection/</url>
      
        <content type="html"><![CDATA[<h2 id="Android-App抓包防护概述"><a href="#Android-App抓包防护概述" class="headerlink" title="Android App抓包防护概述"></a>Android App抓包防护概述</h2><h3 id="什么是抓包防护"><a href="#什么是抓包防护" class="headerlink" title="什么是抓包防护"></a>什么是抓包防护</h3><p><strong>抓包防护</strong>是Android应用为了防止网络流量被第三方工具（如Burp Suite、Fiddler、Charles等）拦截和分析而实施的安全措施。这些防护措施旨在保护敏感数据的传输安全，防止中间人攻击和数据泄露。</p><h3 id="Android-App抓包防护架构图"><a href="#Android-App抓包防护架构图" class="headerlink" title="Android App抓包防护架构图"></a>Android App抓包防护架构图</h3><span id="more"></span><pre class="mermaid">graph TB    A[Android App] --> B[网络请求]    B --> C{防护机制检测}        C --> D[SSL Pinning]    C --> E[证书验证检测]    C --> F[代理检测]    C --> G[反调试检测]    C --> H[应用完整性检测]        D --> I[证书固定验证]    E --> J[CA证书检测]    F --> K[代理设置检查]    G --> L[调试状态检查]    H --> M[签名验证]        I --> N{验证通过?}    J --> N    K --> N    L --> N    M --> N        N -->|是| O[允许网络请求]    N -->|否| P[拒绝网络请求]        Q[抓包工具] --> R[Burp Suite]    Q --> S[Charles]    Q --> T[Fiddler]        R --> U[中间人攻击]    S --> U    T --> U        U --> V[拦截网络流量]    V --> W[分析敏感数据]</pre><h2 id="主要防护机制"><a href="#主要防护机制" class="headerlink" title="主要防护机制"></a>主要防护机制</h2><h3 id="1-SSL-TLS证书固定（Certificate-Pinning）"><a href="#1-SSL-TLS证书固定（Certificate-Pinning）" class="headerlink" title="1. SSL&#x2F;TLS证书固定（Certificate Pinning）"></a>1. SSL&#x2F;TLS证书固定（Certificate Pinning）</h3><p><strong>防护原理</strong>：应用在代码中硬编码了服务器的证书信息，只信任特定的证书，拒绝其他证书（包括用户安装的CA证书）。</p><h4 id="SSL-Pinning证书固定流程图"><a href="#SSL-Pinning证书固定流程图" class="headerlink" title="SSL Pinning证书固定流程图"></a>SSL Pinning证书固定流程图</h4><pre class="mermaid">sequenceDiagram    participant App as Android App    participant SSL as SSL/TLS层    participant Server as 服务器    participant Proxy as 代理工具        Note over App,Proxy: 正常连接流程    App->>SSL: 发起HTTPS请求    SSL->>Server: 建立TLS连接    Server->>SSL: 返回服务器证书    SSL->>App: 验证证书有效性    App->>App: 检查证书哈希值    App->>App: 与预设哈希值比较    App->>Server: 证书验证通过，继续通信        Note over App,Proxy: 代理拦截流程    App->>SSL: 发起HTTPS请求    SSL->>Proxy: 连接被代理拦截    Proxy->>App: 返回代理证书    App->>App: 检查证书哈希值    App->>App: 与预设哈希值不匹配    App->>App: 拒绝连接，抛出异常</pre><p><strong>实现方式</strong>：<br>证书固定通常通过OkHttp库实现，开发者会在代码中硬编码服务器的证书哈希值。当应用发起HTTPS请求时，会验证服务器证书是否与预设的哈希值匹配，如果不匹配则拒绝连接。这种方式可以有效防止中间人攻击，但也会阻止合法的抓包工具。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OkHttp证书固定示例</span></span><br><span class="line"><span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">    .certificatePinner(<span class="keyword">new</span> <span class="title class_">CertificatePinner</span>.Builder()</span><br><span class="line">        .add(<span class="string">&quot;api.example.com&quot;</span>, <span class="string">&quot;sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>)</span><br><span class="line">        .add(<span class="string">&quot;api.example.com&quot;</span>, <span class="string">&quot;sha256/BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB=&quot;</span>)</span><br><span class="line">        .build())</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure><p><strong>检测方法</strong>：<br>检测证书固定可以通过尝试使用自签名证书连接服务器来实现。如果应用没有实施证书固定，连接会成功；如果实施了证书固定，会抛出证书验证异常。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测证书固定</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCertificatePinningEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 尝试使用自签名证书连接</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;https://api.example.com&quot;</span>);</span><br><span class="line">        <span class="type">HttpsURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> (HttpsURLConnection) url.openConnection();</span><br><span class="line">        connection.connect();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 如果没有抛出异常，说明没有证书固定</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 抛出异常说明有证书固定</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-证书验证绕过检测"><a href="#2-证书验证绕过检测" class="headerlink" title="2. 证书验证绕过检测"></a>2. 证书验证绕过检测</h3><p><strong>防护原理</strong>：应用检测是否安装了用户CA证书，如果检测到则拒绝连接。</p><p><strong>实现方式</strong>：<br>应用通过检查系统的信任存储来检测是否安装了用户CA证书。常见的抓包工具如Burp Suite、Charles、Fiddler等都会安装自己的CA证书，应用可以通过检查证书的颁发者信息来识别这些工具。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测用户CA证书</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasUserCACertificate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">TrustManagerFactory</span> <span class="variable">tmf</span> <span class="operator">=</span> TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        tmf.init((KeyStore) <span class="literal">null</span>);</span><br><span class="line">        <span class="type">X509TrustManager</span> <span class="variable">defaultTrustManager</span> <span class="operator">=</span> (X509TrustManager) tmf.getTrustManagers()[<span class="number">0</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查是否有用户添加的CA证书</span></span><br><span class="line">        X509Certificate[] acceptedIssuers = defaultTrustManager.getAcceptedIssuers();</span><br><span class="line">        <span class="keyword">for</span> (X509Certificate cert : acceptedIssuers) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">subject</span> <span class="operator">=</span> cert.getSubjectDN().getName();</span><br><span class="line">            <span class="keyword">if</span> (subject.contains(<span class="string">&quot;Burp&quot;</span>) || subject.contains(<span class="string">&quot;Charles&quot;</span>) || </span><br><span class="line">                subject.contains(<span class="string">&quot;Fiddler&quot;</span>) || subject.contains(<span class="string">&quot;Custom&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-网络环境检测"><a href="#3-网络环境检测" class="headerlink" title="3. 网络环境检测"></a>3. 网络环境检测</h3><p><strong>防护原理</strong>：检测设备是否连接了代理服务器，如果检测到代理则拒绝网络请求。</p><p><strong>实现方式</strong>：<br>网络环境检测主要通过检查系统代理设置和网络连接信息来实现。当用户配置了代理服务器时，系统会设置相应的代理属性，应用可以通过检查这些属性来判断是否存在代理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测代理设置</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isProxyEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 检查系统代理设置</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">proxyHost</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;http.proxyHost&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">proxyPort</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;http.proxyPort&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (proxyHost != <span class="literal">null</span> &amp;&amp; proxyPort != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查网络连接</span></span><br><span class="line">        <span class="type">ConnectivityManager</span> <span class="variable">cm</span> <span class="operator">=</span> (ConnectivityManager) getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">        <span class="type">NetworkInfo</span> <span class="variable">activeNetwork</span> <span class="operator">=</span> cm.getActiveNetworkInfo();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (activeNetwork != <span class="literal">null</span> &amp;&amp; activeNetwork.isConnected()) &#123;</span><br><span class="line">            <span class="comment">// 检查是否有代理</span></span><br><span class="line">            <span class="type">ProxyInfo</span> <span class="variable">proxyInfo</span> <span class="operator">=</span> activeNetwork.getProxyInfo();</span><br><span class="line">            <span class="keyword">if</span> (proxyInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-反调试检测"><a href="#4-反调试检测" class="headerlink" title="4. 反调试检测"></a>4. 反调试检测</h3><p><strong>防护原理</strong>：检测应用是否在调试模式下运行，如果检测到调试则拒绝网络请求。</p><h4 id="反Hook检测流程图"><a href="#反Hook检测流程图" class="headerlink" title="反Hook检测流程图"></a>反Hook检测流程图</h4><pre class="mermaid">flowchart TD    A[应用启动] --> B[检测Hook工具]        B --> C{检测Frida}    C -->|发现| D[标记为被Hook]    C -->|未发现| E{检测Xposed}        E -->|发现| D    E -->|未发现| F{检测Substrate}        F -->|发现| D    F -->|未发现| G{检测内存修改}        G -->|发现| D    G -->|未发现| H{检测异常行为}        H -->|发现| D    H -->|未发现| I[正常运行]        D --> J[触发反Hook机制]    J --> K[清除Hook痕迹]    K --> L[退出应用]        I --> M[继续正常执行]        N[检测方法] --> O[文件系统检查]    N --> P[进程检查]    N --> Q[端口检查]    N --> R[内存检查]    N --> S[行为分析]</pre><p><strong>实现方式</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测调试状态</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isDebugging</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 检查调试标志</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isDebug</span> <span class="operator">=</span> (getApplicationInfo().flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (isDebug) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查调试器连接</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isDebuggerConnected</span> <span class="operator">=</span> Debug.isDebuggerConnected();</span><br><span class="line">        <span class="keyword">if</span> (isDebuggerConnected) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查调试端口</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8700</span>);</span><br><span class="line">            socket.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 端口未开放，不是调试状态</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-应用完整性检测"><a href="#5-应用完整性检测" class="headerlink" title="5. 应用完整性检测"></a>5. 应用完整性检测</h3><p><strong>防护原理</strong>：检测应用是否被修改或重打包，如果检测到则拒绝网络请求。</p><p><strong>实现方式</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测应用签名</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAppModified</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> getPackageManager();</span><br><span class="line">        <span class="type">PackageInfo</span> <span class="variable">packageInfo</span> <span class="operator">=</span> pm.getPackageInfo(getPackageName(), PackageManager.GET_SIGNATURES);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取当前签名</span></span><br><span class="line">        Signature[] signatures = packageInfo.signatures;</span><br><span class="line">        <span class="type">String</span> <span class="variable">currentSignature</span> <span class="operator">=</span> signatures[<span class="number">0</span>].toCharsString();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 与预期签名比较</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">expectedSignature</span> <span class="operator">=</span> <span class="string">&quot;预期签名的SHA1值&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!currentSignature.equals(expectedSignature)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="绕过技术详解"><a href="#绕过技术详解" class="headerlink" title="绕过技术详解"></a>绕过技术详解</h2><h3 id="Frida-Hook原理图"><a href="#Frida-Hook原理图" class="headerlink" title="Frida Hook原理图"></a>Frida Hook原理图</h3><pre class="mermaid">graph LR    A[原始函数] --> B[函数入口点]    B --> C[原始函数体]    C --> D[函数返回]        E[Frida Hook] --> F[Hook函数入口]    F --> G[自定义Hook函数]    G --> H[修改参数/返回值]    H --> I[调用原始函数]    I --> J[处理返回结果]    J --> K[返回修改后的结果]        B -.->|被Hook| F    F -.->|替换| B        L[应用进程] --> M[加载Frida Agent]    M --> N[注册Hook点]    N --> O[动态修改函数]    O --> P[执行Hook逻辑]</pre><h3 id="1-SSL-Pinning绕过"><a href="#1-SSL-Pinning绕过" class="headerlink" title="1. SSL Pinning绕过"></a>1. SSL Pinning绕过</h3><h4 id="方法一：Frida-Hook"><a href="#方法一：Frida-Hook" class="headerlink" title="方法一：Frida Hook"></a>方法一：Frida Hook</h4><p>Frida Hook是最常用的SSL Pinning绕过方法，通过Hook证书验证相关的函数来实现绕过。这种方法不需要修改应用代码，只需要在运行时动态Hook即可。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida Hook SSL Pinning</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook OkHttp的CertificatePinner</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">CertificatePinner</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.CertificatePinner&quot;</span>);</span><br><span class="line">    <span class="title class_">CertificatePinner</span>.<span class="property">check</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>, <span class="string">&quot;java.util.List&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">hostname, peerCertificates</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;绕过SSL Pinning: &quot;</span> + hostname);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook X509TrustManager</span></span><br><span class="line">    <span class="keyword">var</span> X509TrustManager = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.net.ssl.X509TrustManager&quot;</span>);</span><br><span class="line">    X509TrustManager.<span class="property">checkClientTrusted</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">chain, authType</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;绕过客户端证书检查&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    X509TrustManager.<span class="property">checkServerTrusted</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">chain, authType</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;绕过服务端证书检查&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    X509TrustManager.<span class="property">getAcceptedIssuers</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.util.ArrayList&quot;</span>).$new();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="方法二：Xposed模块"><a href="#方法二：Xposed模块" class="headerlink" title="方法二：Xposed模块"></a>方法二：Xposed模块</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Xposed模块绕过SSL Pinning</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSLUnpinning</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// Hook OkHttp</span></span><br><span class="line">        XposedHelpers.findAndHookMethod(<span class="string">&quot;okhttp3.CertificatePinner&quot;</span>, lpparam.classLoader,</span><br><span class="line">            <span class="string">&quot;check&quot;</span>, String.class, List.class, <span class="keyword">new</span> <span class="title class_">XC_MethodReplacement</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> Object <span class="title function_">replaceHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Hook TrustManager</span></span><br><span class="line">        XposedHelpers.findAndHookMethod(<span class="string">&quot;javax.net.ssl.X509TrustManager&quot;</span>, lpparam.classLoader,</span><br><span class="line">            <span class="string">&quot;checkServerTrusted&quot;</span>, X509Certificate[].class, String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodReplacement</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> Object <span class="title function_">replaceHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="方法三：内存补丁"><a href="#方法三：内存补丁" class="headerlink" title="方法三：内存补丁"></a>方法三：内存补丁</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存补丁绕过SSL Pinning</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL <span class="title function_">Java_com_example_SSLUnpinner_unpin</span><span class="params">(JNIEnv *env, jobject thiz)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取SSL_CTX_set_verify函数地址</span></span><br><span class="line">    <span class="type">void</span> *ssl_ctx_set_verify = dlsym(RTLD_DEFAULT, <span class="string">&quot;SSL_CTX_set_verify&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ssl_ctx_set_verify) &#123;</span><br><span class="line">        <span class="comment">// 修改函数实现</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> patch[] = &#123;<span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>&#125;; <span class="comment">// NOP指令</span></span><br><span class="line">        mprotect(ssl_ctx_set_verify, <span class="number">5</span>, PROT_READ | PROT_WRITE | PROT_EXEC);</span><br><span class="line">        <span class="built_in">memcpy</span>(ssl_ctx_set_verify, patch, <span class="number">5</span>);</span><br><span class="line">        mprotect(ssl_ctx_set_verify, <span class="number">5</span>, PROT_READ | PROT_EXEC);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-代理检测绕过"><a href="#2-代理检测绕过" class="headerlink" title="2. 代理检测绕过"></a>2. 代理检测绕过</h3><h4 id="方法一：Hook系统属性"><a href="#方法一：Hook系统属性" class="headerlink" title="方法一：Hook系统属性"></a>方法一：Hook系统属性</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida Hook代理检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook System.getProperty</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">System</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.System&quot;</span>);</span><br><span class="line">    <span class="title class_">System</span>.<span class="property">getProperty</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&quot;http.proxyHost&quot;</span> || key === <span class="string">&quot;http.proxyPort&quot;</span> || </span><br><span class="line">            key === <span class="string">&quot;https.proxyHost&quot;</span> || key === <span class="string">&quot;https.proxyPort&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;绕过代理检测: &quot;</span> + key);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getProperty</span>(key);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook ConnectivityManager</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">ConnectivityManager</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.net.ConnectivityManager&quot;</span>);</span><br><span class="line">    <span class="title class_">ConnectivityManager</span>.<span class="property">getActiveNetworkInfo</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> networkInfo = <span class="variable language_">this</span>.<span class="title function_">getActiveNetworkInfo</span>();</span><br><span class="line">        <span class="keyword">if</span> (networkInfo) &#123;</span><br><span class="line">            <span class="comment">// 清除代理信息</span></span><br><span class="line">            networkInfo.<span class="title function_">setProxyInfo</span>(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> networkInfo;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="方法二：修改网络配置"><a href="#方法二：修改网络配置" class="headerlink" title="方法二：修改网络配置"></a>方法二：修改网络配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改网络配置绕过代理检测</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyBypass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">bypassProxyDetection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 清除系统代理设置</span></span><br><span class="line">            System.setProperty(<span class="string">&quot;http.proxyHost&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            System.setProperty(<span class="string">&quot;http.proxyPort&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            System.setProperty(<span class="string">&quot;https.proxyHost&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            System.setProperty(<span class="string">&quot;https.proxyPort&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 修改网络配置</span></span><br><span class="line">            <span class="type">ConnectivityManager</span> <span class="variable">cm</span> <span class="operator">=</span> (ConnectivityManager) getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">            <span class="keyword">if</span> (cm != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 强制使用直连</span></span><br><span class="line">                cm.setNetworkPreference(ConnectivityManager.TYPE_WIFI);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-反调试绕过"><a href="#3-反调试绕过" class="headerlink" title="3. 反调试绕过"></a>3. 反调试绕过</h3><h4 id="方法一：Frida-Hook反调试检测"><a href="#方法一：Frida-Hook反调试检测" class="headerlink" title="方法一：Frida Hook反调试检测"></a>方法一：Frida Hook反调试检测</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida Hook反调试检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook Debug.isDebuggerConnected</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Debug</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.os.Debug&quot;</span>);</span><br><span class="line">    <span class="title class_">Debug</span>.<span class="property">isDebuggerConnected</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;绕过调试检测&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook ApplicationInfo.FLAG_DEBUGGABLE</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">ApplicationInfo</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.content.pm.ApplicationInfo&quot;</span>);</span><br><span class="line">    <span class="title class_">ApplicationInfo</span>.<span class="property">flags</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> flags = <span class="variable language_">this</span>.<span class="property">flags</span>;</span><br><span class="line">        <span class="comment">// 清除调试标志</span></span><br><span class="line">        flags = flags &amp; ~<span class="title class_">ApplicationInfo</span>.<span class="property">FLAG_DEBUGGABLE</span>.<span class="property">value</span>;</span><br><span class="line">        <span class="keyword">return</span> flags;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook Socket连接检测</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Socket</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.net.Socket&quot;</span>);</span><br><span class="line">    <span class="title class_">Socket</span>.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>, <span class="string">&quot;int&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">host, port</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (host === <span class="string">&quot;127.0.0.1&quot;</span> &amp;&amp; port === <span class="number">8700</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;绕过调试端口检测&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.net.ConnectException&quot;</span>).$new(<span class="string">&quot;Connection refused&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.$init(host, port);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="方法二：修改应用标志"><a href="#方法二：修改应用标志" class="headerlink" title="方法二：修改应用标志"></a>方法二：修改应用标志</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改应用标志绕过反调试</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DebugBypass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">bypassDebugDetection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 修改调试标志</span></span><br><span class="line">            <span class="type">ApplicationInfo</span> <span class="variable">appInfo</span> <span class="operator">=</span> getApplicationInfo();</span><br><span class="line">            appInfo.flags = appInfo.flags &amp; ~ApplicationInfo.FLAG_DEBUGGABLE;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 修改系统属性</span></span><br><span class="line">            System.setProperty(<span class="string">&quot;ro.debuggable&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">            System.setProperty(<span class="string">&quot;ro.secure&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-应用完整性绕过"><a href="#4-应用完整性绕过" class="headerlink" title="4. 应用完整性绕过"></a>4. 应用完整性绕过</h3><h4 id="方法一：Hook签名验证"><a href="#方法一：Hook签名验证" class="headerlink" title="方法一：Hook签名验证"></a>方法一：Hook签名验证</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida Hook签名验证</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook PackageManager.getPackageInfo</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">PackageManager</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.content.pm.PackageManager&quot;</span>);</span><br><span class="line">    <span class="title class_">PackageManager</span>.<span class="property">getPackageInfo</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>, <span class="string">&quot;int&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">packageName, flags</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> packageInfo = <span class="variable language_">this</span>.<span class="title function_">getPackageInfo</span>(packageName, flags);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (flags == <span class="title class_">PackageManager</span>.<span class="property">GET_SIGNATURES</span>.<span class="property">value</span>) &#123;</span><br><span class="line">            <span class="comment">// 替换签名信息</span></span><br><span class="line">            <span class="keyword">var</span> <span class="title class_">Signature</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.content.pm.Signature&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> fakeSignature = <span class="title class_">Signature</span>.$new(<span class="string">&quot;伪造的签名信息&quot;</span>);</span><br><span class="line">            packageInfo.<span class="property">signatures</span> = [fakeSignature];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> packageInfo;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="方法二：修改签名文件"><a href="#方法二：修改签名文件" class="headerlink" title="方法二：修改签名文件"></a>方法二：修改签名文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用apktool重新签名</span></span><br><span class="line">apktool d app.apk</span><br><span class="line"><span class="comment"># 修改应用代码</span></span><br><span class="line"><span class="comment"># 重新打包</span></span><br><span class="line">apktool b app -o app_modified.apk</span><br><span class="line"><span class="comment"># 签名</span></span><br><span class="line">jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.keystore app_modified.apk alias_name</span><br></pre></td></tr></table></figure><h2 id="进阶绕过技术"><a href="#进阶绕过技术" class="headerlink" title="进阶绕过技术"></a>进阶绕过技术</h2><h3 id="1-动态Hook技术"><a href="#1-动态Hook技术" class="headerlink" title="1. 动态Hook技术"></a>1. 动态Hook技术</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态Hook技术</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 等待类加载</span></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.example.SecurityChecker&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;找到SecurityChecker实例&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Hook实例方法</span></span><br><span class="line">            instance.<span class="property">checkSecurity</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;绕过安全检查&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 返回安全检查通过</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;搜索完成&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="2-内存修改技术"><a href="#2-内存修改技术" class="headerlink" title="2. 内存修改技术"></a>2. 内存修改技术</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存修改技术</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">patchMemory</span><span class="params">(<span class="type">void</span> *addr, <span class="type">unsigned</span> <span class="type">char</span> *patch, <span class="type">size_t</span> patchSize)</span> &#123;</span><br><span class="line">    <span class="comment">// 修改内存保护</span></span><br><span class="line">    mprotect(addr, patchSize, PROT_READ | PROT_WRITE | PROT_EXEC);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 应用补丁</span></span><br><span class="line">    <span class="built_in">memcpy</span>(addr, patch, patchSize);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 恢复内存保护</span></span><br><span class="line">    mprotect(addr, patchSize, PROT_READ | PROT_EXEC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-系统调用Hook"><a href="#3-系统调用Hook" class="headerlink" title="3. 系统调用Hook"></a>3. 系统调用Hook</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 系统调用Hook</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">syscall_hook</span><span class="params">(<span class="type">int</span> syscall_num, <span class="keyword">struct</span> user_regs_struct *regs)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (syscall_num) &#123;</span><br><span class="line">        <span class="keyword">case</span> SYS_ptrace:</span><br><span class="line">            <span class="comment">// 绕过ptrace检测</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">case</span> SYS_kill:</span><br><span class="line">            <span class="comment">// 绕过kill检测</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> syscall(syscall_num, regs-&gt;rdi, regs-&gt;rsi, regs-&gt;rdx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="检测与防护"><a href="#检测与防护" class="headerlink" title="检测与防护"></a>检测与防护</h2><h3 id="1-检测Hook工具"><a href="#1-检测Hook工具" class="headerlink" title="1. 检测Hook工具"></a>1. 检测Hook工具</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测Hook工具</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isHooked</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 检测Frida</span></span><br><span class="line">        <span class="keyword">if</span> (isFridaDetected()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测Xposed</span></span><br><span class="line">        <span class="keyword">if</span> (isXposedDetected()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测Substrate</span></span><br><span class="line">        <span class="keyword">if</span> (isSubstrateDetected()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isFridaDetected</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 检测Frida相关文件</span></span><br><span class="line">        String[] fridaFiles = &#123;</span><br><span class="line">            <span class="string">&quot;/data/local/tmp/frida-server&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/data/local/tmp/re.frida.server&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/system/bin/frida-server&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String file : fridaFiles) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">File</span>(file).exists()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测Frida端口</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">27042</span>);</span><br><span class="line">            socket.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 端口未开放</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-反Hook技术"><a href="#2-反Hook技术" class="headerlink" title="2. 反Hook技术"></a>2. 反Hook技术</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反Hook技术</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AntiHook</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">enableAntiHook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检测并清除Hook</span></span><br><span class="line">        <span class="keyword">if</span> (isHooked()) &#123;</span><br><span class="line">            <span class="comment">// 退出应用</span></span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 定期检查</span></span><br><span class="line">        <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();</span><br><span class="line">        timer.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isHooked()) &#123;</span><br><span class="line">                    System.exit(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">5000</span>); <span class="comment">// 每5秒检查一次</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><h3 id="技术对抗演进图"><a href="#技术对抗演进图" class="headerlink" title="技术对抗演进图"></a>技术对抗演进图</h3><pre class="mermaid">timeline    title Android抓包防护与绕过技术演进        section 初期阶段        2010-2015 : 基础HTTPS                  : 简单代理检测                  : 基础反调试        section 发展阶段        2015-2020 : SSL Pinning普及                  : 证书固定技术                  : 应用完整性检测                  : Frida Hook兴起                  : Xposed模块开发        section 成熟阶段        2020-2023 : 多层防护机制                  : 智能检测算法                  : 动态Hook技术                  : 内存修改技术                  : 系统调用Hook        section 未来趋势        2023+ : AI驱动检测              : 机器学习防护              : 云原生安全              : 零信任架构              : 量子加密</pre><h3 id="绕过技术分类图"><a href="#绕过技术分类图" class="headerlink" title="绕过技术分类图"></a>绕过技术分类图</h3><pre class="mermaid">mindmap  root((Android抓包绕过技术))    静态修改      重打包应用      修改证书验证      替换CA证书      修改网络配置    动态Hook      Frida Hook        SSL Pinning绕过        代理检测绕过        反调试绕过        签名验证绕过      Xposed模块        系统API Hook        应用层Hook        框架层Hook      Substrate Hook        iOS平台Hook        运行时修改    内存修改      直接内存操作      函数替换      指令修改      数据结构修改    系统调用Hook      内核层Hook      系统调用拦截      进程间通信Hook      文件系统Hook</pre><p>在实际应用中，无论是进行安全测试、漏洞挖掘，还是应用安全评估，都需要在合法合规的前提下使用这些技术。同时，开发者也需要不断加强应用的安全防护，采用多层防护策略，提高应用的安全性。</p>]]></content>
      
      
      <categories>
          
          <category> App抓包 </category>
          
          <category> Android安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> 抓包防护 </tag>
            
            <tag> 绕过技术 </tag>
            
            <tag> 防护机制 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于ADB的Android自动化工具全解析</title>
      <link href="/2025/09/19/article14_android_automation_tools/"/>
      <url>/2025/09/19/article14_android_automation_tools/</url>
      
        <content type="html"><![CDATA[<h2 id="Android自动化工具概述"><a href="#Android自动化工具概述" class="headerlink" title="Android自动化工具概述"></a>Android自动化工具概述</h2><h3 id="什么是Android自动化工具"><a href="#什么是Android自动化工具" class="headerlink" title="什么是Android自动化工具"></a>什么是Android自动化工具</h3><p><strong>Android自动化工具</strong>是基于ADB等底层接口构建的测试和操作工具，主要功能：</p><ul><li>自动化UI操作</li><li>应用测试</li><li>性能监控</li><li>批量处理</li><li>智能分析</li></ul><span id="more"></span><h2 id="自动化工具"><a href="#自动化工具" class="headerlink" title="自动化工具"></a>自动化工具</h2><h3 id="1-Appium"><a href="#1-Appium" class="headerlink" title="1. Appium"></a>1. Appium</h3><p><strong>项目介绍</strong>：Appium是一个开源的移动应用自动化测试框架，支持Android和iOS平台。</p><p><strong>核心特点</strong>：</p><ul><li>跨平台支持</li><li>多语言支持（Python、Java、JavaScript等）</li><li>基于WebDriver协议</li><li>支持原生、混合和Web应用</li></ul><p><strong>安装配置</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装Node.js</span></span><br><span class="line">npm install -g appium</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Android驱动</span></span><br><span class="line">npm install -g appium-doctor</span><br><span class="line">appium-doctor --android</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Appium服务器</span></span><br><span class="line">appium</span><br></pre></td></tr></table></figure><p><strong>使用示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> appium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Desired Capabilities</span></span><br><span class="line">desired_caps = &#123;</span><br><span class="line">    <span class="string">&#x27;platformName&#x27;</span>: <span class="string">&#x27;Android&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;deviceName&#x27;</span>: <span class="string">&#x27;Android Emulator&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;appPackage&#x27;</span>: <span class="string">&#x27;com.example.app&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;appActivity&#x27;</span>: <span class="string">&#x27;.MainActivity&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建驱动实例</span></span><br><span class="line">driver = webdriver.Remote(<span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span>, desired_caps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行操作</span></span><br><span class="line">driver.find_element_by_id(<span class="string">&quot;button1&quot;</span>).click()</span><br><span class="line">driver.find_element_by_xpath(<span class="string">&quot;//android.widget.EditText&quot;</span>).send_keys(<span class="string">&quot;test&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭驱动</span></span><br><span class="line">driver.quit()</span><br></pre></td></tr></table></figure><p><strong>实际应用场景</strong>：</p><ul><li>移动应用UI自动化测试</li><li>跨平台兼容性测试</li><li>回归测试自动化</li><li>性能测试</li></ul><h3 id="2-UIAutomator2"><a href="#2-UIAutomator2" class="headerlink" title="2. UIAutomator2"></a>2. UIAutomator2</h3><p><strong>项目介绍</strong>：UIAutomator2是Google官方提供的Android UI自动化测试框架的Python封装。</p><p><strong>核心特点</strong>：</p><ul><li>基于Google UIAutomator</li><li>Python语言支持</li><li>支持复杂UI操作</li><li>性能优秀</li></ul><p><strong>安装配置</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装UIAutomator2</span></span><br><span class="line">pip install uiautomator2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化设备</span></span><br><span class="line">python -m uiautomator2 init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接设备</span></span><br><span class="line">python -c <span class="string">&quot;import uiautomator2 as u2; d = u2.connect()&quot;</span></span><br></pre></td></tr></table></figure><p><strong>使用示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uiautomator2 <span class="keyword">as</span> u2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接设备</span></span><br><span class="line">d = u2.connect()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动应用</span></span><br><span class="line">d.app_start(<span class="string">&quot;com.example.app&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 点击元素</span></span><br><span class="line">d(text=<span class="string">&quot;登录&quot;</span>).click()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入文本</span></span><br><span class="line">d(className=<span class="string">&quot;android.widget.EditText&quot;</span>).set_text(<span class="string">&quot;username&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 滑动操作</span></span><br><span class="line">d.swipe(<span class="number">500</span>, <span class="number">1000</span>, <span class="number">500</span>, <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 截图</span></span><br><span class="line">d.screenshot(<span class="string">&quot;screenshot.png&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>实际应用场景</strong>：</p><ul><li>Android原生应用测试</li><li>UI元素定位和操作</li><li>手势操作测试</li><li>屏幕截图和对比</li></ul><h3 id="3-ADB-Shell自动化"><a href="#3-ADB-Shell自动化" class="headerlink" title="3. ADB Shell自动化"></a>3. ADB Shell自动化</h3><p><strong>项目介绍</strong>：基于ADB Shell命令的自动化脚本，轻量级且灵活。</p><p><strong>核心特点</strong>：</p><ul><li>轻量级实现</li><li>完全基于ADB</li><li>高度可定制</li><li>学习成本低</li></ul><p><strong>使用示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 简单的ADB自动化脚本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动应用</span></span><br><span class="line">adb shell am start -n com.example.app/.MainActivity</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待应用启动</span></span><br><span class="line"><span class="built_in">sleep</span> 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 点击坐标</span></span><br><span class="line">adb shell input tap 500 500</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入文本</span></span><br><span class="line">adb shell input text <span class="string">&quot;test123&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按键操作</span></span><br><span class="line">adb shell input keyevent 66</span><br><span class="line"></span><br><span class="line"><span class="comment"># 截图</span></span><br><span class="line">adb shell screencap /sdcard/screenshot.png</span><br><span class="line">adb pull /sdcard/screenshot.png</span><br></pre></td></tr></table></figure><p><strong>实际应用场景</strong>：</p><ul><li>简单的自动化任务</li><li>快速原型开发</li><li>设备管理自动化</li><li>批量操作</li></ul><h3 id="4-Airtest"><a href="#4-Airtest" class="headerlink" title="4. Airtest"></a>4. Airtest</h3><p><strong>项目介绍</strong>：Airtest是网易开源的跨平台UI自动化测试框架，支持图像识别和脚本录制。</p><p><strong>核心特点</strong>：</p><ul><li>图像识别技术</li><li>跨平台支持</li><li>可视化脚本录制</li><li>丰富的API</li></ul><p><strong>安装配置</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装Airtest</span></span><br><span class="line">pip install airtest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Poco</span></span><br><span class="line">pip install pocoui</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Airtest IDE</span></span><br><span class="line">airtest</span><br></pre></td></tr></table></figure><p><strong>使用示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> airtest.core.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接设备</span></span><br><span class="line">connect_device(<span class="string">&quot;Android:///&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动应用</span></span><br><span class="line">start_app(<span class="string">&quot;com.example.app&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 图像识别点击</span></span><br><span class="line">touch(Template(<span class="string">&quot;button.png&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文本输入</span></span><br><span class="line">text(<span class="string">&quot;username&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 滑动操作</span></span><br><span class="line">swipe((<span class="number">500</span>, <span class="number">1000</span>), (<span class="number">500</span>, <span class="number">500</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 断言</span></span><br><span class="line">assert_exists(Template(<span class="string">&quot;success.png&quot;</span>))</span><br></pre></td></tr></table></figure><p><strong>实际应用场景</strong>：</p><ul><li>游戏自动化测试</li><li>图像识别测试</li><li>跨平台应用测试</li><li>快速脚本录制</li></ul><h3 id="5-STF-Smartphone-Test-Farm"><a href="#5-STF-Smartphone-Test-Farm" class="headerlink" title="5. STF (Smartphone Test Farm)"></a>5. STF (Smartphone Test Farm)</h3><p><strong>项目介绍</strong>：STF是一个开源的移动设备管理平台，支持远程设备访问和自动化测试。</p><p><strong>核心特点</strong>：</p><ul><li>设备远程访问</li><li>多设备管理</li><li>Web界面操作</li><li>支持自动化测试</li></ul><p><strong>安装配置</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装STF</span></span><br><span class="line">npm install -g stf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动STF</span></span><br><span class="line">stf <span class="built_in">local</span></span><br></pre></td></tr></table></figure><p><strong>使用示例</strong>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STF自动化脚本</span></span><br><span class="line"><span class="keyword">const</span> stf = <span class="built_in">require</span>(<span class="string">&#x27;stf&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接设备</span></span><br><span class="line"><span class="keyword">const</span> device = stf.<span class="title function_">connect</span>(<span class="string">&#x27;device_id&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行操作</span></span><br><span class="line">device.<span class="title function_">tap</span>(<span class="number">500</span>, <span class="number">500</span>);</span><br><span class="line">device.<span class="title function_">input</span>(<span class="string">&#x27;test123&#x27;</span>);</span><br><span class="line">device.<span class="title function_">screenshot</span>(<span class="string">&#x27;screenshot.png&#x27;</span>);</span><br></pre></td></tr></table></figure><p><strong>实际应用场景</strong>：</p><ul><li>远程设备测试</li><li>多设备并行测试</li><li>设备资源共享</li><li>云端测试平台</li></ul><h3 id="6-Appium-Inspector-AI"><a href="#6-Appium-Inspector-AI" class="headerlink" title="6. Appium Inspector AI"></a>6. Appium Inspector AI</h3><p><strong>项目介绍</strong>：基于AI技术的Appium增强版本，能够智能识别UI元素和生成测试脚本。</p><p><strong>核心特点</strong>：</p><ul><li>AI元素识别</li><li>智能脚本生成</li><li>自动元素定位</li><li>学习用户行为</li></ul><p><strong>使用示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> appium_ai <span class="keyword">import</span> WebDriver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建AI驱动</span></span><br><span class="line">driver = WebDriver(desired_caps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># AI智能点击</span></span><br><span class="line">driver.ai_click(<span class="string">&quot;登录按钮&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># AI智能输入</span></span><br><span class="line">driver.ai_input(<span class="string">&quot;用户名&quot;</span>, <span class="string">&quot;testuser&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># AI智能等待</span></span><br><span class="line">driver.ai_wait(<span class="string">&quot;页面加载完成&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成测试报告</span></span><br><span class="line">driver.generate_ai_report()</span><br></pre></td></tr></table></figure><p><strong>实际应用场景</strong>：</p><ul><li>智能测试脚本生成</li><li>复杂UI元素识别</li><li>自适应测试用例</li><li>测试用例维护</li></ul><h3 id="7-Test-ai"><a href="#7-Test-ai" class="headerlink" title="7. Test.ai"></a>7. Test.ai</h3><p><strong>项目介绍</strong>：基于机器学习的移动应用测试平台，能够自动生成和执行测试用例。</p><p><strong>核心特点</strong>：</p><ul><li>机器学习算法</li><li>自动测试生成</li><li>智能缺陷检测</li><li>性能分析</li></ul><p><strong>使用示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> testai <span class="keyword">import</span> TestAI</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建TestAI实例</span></span><br><span class="line">testai = TestAI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析应用</span></span><br><span class="line">testai.analyze_app(<span class="string">&quot;com.example.app&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成测试用例</span></span><br><span class="line">test_cases = testai.generate_test_cases()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行测试</span></span><br><span class="line">results = testai.run_tests(test_cases)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成报告</span></span><br><span class="line">testai.generate_report(results)</span><br></pre></td></tr></table></figure><p><strong>实际应用场景</strong>：</p><ul><li>自动化测试用例生成</li><li>智能缺陷检测</li><li>性能瓶颈分析</li><li>测试覆盖率分析</li></ul><h3 id="8-Katalon-Studio"><a href="#8-Katalon-Studio" class="headerlink" title="8. Katalon Studio"></a>8. Katalon Studio</h3><p><strong>项目介绍</strong>：Katalon Studio是一个基于AI的测试自动化平台，支持Web、移动和API测试。</p><p><strong>核心特点</strong>：</p><ul><li>AI驱动的测试</li><li>可视化测试设计</li><li>智能元素识别</li><li>集成CI&#x2F;CD</li></ul><p><strong>使用示例</strong>：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Katalon Studio脚本</span></span><br><span class="line"><span class="keyword">import</span> com.kms.katalon.core.testobject.TestObject</span><br><span class="line"><span class="keyword">import</span> com.kms.katalon.core.testobject.TestObjectProperty</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建测试对象</span></span><br><span class="line">TestObject button = <span class="keyword">new</span> TestObject(<span class="string">&quot;Login Button&quot;</span>)</span><br><span class="line">button.addProperty(<span class="string">&quot;xpath&quot;</span>, ConditionType.EQUALS, <span class="string">&quot;//button[@id=&#x27;login&#x27;]&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行操作</span></span><br><span class="line">WebUI.click(button)</span><br><span class="line">WebUI.setText(findTestObject(<span class="string">&quot;Username Field&quot;</span>), <span class="string">&quot;testuser&quot;</span>)</span><br><span class="line">WebUI.click(findTestObject(<span class="string">&quot;Submit Button&quot;</span>))</span><br></pre></td></tr></table></figure><p><strong>实际应用场景</strong>：</p><ul><li>企业级测试自动化</li><li>跨平台测试</li><li>持续集成测试</li><li>测试数据管理</li></ul><h3 id="9-Android-UI-Automator-AI"><a href="#9-Android-UI-Automator-AI" class="headerlink" title="9. Android UI Automator AI"></a>9. Android UI Automator AI</h3><p><strong>项目介绍</strong>：基于深度学习的Android UI自动化框架，能够智能识别和操作UI元素。</p><p><strong>GitHub地址</strong>：<a href="https://github.com/android-ui-automator-ai">https://github.com/android-ui-automator-ai</a></p><p><strong>核心特点</strong>：</p><ul><li>深度学习模型</li><li>智能元素识别</li><li>自适应操作</li><li>多语言支持</li></ul><p><strong>安装配置</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/android-ui-automator-ai/android-ui-automator-ai.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练模型</span></span><br><span class="line">python train_model.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行测试</span></span><br><span class="line">python run_tests.py</span><br></pre></td></tr></table></figure><p><strong>使用示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> android_ui_automator_ai <span class="keyword">import</span> AndroidUIAutomatorAI</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建AI实例</span></span><br><span class="line">ai = AndroidUIAutomatorAI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接设备</span></span><br><span class="line">ai.connect_device()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 智能操作</span></span><br><span class="line">ai.smart_click(<span class="string">&quot;登录&quot;</span>)</span><br><span class="line">ai.smart_input(<span class="string">&quot;用户名&quot;</span>, <span class="string">&quot;testuser&quot;</span>)</span><br><span class="line">ai.smart_swipe(<span class="string">&quot;向下滑动&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成测试报告</span></span><br><span class="line">ai.generate_report()</span><br></pre></td></tr></table></figure><h3 id="10-Mobile-Test-AI"><a href="#10-Mobile-Test-AI" class="headerlink" title="10. Mobile Test AI"></a>10. Mobile Test AI</h3><p><strong>项目介绍</strong>：基于计算机视觉的移动应用测试AI框架，能够理解应用界面并生成测试用例。</p><p><strong>GitHub地址</strong>：<a href="https://github.com/mobile-test-ai">https://github.com/mobile-test-ai</a></p><p><strong>核心特点</strong>：</p><ul><li>计算机视觉技术</li><li>自然语言处理</li><li>自动测试生成</li><li>智能缺陷检测</li></ul><p><strong>使用示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mobile_test_ai <span class="keyword">import</span> MobileTestAI</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建AI实例</span></span><br><span class="line">ai = MobileTestAI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析应用界面</span></span><br><span class="line">ai.analyze_ui(<span class="string">&quot;com.example.app&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成测试用例</span></span><br><span class="line">test_cases = ai.generate_test_cases(<span class="string">&quot;用户登录流程&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行测试</span></span><br><span class="line">results = ai.execute_tests(test_cases)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析结果</span></span><br><span class="line">ai.analyze_results(results)</span><br></pre></td></tr></table></figure><h3 id="11-Mobile-Use"><a href="#11-Mobile-Use" class="headerlink" title="11. Mobile-Use"></a>11. Mobile-Use</h3><p><strong>项目介绍</strong>：Mobile-Use是一个强大的开源AI代理，能够使用自然语言控制Android和iOS设备，就像人类一样与应用程序交互。</p><p><strong>GitHub地址</strong>：<a href="https://github.com/minitap-ai/mobile-use">https://github.com/minitap-ai/mobile-use</a></p><p><strong>核心特点</strong>：</p><ul><li>自然语言控制：使用母语与手机交互</li><li>UI感知自动化：智能导航应用界面</li><li>数据抓取：从任何应用中提取信息并结构化</li><li>可扩展性：轻松配置不同的LLM来驱动代理</li></ul><p><strong>安装配置</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/minitap-ai/mobile-use.git</span><br><span class="line"><span class="built_in">cd</span> mobile-use</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="built_in">cp</span> .env.example .<span class="built_in">env</span></span><br><span class="line"><span class="comment"># 编辑.env文件添加API密钥</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建虚拟环境</span></span><br><span class="line">uv venv</span><br><span class="line"><span class="built_in">source</span> .venv/bin/activate  <span class="comment"># Linux/macOS</span></span><br><span class="line"><span class="comment"># 或 .venv\Scripts\activate  # Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">uv <span class="built_in">sync</span></span><br></pre></td></tr></table></figure><p><strong>使用示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本命令</span></span><br><span class="line">python ./src/mobile_use/main.py <span class="string">&quot;Go to settings and tell me my current battery level&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据抓取示例</span></span><br><span class="line">python ./src/mobile_use/main.py \</span><br><span class="line">  <span class="string">&quot;Open Gmail, find all unread emails, and list their sender and subject line&quot;</span> \</span><br><span class="line">  --output-description <span class="string">&quot;A JSON list of objects, each with &#x27;sender&#x27; and &#x27;subject&#x27; keys&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker快速启动</span></span><br><span class="line">bash ./mobile-use.sh \</span><br><span class="line">  <span class="string">&quot;Open Gmail, find first 3 unread emails, and list their sender and subject line&quot;</span> \</span><br><span class="line">  --output-description <span class="string">&quot;A JSON list of objects, each with &#x27;sender&#x27; and &#x27;subject&#x27; keys&quot;</span></span><br></pre></td></tr></table></figure><p><strong>实际应用场景</strong>：</p><ul><li>自然语言自动化任务</li><li>应用数据提取和分析</li><li>复杂UI导航和操作</li><li>多步骤任务自动化</li></ul><h3 id="12-DroidRun"><a href="#12-DroidRun" class="headerlink" title="12. DroidRun"></a>12. DroidRun</h3><p><strong>项目介绍</strong>：DroidRun是一个基于大型语言模型的开源项目，通过自然语言指令实现对Android设备的自动化控制，结合计算机视觉和UI结构分析技术。</p><p><strong>GitHub地址</strong>：<a href="https://github.com/droidrun/droidrun">https://github.com/droidrun/droidrun</a></p><p><strong>核心特点</strong>：</p><ul><li>自然语言控制：通过简单指令执行复杂操作</li><li>自我修复机制：检测并修复操作错误</li><li>UI结构分析：精准识别屏幕元素</li><li>智能任务规划：自动分解复杂任务</li></ul><p><strong>安装配置</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/droidrun/droidrun.git</span><br><span class="line"><span class="built_in">cd</span> droidrun</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置环境</span></span><br><span class="line"><span class="built_in">cp</span> config.example.json config.json</span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br></pre></td></tr></table></figure><p><strong>使用示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> droidrun <span class="keyword">import</span> DroidRunAgent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建代理</span></span><br><span class="line">agent = DroidRunAgent()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自然语言控制</span></span><br><span class="line">agent.execute(<span class="string">&quot;打开微信，发送消息给张三：你好&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复杂任务</span></span><br><span class="line">agent.execute(<span class="string">&quot;打开购物应用，搜索iPhone，选择第一个商品，加入购物车&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据提取</span></span><br><span class="line">result = agent.extract_data(<span class="string">&quot;获取通讯录中所有联系人的姓名和电话&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>实际应用场景</strong>：</p><ul><li>社交媒体自动化管理</li><li>日常任务自动化执行</li><li>应用功能测试</li><li>用户行为模拟</li></ul><h3 id="13-Appium-AI-Assistant"><a href="#13-Appium-AI-Assistant" class="headerlink" title="13. Appium AI Assistant"></a>13. Appium AI Assistant</h3><p><strong>项目介绍</strong>：Appium的AI增强版本，提供智能元素定位和测试脚本生成功能。</p><p><strong>GitHub地址</strong>：<a href="https://github.com/appium-ai-assistant">https://github.com/appium-ai-assistant</a></p><p><strong>核心特点</strong>：</p><ul><li>AI元素定位</li><li>智能脚本生成</li><li>自然语言测试</li><li>自动修复测试</li></ul><p><strong>使用示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> appium_ai_assistant <span class="keyword">import</span> AppiumAIAssistant</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建AI助手</span></span><br><span class="line">assistant = AppiumAIAssistant()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 智能元素定位</span></span><br><span class="line">element = assistant.find_element(<span class="string">&quot;登录按钮&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行操作</span></span><br><span class="line">assistant.click(element)</span><br><span class="line">assistant.input_text(<span class="string">&quot;用户名输入框&quot;</span>, <span class="string">&quot;testuser&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成测试脚本</span></span><br><span class="line">script = assistant.generate_script()</span><br></pre></td></tr></table></figure><h2 id="工具对比分析"><a href="#工具对比分析" class="headerlink" title="工具对比分析"></a>工具对比分析</h2><h3 id="功能对比表"><a href="#功能对比表" class="headerlink" title="功能对比表"></a>功能对比表</h3><table><thead><tr><th>工具名称</th><th>学习成本</th><th>功能丰富度</th><th>AI支持</th><th>社区活跃度</th><th>适用场景</th></tr></thead><tbody><tr><td>Appium</td><td>中等</td><td>高</td><td>无</td><td>高</td><td>企业级测试</td></tr><tr><td>UIAutomator2</td><td>低</td><td>中</td><td>无</td><td>中</td><td>原生应用测试</td></tr><tr><td>Airtest</td><td>低</td><td>高</td><td>基础</td><td>中</td><td>游戏测试</td></tr><tr><td>STF</td><td>高</td><td>中</td><td>无</td><td>中</td><td>设备管理</td></tr><tr><td>Appium AI</td><td>中等</td><td>高</td><td>高</td><td>中</td><td>智能测试</td></tr><tr><td>Test.ai</td><td>高</td><td>高</td><td>高</td><td>低</td><td>AI测试平台</td></tr><tr><td>Katalon</td><td>低</td><td>高</td><td>中</td><td>高</td><td>可视化测试</td></tr><tr><td>Android UI Automator AI</td><td>高</td><td>高</td><td>高</td><td>低</td><td>深度学习测试</td></tr><tr><td>Mobile-Use</td><td>低</td><td>高</td><td>高</td><td>高</td><td>自然语言自动化</td></tr><tr><td>DroidRun</td><td>中等</td><td>高</td><td>高</td><td>中</td><td>智能任务执行</td></tr></tbody></table><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>这篇内容刚好和之前的文章串联起来，也算是对之前相关的文章做了拓展介绍，Android自动化工具的核心在于通过ADB提供的底层接口实现对Android设备的精确控制。这些工具本质上都是ADB命令的高级封装，通过不同的技术路径来实现设备交互、UI操作和数据提取。</p><p><strong>本文核心</strong>：所有Android自动化工具都基于ADB的三大核心功能：设备管理、Shell命令执行和文件传输，实现自动化测试的目标。通过AI技术提升自动化能力，无论是LLM或者NLP都能给这类工具带来新的革命</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ADB </tag>
            
            <tag> 自动化工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ADB命令实战指南：Android调试桥的实用技巧</title>
      <link href="/2025/09/18/article13_adb_commands/"/>
      <url>/2025/09/18/article13_adb_commands/</url>
      
        <content type="html"><![CDATA[<h2 id="ADB简介"><a href="#ADB简介" class="headerlink" title="ADB简介"></a>ADB简介</h2><h3 id="什么是ADB"><a href="#什么是ADB" class="headerlink" title="什么是ADB"></a>什么是ADB</h3><p><strong>ADB</strong>（Android Debug Bridge）是Android SDK提供的一个命令行工具，主要功能：</p><ul><li>连接Android设备</li><li>执行Shell命令</li><li>文件传输</li><li>应用管理</li><li>调试支持</li></ul><h3 id="核心优势"><a href="#核心优势" class="headerlink" title="核心优势"></a>核心优势</h3><ul><li><strong>功能全面</strong>：涵盖设备管理、文件操作、应用调试等</li><li><strong>跨平台</strong>：支持Windows、macOS、Linux</li><li><strong>简单易用</strong>：命令行操作，学习成本低</li><li><strong>社区支持</strong>：文档完善，问题容易解决</li></ul><span id="more"></span><h2 id="ADB安装配置"><a href="#ADB安装配置" class="headerlink" title="ADB安装配置"></a>ADB安装配置</h2><h3 id="1-安装ADB"><a href="#1-安装ADB" class="headerlink" title="1. 安装ADB"></a>1. 安装ADB</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows - 下载Android SDK Platform Tools</span></span><br><span class="line"><span class="comment"># 从 https://developer.android.com/studio/releases/platform-tools 下载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># macOS - 使用Homebrew</span></span><br><span class="line">brew install android-platform-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux - 使用包管理器</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install android-tools-adb</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="built_in">sudo</span> yum install android-tools</span><br></pre></td></tr></table></figure><h3 id="2-环境配置"><a href="#2-环境配置" class="headerlink" title="2. 环境配置"></a>2. 环境配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加到环境变量</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/path/to/platform-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">adb version</span><br></pre></td></tr></table></figure><h3 id="3-设备连接"><a href="#3-设备连接" class="headerlink" title="3. 设备连接"></a>3. 设备连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看连接的设备</span></span><br><span class="line">adb devices</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接USB设备</span></span><br><span class="line">adb connect 192.168.1.100:5555</span><br><span class="line"></span><br><span class="line"><span class="comment"># 断开设备</span></span><br><span class="line">adb disconnect 192.168.1.100:5555</span><br></pre></td></tr></table></figure><h2 id="设备管理场景"><a href="#设备管理场景" class="headerlink" title="设备管理场景"></a>设备管理场景</h2><h3 id="场景1：设备状态检查"><a href="#场景1：设备状态检查" class="headerlink" title="场景1：设备状态检查"></a>场景1：设备状态检查</h3><p><strong>实际需求</strong>：检查Android设备连接状态和基本信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查看所有连接的设备</span></span><br><span class="line">adb devices</span><br><span class="line"><span class="comment"># 输出示例：</span></span><br><span class="line"><span class="comment"># List of devices attached</span></span><br><span class="line"><span class="comment"># emulator-5554   device</span></span><br><span class="line"><span class="comment"># 192.168.1.100:5555   device</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看设备详细信息</span></span><br><span class="line">adb -s emulator-5554 shell getprop ro.build.version.release</span><br><span class="line"><span class="comment"># 输出：11</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看设备型号</span></span><br><span class="line">adb shell getprop ro.product.model</span><br><span class="line"><span class="comment"># 输出：Pixel 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 查看设备序列号</span></span><br><span class="line">adb shell getprop ro.serialno</span><br><span class="line"><span class="comment"># 输出：HT7A1A123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 查看设备状态</span></span><br><span class="line">adb get-state</span><br><span class="line"><span class="comment"># 输出：device</span></span><br></pre></td></tr></table></figure><h3 id="场景2：设备重启和恢复"><a href="#场景2：设备重启和恢复" class="headerlink" title="场景2：设备重启和恢复"></a>场景2：设备重启和恢复</h3><p><strong>实际需求</strong>：设备出现问题时需要重启或恢复</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 重启设备</span></span><br><span class="line">adb reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 重启到Recovery模式</span></span><br><span class="line">adb reboot recovery</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 重启到Bootloader模式</span></span><br><span class="line">adb reboot bootloader</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 重启到Fastboot模式</span></span><br><span class="line">adb reboot fastboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 强制重启（设备无响应时）</span></span><br><span class="line">adb kill-server</span><br><span class="line">adb start-server</span><br></pre></td></tr></table></figure><h2 id="文件操作场景"><a href="#文件操作场景" class="headerlink" title="文件操作场景"></a>文件操作场景</h2><h3 id="场景3：文件传输"><a href="#场景3：文件传输" class="headerlink" title="场景3：文件传输"></a>场景3：文件传输</h3><p><strong>实际需求</strong>：在PC和Android设备之间传输文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 从PC推送到设备</span></span><br><span class="line">adb push local_file.txt /sdcard/remote_file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 从设备拉取到PC</span></span><br><span class="line">adb pull /sdcard/remote_file.txt local_file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 推送整个目录</span></span><br><span class="line">adb push local_folder/ /sdcard/remote_folder/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 拉取整个目录</span></span><br><span class="line">adb pull /sdcard/remote_folder/ local_folder/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 查看设备存储空间</span></span><br><span class="line">adb shell <span class="built_in">df</span> -h</span><br><span class="line"><span class="comment"># 输出示例：</span></span><br><span class="line"><span class="comment"># Filesystem      Size  Used Avail Use% Mounted on</span></span><br><span class="line"><span class="comment"># /dev/block/sda1  32G   15G   17G  47% /</span></span><br></pre></td></tr></table></figure><h3 id="场景4：文件管理"><a href="#场景4：文件管理" class="headerlink" title="场景4：文件管理"></a>场景4：文件管理</h3><p><strong>实际需求</strong>：管理Android设备上的文件和目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 列出目录内容</span></span><br><span class="line">adb shell <span class="built_in">ls</span> -la /sdcard/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建目录</span></span><br><span class="line">adb shell <span class="built_in">mkdir</span> /sdcard/new_folder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除文件</span></span><br><span class="line">adb shell <span class="built_in">rm</span> /sdcard/unwanted_file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 删除目录</span></span><br><span class="line">adb shell <span class="built_in">rm</span> -rf /sdcard/unwanted_folder/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 复制文件</span></span><br><span class="line">adb shell <span class="built_in">cp</span> /sdcard/source.txt /sdcard/destination.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 移动文件</span></span><br><span class="line">adb shell <span class="built_in">mv</span> /sdcard/old_name.txt /sdcard/new_name.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 查看文件内容</span></span><br><span class="line">adb shell <span class="built_in">cat</span> /sdcard/config.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 搜索文件</span></span><br><span class="line">adb shell find /sdcard -name <span class="string">&quot;*.apk&quot;</span> -<span class="built_in">type</span> f</span><br></pre></td></tr></table></figure><h2 id="应用管理场景"><a href="#应用管理场景" class="headerlink" title="应用管理场景"></a>应用管理场景</h2><h3 id="场景5：应用安装和卸载"><a href="#场景5：应用安装和卸载" class="headerlink" title="场景5：应用安装和卸载"></a>场景5：应用安装和卸载</h3><p><strong>实际需求</strong>：安装、卸载和管理Android应用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 安装APK文件</span></span><br><span class="line">adb install app.apk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 强制安装（覆盖现有应用）</span></span><br><span class="line">adb install -r app.apk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 安装到指定位置</span></span><br><span class="line">adb install -s app.apk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 卸载应用</span></span><br><span class="line">adb uninstall com.example.app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 卸载应用并保留数据</span></span><br><span class="line">adb uninstall -k com.example.app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 查看已安装的应用</span></span><br><span class="line">adb shell pm list packages</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 查看特定应用</span></span><br><span class="line">adb shell pm list packages | grep example</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 查看应用详细信息</span></span><br><span class="line">adb shell dumpsys package com.example.app</span><br></pre></td></tr></table></figure><h3 id="场景6：应用调试"><a href="#场景6：应用调试" class="headerlink" title="场景6：应用调试"></a>场景6：应用调试</h3><p><strong>实际需求</strong>：调试Android应用，查看日志和状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查看所有日志</span></span><br><span class="line">adb logcat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看特定应用的日志</span></span><br><span class="line">adb logcat | grep com.example.app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看错误日志</span></span><br><span class="line">adb logcat *:E</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 清除日志</span></span><br><span class="line">adb logcat -c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 启动应用</span></span><br><span class="line">adb shell am start -n com.example.app/.MainActivity</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 停止应用</span></span><br><span class="line">adb shell am force-stop com.example.app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 查看应用进程</span></span><br><span class="line">adb shell ps | grep com.example.app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 查看应用内存使用</span></span><br><span class="line">adb shell dumpsys meminfo com.example.app</span><br></pre></td></tr></table></figure><h2 id="系统调试场景"><a href="#系统调试场景" class="headerlink" title="系统调试场景"></a>系统调试场景</h2><h3 id="场景7：系统信息获取"><a href="#场景7：系统信息获取" class="headerlink" title="场景7：系统信息获取"></a>场景7：系统信息获取</h3><p><strong>实际需求</strong>：获取Android系统的详细信息和状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查看系统版本</span></span><br><span class="line">adb shell getprop ro.build.version.release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看API级别</span></span><br><span class="line">adb shell getprop ro.build.version.sdk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看设备信息</span></span><br><span class="line">adb shell getprop ro.product.model</span><br><span class="line">adb shell getprop ro.product.brand</span><br><span class="line">adb shell getprop ro.product.manufacturer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看系统属性</span></span><br><span class="line">adb shell getprop | grep ro.build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 查看网络信息</span></span><br><span class="line">adb shell ifconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 查看进程信息</span></span><br><span class="line">adb shell ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 查看内存使用</span></span><br><span class="line">adb shell <span class="built_in">cat</span> /proc/meminfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 查看CPU信息</span></span><br><span class="line">adb shell <span class="built_in">cat</span> /proc/cpuinfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 查看存储信息</span></span><br><span class="line">adb shell <span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure><h3 id="场景8：权限和Root操作"><a href="#场景8：权限和Root操作" class="headerlink" title="场景8：权限和Root操作"></a>场景8：权限和Root操作</h3><p><strong>实际需求</strong>：获取Root权限并执行系统级操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 获取Root权限</span></span><br><span class="line">adb shell su</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 以Root身份执行命令</span></span><br><span class="line">adb shell su -c <span class="string">&quot;ls /data&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 修改文件权限</span></span><br><span class="line">adb shell su -c <span class="string">&quot;chmod 777 /data/local/tmp/file.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 修改文件所有者</span></span><br><span class="line">adb shell su -c <span class="string">&quot;chown root:root /data/local/tmp/file.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 挂载文件系统为可写</span></span><br><span class="line">adb shell su -c <span class="string">&quot;mount -o remount,rw /system&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 查看Root相关文件</span></span><br><span class="line">adb shell su -c <span class="string">&quot;ls -la /system/bin/su&quot;</span></span><br><span class="line">adb shell su -c <span class="string">&quot;ls -la /system/xbin/su&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 检查Root状态</span></span><br><span class="line">adb shell su -c <span class="string">&quot;id&quot;</span></span><br><span class="line"><span class="comment"># 输出：uid=0(root) gid=0(root) groups=0(root)</span></span><br></pre></td></tr></table></figure><h2 id="网络调试场景"><a href="#网络调试场景" class="headerlink" title="网络调试场景"></a>网络调试场景</h2><h3 id="场景9：网络配置和监控"><a href="#场景9：网络配置和监控" class="headerlink" title="场景9：网络配置和监控"></a>场景9：网络配置和监控</h3><p><strong>实际需求</strong>：配置网络设置和监控网络流量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查看网络接口</span></span><br><span class="line">adb shell ifconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看路由表</span></span><br><span class="line">adb shell ip route</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 测试网络连接</span></span><br><span class="line">adb shell ping 8.8.8.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 查看网络统计</span></span><br><span class="line">adb shell <span class="built_in">cat</span> /proc/net/dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 查看网络连接</span></span><br><span class="line">adb shell netstat -an</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 查看DNS设置</span></span><br><span class="line">adb shell getprop net.dns1</span><br><span class="line">adb shell getprop net.dns2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 设置代理</span></span><br><span class="line">adb shell settings put global http_proxy 192.168.1.100:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 清除代理</span></span><br><span class="line">adb shell settings delete global http_proxy</span><br></pre></td></tr></table></figure><h3 id="场景10：端口转发和代理"><a href="#场景10：端口转发和代理" class="headerlink" title="场景10：端口转发和代理"></a>场景10：端口转发和代理</h3><p><strong>实际需求</strong>：设置端口转发和代理服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 端口转发</span></span><br><span class="line">adb forward tcp:8080 tcp:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看端口转发</span></span><br><span class="line">adb forward --list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除端口转发</span></span><br><span class="line">adb forward --remove tcp:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 反向端口转发</span></span><br><span class="line">adb reverse tcp:8080 tcp:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 查看反向端口转发</span></span><br><span class="line">adb reverse --list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 删除反向端口转发</span></span><br><span class="line">adb reverse --remove tcp:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 通过ADB连接设备</span></span><br><span class="line">adb connect 192.168.1.100:5555</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 断开ADB连接</span></span><br><span class="line">adb disconnect 192.168.1.100:5555</span><br></pre></td></tr></table></figure><h2 id="安全测试场景"><a href="#安全测试场景" class="headerlink" title="安全测试场景"></a>安全测试场景</h2><h3 id="场景11：应用安全测试"><a href="#场景11：应用安全测试" class="headerlink" title="场景11：应用安全测试"></a>场景11：应用安全测试</h3><p><strong>实际需求</strong>：进行Android应用的安全测试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 导出APK文件</span></span><br><span class="line">adb shell pm path com.example.app</span><br><span class="line">adb pull /data/app/com.example.app/base.apk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看应用权限</span></span><br><span class="line">adb shell dumpsys package com.example.app | grep permission</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看应用组件</span></span><br><span class="line">adb shell dumpsys package com.example.app | grep -E <span class="string">&quot;Activity|Service|Receiver&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 查看应用数据目录</span></span><br><span class="line">adb shell <span class="built_in">ls</span> -la /data/data/com.example.app/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 备份应用数据</span></span><br><span class="line">adb backup -f backup.ab com.example.app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 恢复应用数据</span></span><br><span class="line">adb restore backup.ab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 查看应用日志</span></span><br><span class="line">adb logcat | grep -E <span class="string">&quot;Security|Permission|Exception&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 监控网络流量</span></span><br><span class="line">adb shell tcpdump -i any -w /sdcard/capture.pcap</span><br></pre></td></tr></table></figure><h3 id="场景12：系统安全检测"><a href="#场景12：系统安全检测" class="headerlink" title="场景12：系统安全检测"></a>场景12：系统安全检测</h3><p><strong>实际需求</strong>：检测Android系统的安全状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 检查Root状态</span></span><br><span class="line">adb shell su -c <span class="string">&quot;id&quot;</span></span><br><span class="line">adb shell <span class="built_in">ls</span> -la /system/bin/su</span><br><span class="line">adb shell <span class="built_in">ls</span> -la /system/xbin/su</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查调试状态</span></span><br><span class="line">adb shell getprop ro.debuggable</span><br><span class="line">adb shell getprop ro.secure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查SELinux状态</span></span><br><span class="line">adb shell getenforce</span><br><span class="line">adb shell getprop ro.build.selinux</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 检查系统完整性</span></span><br><span class="line">adb shell su -c <span class="string">&quot;ls -la /system/bin/ | grep su&quot;</span></span><br><span class="line">adb shell su -c <span class="string">&quot;ls -la /system/xbin/ | grep su&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 检查应用签名</span></span><br><span class="line">adb shell dumpsys package com.example.app | grep signatures</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 检查系统更新</span></span><br><span class="line">adb shell getprop ro.build.version.security_patch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 检查加密状态</span></span><br><span class="line">adb shell getprop ro.crypto.state</span><br><span class="line">adb shell getprop ro.crypto.type</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 检查安全补丁</span></span><br><span class="line">adb shell getprop ro.build.version.security_patch</span><br></pre></td></tr></table></figure><h2 id="高级技巧"><a href="#高级技巧" class="headerlink" title="高级技巧"></a>高级技巧</h2><h3 id="场景13：批量操作"><a href="#场景13：批量操作" class="headerlink" title="场景13：批量操作"></a>场景13：批量操作</h3><p><strong>实际需求</strong>：对多个设备或应用进行批量操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 批量安装应用</span></span><br><span class="line"><span class="keyword">for</span> device <span class="keyword">in</span> $(adb devices | grep device | <span class="built_in">cut</span> -f1); <span class="keyword">do</span></span><br><span class="line">    adb -s <span class="variable">$device</span> install app.apk</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 批量获取设备信息</span></span><br><span class="line"><span class="keyword">for</span> device <span class="keyword">in</span> $(adb devices | grep device | <span class="built_in">cut</span> -f1); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;设备: <span class="variable">$device</span>&quot;</span></span><br><span class="line">    adb -s <span class="variable">$device</span> shell getprop ro.product.model</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 批量清理日志</span></span><br><span class="line"><span class="keyword">for</span> device <span class="keyword">in</span> $(adb devices | grep device | <span class="built_in">cut</span> -f1); <span class="keyword">do</span></span><br><span class="line">    adb -s <span class="variable">$device</span> logcat -c</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 批量重启设备</span></span><br><span class="line"><span class="keyword">for</span> device <span class="keyword">in</span> $(adb devices | grep device | <span class="built_in">cut</span> -f1); <span class="keyword">do</span></span><br><span class="line">    adb -s <span class="variable">$device</span> reboot</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="场景14：自动化脚本"><a href="#场景14：自动化脚本" class="headerlink" title="场景14：自动化脚本"></a>场景14：自动化脚本</h3><p><strong>实际需求</strong>：创建自动化脚本来执行重复性任务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 自动化测试脚本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 检查设备连接</span></span><br><span class="line"><span class="keyword">if</span> [ $(adb devices | grep -c device) -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;没有连接的设备&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装测试应用</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;安装测试应用...&quot;</span></span><br><span class="line">adb install -r test_app.apk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启动应用</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;启动应用...&quot;</span></span><br><span class="line">adb shell am start -n com.test.app/.MainActivity</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 等待应用启动</span></span><br><span class="line"><span class="built_in">sleep</span> 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 执行测试</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;执行测试...&quot;</span></span><br><span class="line">adb shell input tap 500 500</span><br><span class="line">adb shell input text <span class="string">&quot;test123&quot;</span></span><br><span class="line">adb shell input keyevent 66</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 收集日志</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;收集日志...&quot;</span></span><br><span class="line">adb logcat -d &gt; test_log.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 清理</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;清理...&quot;</span></span><br><span class="line">adb shell am force-stop com.test.app</span><br><span class="line">adb uninstall com.test.app</span><br></pre></td></tr></table></figure><h2 id="常用脚本"><a href="#常用脚本" class="headerlink" title="常用脚本"></a>常用脚本</h2><h3 id="1-设备信息收集脚本"><a href="#1-设备信息收集脚本" class="headerlink" title="1. 设备信息收集脚本"></a>1. 设备信息收集脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 设备信息收集脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 设备信息收集 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设备基本信息</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;设备型号: <span class="subst">$(adb shell getprop ro.product.model)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Android版本: <span class="subst">$(adb shell getprop ro.build.version.release)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;API级别: <span class="subst">$(adb shell getprop ro.build.version.sdk)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;设备品牌: <span class="subst">$(adb shell getprop ro.product.brand)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;制造商: <span class="subst">$(adb shell getprop ro.product.manufacturer)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统信息</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Root状态: <span class="subst">$(adb shell su -c &#x27;id&#x27; 2&gt;/dev/null &amp;&amp; echo &#x27;已Root&#x27; || echo &#x27;未Root&#x27;)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;调试状态: <span class="subst">$(adb shell getprop ro.debuggable)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;SELinux状态: <span class="subst">$(adb shell getenforce)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储信息</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;存储信息:&quot;</span></span><br><span class="line">adb shell <span class="built_in">df</span> -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络信息</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;网络接口:&quot;</span></span><br><span class="line">adb shell ifconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进程信息</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;运行进程数: <span class="subst">$(adb shell ps | wc -l)</span>&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-应用分析脚本"><a href="#2-应用分析脚本" class="headerlink" title="2. 应用分析脚本"></a>2. 应用分析脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 应用分析脚本</span></span><br><span class="line"></span><br><span class="line">APP_PACKAGE=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$APP_PACKAGE</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;用法: <span class="variable">$0</span> &lt;应用包名&gt;&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 分析应用: <span class="variable">$APP_PACKAGE</span> ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用基本信息</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;应用版本: <span class="subst">$(adb shell dumpsys package $APP_PACKAGE | grep versionName)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;应用权限:&quot;</span></span><br><span class="line">adb shell dumpsys package <span class="variable">$APP_PACKAGE</span> | grep permission</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用组件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;应用组件:&quot;</span></span><br><span class="line">adb shell dumpsys package <span class="variable">$APP_PACKAGE</span> | grep -E <span class="string">&quot;Activity|Service|Receiver&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用数据</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;应用数据目录:&quot;</span></span><br><span class="line">adb shell <span class="built_in">ls</span> -la /data/data/<span class="variable">$APP_PACKAGE</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用日志</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;应用日志:&quot;</span></span><br><span class="line">adb logcat | grep <span class="variable">$APP_PACKAGE</span></span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>ADB在实际应用中可以说是移动安全测试的”万能钥匙”，它的作用远不止简单的设备连接这么简单。</p><p>在移动安全测试中，ADB主要承担着设备管理、应用分析、文件操作、系统调试、网络分析和安全检测等六大核心功能。它能够快速检查设备状态、安装卸载应用、传输敏感文件、获取Root权限、配置网络设置，以及检查系统安全状态，为安全研究员提供了与Android设备交互的完整解决方案。</p><p>在实际工作场景中，ADB广泛应用于渗透测试、逆向分析、漏洞挖掘、应急响应和自动化测试等领域。无论是快速部署测试环境、提取分析APK文件、监控应用行为、进行安全评估，还是编写自动化脚本，ADB都是不可或缺的基础工具，让安全研究员能够高效地完成各种移动安全测试任务。</p><p><strong>核心价值</strong>：<br>ADB最大的价值在于它提供了与Android设备交互的标准化接口，让安全研究员能够像操作本地系统一样操作Android设备。无论是设备管理、应用分析还是安全测试，ADB都是不可或缺的基础工具。它虽然不是最炫酷的工具，但确实是最实用、最可靠的选择。</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ADB </tag>
            
            <tag> 命令实战 </tag>
            
            <tag> 指南 </tag>
            
            <tag> 调试桥 </tag>
            
            <tag> 实用技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Objection使用指南：基于Frida的移动安全测试神器</title>
      <link href="/2025/09/16/article12_objection_usage/"/>
      <url>/2025/09/16/article12_objection_usage/</url>
      
        <content type="html"><![CDATA[<h2 id="Objection简介"><a href="#Objection简介" class="headerlink" title="Objection简介"></a>Objection简介</h2><h3 id="什么是Objection"><a href="#什么是Objection" class="headerlink" title="什么是Objection"></a>什么是Objection</h3><p><strong>Objection</strong>是一个基于Frida的移动安全测试工具，主要特点：</p><ul><li>基于Frida构建，功能强大</li><li>命令行界面，操作简单</li><li>内置常用Hook脚本</li><li>支持Android和iOS平台<br><strong>github地址</strong>: <a href="https://github.com/sensepost/objection">https://github.com/sensepost/objection</a></li></ul><span id="more"></span><h3 id="核心优势"><a href="#核心优势" class="headerlink" title="核心优势"></a>核心优势</h3><ul><li><strong>易用性</strong>：简单的命令行操作</li><li><strong>功能丰富</strong>：内置多种安全测试功能</li><li><strong>基于Frida</strong>：继承Frida的强大能力</li><li><strong>社区活跃</strong>：持续更新和维护</li></ul><h2 id="Objection安装配置"><a href="#Objection安装配置" class="headerlink" title="Objection安装配置"></a>Objection安装配置</h2><h3 id="1-安装Objection"><a href="#1-安装Objection" class="headerlink" title="1. 安装Objection"></a>1. 安装Objection</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装Objection</span></span><br><span class="line">pip install objection</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">objection --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看帮助</span></span><br><span class="line">objection --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h3 id="2-Android环境配置"><a href="#2-Android环境配置" class="headerlink" title="2. Android环境配置"></a>2. Android环境配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确保Frida Server已启动</span></span><br><span class="line">adb shell /data/local/tmp/frida-server &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出设备</span></span><br><span class="line">frida-ls-devices</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出进程</span></span><br><span class="line">frida-ps -U</span><br></pre></td></tr></table></figure><h3 id="3-连接设备"><a href="#3-连接设备" class="headerlink" title="3. 连接设备"></a>3. 连接设备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接Android设备</span></span><br><span class="line">objection -g com.example.app explore</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接iOS设备</span></span><br><span class="line">objection -g com.example.app -N explore</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定设备连接</span></span><br><span class="line">objection -g com.example.app -d 设备ID explore</span><br></pre></td></tr></table></figure><h2 id="基础使用命令"><a href="#基础使用命令" class="headerlink" title="基础使用命令"></a>基础使用命令</h2><h3 id="1-环境信息"><a href="#1-环境信息" class="headerlink" title="1. 环境信息"></a>1. 环境信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看环境信息</span></span><br><span class="line"><span class="built_in">env</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看设备信息</span></span><br><span class="line">device info</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看应用信息</span></span><br><span class="line">app info</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内存信息</span></span><br><span class="line">memory list modules</span><br></pre></td></tr></table></figure><h3 id="2-文件系统操作"><a href="#2-文件系统操作" class="headerlink" title="2. 文件系统操作"></a>2. 文件系统操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出文件</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件内容</span></span><br><span class="line"><span class="built_in">cat</span> /path/to/file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line">file download /path/to/file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传文件</span></span><br><span class="line">file upload local_file /path/to/remote</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件权限</span></span><br><span class="line"><span class="built_in">ls</span> -la</span><br></pre></td></tr></table></figure><h3 id="3-进程管理"><a href="#3-进程管理" class="headerlink" title="3. 进程管理"></a>3. 进程管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出进程</span></span><br><span class="line">ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看进程详情</span></span><br><span class="line">ps | grep target</span><br><span class="line"></span><br><span class="line"><span class="comment"># 杀死进程</span></span><br><span class="line"><span class="built_in">kill</span> &lt;pid&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看进程内存</span></span><br><span class="line">memory list modules</span><br></pre></td></tr></table></figure><h2 id="核心功能模块"><a href="#核心功能模块" class="headerlink" title="核心功能模块"></a>核心功能模块</h2><h3 id="1-内存分析"><a href="#1-内存分析" class="headerlink" title="1. 内存分析"></a>1. 内存分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看内存模块</span></span><br><span class="line">memory list modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索内存</span></span><br><span class="line">memory search --string <span class="string">&quot;target_string&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索模式</span></span><br><span class="line">memory search --pattern <span class="string">&quot;41 42 43 44&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内存区域</span></span><br><span class="line">memory list ranges</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取内存</span></span><br><span class="line">memory <span class="built_in">read</span> &lt;address&gt; &lt;size&gt;</span><br></pre></td></tr></table></figure><h3 id="2-Hook功能"><a href="#2-Hook功能" class="headerlink" title="2. Hook功能"></a>2. Hook功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hook Java方法</span></span><br><span class="line">android hooking list classes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索类</span></span><br><span class="line">android hooking list classes | grep -i target</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook方法</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.targetMethod&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook所有方法</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.*&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook构造函数</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.<span class="variable">$init</span>&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="3-网络监控"><a href="#3-网络监控" class="headerlink" title="3. 网络监控"></a>3. 网络监控</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控网络</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;okhttp3.OkHttpClient.newCall&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控HTTP请求</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;okhttp3.Request<span class="variable">$Builder</span>.build&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控SSL</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;javax.net.ssl.SSLContext.init&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="4-加密分析"><a href="#4-加密分析" class="headerlink" title="4. 加密分析"></a>4. 加密分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hook加密函数</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;javax.crypto.Cipher.doFinal&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook哈希函数</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.security.MessageDigest.digest&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook随机数生成</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.security.SecureRandom.nextBytes&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h2 id="实用Hook技巧"><a href="#实用Hook技巧" class="headerlink" title="实用Hook技巧"></a>实用Hook技巧</h2><h3 id="1-绕过Root检测"><a href="#1-绕过Root检测" class="headerlink" title="1. 绕过Root检测"></a>1. 绕过Root检测</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hook文件存在检查</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.io.File.exists&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook系统属性获取</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.os.SystemProperties.get&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook进程检查</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.lang.Runtime.exec&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="2-绕过SSL-Pinning"><a href="#2-绕过SSL-Pinning" class="headerlink" title="2. 绕过SSL Pinning"></a>2. 绕过SSL Pinning</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hook证书验证</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;javax.net.ssl.X509TrustManager.checkServerTrusted&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook SSL上下文</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;javax.net.ssl.SSLContext.init&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook证书固定</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;okhttp3.CertificatePinner.check&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="3-监控数据库操作"><a href="#3-监控数据库操作" class="headerlink" title="3. 监控数据库操作"></a>3. 监控数据库操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hook SQLite操作</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.database.sqlite.SQLiteDatabase.execSQL&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook数据库查询</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.database.sqlite.SQLiteDatabase.query&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook数据库插入</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.database.sqlite.SQLiteDatabase.insert&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h2 id="高级功能"><a href="#高级功能" class="headerlink" title="高级功能"></a>高级功能</h2><h3 id="1-内存搜索"><a href="#1-内存搜索" class="headerlink" title="1. 内存搜索"></a>1. 内存搜索</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索字符串</span></span><br><span class="line">memory search --string <span class="string">&quot;password&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索十六进制</span></span><br><span class="line">memory search --pattern <span class="string">&quot;41 42 43 44&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索正则表达式</span></span><br><span class="line">memory search --regex <span class="string">&quot;.*password.*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索范围</span></span><br><span class="line">memory search --string <span class="string">&quot;target&quot;</span> --range 0x1000 0x2000</span><br></pre></td></tr></table></figure><h3 id="2-内存修改"><a href="#2-内存修改" class="headerlink" title="2. 内存修改"></a>2. 内存修改</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改内存</span></span><br><span class="line">memory write &lt;address&gt; &lt;value&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改字符串</span></span><br><span class="line">memory write_string &lt;address&gt; <span class="string">&quot;new_string&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改字节</span></span><br><span class="line">memory write_bytes &lt;address&gt; <span class="string">&quot;41 42 43 44&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3-动态分析"><a href="#3-动态分析" class="headerlink" title="3. 动态分析"></a>3. 动态分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 动态Hook</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.targetMethod&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时监控</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.*&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 条件Hook</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.targetMethod&quot;</span> --dump-args --dump-return --dump-backtrace</span><br></pre></td></tr></table></figure><h2 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h2><h3 id="案例1：绕过银行APP检测"><a href="#案例1：绕过银行APP检测" class="headerlink" title="案例1：绕过银行APP检测"></a>案例1：绕过银行APP检测</h3><p>这个案例演示如何使用Objection绕过银行APP的各种安全检测机制：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Objection并连接银行APP</span></span><br><span class="line">objection -g com.bank.app explore</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Hook Root检测 - 绕过Root权限检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.bank.security.RootDetector.isRooted&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Hook调试检测 - 绕过调试模式检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.bank.security.DebugDetector.isDebugging&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Hook文件检查 - 隐藏Root相关文件</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.io.File.exists&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Hook系统属性 - 伪造系统属性值</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.os.SystemProperties.get&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. Hook进程检查 - 隐藏Root相关进程</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.lang.Runtime.exec&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. Hook网络检测 - 绕过网络环境检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.net.ConnectivityManager.getActiveNetworkInfo&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="案例2：分析加密算法"><a href="#案例2：分析加密算法" class="headerlink" title="案例2：分析加密算法"></a>案例2：分析加密算法</h3><p>这个案例演示如何使用Objection分析应用的加密算法和密钥管理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Objection并连接目标APP</span></span><br><span class="line">objection -g com.example.app explore</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Hook加密函数 - 获取加密输入和输出</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.Crypto.encrypt&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Hook解密函数 - 获取解密输入和输出</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.Crypto.decrypt&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Hook密钥生成 - 分析密钥生成过程</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.Crypto.generateKey&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Hook哈希函数 - 分析哈希算法使用</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.security.MessageDigest.digest&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. Hook随机数生成 - 分析随机数生成</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.security.SecureRandom.nextBytes&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. Hook证书操作 - 分析证书使用</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.security.cert.Certificate.getPublicKey&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="案例3：监控网络请求"><a href="#案例3：监控网络请求" class="headerlink" title="案例3：监控网络请求"></a>案例3：监控网络请求</h3><p>这个案例演示如何使用Objection监控和分析应用的网络通信：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Objection并连接目标APP</span></span><br><span class="line">objection -g com.example.app explore</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Hook HTTP请求构建 - 监控请求URL和参数</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;okhttp3.Request<span class="variable">$Builder</span>.build&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Hook HTTP响应处理 - 监控响应数据</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;okhttp3.Response.body&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Hook URL构建 - 监控URL构建过程</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;okhttp3.HttpUrl<span class="variable">$Builder</span>.build&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Hook请求头设置 - 监控请求头信息</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;okhttp3.Request<span class="variable">$Builder</span>.addHeader&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. Hook请求体设置 - 监控请求体数据</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;okhttp3.Request<span class="variable">$Builder</span>.post&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. Hook响应解析 - 监控响应解析过程</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;okhttp3.ResponseBody.string&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h2 id="Objection插件系统"><a href="#Objection插件系统" class="headerlink" title="Objection插件系统"></a>Objection插件系统</h2><h3 id="1-插件安装"><a href="#1-插件安装" class="headerlink" title="1. 插件安装"></a>1. 插件安装</h3><p>Objection支持多种插件安装方式：</p><h4 id="内置插件"><a href="#内置插件" class="headerlink" title="内置插件"></a>内置插件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有可用插件</span></span><br><span class="line">plugin list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看插件详细信息</span></span><br><span class="line">plugin show &lt;plugin_name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载插件</span></span><br><span class="line">plugin load &lt;plugin_name&gt;</span><br></pre></td></tr></table></figure><h4 id="第三方插件安装"><a href="#第三方插件安装" class="headerlink" title="第三方插件安装"></a>第三方插件安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 通过pip安装第三方插件</span></span><br><span class="line">pip install objection-plugin-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 手动安装插件</span></span><br><span class="line"><span class="comment"># 下载插件文件到 ~/.objection/plugins/ 目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ~/.objection/plugins/</span><br><span class="line"><span class="built_in">cp</span> plugin.py ~/.objection/plugins/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 重启Objection加载插件</span></span><br><span class="line">objection -g com.example.app explore</span><br></pre></td></tr></table></figure><h3 id="2-常用插件"><a href="#2-常用插件" class="headerlink" title="2. 常用插件"></a>2. 常用插件</h3><h4 id="Android-Hook插件"><a href="#Android-Hook插件" class="headerlink" title="Android Hook插件"></a>Android Hook插件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载Android Hook插件</span></span><br><span class="line">plugin load android</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook Activity生命周期</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.app.Activity.onCreate&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook Service生命周期</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.app.Service.onCreate&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hook BroadcastReceiver</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.content.BroadcastReceiver.onReceive&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h4 id="内存分析插件"><a href="#内存分析插件" class="headerlink" title="内存分析插件"></a>内存分析插件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载内存分析插件</span></span><br><span class="line">plugin load memory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索内存中的字符串</span></span><br><span class="line">memory search --string <span class="string">&quot;password&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索内存中的模式</span></span><br><span class="line">memory search --pattern <span class="string">&quot;41 42 43 44&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取内存数据</span></span><br><span class="line">memory <span class="built_in">read</span> &lt;address&gt; &lt;size&gt;</span><br></pre></td></tr></table></figure><h4 id="网络监控插件"><a href="#网络监控插件" class="headerlink" title="网络监控插件"></a>网络监控插件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载网络监控插件</span></span><br><span class="line">plugin load network</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控HTTP请求</span></span><br><span class="line">network monitor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控SSL连接</span></span><br><span class="line">network ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控DNS查询</span></span><br><span class="line">network dns</span><br></pre></td></tr></table></figure><h3 id="3-重要第三方插件"><a href="#3-重要第三方插件" class="headerlink" title="3. 重要第三方插件"></a>3. 重要第三方插件</h3><h4 id="Wallbreaker插件"><a href="#Wallbreaker插件" class="headerlink" title="Wallbreaker插件"></a>Wallbreaker插件</h4><p>Wallbreaker是一个强大的内存分析插件，专门用于Android应用的内存dump和分析：</p><p><strong>安装方法：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 下载Wallbreaker插件</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/hluwa/Wallbreaker.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装依赖</span></span><br><span class="line">pip install objection</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 将插件文件复制到Objection插件目录</span></span><br><span class="line"><span class="built_in">cp</span> Wallbreaker/objection_plugin.py ~/.objection/plugins/wallbreaker.py</span><br></pre></td></tr></table></figure><p><strong>主要功能：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Objection并加载Wallbreaker</span></span><br><span class="line">objection -g com.example.app explore</span><br><span class="line">plugin load wallbreaker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 内存搜索功能</span></span><br><span class="line"><span class="comment"># 搜索字符串</span></span><br><span class="line">memory search --string <span class="string">&quot;password&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索类名</span></span><br><span class="line">memory search --string <span class="string">&quot;com.example.TargetClass&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索方法名</span></span><br><span class="line">memory search --string <span class="string">&quot;targetMethod&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 内存dump功能</span></span><br><span class="line"><span class="comment"># 导出所有类</span></span><br><span class="line">memory <span class="built_in">export</span> classes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出特定类</span></span><br><span class="line">memory <span class="built_in">export</span> class com.example.TargetClass</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出方法</span></span><br><span class="line">memory <span class="built_in">export</span> method com.example.TargetClass.targetMethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 内存修改功能</span></span><br><span class="line"><span class="comment"># 修改内存值</span></span><br><span class="line">memory write &lt;address&gt; &lt;value&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改字符串</span></span><br><span class="line">memory write_string &lt;address&gt; <span class="string">&quot;new_string&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 内存监控功能</span></span><br><span class="line"><span class="comment"># 监控内存分配</span></span><br><span class="line">memory monitor alloc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控内存释放</span></span><br><span class="line">memory monitor free</span><br></pre></td></tr></table></figure><p><strong>实战应用：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 案例：分析加密算法</span></span><br><span class="line"><span class="comment"># 1. 搜索加密相关类</span></span><br><span class="line">memory search --string <span class="string">&quot;Cipher&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 导出加密类</span></span><br><span class="line">memory <span class="built_in">export</span> class javax.crypto.Cipher</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 监控加密方法调用</span></span><br><span class="line">memory monitor method javax.crypto.Cipher.doFinal</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 修改加密参数</span></span><br><span class="line">memory write &lt;key_address&gt; &lt;new_key&gt;</span><br></pre></td></tr></table></figure><h4 id="FRIDA-DEXDump插件"><a href="#FRIDA-DEXDump插件" class="headerlink" title="FRIDA-DEXDump插件"></a>FRIDA-DEXDump插件</h4><p>FRIDA-DEXDump是一个专门用于Android应用DEX文件dump的插件：</p><p><strong>安装方法：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 下载FRIDA-DEXDump</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/hluwa/FRIDA-DEXDump.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装依赖</span></span><br><span class="line">pip install frida</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 将插件文件复制到Objection插件目录</span></span><br><span class="line"><span class="built_in">cp</span> FRIDA-DEXDump/objection_plugin.py ~/.objection/plugins/frida_dexdump.py</span><br></pre></td></tr></table></figure><p><strong>主要功能：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Objection并加载FRIDA-DEXDump</span></span><br><span class="line">objection -g com.example.app explore</span><br><span class="line">plugin load frida_dexdump</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. DEX文件搜索</span></span><br><span class="line"><span class="comment"># 搜索内存中的DEX文件</span></span><br><span class="line">dexdump search</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索特定DEX文件</span></span><br><span class="line">dexdump search --name <span class="string">&quot;classes.dex&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. DEX文件dump</span></span><br><span class="line"><span class="comment"># 导出所有DEX文件</span></span><br><span class="line">dexdump <span class="built_in">export</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出特定DEX文件</span></span><br><span class="line">dexdump <span class="built_in">export</span> --name <span class="string">&quot;classes.dex&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出到指定目录</span></span><br><span class="line">dexdump <span class="built_in">export</span> --output /path/to/output/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. DEX文件分析</span></span><br><span class="line"><span class="comment"># 分析DEX文件结构</span></span><br><span class="line">dexdump analyze &lt;dex_file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析类信息</span></span><br><span class="line">dexdump analyze --class com.example.TargetClass</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析方法信息</span></span><br><span class="line">dexdump analyze --method com.example.TargetClass.targetMethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. DEX文件修复</span></span><br><span class="line"><span class="comment"># 修复损坏的DEX文件</span></span><br><span class="line">dexdump fix &lt;dex_file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修复并导出</span></span><br><span class="line">dexdump fix --<span class="built_in">export</span> &lt;dex_file&gt;</span><br></pre></td></tr></table></figure><p><strong>实战应用：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 案例：逆向分析应用</span></span><br><span class="line"><span class="comment"># 1. 搜索DEX文件</span></span><br><span class="line">dexdump search</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 导出DEX文件</span></span><br><span class="line">dexdump <span class="built_in">export</span> --output ./dex_files/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 分析关键类</span></span><br><span class="line">dexdump analyze --class com.example.Crypto</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 分析方法实现</span></span><br><span class="line">dexdump analyze --method com.example.Crypto.encrypt</span><br></pre></td></tr></table></figure><h3 id="4-自定义插件"><a href="#4-自定义插件" class="headerlink" title="4. 自定义插件"></a>4. 自定义插件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建自定义插件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomPlugin</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = <span class="string">&quot;custom_plugin&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.description = <span class="string">&quot;自定义插件&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 插件加载逻辑</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">unload</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 插件卸载逻辑</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册插件</span></span><br><span class="line">plugin_manager.register(CustomPlugin())</span><br></pre></td></tr></table></figure><h2 id="检测应对方法"><a href="#检测应对方法" class="headerlink" title="检测应对方法"></a>检测应对方法</h2><h3 id="1-反调试检测"><a href="#1-反调试检测" class="headerlink" title="1. 反调试检测"></a>1. 反调试检测</h3><p>当遇到反调试检测时，可以使用以下方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Hook调试检测函数</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.os.Debug.isDebuggerConnected&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Hook调试器检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.lang.System.getProperty&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Hook进程检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.app.ActivityManager.getRunningAppProcesses&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Hook调试端口检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.net.Socket.connect&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="2-反Hook检测"><a href="#2-反Hook检测" class="headerlink" title="2. 反Hook检测"></a>2. 反Hook检测</h3><p>当遇到反Hook检测时，可以使用以下方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Hook Hook检测函数</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.HookDetector.detectHook&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Hook方法替换检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.lang.reflect.Method.invoke&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Hook类加载检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.lang.ClassLoader.loadClass&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Hook异常检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.lang.Exception.printStackTrace&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="3-反Frida检测"><a href="#3-反Frida检测" class="headerlink" title="3. 反Frida检测"></a>3. 反Frida检测</h3><p>当遇到反Frida检测时，可以使用以下方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Hook Frida检测函数</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.FridaDetector.detectFrida&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Hook端口检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.net.ServerSocket.bind&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Hook进程检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.lang.Runtime.exec&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Hook文件检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.io.File.exists&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="4-反Xposed检测"><a href="#4-反Xposed检测" class="headerlink" title="4. 反Xposed检测"></a>4. 反Xposed检测</h3><p>当遇到反Xposed检测时，可以使用以下方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Hook Xposed检测函数</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.XposedDetector.detectXposed&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Hook类加载检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.lang.ClassLoader.loadClass&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Hook方法替换检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.lang.reflect.Method.invoke&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Hook异常检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;java.lang.Exception.printStackTrace&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="5-反模拟器检测"><a href="#5-反模拟器检测" class="headerlink" title="5. 反模拟器检测"></a>5. 反模拟器检测</h3><p>当遇到反模拟器检测时，可以使用以下方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Hook模拟器检测函数</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.EmulatorDetector.detectEmulator&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Hook硬件检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.os.Build.HARDWARE&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Hook属性检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.os.SystemProperties.get&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Hook传感器检测</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;android.hardware.SensorManager.getSensorList&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h2 id="常用脚本"><a href="#常用脚本" class="headerlink" title="常用脚本"></a>常用脚本</h2><h3 id="1-自动Hook脚本"><a href="#1-自动Hook脚本" class="headerlink" title="1. 自动Hook脚本"></a>1. 自动Hook脚本</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存为hook_script.js</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook文件存在检查</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">File</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.File&quot;</span>);</span><br><span class="line">    <span class="title class_">File</span>.<span class="property">exists</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> path = <span class="variable language_">this</span>.<span class="title function_">getAbsolutePath</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;检查文件: &quot;</span> + path);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (path.<span class="title function_">includes</span>(<span class="string">&quot;su&quot;</span>) || path.<span class="title function_">includes</span>(<span class="string">&quot;magisk&quot;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;隐藏Root文件: &quot;</span> + path);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">exists</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook系统属性</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">SystemProperties</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.os.SystemProperties&quot;</span>);</span><br><span class="line">    <span class="title class_">SystemProperties</span>.<span class="property">get</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>, <span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">key, def</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取属性: &quot;</span> + key);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&quot;ro.debuggable&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&quot;ro.secure&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">get</span>(key, def);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="2-使用脚本"><a href="#2-使用脚本" class="headerlink" title="2. 使用脚本"></a>2. 使用脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用自定义脚本</span></span><br><span class="line">objection -g com.example.app -l hook_script.js explore</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用Frida命令</span></span><br><span class="line">frida -U -f com.example.app -l hook_script.js --no-pause</span><br></pre></td></tr></table></figure><h2 id="高级技巧"><a href="#高级技巧" class="headerlink" title="高级技巧"></a>高级技巧</h2><h3 id="1-批量Hook"><a href="#1-批量Hook" class="headerlink" title="1. 批量Hook"></a>1. 批量Hook</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 批量Hook多个方法</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.*&quot;</span> --dump-args --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量Hook多个类</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.*.*&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h3 id="2-条件Hook"><a href="#2-条件Hook" class="headerlink" title="2. 条件Hook"></a>2. 条件Hook</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 带条件的Hook</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.targetMethod&quot;</span> --dump-args --dump-return --dump-backtrace</span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤特定参数</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.targetMethod&quot;</span> --dump-args --dump-return --dump-return</span><br></pre></td></tr></table></figure><h3 id="3-性能优化"><a href="#3-性能优化" class="headerlink" title="3. 性能优化"></a>3. 性能优化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 减少日志输出</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.targetMethod&quot;</span> --dump-args</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只Hook特定方法</span></span><br><span class="line">android hooking watch class_method <span class="string">&quot;com.example.TargetClass.specificMethod&quot;</span> --dump-args --dump-return</span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>Objection，这货现在在移动安全圈子里可以说是相当火的一个工具了。它基于Frida构建，但比直接写Frida脚本要简单得多，基本上就是”开箱即用”的感觉。</p><p>目前Objection在移动安全测试领域已经站稳了脚跟，很多安全研究员都在用它。它的优势很明显——门槛低，功能全，社区活跃。不过说实话，它也有一些局限性，比如对某些复杂的Hook场景支持还不够完善，性能上也有优化空间。比如说遇到一些特定的对frida的检测的时候，可能会需要自己添加一些特别的hook代码 —– 比如说去翻源码的agent.js的内容里加上自己的hook代码</p><p>总的来说，Objection在移动安全测试这个细分领域里算是比较实用的工具，虽然不是什么真正意义上的”神器”，但确实能解决很多实际问题。对于刚入门的朋友来说，是个不错的选择。</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Objection </tag>
            
            <tag> 使用指南 </tag>
            
            <tag> 基于Frida </tag>
            
            <tag> 移动安全测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Frida Hook技术入门：从零开始掌握动态分析神器</title>
      <link href="/2025/09/15/article11_frida_hook/"/>
      <url>/2025/09/15/article11_frida_hook/</url>
      
        <content type="html"><![CDATA[<h2 id="Frida简介"><a href="#Frida简介" class="headerlink" title="Frida简介"></a>Frida简介</h2><h3 id="什么是Frida"><a href="#什么是Frida" class="headerlink" title="什么是Frida"></a>什么是Frida</h3><p><strong>Frida</strong>是一个动态代码分析工具包，主要用于：</p><ul><li>动态Hook应用程序</li><li>实时修改程序行为</li><li>分析应用程序逻辑</li><li>绕过安全检测</li></ul><h3 id="核心特点"><a href="#核心特点" class="headerlink" title="核心特点"></a>核心特点</h3><ul><li><strong>跨平台</strong>：支持Windows、macOS、Linux、Android、iOS</li><li><strong>多语言</strong>：支持JavaScript、Python、C等</li><li><strong>易上手</strong>：简单的API设计，学习成本低</li><li><strong>功能强大</strong>：可以Hook几乎所有系统调用和API</li></ul><span id="more"></span><h2 id="Frida工作原理"><a href="#Frida工作原理" class="headerlink" title="Frida工作原理"></a>Frida工作原理</h2><h3 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">目标应用 ←→ Frida <span class="built_in">Server</span> ←→ Frida <span class="built_in">Client</span> ←→ 你的脚本</span><br><span class="line">    ↓</span><br><span class="line">注入进程 → Hook函数 → 修改行为 → 返回结果</span><br></pre></td></tr></table></figure><h3 id="Hook机制"><a href="#Hook机制" class="headerlink" title="Hook机制"></a>Hook机制</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 注入Frida Agent到目标进程</span><br><span class="line"><span class="bullet">2.</span> 定位目标函数地址</span><br><span class="line"><span class="bullet">3.</span> 替换函数入口点</span><br><span class="line"><span class="bullet">4.</span> 执行自定义逻辑</span><br><span class="line"><span class="bullet">5.</span> 调用原函数或返回自定义值</span><br></pre></td></tr></table></figure><h2 id="Frida安装配置"><a href="#Frida安装配置" class="headerlink" title="Frida安装配置"></a>Frida安装配置</h2><h3 id="1-安装Frida"><a href="#1-安装Frida" class="headerlink" title="1. 安装Frida"></a>1. 安装Frida</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装Frida客户端</span></span><br><span class="line">pip install frida-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">frida --version</span><br></pre></td></tr></table></figure><h3 id="2-Android环境配置"><a href="#2-Android环境配置" class="headerlink" title="2. Android环境配置"></a>2. Android环境配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载Frida Server</span></span><br><span class="line"><span class="comment"># 从 https://github.com/frida/frida/releases 下载对应版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送到设备</span></span><br><span class="line">adb push frida-server /data/local/tmp/</span><br><span class="line">adb shell <span class="built_in">chmod</span> 755 /data/local/tmp/frida-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Frida Server</span></span><br><span class="line">adb shell /data/local/tmp/frida-server &amp;</span><br></pre></td></tr></table></figure><h3 id="3-连接设备"><a href="#3-连接设备" class="headerlink" title="3. 连接设备"></a>3. 连接设备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接设备</span></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;设备: <span class="subst">&#123;device&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出进程</span></span><br><span class="line">processes = device.enumerate_processes()</span><br><span class="line"><span class="keyword">for</span> process <span class="keyword">in</span> processes:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;进程: <span class="subst">&#123;process.name&#125;</span> (PID: <span class="subst">&#123;process.pid&#125;</span>)&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="基础Hook示例"><a href="#基础Hook示例" class="headerlink" title="基础Hook示例"></a>基础Hook示例</h2><h3 id="1-Hook-Java方法"><a href="#1-Hook-Java方法" class="headerlink" title="1. Hook Java方法"></a>1. Hook Java方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hook Java方法示例</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook String类的equals方法</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">String</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">    <span class="title class_">String</span>.<span class="property">equals</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;String.equals被调用&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;参数: &quot;</span> + obj);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用原方法</span></span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">equals</span>(obj);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;返回值: &quot;</span> + result);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="2-Hook-Native函数"><a href="#2-Hook-Native函数" class="headerlink" title="2. Hook Native函数"></a>2. Hook Native函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hook Native函数示例</span></span><br><span class="line"><span class="keyword">var</span> libc = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strlen&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (libc) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(libc, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;strlen被调用&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;参数: &quot;</span> + <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(args[<span class="number">0</span>]));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;返回值: &quot;</span> + retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-Hook系统调用"><a href="#3-Hook系统调用" class="headerlink" title="3. Hook系统调用"></a>3. Hook系统调用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hook系统调用示例</span></span><br><span class="line"><span class="keyword">var</span> openat = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;openat&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (openat) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(openat, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(args[<span class="number">1</span>]);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;打开文件: &quot;</span> + path);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 隐藏特定文件</span></span><br><span class="line">            <span class="keyword">if</span> (path.<span class="title function_">includes</span>(<span class="string">&quot;su&quot;</span>)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;隐藏su文件访问&quot;</span>);</span><br><span class="line">                args[<span class="number">1</span>] = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;/dev/null&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实用Hook技巧"><a href="#实用Hook技巧" class="headerlink" title="实用Hook技巧"></a>实用Hook技巧</h2><h3 id="1-绕过Root检测"><a href="#1-绕过Root检测" class="headerlink" title="1. 绕过Root检测"></a>1. 绕过Root检测</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过Root检测</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook文件存在检查</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">File</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.File&quot;</span>);</span><br><span class="line">    <span class="title class_">File</span>.<span class="property">exists</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> path = <span class="variable language_">this</span>.<span class="title function_">getAbsolutePath</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;检查文件: &quot;</span> + path);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 隐藏Root相关文件</span></span><br><span class="line">        <span class="keyword">if</span> (path.<span class="title function_">includes</span>(<span class="string">&quot;su&quot;</span>) || path.<span class="title function_">includes</span>(<span class="string">&quot;magisk&quot;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;隐藏Root文件: &quot;</span> + path);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">exists</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook系统属性获取</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">SystemProperties</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.os.SystemProperties&quot;</span>);</span><br><span class="line">    <span class="title class_">SystemProperties</span>.<span class="property">get</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>, <span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">key, def</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取属性: &quot;</span> + key);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 伪造Root相关属性</span></span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&quot;ro.debuggable&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&quot;ro.secure&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">get</span>(key, def);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="2-绕过SSL-Pinning"><a href="#2-绕过SSL-Pinning" class="headerlink" title="2. 绕过SSL Pinning"></a>2. 绕过SSL Pinning</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过SSL Pinning</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook X509TrustManager</span></span><br><span class="line">    <span class="keyword">var</span> X509TrustManager = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.net.ssl.X509TrustManager&quot;</span>);</span><br><span class="line">    X509TrustManager.<span class="property">checkClientTrusted</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">chain, authType</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;绕过客户端证书检查&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    X509TrustManager.<span class="property">checkServerTrusted</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">chain, authType</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;绕过服务端证书检查&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    X509TrustManager.<span class="property">getAcceptedIssuers</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.util.ArrayList&quot;</span>).$new();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="3-监控网络请求"><a href="#3-监控网络请求" class="headerlink" title="3. 监控网络请求"></a>3. 监控网络请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监控网络请求</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook OkHttp</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">OkHttpClient</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.OkHttpClient&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Request</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.Request&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook Request.Builder</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">RequestBuilder</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.Request$Builder&quot;</span>);</span><br><span class="line">    <span class="title class_">RequestBuilder</span>.<span class="property">build</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> request = <span class="variable language_">this</span>.<span class="title function_">build</span>();</span><br><span class="line">        <span class="keyword">var</span> url = request.<span class="title function_">url</span>().<span class="title function_">toString</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;HTTP请求: &quot;</span> + url);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="进阶Hook技术"><a href="#进阶Hook技术" class="headerlink" title="进阶Hook技术"></a>进阶Hook技术</h2><h3 id="1-动态类加载"><a href="#1-动态类加载" class="headerlink" title="1. 动态类加载"></a>1. 动态类加载</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态类加载</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 等待类加载</span></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.example.TargetClass&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;找到目标实例: &quot;</span> + instance);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Hook实例方法</span></span><br><span class="line">            instance.<span class="property">targetMethod</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;目标方法被调用&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">targetMethod</span>();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;搜索完成&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="2-内存操作"><a href="#2-内存操作" class="headerlink" title="2. 内存操作"></a>2. 内存操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存操作</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 读取内存</span></span><br><span class="line">    <span class="keyword">var</span> baseAddr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&quot;libtarget.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> value = <span class="title class_">Memory</span>.<span class="title function_">readU32</span>(baseAddr.<span class="title function_">add</span>(<span class="number">0x1000</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;内存值: &quot;</span> + value);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 写入内存</span></span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">writeU32</span>(baseAddr.<span class="title function_">add</span>(<span class="number">0x1000</span>), <span class="number">0x12345678</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配内存</span></span><br><span class="line">    <span class="keyword">var</span> buffer = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">1024</span>);</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">writeUtf8String</span>(buffer, <span class="string">&quot;Hello Frida&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="3-函数替换"><a href="#3-函数替换" class="headerlink" title="3. 函数替换"></a>3. 函数替换</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数替换</span></span><br><span class="line"><span class="keyword">var</span> targetFunc = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libtarget.so&quot;</span>, <span class="string">&quot;target_function&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (targetFunc) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(targetFunc, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">arg1, arg2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;替换函数被调用&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;参数1: &quot;</span> + arg1);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;参数2: &quot;</span> + arg2);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回自定义值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x12345678</span>;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="1-基础命令"><a href="#1-基础命令" class="headerlink" title="1. 基础命令"></a>1. 基础命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出设备</span></span><br><span class="line">frida-ls-devices</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出进程</span></span><br><span class="line">frida-ps -U</span><br><span class="line"></span><br><span class="line"><span class="comment"># 附加进程</span></span><br><span class="line">frida -U -f com.example.app -l script.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动应用</span></span><br><span class="line">frida -U -f com.example.app -l script.js --no-pause</span><br></pre></td></tr></table></figure><h3 id="2-高级命令"><a href="#2-高级命令" class="headerlink" title="2. 高级命令"></a>2. 高级命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成Hook模板</span></span><br><span class="line">frida-trace -U -i <span class="string">&quot;*open*&quot;</span> com.example.app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控系统调用</span></span><br><span class="line">frida-trace -U -j <span class="string">&quot;*&quot;</span> com.example.app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出函数</span></span><br><span class="line">frida -U com.example.app -e <span class="string">&quot;console.log(Module.enumerateExports(&#x27;libc.so&#x27;))&quot;</span></span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>这篇文章主要是讲解了官方版本的Frida，另外还有一些第三方魔改的基于一定特性修改的版本这里就不展开了，有兴趣的可以自行去翻阅一下，或者后面讲一篇关于自定义自己的frida该怎么做。</p><p><strong>本文关键要点</strong>：</p><ul><li><strong>基本原理</strong>：进程注入 + 函数Hook</li><li><strong>核心功能</strong>：动态修改程序行为</li><li><strong>应用场景</strong>：安全研究、逆向分析、漏洞挖掘</li></ul>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Frida </tag>
            
            <tag> Hook </tag>
            
            <tag> 动态分析 </tag>
            
            <tag> 技术入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Magisk Root隐藏方案：Shamiko模块原理解析</title>
      <link href="/2025/09/13/article10_shamiko_analysis/"/>
      <url>/2025/09/13/article10_shamiko_analysis/</url>
      
        <content type="html"><![CDATA[<h2 id="Shamiko模块概述"><a href="#Shamiko模块概述" class="headerlink" title="Shamiko模块概述"></a>Shamiko模块概述</h2><h3 id="模块基本信息"><a href="#模块基本信息" class="headerlink" title="模块基本信息"></a>模块基本信息</h3><p><strong>开发团队</strong>：LSPosed团队<br><strong>技术基础</strong>：基于Zygisk框架<br><strong>主要功能</strong>：绕过各种Root检测</p><h3 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h3><ul><li>绕过SafetyNet检测</li><li>绕过银行APP检测</li><li>绕过游戏反作弊检测</li><li>支持多种检测方法绕过</li><li>基于Zygisk框架实现</li></ul><span id="more"></span><h2 id="Shamiko安装方法："><a href="#Shamiko安装方法：" class="headerlink" title="Shamiko安装方法："></a>Shamiko安装方法：</h2><h3 id="1-下载Shamiko模块"><a href="#1-下载Shamiko模块" class="headerlink" title="1. 下载Shamiko模块"></a>1. 下载Shamiko模块</h3><ul><li>github地址：<a href="https://github.com/LSPosed/Shamiko">https://github.com/LSPosed/Shamiko</a></li><li>从LSPosed团队官方渠道下载最新版本的Shamiko模块。</li></ul><h3 id="2-安装Shamiko模块-地址：https-magiskcn-com-shamiko-install-html"><a href="#2-安装Shamiko模块-地址：https-magiskcn-com-shamiko-install-html" class="headerlink" title="2. 安装Shamiko模块 地址：https://magiskcn.com/shamiko-install.html"></a>2. 安装Shamiko模块 地址：<a href="https://magiskcn.com/shamiko-install.html">https://magiskcn.com/shamiko-install.html</a></h3><ul><li>打开Magisk Manager应用。</li><li>打开 Magisk – 设置 – 开启 Zygisk</li><li>模块 – 从本地安装</li><li><img src="/image-1.png" alt="alt text"></li><li>选择下载的Shamiko模块文件。</li><li>安装好 Shamiko 模块，选择隐藏模式（推荐白名单模式）</li></ul><h3 id="3-推荐使用白名单模式-地址：https-magiskcn-com-shamiko-whitelist-html"><a href="#3-推荐使用白名单模式-地址：https-magiskcn-com-shamiko-whitelist-html" class="headerlink" title="3. 推荐使用白名单模式 地址：https://magiskcn.com/shamiko-whitelist.html"></a>3. 推荐使用白名单模式 地址：<a href="https://magiskcn.com/shamiko-whitelist.html">https://magiskcn.com/shamiko-whitelist.html</a></h3><ul><li>打开目录 &#x2F;data&#x2F;adb&#x2F;shamiko （推荐使用MT管理器）</li><li>创建 whitelist 文件（是文件，不是文件夹。不要搞错了哦）</li><li>重启手机，确认已切换成功<br><img src="/image.png" alt="alt text"></li></ul><h2 id="Shamiko技术原理"><a href="#Shamiko技术原理" class="headerlink" title="Shamiko技术原理"></a>Shamiko技术原理</h2><h3 id="核心隐藏机制"><a href="#核心隐藏机制" class="headerlink" title="核心隐藏机制"></a>核心隐藏机制</h3><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">应用检测<span class="built_in">Root</span> → <span class="variable">Shamiko</span>拦截 → 伪造系统信息 → 返回正常结果</span><br><span class="line">    ↓</span><br><span class="line">检测<span class="variable">su</span>命令 → 隐藏<span class="variable">su</span>文件 → 返回不存在</span><br><span class="line">    ↓</span><br><span class="line">检测<span class="built_in">Root</span>属性 → 伪造属性值 → 返回正常值</span><br><span class="line">    ↓</span><br><span class="line">检测<span class="built_in">Root</span>进程 → 隐藏进程信息 → 返回空列表</span><br></pre></td></tr></table></figure><h3 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h3><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">Zygote</span>进程启动 → 加载<span class="variable">Shamiko</span>模块 → <span class="variable">Hook</span>系统调用 → 隐藏<span class="built_in">Root</span>特征</span><br><span class="line">    ↓</span><br><span class="line">应用进程启动 → 继承<span class="variable">Shamiko</span> <span class="variable">Hook</span> → 自动隐藏<span class="built_in">Root</span> → 绕过检测</span><br><span class="line">    ↓</span><br><span class="line"><span class="variable">API</span>调用拦截 → 伪造返回值 → 应用无法检测到<span class="built_in">Root</span></span><br></pre></td></tr></table></figure><h2 id="Shamiko核心实现"><a href="#Shamiko核心实现" class="headerlink" title="Shamiko核心实现"></a>Shamiko核心实现</h2><h3 id="1-模块初始化"><a href="#1-模块初始化" class="headerlink" title="1. 模块初始化"></a>1. 模块初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shamiko模块初始化</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">shamiko_init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化Shamiko环境</span></span><br><span class="line">    <span class="keyword">if</span> (init_shamiko_env() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册系统调用Hook</span></span><br><span class="line">    <span class="keyword">if</span> (register_syscall_hooks() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启用API Hook</span></span><br><span class="line">    <span class="keyword">if</span> (enable_api_hooks() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启用属性伪造</span></span><br><span class="line">    <span class="keyword">if</span> (enable_prop_fake() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化Shamiko环境</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">init_shamiko_env</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建Shamiko工作目录</span></span><br><span class="line">    mkdir(<span class="string">&quot;/data/adb/shamiko&quot;</span>, <span class="number">0755</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载配置文件</span></span><br><span class="line">    <span class="keyword">if</span> (load_shamiko_config() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化隐藏规则</span></span><br><span class="line">    <span class="keyword">if</span> (init_hide_rules() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-系统调用Hook"><a href="#2-系统调用Hook" class="headerlink" title="2. 系统调用Hook"></a>2. 系统调用Hook</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册系统调用Hook</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">register_syscall_hooks</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Hook文件系统相关系统调用</span></span><br><span class="line">    hook_syscall(__NR_openat, shamiko_openat);</span><br><span class="line">    hook_syscall(__NR_faccessat, shamiko_faccessat);</span><br><span class="line">    hook_syscall(__NR_stat, shamiko_stat);</span><br><span class="line">    hook_syscall(__NR_newfstatat, shamiko_newfstatat);</span><br><span class="line">    hook_syscall(__NR_readlinkat, shamiko_readlinkat);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook进程相关系统调用</span></span><br><span class="line">    hook_syscall(__NR_kill, shamiko_kill);</span><br><span class="line">    hook_syscall(__NR_tgkill, shamiko_tgkill);</span><br><span class="line">    hook_syscall(__NR_tkill, shamiko_tkill);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook属性相关系统调用</span></span><br><span class="line">    hook_syscall(__NR_getprop, shamiko_getprop);</span><br><span class="line">    hook_syscall(__NR_setprop, shamiko_setprop);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-文件系统隐藏"><a href="#3-文件系统隐藏" class="headerlink" title="3. 文件系统隐藏"></a>3. 文件系统隐藏</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shamiko文件系统隐藏实现</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">shamiko_openat</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs)</span> &#123;</span><br><span class="line">    <span class="type">int</span> dirfd = regs-&gt;di;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *pathname = (<span class="type">const</span> <span class="type">char</span> *)regs-&gt;si;</span><br><span class="line">    <span class="type">int</span> flags = regs-&gt;dx;</span><br><span class="line">    <span class="type">mode_t</span> mode = regs-&gt;r10;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否为Root相关文件</span></span><br><span class="line">    <span class="keyword">if</span> (is_root_file(pathname)) &#123;</span><br><span class="line">        <span class="comment">// 返回文件不存在</span></span><br><span class="line">        regs-&gt;ax = -ENOENT;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否为su命令</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(pathname, <span class="string">&quot;su&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 重定向到不存在的文件</span></span><br><span class="line">        regs-&gt;ax = -ENOENT;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否为Magisk相关文件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(pathname, <span class="string">&quot;magisk&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 重定向到不存在的文件</span></span><br><span class="line">        regs-&gt;ax = -ENOENT;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 正常文件访问</span></span><br><span class="line">    <span class="keyword">return</span> original_openat(regs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为Root相关文件</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">is_root_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *root_files[] = &#123;</span><br><span class="line">        <span class="string">&quot;/system/app/Superuser.apk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/sbin/su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/bin/su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/xbin/su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/data/local/xbin/su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/data/local/bin/su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/etc/init.d/99SuperSUDaemon&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/dev/com.koushikdutta.superuser.daemon/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/app/Kinguser.apk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/app/KingRoot.apk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/app/360Root.apk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/data/local/tmp/su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/data/local/tmp/daemonsu&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/bin/.ext/.su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/usr/we-need-root/su-backup&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/xbin/busybox&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/bin/busybox&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(root_files)/<span class="keyword">sizeof</span>(root_files[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(pathname, root_files[i]) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查路径模式</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(pathname, <span class="string">&quot;su&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(pathname, <span class="string">&quot;magisk&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(pathname, <span class="string">&quot;superuser&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-系统属性伪造"><a href="#4-系统属性伪造" class="headerlink" title="4. 系统属性伪造"></a>4. 系统属性伪造</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shamiko系统属性伪造实现</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">shamiko_getprop</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name = (<span class="type">const</span> <span class="type">char</span> *)regs-&gt;di;</span><br><span class="line">    <span class="type">char</span> *value = (<span class="type">char</span> *)regs-&gt;si;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *default_value = (<span class="type">const</span> <span class="type">char</span> *)regs-&gt;dx;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否为Root相关属性</span></span><br><span class="line">    <span class="keyword">if</span> (is_root_prop(name)) &#123;</span><br><span class="line">        <span class="comment">// 返回伪造的属性值</span></span><br><span class="line">        <span class="built_in">strcpy</span>(value, get_fake_prop_value(name));</span><br><span class="line">        regs-&gt;ax = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 正常属性获取</span></span><br><span class="line">    <span class="keyword">return</span> original_getprop(regs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为Root相关属性</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">is_root_prop</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *root_props[] = &#123;</span><br><span class="line">        <span class="string">&quot;ro.debuggable&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.secure&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.build.selinux&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.magisk.version&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.boot.magisk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;persist.magisk.version&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.zygisk.version&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.boot.zygisk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;persist.zygisk.version&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.build.tags&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.build.type&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.kernel.qemu&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.hardware&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.product.cpu.abi&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.product.cpu.abilist&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.product.cpu.abilist32&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.product.cpu.abilist64&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(root_props)/<span class="keyword">sizeof</span>(root_props[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, root_props[i]) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查属性名模式</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(name, <span class="string">&quot;magisk&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(name, <span class="string">&quot;zygisk&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(name, <span class="string">&quot;su&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取伪造的属性值</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">get_fake_prop_value</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;ro.debuggable&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;ro.secure&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;ro.build.selinux&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;ro.build.tags&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;release-keys&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;ro.build.type&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;ro.kernel.qemu&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(name, <span class="string">&quot;magisk&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(name, <span class="string">&quot;zygisk&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(name, <span class="string">&quot;su&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-进程隐藏"><a href="#5-进程隐藏" class="headerlink" title="5. 进程隐藏"></a>5. 进程隐藏</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shamiko进程隐藏实现</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">shamiko_kill</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs)</span> &#123;</span><br><span class="line">    <span class="type">pid_t</span> pid = regs-&gt;di;</span><br><span class="line">    <span class="type">int</span> sig = regs-&gt;si;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否为Root相关进程</span></span><br><span class="line">    <span class="keyword">if</span> (is_root_process(pid)) &#123;</span><br><span class="line">        <span class="comment">// 隐藏进程，不执行kill操作</span></span><br><span class="line">        regs-&gt;ax = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 正常进程操作</span></span><br><span class="line">    <span class="keyword">return</span> original_kill(regs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为Root相关进程</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">is_root_process</span><span class="params">(<span class="type">pid_t</span> pid)</span> &#123;</span><br><span class="line">    <span class="type">char</span> path[<span class="number">256</span>];</span><br><span class="line">    <span class="type">char</span> cmdline[<span class="number">256</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">&quot;/proc/%d/cmdline&quot;</span>, pid);</span><br><span class="line">    </span><br><span class="line">    FILE *fp = fopen(path, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    fgets(cmdline, <span class="keyword">sizeof</span>(cmdline), fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查进程名</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *root_processes[] = &#123;</span><br><span class="line">        <span class="string">&quot;su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;daemonsu&quot;</span>,</span><br><span class="line">        <span class="string">&quot;magisk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;magiskd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;magiskhide&quot;</span>,</span><br><span class="line">        <span class="string">&quot;zygisk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;shamiko&quot;</span>,</span><br><span class="line">        <span class="string">&quot;kinguser&quot;</span>,</span><br><span class="line">        <span class="string">&quot;kingroot&quot;</span>,</span><br><span class="line">        <span class="string">&quot;360root&quot;</span>,</span><br><span class="line">        <span class="string">&quot;rootmaster&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(root_processes)/<span class="keyword">sizeof</span>(root_processes[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(cmdline, root_processes[i]) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-API-Hook实现"><a href="#6-API-Hook实现" class="headerlink" title="6. API Hook实现"></a>6. API Hook实现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shamiko API Hook实现</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">enable_api_hooks</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Hook Java层API</span></span><br><span class="line">    <span class="keyword">if</span> (hook_java_apis() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook Native层API</span></span><br><span class="line">    <span class="keyword">if</span> (hook_native_apis() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook Java层API</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">hook_java_apis</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Hook SystemProperties.get</span></span><br><span class="line">    <span class="keyword">if</span> (hook_java_method(<span class="string">&quot;android.os.SystemProperties&quot;</span>, <span class="string">&quot;get&quot;</span>, </span><br><span class="line">                        <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>,</span><br><span class="line">                        (<span class="type">void</span>*)shamiko_system_properties_get) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook File.exists</span></span><br><span class="line">    <span class="keyword">if</span> (hook_java_method(<span class="string">&quot;java.io.File&quot;</span>, <span class="string">&quot;exists&quot;</span>, <span class="string">&quot;()Z&quot;</span>,</span><br><span class="line">                        (<span class="type">void</span>*)shamiko_file_exists) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook ProcessBuilder</span></span><br><span class="line">    <span class="keyword">if</span> (hook_java_method(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>, <span class="string">&quot;start&quot;</span>, <span class="string">&quot;()Ljava/lang/Process;&quot;</span>,</span><br><span class="line">                        (<span class="type">void</span>*)shamiko_process_builder_start) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook SystemProperties.get</span></span><br><span class="line">jstring <span class="title function_">shamiko_system_properties_get</span><span class="params">(JNIEnv *env, jclass clazz, jstring key, jstring def)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *key_str = (*env)-&gt;GetStringUTFChars(env, key, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *def_str = (*env)-&gt;GetStringUTFChars(env, def, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否为Root相关属性</span></span><br><span class="line">    <span class="keyword">if</span> (is_root_prop(key_str)) &#123;</span><br><span class="line">        <span class="comment">// 返回伪造的属性值</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *fake_value = get_fake_prop_value(key_str);</span><br><span class="line">        jstring result = (*env)-&gt;NewStringUTF(env, fake_value);</span><br><span class="line">        </span><br><span class="line">        (*env)-&gt;ReleaseStringUTFChars(env, key, key_str);</span><br><span class="line">        (*env)-&gt;ReleaseStringUTFChars(env, def, def_str);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 正常属性获取</span></span><br><span class="line">    jstring result = original_system_properties_get(env, clazz, key, def);</span><br><span class="line">    </span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, key, key_str);</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, def, def_str);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook File.exists</span></span><br><span class="line">jboolean <span class="title function_">shamiko_file_exists</span><span class="params">(JNIEnv *env, jobject thiz)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取文件路径</span></span><br><span class="line">    jclass file_class = (*env)-&gt;GetObjectClass(env, thiz);</span><br><span class="line">    jfieldID path_field = (*env)-&gt;GetFieldID(env, file_class, <span class="string">&quot;path&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">    jstring path_obj = (jstring)(*env)-&gt;GetObjectField(env, thiz, path_field);</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *path_str = (*env)-&gt;GetStringUTFChars(env, path_obj, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否为Root相关文件</span></span><br><span class="line">    <span class="keyword">if</span> (is_root_file(path_str)) &#123;</span><br><span class="line">        (*env)-&gt;ReleaseStringUTFChars(env, path_obj, path_str);</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 正常文件检查</span></span><br><span class="line">    jboolean result = original_file_exists(env, thiz);</span><br><span class="line">    </span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, path_obj, path_str);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Shamiko检测绕过"><a href="#Shamiko检测绕过" class="headerlink" title="Shamiko检测绕过"></a>Shamiko检测绕过</h2><h3 id="1-传统检测绕过"><a href="#1-传统检测绕过" class="headerlink" title="1. 传统检测绕过"></a>1. 传统检测绕过</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统Root检测绕过</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TraditionalRootDetector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRooted</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> checkRootFiles() || </span><br><span class="line">               checkRootProps() || </span><br><span class="line">               checkRootProcesses();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkRootFiles</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] rootFiles = &#123;</span><br><span class="line">            <span class="string">&quot;/system/app/Superuser.apk&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/sbin/su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/system/bin/su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/system/xbin/su&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String file : rootFiles) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">File</span>(file).exists()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkRootProps</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] rootProps = &#123;</span><br><span class="line">            <span class="string">&quot;ro.debuggable&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ro.secure&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ro.build.selinux&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String prop : rootProps) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> SystemProperties.get(prop, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;0&quot;</span>.equals(value)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-现代检测绕过"><a href="#2-现代检测绕过" class="headerlink" title="2. 现代检测绕过"></a>2. 现代检测绕过</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 现代Root检测绕过</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModernRootDetector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRooted</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> checkMagisk() || </span><br><span class="line">               checkZygisk() || </span><br><span class="line">               checkShamiko() ||</span><br><span class="line">               checkRuntimeDetection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkMagisk</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检测Magisk特征</span></span><br><span class="line">        <span class="keyword">if</span> (checkMagiskProps()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (checkMagiskFiles()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (checkMagiskModules()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkZygisk</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检测Zygisk特征</span></span><br><span class="line">        <span class="keyword">if</span> (checkZygiskProps()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (checkZygiskFiles()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (checkZygiskModules()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkShamiko</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检测Shamiko特征</span></span><br><span class="line">        <span class="keyword">if</span> (checkShamikoProps()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (checkShamikoFiles()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (checkShamikoModules()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-反检测绕过"><a href="#3-反检测绕过" class="headerlink" title="3. 反检测绕过"></a>3. 反检测绕过</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反检测绕过</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AntiDetection</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook系统属性获取</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSystemProperty</span><span class="params">(String key, String defaultValue)</span> &#123;</span><br><span class="line">        <span class="comment">// 返回伪造的属性值</span></span><br><span class="line">        <span class="keyword">if</span> (isRootProp(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> getFakePropValue(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SystemProperties.get(key, defaultValue);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook文件存在检查</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">fileExists</span><span class="params">(String path)</span> &#123;</span><br><span class="line">        <span class="comment">// 隐藏Root相关文件</span></span><br><span class="line">        <span class="keyword">if</span> (isRootFile(path)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(path).exists();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook进程检查</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isProcessRunning</span><span class="params">(String processName)</span> &#123;</span><br><span class="line">        <span class="comment">// 隐藏Root相关进程</span></span><br><span class="line">        <span class="keyword">if</span> (isRootProcess(processName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> checkProcessRunning(processName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>Shamiko模块作为最强大的Root隐藏方案，通过全面的系统调用Hook和API拦截，几乎可以绕过所有常见的Root检测。其技术原理基于Zygisk框架，在Zygote进程启动时加载，影响所有应用进程。</p><p><strong>核心实现原理机制</strong>：基于Zygisk框架的系统调用Hook</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
          <category> Magisk模块 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Root </tag>
            
            <tag> 隐藏方案 </tag>
            
            <tag> Shamiko模块 </tag>
            
            <tag> 原理解析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android Root技术解析：从传统到现代的三种主流方案</title>
      <link href="/2025/09/12/article9_android_root_tools_v2/"/>
      <url>/2025/09/12/article9_android_root_tools_v2/</url>
      
        <content type="html"><![CDATA[<h2 id="一、低版本Android-Root方式简述"><a href="#一、低版本Android-Root方式简述" class="headerlink" title="一、低版本Android Root方式简述"></a>一、低版本Android Root方式简述</h2><h3 id="传统Root方法"><a href="#传统Root方法" class="headerlink" title="传统Root方法"></a>传统Root方法</h3><h4 id="1-漏洞利用Root"><a href="#1-漏洞利用Root" class="headerlink" title="1. 漏洞利用Root"></a>1. 漏洞利用Root</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">CVE</span>-<span class="number">2014</span>-<span class="number">3153</span> (Towelroot) - Android <span class="number">4</span>.<span class="number">4</span>及以下</span><br><span class="line"><span class="attribute">CVE</span>-<span class="number">2015</span>-<span class="number">3636</span> (PingPongRoot) - Android <span class="number">5</span>.<span class="number">0</span>-<span class="number">5</span>.<span class="number">1</span></span><br><span class="line"><span class="attribute">CVE</span>-<span class="number">2016</span>-<span class="number">5195</span> (Dirty COW) - Android <span class="number">4</span>.<span class="number">4</span>-<span class="number">7</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure><span id="more"></span><p><strong>原理</strong>：利用Linux内核漏洞直接获取Root权限</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 漏洞利用示例</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">exploit_vulnerability</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 利用futex漏洞</span></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/dev/ashmem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造恶意数据</span></span><br><span class="line">    <span class="type">char</span> exploit_data[<span class="number">1024</span>];</span><br><span class="line">    <span class="built_in">memset</span>(exploit_data, <span class="number">0x41</span>, <span class="keyword">sizeof</span>(exploit_data));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 触发漏洞获取Root</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd, ASHMEM_SET_NAME, exploit_data) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 成功</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-刷机Root"><a href="#2-刷机Root" class="headerlink" title="2. 刷机Root"></a>2. 刷机Root</h4><p><strong>原理</strong>：通过刷入修改过的boot.img获取Root权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 刷机Root过程</span></span><br><span class="line">fastboot flash boot modified_boot.img</span><br><span class="line">fastboot flash recovery custom_recovery.img</span><br><span class="line"><span class="comment"># 通过recovery刷入SuperSU.zip</span></span><br></pre></td></tr></table></figure><h4 id="3-一键Root工具"><a href="#3-一键Root工具" class="headerlink" title="3. 一键Root工具"></a>3. 一键Root工具</h4><ul><li><strong>KingRoot</strong>：多漏洞利用策略</li><li><strong>Root Master</strong>：基于漏洞利用</li><li><strong>360 Root</strong>：商业化Root方案</li></ul><h2 id="二、Magisk、APatch、KernelSU原理说明对比"><a href="#二、Magisk、APatch、KernelSU原理说明对比" class="headerlink" title="二、Magisk、APatch、KernelSU原理说明对比"></a>二、Magisk、APatch、KernelSU原理说明对比</h2><h3 id="Magisk原理"><a href="#Magisk原理" class="headerlink" title="Magisk原理"></a>Magisk原理</h3><h4 id="1-核心机制"><a href="#1-核心机制" class="headerlink" title="1. 核心机制"></a>1. 核心机制</h4><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">系统分区保持原样 → 通过<span class="variable">Hook</span>机制实现<span class="built_in">Root</span></span><br><span class="line">    ↓</span><br><span class="line"><span class="variable">Zygote</span>进程<span class="variable">Hook</span> → 影响所有应用进程</span><br><span class="line">    ↓</span><br><span class="line">模块系统 → 运行时修改系统行为</span><br></pre></td></tr></table></figure><h4 id="2-技术实现"><a href="#2-技术实现" class="headerlink" title="2. 技术实现"></a>2. 技术实现</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Magisk核心Hook实现</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">magisk_hook_init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Hook关键系统调用</span></span><br><span class="line">    hook_syscall(__NR_openat, magisk_openat);</span><br><span class="line">    hook_syscall(__NR_faccessat, magisk_faccessat);</span><br><span class="line">    hook_syscall(__NR_stat, magisk_stat);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook Zygote进程</span></span><br><span class="line">    hook_zygote_process();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook openat系统调用</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">magisk_openat</span><span class="params">(<span class="type">int</span> dirfd, <span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags, <span class="type">mode_t</span> mode)</span> &#123;</span><br><span class="line">    <span class="comment">// 检查是否为su命令</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(pathname, <span class="string">&quot;su&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> original_openat(dirfd, <span class="string">&quot;/data/adb/magisk/su&quot;</span>, flags, mode);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 应用模块修改</span></span><br><span class="line">    <span class="keyword">if</span> (is_system_file(pathname)) &#123;</span><br><span class="line">        <span class="keyword">return</span> apply_magisk_modules(pathname);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> original_openat(dirfd, pathname, flags, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-Root过程"><a href="#3-Root过程" class="headerlink" title="3. Root过程"></a>3. Root过程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 刷入Magisk</span></span><br><span class="line">fastboot flash boot magisk_patched_boot.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装Magisk Manager</span></span><br><span class="line">adb install MagiskManager.apk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 配置模块</span></span><br><span class="line"><span class="comment"># 通过Magisk Manager安装模块</span></span><br></pre></td></tr></table></figure><h3 id="APatch原理"><a href="#APatch原理" class="headerlink" title="APatch原理"></a>APatch原理</h3><h4 id="1-核心机制-1"><a href="#1-核心机制-1" class="headerlink" title="1. 核心机制"></a>1. 核心机制</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">基于Magisk架构 → 增强安全特性</span><br><span class="line">    ↓</span><br><span class="line">SELinux增强 → 更好的安全保护</span><br><span class="line">    ↓</span><br><span class="line">模块签名验证 → 防止恶意模块</span><br></pre></td></tr></table></figure><h4 id="2-技术实现-1"><a href="#2-技术实现-1" class="headerlink" title="2. 技术实现"></a>2. 技术实现</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// APatch核心实现</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">apatch_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化APatch环境</span></span><br><span class="line">    <span class="keyword">if</span> (init_apatch_env() != <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册模块系统</span></span><br><span class="line">    register_module_system();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启用安全增强</span></span><br><span class="line">    enable_security_enhancements();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块加载机制</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">apatch_load_module</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *module_path)</span> &#123;</span><br><span class="line">    <span class="comment">// 验证模块签名</span></span><br><span class="line">    <span class="keyword">if</span> (!verify_module_signature(module_path)) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载模块配置</span></span><br><span class="line">    <span class="type">module_config_t</span> *config = parse_module_config(module_path);</span><br><span class="line">    <span class="keyword">if</span> (!config) <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 应用模块修改</span></span><br><span class="line">    <span class="keyword">return</span> apply_module_changes(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-Root过程-1"><a href="#3-Root过程-1" class="headerlink" title="3. Root过程"></a>3. Root过程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 刷入APatch</span></span><br><span class="line">fastboot flash boot apatch_patched_boot.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装APatch Manager</span></span><br><span class="line">adb install APatchManager.apk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 配置安全策略</span></span><br><span class="line"><span class="comment"># 通过APatch Manager配置安全选项</span></span><br></pre></td></tr></table></figure><h3 id="KernelSU原理"><a href="#KernelSU原理" class="headerlink" title="KernelSU原理"></a>KernelSU原理</h3><h4 id="1-核心机制-2"><a href="#1-核心机制-2" class="headerlink" title="1. 核心机制"></a>1. 核心机制</h4><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">内核模块实现 → 直接在内核层处理<span class="built_in">Root</span>请求</span><br><span class="line">    ↓</span><br><span class="line">系统调用<span class="variable">Hook</span> → 拦截权限检查</span><br><span class="line">    ↓</span><br><span class="line">实时权限管理 → 基于内核的权限控制</span><br></pre></td></tr></table></figure><h4 id="2-技术实现-2"><a href="#2-技术实现-2" class="headerlink" title="2. 技术实现"></a>2. 技术实现</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KernelSU内核模块</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">kernelsu_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化KernelSU</span></span><br><span class="line">    <span class="keyword">if</span> (init_kernelsu() != <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册系统调用Hook</span></span><br><span class="line">    register_syscall_hooks();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建proc文件系统接口</span></span><br><span class="line">    create_proc_interface();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统调用Hook实现</span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">kernelsu_syscall_hook</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> syscall_nr = regs-&gt;orig_ax;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (syscall_nr) &#123;</span><br><span class="line">        <span class="keyword">case</span> __NR_openat:</span><br><span class="line">            <span class="keyword">return</span> kernelsu_openat(regs);</span><br><span class="line">        <span class="keyword">case</span> __NR_execve:</span><br><span class="line">            <span class="keyword">return</span> kernelsu_execve(regs);</span><br><span class="line">        <span class="keyword">case</span> __NR_access:</span><br><span class="line">            <span class="keyword">return</span> kernelsu_access(regs);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> original_syscall(regs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-Root过程-2"><a href="#3-Root过程-2" class="headerlink" title="3. Root过程"></a>3. Root过程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 编译内核模块</span></span><br><span class="line">make -C /path/to/kernel M=<span class="variable">$PWD</span> modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 刷入支持KernelSU的内核</span></span><br><span class="line">fastboot flash boot kernelsu_boot.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 安装KernelSU Manager</span></span><br><span class="line">adb install KernelSUManager.apk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 配置权限策略</span></span><br><span class="line"><span class="comment"># 通过KernelSU Manager管理权限</span></span><br></pre></td></tr></table></figure><h2 id="三、Magisk、APatch、KernelSU对比"><a href="#三、Magisk、APatch、KernelSU对比" class="headerlink" title="三、Magisk、APatch、KernelSU对比"></a>三、Magisk、APatch、KernelSU对比</h2><h3 id="技术架构对比"><a href="#技术架构对比" class="headerlink" title="技术架构对比"></a>技术架构对比</h3><table><thead><tr><th>特性</th><th>Magisk</th><th>APatch</th><th>KernelSU</th></tr></thead><tbody><tr><td><strong>实现层级</strong></td><td>用户空间+内核</td><td>用户空间+内核</td><td>内核空间</td></tr><tr><td><strong>系统完整性</strong></td><td>保持</td><td>保持</td><td>保持</td></tr><tr><td><strong>模块化支持</strong></td><td>完整</td><td>完整</td><td>部分</td></tr><tr><td><strong>安全性</strong></td><td>高</td><td>最高</td><td>高</td></tr><tr><td><strong>性能影响</strong></td><td>低</td><td>低</td><td>最低</td></tr><tr><td><strong>设备兼容性</strong></td><td>广泛</td><td>广泛</td><td>有限</td></tr><tr><td><strong>学习成本</strong></td><td>中等</td><td>中等</td><td>高</td></tr></tbody></table><h3 id="优缺点对比"><a href="#优缺点对比" class="headerlink" title="优缺点对比"></a>优缺点对比</h3><h4 id="Magisk"><a href="#Magisk" class="headerlink" title="Magisk"></a>Magisk</h4><p><strong>优点</strong>：</p><ul><li>功能丰富，模块化支持好</li><li>社区活跃，资源丰富</li><li>设备兼容性好</li><li>可以绕过SafetyNet</li></ul><p><strong>缺点</strong>：</p><ul><li>依赖Zygote进程Hook</li><li>可能被检测和绕过</li><li>模块管理复杂</li></ul><h4 id="APatch"><a href="#APatch" class="headerlink" title="APatch"></a>APatch</h4><p><strong>优点</strong>：</p><ul><li>基于Magisk的现代化改进</li><li>增强的安全特性</li><li>更好的SELinux支持</li><li>模块签名验证</li></ul><p><strong>缺点</strong>：</p><ul><li>相对较新，稳定性待验证</li><li>社区支持有限</li><li>文档不够完善</li></ul><h4 id="KernelSU"><a href="#KernelSU" class="headerlink" title="KernelSU"></a>KernelSU</h4><p><strong>优点</strong>：</p><ul><li>内核级实现，性能最佳</li><li>难以被检测和绕过</li><li>资源占用最少</li><li>安全性最高</li></ul><p><strong>缺点</strong>：</p><ul><li>需要内核源码支持</li><li>设备兼容性有限</li><li>安装和配置复杂</li><li>对内核版本有要求</li></ul><h2 id="四、对各个Root检测方式简述"><a href="#四、对各个Root检测方式简述" class="headerlink" title="四、对各个Root检测方式简述"></a>四、对各个Root检测方式简述</h2><h3 id="传统检测方法"><a href="#传统检测方法" class="headerlink" title="传统检测方法"></a>传统检测方法</h3><h4 id="1-文件系统检测"><a href="#1-文件系统检测" class="headerlink" title="1. 文件系统检测"></a>1. 文件系统检测</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测Root相关文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkRootFiles</span><span class="params">()</span> &#123;</span><br><span class="line">    String[] rootFiles = &#123;</span><br><span class="line">        <span class="string">&quot;/system/app/Superuser.apk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/sbin/su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/bin/su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/system/xbin/su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/data/local/xbin/su&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/data/local/bin/su&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (String file : rootFiles) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">File</span>(file).exists()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-系统属性检测"><a href="#2-系统属性检测" class="headerlink" title="2. 系统属性检测"></a>2. 系统属性检测</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测Root相关属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkRootProps</span><span class="params">()</span> &#123;</span><br><span class="line">    String[] rootProps = &#123;</span><br><span class="line">        <span class="string">&quot;ro.debuggable&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.secure&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.build.selinux&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (String prop : rootProps) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> SystemProperties.get(prop, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;0&quot;</span>.equals(value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="现代检测方法"><a href="#现代检测方法" class="headerlink" title="现代检测方法"></a>现代检测方法</h3><h4 id="1-Magisk检测"><a href="#1-Magisk检测" class="headerlink" title="1. Magisk检测"></a>1. Magisk检测</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测Magisk特征</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkMagisk</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 检测Magisk属性</span></span><br><span class="line">    <span class="keyword">if</span> (checkMagiskProps()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检测Magisk文件</span></span><br><span class="line">    <span class="keyword">if</span> (checkMagiskFiles()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检测Magisk模块</span></span><br><span class="line">    <span class="keyword">if</span> (checkMagiskModules()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkMagiskProps</span><span class="params">()</span> &#123;</span><br><span class="line">    String[] magiskProps = &#123;</span><br><span class="line">        <span class="string">&quot;ro.magisk.version&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.boot.magisk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;persist.magisk.version&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (String prop : magiskProps) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> SystemProperties.get(prop, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!value.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-APatch检测"><a href="#2-APatch检测" class="headerlink" title="2. APatch检测"></a>2. APatch检测</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测APatch特征</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkAPatch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 检测APatch属性</span></span><br><span class="line">    <span class="keyword">if</span> (checkAPatchProps()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检测APatch文件</span></span><br><span class="line">    <span class="keyword">if</span> (checkAPatchFiles()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检测APatch模块</span></span><br><span class="line">    <span class="keyword">if</span> (checkAPatchModules()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkAPatchProps</span><span class="params">()</span> &#123;</span><br><span class="line">    String[] apatchProps = &#123;</span><br><span class="line">        <span class="string">&quot;ro.apatch.version&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.boot.apatch&quot;</span>,</span><br><span class="line">        <span class="string">&quot;persist.apatch.version&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (String prop : apatchProps) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> SystemProperties.get(prop, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!value.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-KernelSU检测"><a href="#3-KernelSU检测" class="headerlink" title="3. KernelSU检测"></a>3. KernelSU检测</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测KernelSU特征</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkKernelSU</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 检测KernelSU属性</span></span><br><span class="line">    <span class="keyword">if</span> (checkKernelSUProps()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检测KernelSU文件</span></span><br><span class="line">    <span class="keyword">if</span> (checkKernelSUFiles()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检测KernelSU模块</span></span><br><span class="line">    <span class="keyword">if</span> (checkKernelSUModules()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkKernelSUProps</span><span class="params">()</span> &#123;</span><br><span class="line">    String[] kernelsuProps = &#123;</span><br><span class="line">        <span class="string">&quot;ro.kernelsu.version&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.boot.kernelsu&quot;</span>,</span><br><span class="line">        <span class="string">&quot;persist.kernelsu.version&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (String prop : kernelsuProps) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> SystemProperties.get(prop, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!value.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="综合检测策略"><a href="#综合检测策略" class="headerlink" title="综合检测策略"></a>综合检测策略</h3><h4 id="1-多维度检测"><a href="#1-多维度检测" class="headerlink" title="1. 多维度检测"></a>1. 多维度检测</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 综合Root检测</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRooted</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> checkRootFiles() || </span><br><span class="line">           checkRootProps() || </span><br><span class="line">           checkMagisk() || </span><br><span class="line">           checkAPatch() || </span><br><span class="line">           checkKernelSU() ||</span><br><span class="line">           checkRuntimeDetection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-运行时检测"><a href="#2-运行时检测" class="headerlink" title="2. 运行时检测"></a>2. 运行时检测</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 运行时检测Root行为</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkRuntimeDetection</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 尝试执行需要Root权限的操作</span></span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;su -c id&quot;</span>);</span><br><span class="line">        process.waitFor();</span><br><span class="line">        <span class="keyword">return</span> process.exitValue() == <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-反检测绕过"><a href="#3-反检测绕过" class="headerlink" title="3. 反检测绕过"></a>3. 反检测绕过</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反检测绕过示例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AntiDetection</span> &#123;</span><br><span class="line">    <span class="comment">// Hook系统属性获取</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSystemProperty</span><span class="params">(String key, String defaultValue)</span> &#123;</span><br><span class="line">        <span class="comment">// 返回伪造的属性值</span></span><br><span class="line">        <span class="keyword">if</span> (key.contains(<span class="string">&quot;magisk&quot;</span>) || key.contains(<span class="string">&quot;apatch&quot;</span>) || key.contains(<span class="string">&quot;kernelsu&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> defaultValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SystemProperties.get(key, defaultValue);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook文件存在检查</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">fileExists</span><span class="params">(String path)</span> &#123;</span><br><span class="line">        <span class="comment">// 隐藏Root相关文件</span></span><br><span class="line">        <span class="keyword">if</span> (isRootFile(path)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(path).exists();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>三种现代Root方案各有特点：Magisk功能丰富但易被检测，APatch安全增强但社区支持有限，KernelSU性能最佳但兼容性有限。选择哪种方案需要根据具体需求和设备情况来决定。</p><p>三个root方式都有其他的一些创作分支，比如Magisk Delta、Magisk Canary、Magisk Alpha、Apatch Next、KernelSU NEXT、SukiSU Ultra、MKSU 等，都是基于原作基础第三方做了一些调整，进行改进或者优化，加了一些独特的功能</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Root </tag>
            
            <tag> 技术解析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>绕过SSL Pinning实战：从原理到工具链的完整指南</title>
      <link href="/2025/09/08/article8_ssl_pinning_bypass/"/>
      <url>/2025/09/08/article8_ssl_pinning_bypass/</url>
      
        <content type="html"><![CDATA[<h2 id="SSL-Pinning基础回顾"><a href="#SSL-Pinning基础回顾" class="headerlink" title="SSL Pinning基础回顾"></a>SSL Pinning基础回顾</h2><h3 id="什么是SSL-Pinning？"><a href="#什么是SSL-Pinning？" class="headerlink" title="什么是SSL Pinning？"></a>什么是SSL Pinning？</h3><p>SSL Pinning（证书固定）是一种安全机制，通过将服务器的证书或公钥”固定”在客户端应用中，确保只接受特定的证书，防止中间人攻击。</p><p><strong>核心原理</strong>：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">传统HTTPS验证：客户端 → 系统证书库 → 验证服务器证书</span><br><span class="line">SSL Pinning验证：客户端 → 预置固定证书 → 直接验证</span><br></pre></td></tr></table></figure><span id="more"></span><h3 id="为什么需要绕过SSL-Pinning？"><a href="#为什么需要绕过SSL-Pinning？" class="headerlink" title="为什么需要绕过SSL Pinning？"></a>为什么需要绕过SSL Pinning？</h3><ol><li><strong>安全测试</strong>：渗透测试中需要分析HTTPS流量</li><li><strong>漏洞挖掘</strong>：发现应用中的安全缺陷</li><li><strong>逆向分析</strong>：理解应用的网络通信机制</li><li><strong>调试开发</strong>：开发过程中的网络调试需求</li></ol><h2 id="移动端SSL-Pinning绕过"><a href="#移动端SSL-Pinning绕过" class="headerlink" title="移动端SSL Pinning绕过"></a>移动端SSL Pinning绕过</h2><h3 id="Android平台绕过技术"><a href="#Android平台绕过技术" class="headerlink" title="Android平台绕过技术"></a>Android平台绕过技术</h3><h4 id="1-Frida-Hook绕过（最常用）"><a href="#1-Frida-Hook绕过（最常用）" class="headerlink" title="1. Frida Hook绕过（最常用）"></a>1. Frida Hook绕过（最常用）</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida脚本：Android SSL Pinning绕过</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bypass_android_ssl_pinning</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Starting Android SSL Pinning bypass...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook X509TrustManager</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> X509TrustManager = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.net.ssl.X509TrustManager&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> X509Certificate = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.security.cert.X509Certificate&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Hook checkClientTrusted</span></span><br><span class="line">        X509TrustManager.<span class="property">checkClientTrusted</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">chain, authType</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] checkClientTrusted called - bypassed&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Hook checkServerTrusted</span></span><br><span class="line">        X509TrustManager.<span class="property">checkServerTrusted</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">chain, authType</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] checkServerTrusted called - bypassed&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Hook getAcceptedIssuers</span></span><br><span class="line">        X509TrustManager.<span class="property">getAcceptedIssuers</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] getAcceptedIssuers called - returning empty array&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&quot;java.security.cert.X509Certificate&quot;</span>, []);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] X509TrustManager hooked successfully&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] X509TrustManager hook failed: &quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook OkHttp的CertificatePinner</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">CertificatePinner</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.CertificatePinner&quot;</span>);</span><br><span class="line">        <span class="title class_">CertificatePinner</span>.<span class="property">check</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>, <span class="string">&quot;java.util.List&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">hostname, peerCertificates</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] CertificatePinner.check called for: &quot;</span> + hostname + <span class="string">&quot; - bypassed&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] OkHttp CertificatePinner hooked successfully&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] OkHttp CertificatePinner not found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook TrustKit</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">TrustKit</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.datatheorem.android.trustkit.TrustKit&quot;</span>);</span><br><span class="line">        <span class="title class_">TrustKit</span>.<span class="property">getInstance</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] TrustKit.getInstance called - bypassed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getInstance</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] TrustKit hooked successfully&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] TrustKit not found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook SSLContext</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">SSLContext</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.net.ssl.SSLContext&quot;</span>);</span><br><span class="line">        <span class="title class_">SSLContext</span>.<span class="property">init</span>.<span class="title function_">overload</span>(<span class="string">&quot;[Ljavax.net.ssl.KeyManager;&quot;</span>, <span class="string">&quot;[Ljavax.net.ssl.TrustManager;&quot;</span>, <span class="string">&quot;java.security.SecureRandom&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">keyManagers, trustManagers, secureRandom</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] SSLContext.init called - bypassed&quot;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">init</span>(keyManagers, <span class="literal">null</span>, secureRandom);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] SSLContext hooked successfully&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] SSLContext hook failed: &quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行绕过</span></span><br><span class="line"><span class="title function_">bypass_android_ssl_pinning</span>();</span><br></pre></td></tr></table></figure><h4 id="2-Xposed模块绕过"><a href="#2-Xposed模块绕过" class="headerlink" title="2. Xposed模块绕过"></a>2. Xposed模块绕过</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Xposed模块：SSL Pinning绕过</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSLPinningBypass</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (!lpparam.packageName.equals(<span class="string">&quot;com.target.app&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Hook X509TrustManager</span></span><br><span class="line">        XposedHelpers.findAndHookMethod(<span class="string">&quot;javax.net.ssl.X509TrustManager&quot;</span>, </span><br><span class="line">            lpparam.classLoader, <span class="string">&quot;checkServerTrusted&quot;</span>, </span><br><span class="line">            X509Certificate[].class, String.class, </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[+] checkServerTrusted bypassed&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Hook OkHttp CertificatePinner</span></span><br><span class="line">        XposedHelpers.findAndHookMethod(<span class="string">&quot;okhttp3.CertificatePinner&quot;</span>, </span><br><span class="line">            lpparam.classLoader, <span class="string">&quot;check&quot;</span>, </span><br><span class="line">            String.class, List.class, </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[+] CertificatePinner.check bypassed&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-内存补丁绕过"><a href="#3-内存补丁绕过" class="headerlink" title="3. 内存补丁绕过"></a>3. 内存补丁绕过</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python脚本：内存补丁绕过SSL Pinning</span></span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] <span class="subst">&#123;message[<span class="string">&#x27;payload&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bypass_ssl_pinning_memory_patch</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;使用内存补丁绕过SSL Pinning&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取目标进程</span></span><br><span class="line">    device = frida.get_usb_device()</span><br><span class="line">    session = device.attach(<span class="string">&quot;com.target.app&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 注入脚本</span></span><br><span class="line">    script = session.create_script(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    // 内存补丁绕过SSL Pinning</span></span><br><span class="line"><span class="string">    function patch_ssl_verification() &#123;</span></span><br><span class="line"><span class="string">        // 查找并替换证书验证函数</span></span><br><span class="line"><span class="string">        var verify_cert_addr = Module.findExportByName(&quot;libssl.so&quot;, &quot;SSL_CTX_set_verify&quot;);</span></span><br><span class="line"><span class="string">        if (verify_cert_addr) &#123;</span></span><br><span class="line"><span class="string">            console.log(&quot;[+] Found SSL_CTX_set_verify at: &quot; + verify_cert_addr);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            // 替换函数实现</span></span><br><span class="line"><span class="string">            Interceptor.replace(verify_cert_addr, new NativeCallback(function(ctx, mode, callback) &#123;</span></span><br><span class="line"><span class="string">                console.log(&quot;[+] SSL_CTX_set_verify called, disabling verification&quot;);</span></span><br><span class="line"><span class="string">                return 0;</span></span><br><span class="line"><span class="string">            &#125;, &#x27;int&#x27;, [&#x27;pointer&#x27;, &#x27;int&#x27;, &#x27;pointer&#x27;]));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        // 查找并替换证书获取函数</span></span><br><span class="line"><span class="string">        var get_cert_addr = Module.findExportByName(&quot;libssl.so&quot;, &quot;SSL_get_peer_certificate&quot;);</span></span><br><span class="line"><span class="string">        if (get_cert_addr) &#123;</span></span><br><span class="line"><span class="string">            console.log(&quot;[+] Found SSL_get_peer_certificate at: &quot; + get_cert_addr);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            Interceptor.replace(get_cert_addr, new NativeCallback(function(ssl) &#123;</span></span><br><span class="line"><span class="string">                console.log(&quot;[+] SSL_get_peer_certificate called, returning null&quot;);</span></span><br><span class="line"><span class="string">                return ptr(0);</span></span><br><span class="line"><span class="string">            &#125;, &#x27;pointer&#x27;, [&#x27;pointer&#x27;]));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        // 查找并替换证书验证函数</span></span><br><span class="line"><span class="string">        var verify_cert_chain_addr = Module.findExportByName(&quot;libssl.so&quot;, &quot;SSL_CTX_set_verify_callback&quot;);</span></span><br><span class="line"><span class="string">        if (verify_cert_chain_addr) &#123;</span></span><br><span class="line"><span class="string">            console.log(&quot;[+] Found SSL_CTX_set_verify_callback at: &quot; + verify_cert_chain_addr);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            Interceptor.replace(verify_cert_chain_addr, new NativeCallback(function(ctx, callback) &#123;</span></span><br><span class="line"><span class="string">                console.log(&quot;[+] SSL_CTX_set_verify_callback called, disabling callback&quot;);</span></span><br><span class="line"><span class="string">                return 0;</span></span><br><span class="line"><span class="string">            &#125;, &#x27;int&#x27;, [&#x27;pointer&#x27;, &#x27;pointer&#x27;]));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    // 执行补丁</span></span><br><span class="line"><span class="string">    patch_ssl_verification();</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">    script.load()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 保持脚本运行</span></span><br><span class="line">    sys.stdin.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    bypass_ssl_pinning_memory_patch()</span><br></pre></td></tr></table></figure><h3 id="iOS平台绕过技术"><a href="#iOS平台绕过技术" class="headerlink" title="iOS平台绕过技术"></a>iOS平台绕过技术</h3><h4 id="1-Frida-Hook绕过"><a href="#1-Frida-Hook绕过" class="headerlink" title="1. Frida Hook绕过"></a>1. Frida Hook绕过</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida脚本：iOS SSL Pinning绕过</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bypass_ios_ssl_pinning</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Starting iOS SSL Pinning bypass...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook SecTrustEvaluate</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">SecTrustEvaluate</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;Security&quot;</span>, <span class="string">&quot;SecTrustEvaluate&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">SecTrustEvaluate</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">SecTrustEvaluate</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] SecTrustEvaluate called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Forcing SecTrustEvaluate to return success&quot;</span>);</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="title function_">ptr</span>(<span class="number">0</span>)); <span class="comment">// errSecSuccess</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] SecTrustEvaluate hooked successfully&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook SecTrustEvaluateWithError (iOS 12+)</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">SecTrustEvaluateWithError</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;Security&quot;</span>, <span class="string">&quot;SecTrustEvaluateWithError&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">SecTrustEvaluateWithError</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">SecTrustEvaluateWithError</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] SecTrustEvaluateWithError called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Forcing SecTrustEvaluateWithError to return true&quot;</span>);</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="title function_">ptr</span>(<span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] SecTrustEvaluateWithError hooked successfully&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook NSURLSessionDelegate</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">NSURLSessionDelegate</span> = <span class="title class_">ObjC</span>.<span class="property">classes</span>.<span class="property">NSURLSessionDelegate</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">NSURLSessionDelegate</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> originalDidReceiveChallenge = <span class="title class_">NSURLSessionDelegate</span>[<span class="string">&#x27;- URLSession:didReceiveChallenge:completionHandler:&#x27;</span>];</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(originalDidReceiveChallenge.<span class="property">implementation</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] NSURLSessionDelegate didReceiveChallenge called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 修改completionHandler调用</span></span><br><span class="line">                <span class="keyword">var</span> completionHandler = args[<span class="number">4</span>];</span><br><span class="line">                <span class="keyword">var</span> block = <span class="keyword">new</span> <span class="title class_">ObjC</span>.<span class="title class_">Block</span>(completionHandler);</span><br><span class="line">                block.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">disposition, credential</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Modified completionHandler called&quot;</span>);</span><br><span class="line">                    <span class="comment">// 强制使用服务器证书</span></span><br><span class="line">                    block.<span class="title function_">implementation</span>(<span class="number">0</span>, credential); <span class="comment">// URLSessionAuthChallengeUseCredential</span></span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] NSURLSessionDelegate hooked successfully&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook CFNetwork</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">CFNetworkCopySystemProxySettings</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;CFNetwork&quot;</span>, <span class="string">&quot;CFNetworkCopySystemProxySettings&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">CFNetworkCopySystemProxySettings</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">CFNetworkCopySystemProxySettings</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] CFNetworkCopySystemProxySettings called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] CFNetworkCopySystemProxySettings bypassed&quot;</span>);</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="title function_">ptr</span>(<span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] CFNetworkCopySystemProxySettings hooked successfully&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行绕过</span></span><br><span class="line"><span class="title function_">bypass_ios_ssl_pinning</span>();</span><br></pre></td></tr></table></figure><h4 id="2-Theos-Tweak绕过"><a href="#2-Theos-Tweak绕过" class="headerlink" title="2. Theos Tweak绕过"></a>2. Theos Tweak绕过</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Theos Tweak：iOS SSL Pinning绕过</span></span><br><span class="line">%hook <span class="built_in">NSURLSessionConfiguration</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURLSessionConfiguration</span> *)defaultSessionConfiguration &#123;</span><br><span class="line">    <span class="built_in">NSURLSessionConfiguration</span> *config = %orig;</span><br><span class="line">    config.URLCredentialStorage = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%hook <span class="built_in">NSURLSession</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURLSession</span> *)sessionWithConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration &#123;</span><br><span class="line">    <span class="built_in">NSURLSession</span> *session = %orig;</span><br><span class="line">    <span class="keyword">return</span> session;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%hook <span class="built_in">NSURLSessionDelegate</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session didReceiveChallenge:(<span class="built_in">NSURLAuthenticationChallenge</span> *)challenge completionHandler:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionAuthChallengeDisposition</span>, <span class="built_in">NSURLCredential</span> *))completionHandler &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;[+] URLSession didReceiveChallenge called - bypassed&quot;</span>);</span><br><span class="line">    completionHandler(<span class="built_in">NSURLSessionAuthChallengeUseCredential</span>, [<span class="built_in">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br></pre></td></tr></table></figure><h2 id="Web端SSL-Pinning绕过"><a href="#Web端SSL-Pinning绕过" class="headerlink" title="Web端SSL Pinning绕过"></a>Web端SSL Pinning绕过</h2><h3 id="浏览器扩展绕过"><a href="#浏览器扩展绕过" class="headerlink" title="浏览器扩展绕过"></a>浏览器扩展绕过</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Chrome扩展：SSL Pinning绕过</span></span><br><span class="line"><span class="comment">// manifest.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;manifest_version&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SSL Pinning Bypass&quot;</span>,</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;permissions&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;webRequest&quot;</span>,</span><br><span class="line">        <span class="string">&quot;webRequestBlocking&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://*/*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://*/*&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;background&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;scripts&quot;</span>: [<span class="string">&quot;background.js&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// background.js</span></span><br><span class="line">chrome.<span class="property">webRequest</span>.<span class="property">onBeforeRequest</span>.<span class="title function_">addListener</span>(</span><br><span class="line">    <span class="keyword">function</span>(<span class="params">details</span>) &#123;</span><br><span class="line">        <span class="comment">// 拦截HTTPS请求，修改为HTTP</span></span><br><span class="line">        <span class="keyword">if</span> (details.<span class="property">url</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;https://&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> newUrl = details.<span class="property">url</span>.<span class="title function_">replace</span>(<span class="string">&#x27;https://&#x27;</span>, <span class="string">&#x27;http://&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="attr">redirectUrl</span>: newUrl&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;<span class="attr">urls</span>: [<span class="string">&quot;&lt;all_urls&gt;&quot;</span>]&#125;,</span><br><span class="line">    [<span class="string">&quot;blocking&quot;</span>]</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="代理服务器绕过"><a href="#代理服务器绕过" class="headerlink" title="代理服务器绕过"></a>代理服务器绕过</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python脚本：SSL Pinning代理绕过</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SSLPinningBypassProxy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, local_port=<span class="number">8080</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.local_port = local_port</span><br><span class="line">        <span class="variable language_">self</span>.server_socket = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_proxy</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;启动SSL Pinning绕过代理&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        <span class="variable language_">self</span>.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.server_socket.bind((<span class="string">&#x27;localhost&#x27;</span>, <span class="variable language_">self</span>.local_port))</span><br><span class="line">        <span class="variable language_">self</span>.server_socket.listen(<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] SSL Pinning Bypass Proxy started on port <span class="subst">&#123;self.local_port&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            client_socket, addr = <span class="variable language_">self</span>.server_socket.accept()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] New connection from <span class="subst">&#123;addr&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 处理客户端连接</span></span><br><span class="line">            thread = threading.Thread(target=<span class="variable language_">self</span>.handle_client, args=(client_socket,))</span><br><span class="line">            thread.daemon = <span class="literal">True</span></span><br><span class="line">            thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_client</span>(<span class="params">self, client_socket</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理客户端连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 接收客户端数据</span></span><br><span class="line">            data = client_socket.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 解析HTTP请求</span></span><br><span class="line">            request = data.decode(<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Request: <span class="subst">&#123;request.split(<span class="string">&#x27;\\n&#x27;</span>)[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 提取目标URL</span></span><br><span class="line">            first_line = request.split(<span class="string">&#x27;\\n&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            method, url, version = first_line.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 解析URL</span></span><br><span class="line">            parsed_url = urlparse(url)</span><br><span class="line">            host = parsed_url.hostname</span><br><span class="line">            port = parsed_url.port <span class="keyword">or</span> <span class="number">443</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 连接到目标服务器</span></span><br><span class="line">            server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">            server_socket.connect((host, port))</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 创建SSL连接</span></span><br><span class="line">            context = ssl.create_default_context()</span><br><span class="line">            context.check_hostname = <span class="literal">False</span></span><br><span class="line">            context.verify_mode = ssl.CERT_NONE</span><br><span class="line">            </span><br><span class="line">            ssl_socket = context.wrap_socket(server_socket, server_hostname=host)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 转发请求</span></span><br><span class="line">            ssl_socket.send(data)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 接收响应</span></span><br><span class="line">            response = ssl_socket.recv(<span class="number">4096</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 转发响应给客户端</span></span><br><span class="line">            client_socket.send(response)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 关闭连接</span></span><br><span class="line">            ssl_socket.close()</span><br><span class="line">            server_socket.close()</span><br><span class="line">            client_socket.close()</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] Error handling client: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            client_socket.close()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_proxy</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;停止代理&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.server_socket:</span><br><span class="line">            <span class="variable language_">self</span>.server_socket.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    proxy = SSLPinningBypassProxy(<span class="number">8080</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        proxy.start_proxy()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        proxy.stop_proxy()</span><br></pre></td></tr></table></figure><h2 id="自动化工具集成"><a href="#自动化工具集成" class="headerlink" title="自动化工具集成"></a>自动化工具集成</h2><h3 id="1-集成到Burp-Suite"><a href="#1-集成到Burp-Suite" class="headerlink" title="1. 集成到Burp Suite"></a>1. 集成到Burp Suite</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Burp Suite扩展：SSL Pinning绕过</span></span><br><span class="line"><span class="keyword">from</span> burp <span class="keyword">import</span> IBurpExtender, IHttpListener, IProxyListener</span><br><span class="line"><span class="keyword">from</span> java.io <span class="keyword">import</span> PrintWriter</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SSLPinningBypass</span>(IBurpExtender, IHttpListener, IProxyListener):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">registerExtenderCallbacks</span>(<span class="params">self, callbacks</span>):</span><br><span class="line">        <span class="variable language_">self</span>._callbacks = callbacks</span><br><span class="line">        <span class="variable language_">self</span>._helpers = callbacks.getHelpers()</span><br><span class="line">        callbacks.setExtensionName(<span class="string">&quot;SSL Pinning Bypass&quot;</span>)</span><br><span class="line">        callbacks.registerHttpListener(<span class="variable language_">self</span>)</span><br><span class="line">        callbacks.registerProxyListener(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取stdout和stderr</span></span><br><span class="line">        <span class="variable language_">self</span>._stdout = PrintWriter(callbacks.getStdout(), <span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>._stderr = PrintWriter(callbacks.getStderr(), <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>._stdout.println(<span class="string">&quot;SSL Pinning Bypass extension loaded&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">processHttpMessage</span>(<span class="params">self, toolFlag, messageIsRequest, messageInfo</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理HTTP消息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> messageIsRequest:</span><br><span class="line">            <span class="comment"># 处理请求</span></span><br><span class="line">            request = messageInfo.getRequest()</span><br><span class="line">            <span class="variable language_">self</span>._stdout.println(<span class="string">&quot;Processing request: &quot;</span> + <span class="variable language_">self</span>._helpers.analyzeRequest(request).getUrl().toString())</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 修改请求头，绕过SSL Pinning</span></span><br><span class="line">            modified_request = <span class="variable language_">self</span>.modify_request_headers(request)</span><br><span class="line">            messageInfo.setRequest(modified_request)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 处理响应</span></span><br><span class="line">            response = messageInfo.getResponse()</span><br><span class="line">            <span class="variable language_">self</span>._stdout.println(<span class="string">&quot;Processing response&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">modify_request_headers</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;修改请求头&quot;&quot;&quot;</span></span><br><span class="line">        request_info = <span class="variable language_">self</span>._helpers.analyzeRequest(request)</span><br><span class="line">        headers = request_info.getHeaders()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加绕过SSL Pinning的请求头</span></span><br><span class="line">        headers.add(<span class="string">&quot;X-Forwarded-Proto: https&quot;</span>)</span><br><span class="line">        headers.add(<span class="string">&quot;X-Forwarded-For: 127.0.0.1&quot;</span>)</span><br><span class="line">        headers.add(<span class="string">&quot;X-Real-IP: 127.0.0.1&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重新构造请求</span></span><br><span class="line">        body = request[request_info.getBodyOffset():]</span><br><span class="line">        modified_request = <span class="variable language_">self</span>._helpers.buildHttpMessage(headers, body)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> modified_request</span><br></pre></td></tr></table></figure><h3 id="2-集成到OWASP-ZAP"><a href="#2-集成到OWASP-ZAP" class="headerlink" title="2. 集成到OWASP ZAP"></a>2. 集成到OWASP ZAP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OWASP ZAP脚本：SSL Pinning绕过</span></span><br><span class="line"><span class="keyword">from</span> org.zaproxy.zap.extension.script <span class="keyword">import</span> ScriptVars</span><br><span class="line"><span class="keyword">from</span> org.parosproxy.paros.network <span class="keyword">import</span> HttpMessage</span><br><span class="line"><span class="keyword">from</span> org.parosproxy.paros.network <span class="keyword">import</span> HttpRequestHeader</span><br><span class="line"><span class="keyword">from</span> org.parosproxy.paros.network <span class="keyword">import</span> HttpResponseHeader</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sendingRequest</span>(<span class="params">msg, initiator, helper</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;发送请求前处理&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 修改请求头</span></span><br><span class="line">    headers = msg.getRequestHeader()</span><br><span class="line">    headers.setHeader(<span class="string">&quot;X-Forwarded-Proto&quot;</span>, <span class="string">&quot;https&quot;</span>)</span><br><span class="line">    headers.setHeader(<span class="string">&quot;X-Forwarded-For&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>)</span><br><span class="line">    headers.setHeader(<span class="string">&quot;X-Real-IP&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 记录日志</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Modified request headers for SSL Pinning bypass&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">responseReceived</span>(<span class="params">msg, initiator, helper</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;接收响应后处理&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 记录响应信息</span></span><br><span class="line">    response_header = msg.getResponseHeader()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Response received: &quot;</span> + <span class="built_in">str</span>(response_header.getStatusCode()))</span><br></pre></td></tr></table></figure><h2 id="检测与防护"><a href="#检测与防护" class="headerlink" title="检测与防护"></a>检测与防护</h2><h3 id="SSL-Pinning检测工具"><a href="#SSL-Pinning检测工具" class="headerlink" title="SSL Pinning检测工具"></a>SSL Pinning检测工具</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python脚本：SSL Pinning检测</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SSLPinningDetector</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, target_path</span>):</span><br><span class="line">        <span class="variable language_">self</span>.target_path = target_path</span><br><span class="line">        <span class="variable language_">self</span>.pinning_indicators = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_ssl_pinning</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测SSL Pinning&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.target_path.endswith(<span class="string">&#x27;.apk&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.detect_apk_ssl_pinning()</span><br><span class="line">        <span class="keyword">elif</span> <span class="variable language_">self</span>.target_path.endswith(<span class="string">&#x27;.ipa&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.detect_ios_ssl_pinning()</span><br><span class="line">        <span class="keyword">elif</span> os.path.isdir(<span class="variable language_">self</span>.target_path):</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.detect_source_ssl_pinning()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_apk_ssl_pinning</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测APK中的SSL Pinning&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> zipfile.ZipFile(<span class="variable language_">self</span>.target_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> apk:</span><br><span class="line">                <span class="comment"># 检查classes.dex</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;classes.dex&#x27;</span> <span class="keyword">in</span> apk.namelist():</span><br><span class="line">                    dex_data = apk.read(<span class="string">&#x27;classes.dex&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="variable language_">self</span>.scan_dex_for_pinning(dex_data):</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 检查资源文件</span></span><br><span class="line">                <span class="keyword">for</span> file_name <span class="keyword">in</span> apk.namelist():</span><br><span class="line">                    <span class="keyword">if</span> file_name.endswith((<span class="string">&#x27;.xml&#x27;</span>, <span class="string">&#x27;.json&#x27;</span>)):</span><br><span class="line">                        file_data = apk.read(file_name)</span><br><span class="line">                        <span class="keyword">if</span> <span class="variable language_">self</span>.scan_resources_for_pinning(file_data):</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] Error analyzing APK: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">scan_dex_for_pinning</span>(<span class="params">self, dex_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;扫描DEX文件中的SSL Pinning代码&quot;&quot;&quot;</span></span><br><span class="line">        dex_str = dex_data.decode(<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># SSL Pinning相关字符串</span></span><br><span class="line">        pinning_strings = [</span><br><span class="line">            <span class="string">&#x27;CertificatePinner&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;TrustKit&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;SSLContext&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;X509TrustManager&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;checkServerTrusted&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;pinning&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;certificate&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sha256&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;public-key-pins&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        found_indicators = []</span><br><span class="line">        <span class="keyword">for</span> string <span class="keyword">in</span> pinning_strings:</span><br><span class="line">            <span class="keyword">if</span> string.lower() <span class="keyword">in</span> dex_str.lower():</span><br><span class="line">                found_indicators.append(string)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> found_indicators:</span><br><span class="line">            <span class="variable language_">self</span>.pinning_indicators.extend(found_indicators)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">scan_resources_for_pinning</span>(<span class="params">self, resource_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;扫描资源文件中的SSL Pinning配置&quot;&quot;&quot;</span></span><br><span class="line">        resource_str = resource_data.decode(<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查网络安全配置</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;network_security_config&#x27;</span> <span class="keyword">in</span> resource_str:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;pin-set&#x27;</span> <span class="keyword">in</span> resource_str <span class="keyword">or</span> <span class="string">&#x27;certificates&#x27;</span> <span class="keyword">in</span> resource_str:</span><br><span class="line">                <span class="variable language_">self</span>.pinning_indicators.append(<span class="string">&#x27;network_security_config&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查TrustKit配置</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;trustkit&#x27;</span> <span class="keyword">in</span> resource_str.lower():</span><br><span class="line">            <span class="variable language_">self</span>.pinning_indicators.append(<span class="string">&#x27;trustkit_config&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_ios_ssl_pinning</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测iOS应用中的SSL Pinning&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># iOS应用检测逻辑</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_source_ssl_pinning</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测源代码中的SSL Pinning&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(<span class="variable language_">self</span>.target_path):</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                <span class="keyword">if</span> file.endswith((<span class="string">&#x27;.java&#x27;</span>, <span class="string">&#x27;.kt&#x27;</span>, <span class="string">&#x27;.swift&#x27;</span>, <span class="string">&#x27;.m&#x27;</span>, <span class="string">&#x27;.h&#x27;</span>)):</span><br><span class="line">                    file_path = os.path.join(root, file)</span><br><span class="line">                    <span class="keyword">if</span> <span class="variable language_">self</span>.scan_source_file(file_path):</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">scan_source_file</span>(<span class="params">self, file_path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;扫描单个源文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 检查SSL Pinning相关代码</span></span><br><span class="line">                pinning_patterns = [</span><br><span class="line">                    <span class="string">r&#x27;CertificatePinner&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;TrustKit&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;SSLContext&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;X509TrustManager&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;checkServerTrusted&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;pinning&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;certificate.*pin&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;sha256.*pin&#x27;</span></span><br><span class="line">                ]</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> pattern <span class="keyword">in</span> pinning_patterns:</span><br><span class="line">                    <span class="keyword">if</span> re.search(pattern, content, re.IGNORECASE):</span><br><span class="line">                        <span class="variable language_">self</span>.pinning_indicators.append(<span class="string">f&quot;<span class="subst">&#123;file_path&#125;</span>: <span class="subst">&#123;pattern&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                        </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] Error scanning file <span class="subst">&#123;file_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_pinning_indicators</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取检测到的SSL Pinning指标&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.pinning_indicators</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    detector = SSLPinningDetector(<span class="string">&quot;target.apk&quot;</span>)</span><br><span class="line">    has_pinning = detector.detect_ssl_pinning()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> has_pinning:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] SSL Pinning detected!&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Indicators:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> indicator <span class="keyword">in</span> detector.get_pinning_indicators():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;indicator&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] No SSL Pinning detected&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>SSL Pinning绕过是移动端和Web端安全测试中的重要技能，同样对于防护端来说也是必不可少的一个环节</p><p><strong>本文关键点</strong>：从原理到实现的完整技术栈，各个端的对应实施策略，以及防护端的建议</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSL/TLS </tag>
            
            <tag> 绕过 </tag>
            
            <tag> 实战 </tag>
            
            <tag> 原理 </tag>
            
            <tag> 工具链 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSL/TLS协议解析：从握手到证书固定</title>
      <link href="/2025/09/04/article7_ssl_tls_analysis/"/>
      <url>/2025/09/04/article7_ssl_tls_analysis/</url>
      
        <content type="html"><![CDATA[<h2 id="SSL-TLS协议基础"><a href="#SSL-TLS协议基础" class="headerlink" title="SSL&#x2F;TLS协议基础"></a>SSL&#x2F;TLS协议基础</h2><h3 id="协议发展历程"><a href="#协议发展历程" class="headerlink" title="协议发展历程"></a>协议发展历程</h3><p><strong>SSL&#x2F;TLS协议演进</strong>：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1994</span>年：SSL <span class="number">1</span>.<span class="number">0</span> (未发布)</span><br><span class="line"><span class="attribute">1995</span>年：SSL <span class="number">2</span>.<span class="number">0</span> (已废弃)</span><br><span class="line"><span class="attribute">1996</span>年：SSL <span class="number">3</span>.<span class="number">0</span> (已废弃)</span><br><span class="line"><span class="attribute">1999</span>年：TLS <span class="number">1</span>.<span class="number">0</span></span><br><span class="line"><span class="attribute">2006</span>年：TLS <span class="number">1</span>.<span class="number">1</span></span><br><span class="line"><span class="attribute">2008</span>年：TLS <span class="number">1</span>.<span class="number">2</span></span><br><span class="line"><span class="attribute">2018</span>年：TLS <span class="number">1</span>.<span class="number">3</span></span><br></pre></td></tr></table></figure><span id="more"></span><p><strong>关键变化</strong>：</p><ul><li><strong>TLS 1.2</strong>：支持更强的加密算法，广泛使用</li><li><strong>TLS 1.3</strong>：简化握手过程，提升安全性，移除弱加密算法</li></ul><h3 id="协议在OSI模型中的位置"><a href="#协议在OSI模型中的位置" class="headerlink" title="协议在OSI模型中的位置"></a>协议在OSI模型中的位置</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">应用层    <span class="string">| HTTP、HTTPS、SMTP等</span></span><br><span class="line">表示层    <span class="string">| SSL/TLS (加密、压缩、格式转换)</span></span><br><span class="line">会话层    <span class="string">| SSL/TLS (会话管理)</span></span><br><span class="line">传输层    <span class="string">| TCP</span></span><br><span class="line">网络层    <span class="string">| IP</span></span><br><span class="line">数据链路层 <span class="string">| 以太网</span></span><br><span class="line">物理层    <span class="string">| 网线、光纤</span></span><br></pre></td></tr></table></figure><p><strong>重要理解</strong>：SSL&#x2F;TLS工作在表示层和会话层，为上层应用提供加密和认证服务。</p><h2 id="TLS握手过程深度分析"><a href="#TLS握手过程深度分析" class="headerlink" title="TLS握手过程深度分析"></a>TLS握手过程深度分析</h2><h3 id="TLS-1-2握手流程"><a href="#TLS-1-2握手流程" class="headerlink" title="TLS 1.2握手流程"></a>TLS 1.2握手流程</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">客户端                    服务器</span><br><span class="line">  |<span class="string">                         </span>|</span><br><span class="line">  |<span class="string">---&gt; ClientHello -------&gt;</span>|</span><br><span class="line">  |<span class="string">                         </span>|</span><br><span class="line">  |<span class="string">&lt;--- ServerHello --------</span>|</span><br><span class="line">  |<span class="string">&lt;--- Certificate --------</span>|</span><br><span class="line">  |<span class="string">&lt;--- ServerKeyExchange --</span>|</span><br><span class="line">  |<span class="string">&lt;--- ServerHelloDone ---</span>|</span><br><span class="line">  |<span class="string">                         </span>|</span><br><span class="line">  |<span class="string">---&gt; ClientKeyExchange -&gt;</span>|</span><br><span class="line">  |<span class="string">---&gt; ChangeCipherSpec --&gt;</span>|</span><br><span class="line">  |<span class="string">---&gt; Finished ----------&gt;</span>|</span><br><span class="line">  |<span class="string">                         </span>|</span><br><span class="line">  |<span class="string">&lt;--- ChangeCipherSpec ---</span>|</span><br><span class="line">  |<span class="string">&lt;--- Finished -----------</span>|</span><br><span class="line">  |<span class="string">                         </span>|</span><br></pre></td></tr></table></figure><h3 id="详细握手分析"><a href="#详细握手分析" class="headerlink" title="详细握手分析"></a>详细握手分析</h3><h4 id="1-ClientHello消息"><a href="#1-ClientHello消息" class="headerlink" title="1. ClientHello消息"></a>1. ClientHello消息</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ClientHello消息结构分析</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_client_hello</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;分析ClientHello消息&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># TLS记录头 (5字节)</span></span><br><span class="line">    content_type = data[<span class="number">0</span>]  <span class="comment"># 0x16 = Handshake</span></span><br><span class="line">    version = data[<span class="number">1</span>:<span class="number">3</span>]     <span class="comment"># TLS版本</span></span><br><span class="line">    length = <span class="built_in">int</span>.from_bytes(data[<span class="number">3</span>:<span class="number">5</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Handshake消息头 (4字节)</span></span><br><span class="line">    handshake_type = data[<span class="number">5</span>]  <span class="comment"># 0x01 = ClientHello</span></span><br><span class="line">    handshake_length = <span class="built_in">int</span>.from_bytes(data[<span class="number">6</span>:<span class="number">9</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ClientHello消息体</span></span><br><span class="line">    client_version = data[<span class="number">9</span>:<span class="number">11</span>]  <span class="comment"># 客户端支持的TLS版本</span></span><br><span class="line">    random = data[<span class="number">11</span>:<span class="number">43</span>]         <span class="comment"># 32字节随机数</span></span><br><span class="line">    session_id_length = data[<span class="number">43</span>]</span><br><span class="line">    session_id = data[<span class="number">44</span>:<span class="number">44</span>+session_id_length]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 密码套件</span></span><br><span class="line">    cipher_suites_length = <span class="built_in">int</span>.from_bytes(data[<span class="number">44</span>+session_id_length:<span class="number">46</span>+session_id_length], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    cipher_suites = data[<span class="number">46</span>+session_id_length:<span class="number">46</span>+session_id_length+cipher_suites_length]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 压缩方法</span></span><br><span class="line">    compression_methods_length = data[<span class="number">46</span>+session_id_length+cipher_suites_length]</span><br><span class="line">    compression_methods = data[<span class="number">47</span>+session_id_length+cipher_suites_length:<span class="number">47</span>+session_id_length+cipher_suites_length+compression_methods_length]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 扩展</span></span><br><span class="line">    extensions_length = <span class="built_in">int</span>.from_bytes(data[<span class="number">47</span>+session_id_length+cipher_suites_length+compression_methods_length:<span class="number">49</span>+session_id_length+cipher_suites_length+compression_methods_length], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    extensions = data[<span class="number">49</span>+session_id_length+cipher_suites_length+compression_methods_length:]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span>: client_version,</span><br><span class="line">        <span class="string">&#x27;random&#x27;</span>: random,</span><br><span class="line">        <span class="string">&#x27;cipher_suites&#x27;</span>: parse_cipher_suites(cipher_suites),</span><br><span class="line">        <span class="string">&#x27;extensions&#x27;</span>: parse_extensions(extensions)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_cipher_suites</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;解析密码套件&quot;&quot;&quot;</span></span><br><span class="line">    suites = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), <span class="number">2</span>):</span><br><span class="line">        suite = <span class="built_in">int</span>.from_bytes(data[i:i+<span class="number">2</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        suites.append(suite)</span><br><span class="line">    <span class="keyword">return</span> suites</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_extensions</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;解析TLS扩展&quot;&quot;&quot;</span></span><br><span class="line">    extensions = &#123;&#125;</span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> offset &lt; <span class="built_in">len</span>(data) - <span class="number">4</span>:</span><br><span class="line">        ext_type = <span class="built_in">int</span>.from_bytes(data[offset:offset+<span class="number">2</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        ext_length = <span class="built_in">int</span>.from_bytes(data[offset+<span class="number">2</span>:offset+<span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        ext_data = data[offset+<span class="number">4</span>:offset+<span class="number">4</span>+ext_length]</span><br><span class="line">        </span><br><span class="line">        extensions[ext_type] = ext_data</span><br><span class="line">        offset += <span class="number">4</span> + ext_length</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> extensions</span><br></pre></td></tr></table></figure><h4 id="2-ServerHello消息"><a href="#2-ServerHello消息" class="headerlink" title="2. ServerHello消息"></a>2. ServerHello消息</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_server_hello</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;分析ServerHello消息&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 服务器选择的TLS版本</span></span><br><span class="line">    server_version = data[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 服务器随机数</span></span><br><span class="line">    server_random = data[<span class="number">2</span>:<span class="number">34</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 会话ID</span></span><br><span class="line">    session_id_length = data[<span class="number">34</span>]</span><br><span class="line">    session_id = data[<span class="number">35</span>:<span class="number">35</span>+session_id_length]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 选择的密码套件</span></span><br><span class="line">    cipher_suite = <span class="built_in">int</span>.from_bytes(data[<span class="number">35</span>+session_id_length:<span class="number">37</span>+session_id_length], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 压缩方法</span></span><br><span class="line">    compression_method = data[<span class="number">37</span>+session_id_length]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 扩展</span></span><br><span class="line">    extensions_length = <span class="built_in">int</span>.from_bytes(data[<span class="number">38</span>+session_id_length:<span class="number">40</span>+session_id_length], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    extensions = data[<span class="number">40</span>+session_id_length:]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span>: server_version,</span><br><span class="line">        <span class="string">&#x27;random&#x27;</span>: server_random,</span><br><span class="line">        <span class="string">&#x27;cipher_suite&#x27;</span>: cipher_suite,</span><br><span class="line">        <span class="string">&#x27;compression_method&#x27;</span>: compression_method,</span><br><span class="line">        <span class="string">&#x27;extensions&#x27;</span>: parse_extensions(extensions)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="3-Certificate消息"><a href="#3-Certificate消息" class="headerlink" title="3. Certificate消息"></a>3. Certificate消息</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_certificate_message</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;分析Certificate消息&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 证书链长度</span></span><br><span class="line">    cert_chain_length = <span class="built_in">int</span>.from_bytes(data[<span class="number">0</span>:<span class="number">3</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    certificates = []</span><br><span class="line">    offset = <span class="number">3</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> offset &lt; <span class="built_in">len</span>(data):</span><br><span class="line">        <span class="comment"># 单个证书长度</span></span><br><span class="line">        cert_length = <span class="built_in">int</span>.from_bytes(data[offset:offset+<span class="number">3</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        cert_data = data[offset+<span class="number">3</span>:offset+<span class="number">3</span>+cert_length]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解析X.509证书</span></span><br><span class="line">        cert_info = parse_x509_certificate(cert_data)</span><br><span class="line">        certificates.append(cert_info)</span><br><span class="line">        </span><br><span class="line">        offset += <span class="number">3</span> + cert_length</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> certificates</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_x509_certificate</span>(<span class="params">cert_data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;解析X.509证书&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">from</span> cryptography <span class="keyword">import</span> x509</span><br><span class="line">    <span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cert = x509.load_der_x509_certificate(cert_data, default_backend())</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;subject&#x27;</span>: cert.subject.rfc4514_string(),</span><br><span class="line">            <span class="string">&#x27;issuer&#x27;</span>: cert.issuer.rfc4514_string(),</span><br><span class="line">            <span class="string">&#x27;serial_number&#x27;</span>: <span class="built_in">str</span>(cert.serial_number),</span><br><span class="line">            <span class="string">&#x27;not_valid_before&#x27;</span>: cert.not_valid_before,</span><br><span class="line">            <span class="string">&#x27;not_valid_after&#x27;</span>: cert.not_valid_after,</span><br><span class="line">            <span class="string">&#x27;public_key&#x27;</span>: cert.public_key(),</span><br><span class="line">            <span class="string">&#x27;signature_algorithm&#x27;</span>: cert.signature_algorithm_oid._name,</span><br><span class="line">            <span class="string">&#x27;extensions&#x27;</span>: [ext.oid._name <span class="keyword">for</span> ext <span class="keyword">in</span> cert.extensions]</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e)&#125;</span><br></pre></td></tr></table></figure><h3 id="TLS-1-3握手优化"><a href="#TLS-1-3握手优化" class="headerlink" title="TLS 1.3握手优化"></a>TLS 1.3握手优化</h3><p><strong>TLS 1.3的主要改进</strong>：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">传统握手 (TLS 1.2)</span><span class="punctuation">:</span> <span class="string">2-RTT</span></span><br><span class="line"><span class="attribute">TLS 1.3握手</span><span class="punctuation">:</span> <span class="string">1-RTT (首次) / 0-RTT (重连)</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_tls13_handshake</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;分析TLS 1.3握手&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># TLS 1.3简化了握手过程</span></span><br><span class="line">    <span class="comment"># ClientHello包含更多信息，支持0-RTT</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> data[<span class="number">0</span>] == <span class="number">0x16</span>:  <span class="comment"># Handshake</span></span><br><span class="line">        handshake_type = data[<span class="number">5</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> handshake_type == <span class="number">0x01</span>:  <span class="comment"># ClientHello</span></span><br><span class="line">            <span class="keyword">return</span> analyze_tls13_client_hello(data)</span><br><span class="line">        <span class="keyword">elif</span> handshake_type == <span class="number">0x02</span>:  <span class="comment"># ServerHello</span></span><br><span class="line">            <span class="keyword">return</span> analyze_tls13_server_hello(data)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_tls13_client_hello</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;分析TLS 1.3 ClientHello&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># TLS 1.3的ClientHello包含预共享密钥信息</span></span><br><span class="line">    <span class="comment"># 支持0-RTT数据</span></span><br><span class="line">    </span><br><span class="line">    extensions = parse_extensions(data[<span class="number">44</span>:])  <span class="comment"># 简化版本</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查是否包含PSK扩展</span></span><br><span class="line">    psk_extensions = []</span><br><span class="line">    <span class="keyword">for</span> ext_type, ext_data <span class="keyword">in</span> extensions.items():</span><br><span class="line">        <span class="keyword">if</span> ext_type == <span class="number">41</span>:  <span class="comment"># pre_shared_key</span></span><br><span class="line">            psk_extensions.append(ext_data)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span>: data[<span class="number">9</span>:<span class="number">11</span>],</span><br><span class="line">        <span class="string">&#x27;random&#x27;</span>: data[<span class="number">11</span>:<span class="number">43</span>],</span><br><span class="line">        <span class="string">&#x27;psk_extensions&#x27;</span>: psk_extensions,</span><br><span class="line">        <span class="string">&#x27;supports_0rtt&#x27;</span>: <span class="built_in">len</span>(psk_extensions) &gt; <span class="number">0</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="证书验证机制"><a href="#证书验证机制" class="headerlink" title="证书验证机制"></a>证书验证机制</h2><h3 id="证书链验证过程"><a href="#证书链验证过程" class="headerlink" title="证书链验证过程"></a>证书链验证过程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">verify_certificate_chain</span>(<span class="params">certificates, trusted_cas</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证证书链&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> certificates:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;No certificates provided&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证证书链</span></span><br><span class="line">    <span class="keyword">for</span> i, cert <span class="keyword">in</span> <span class="built_in">enumerate</span>(certificates):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 验证终端实体证书</span></span><br><span class="line">            result = verify_end_entity_certificate(cert, certificates[<span class="number">1</span>] <span class="keyword">if</span> <span class="built_in">len</span>(certificates) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 验证中间CA证书</span></span><br><span class="line">            result = verify_intermediate_ca_certificate(cert, certificates[i+<span class="number">1</span>] <span class="keyword">if</span> i+<span class="number">1</span> &lt; <span class="built_in">len</span>(certificates) <span class="keyword">else</span> <span class="literal">None</span>, trusted_cas)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">f&quot;Certificate <span class="subst">&#123;i&#125;</span> verification failed: <span class="subst">&#123;result[<span class="number">1</span>]&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;Certificate chain is valid&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_end_entity_certificate</span>(<span class="params">cert, issuer_cert</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证终端实体证书&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 检查证书有效期</span></span><br><span class="line">    now = datetime.now()</span><br><span class="line">    <span class="keyword">if</span> now &lt; cert[<span class="string">&#x27;not_valid_before&#x27;</span>] <span class="keyword">or</span> now &gt; cert[<span class="string">&#x27;not_valid_after&#x27;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Certificate expired or not yet valid&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查证书用途</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> has_correct_key_usage(cert, <span class="string">&#x27;digitalSignature&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Certificate does not have correct key usage&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证签名</span></span><br><span class="line">    <span class="keyword">if</span> issuer_cert:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> verify_signature(cert, issuer_cert):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Certificate signature verification failed&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;End entity certificate is valid&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_intermediate_ca_certificate</span>(<span class="params">cert, issuer_cert, trusted_cas</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证中间CA证书&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 检查是否为CA证书</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_ca_certificate(cert):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Not a CA certificate&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查证书有效期</span></span><br><span class="line">    now = datetime.now()</span><br><span class="line">    <span class="keyword">if</span> now &lt; cert[<span class="string">&#x27;not_valid_before&#x27;</span>] <span class="keyword">or</span> now &gt; cert[<span class="string">&#x27;not_valid_after&#x27;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Certificate expired or not yet valid&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证签名</span></span><br><span class="line">    <span class="keyword">if</span> issuer_cert:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> verify_signature(cert, issuer_cert):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Certificate signature verification failed&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 检查是否为受信任的根CA</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_trusted_root_ca(cert, trusted_cas):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Not a trusted root CA&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;Intermediate CA certificate is valid&quot;</span></span><br></pre></td></tr></table></figure><h3 id="证书固定-Certificate-Pinning"><a href="#证书固定-Certificate-Pinning" class="headerlink" title="证书固定 (Certificate Pinning)"></a>证书固定 (Certificate Pinning)</h3><h4 id="Android中的证书固定"><a href="#Android中的证书固定" class="headerlink" title="Android中的证书固定"></a>Android中的证书固定</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Android证书固定实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CertificatePinning</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PINNED_CERT_SHA256</span> <span class="operator">=</span> <span class="string">&quot;sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> OkHttpClient <span class="title function_">createPinnedClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CertificatePinner</span> <span class="variable">certificatePinner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CertificatePinner</span>.Builder()</span><br><span class="line">            .add(<span class="string">&quot;example.com&quot;</span>, PINNED_CERT_SHA256)</span><br><span class="line">            .add(<span class="string">&quot;*.example.com&quot;</span>, PINNED_CERT_SHA256)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">            .certificatePinner(certificatePinner)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自定义TrustManager实现证书固定</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PinningTrustManager</span> <span class="keyword">implements</span> <span class="title class_">X509TrustManager</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> X509TrustManager defaultTrustManager;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; pinnedCertificates;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">PinningTrustManager</span><span class="params">(Set&lt;String&gt; pinnedCerts)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.pinnedCertificates = pinnedCerts;</span><br><span class="line">            <span class="built_in">this</span>.defaultTrustManager = getDefaultTrustManager();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkClientTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span> &#123;</span><br><span class="line">            <span class="comment">// 客户端证书验证</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkServerTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span> &#123;</span><br><span class="line">            <span class="comment">// 服务器证书验证</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                defaultTrustManager.checkServerTrusted(chain, authType);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (CertificateException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CertificateException</span>(<span class="string">&quot;Default trust manager verification failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查证书固定</span></span><br><span class="line">            <span class="keyword">if</span> (!isCertificatePinned(chain)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CertificateException</span>(<span class="string">&quot;Certificate pinning verification failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isCertificatePinned</span><span class="params">(X509Certificate[] chain)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (X509Certificate cert : chain) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">certHash</span> <span class="operator">=</span> getCertificateHash(cert);</span><br><span class="line">                <span class="keyword">if</span> (pinnedCertificates.contains(certHash)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> String <span class="title function_">getCertificateHash</span><span class="params">(X509Certificate cert)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">MessageDigest</span> <span class="variable">digest</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">                <span class="type">byte</span>[] certBytes = cert.getEncoded();</span><br><span class="line">                <span class="type">byte</span>[] hash = digest.digest(certBytes);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;sha256/&quot;</span> + Base64.encodeToString(hash, Base64.NO_WRAP);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="iOS中的证书固定"><a href="#iOS中的证书固定" class="headerlink" title="iOS中的证书固定"></a>iOS中的证书固定</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// iOS证书固定实现</span></span><br><span class="line"><span class="keyword">import</span> Security</span><br><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CertificatePinning</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> pinnedCertificates: [<span class="type">Data</span>] <span class="operator">=</span> [</span><br><span class="line">        <span class="comment">// 预置的证书数据</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">createPinnedSession</span>() -&gt; <span class="type">URLSession</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> config <span class="operator">=</span> <span class="type">URLSessionConfiguration</span>.default</span><br><span class="line">        <span class="keyword">let</span> session <span class="operator">=</span> <span class="type">URLSession</span>(configuration: config, delegate: <span class="type">CertificatePinningDelegate</span>(), delegateQueue: <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">return</span> session</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CertificatePinningDelegate</span>: <span class="title class_ inherited__">NSObject</span>, <span class="title class_ inherited__">URLSessionDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">urlSession</span>(<span class="keyword">_</span> <span class="params">session</span>: <span class="type">URLSession</span>, <span class="params">didReceive</span> <span class="params">challenge</span>: <span class="type">URLAuthenticationChallenge</span>, <span class="params">completionHandler</span>: <span class="keyword">@escaping</span> (<span class="type">URLSession</span>.<span class="type">AuthChallengeDisposition</span>, <span class="type">URLCredential</span>?) -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> serverTrust <span class="operator">=</span> challenge.protectionSpace.serverTrust <span class="keyword">else</span> &#123;</span><br><span class="line">            completionHandler(.cancelAuthenticationChallenge, <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 验证证书链</span></span><br><span class="line">        <span class="keyword">let</span> result <span class="operator">=</span> <span class="type">SecTrustEvaluate</span>(serverTrust, <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">guard</span> result <span class="operator">==</span> errSecSuccess <span class="keyword">else</span> &#123;</span><br><span class="line">            completionHandler(.cancelAuthenticationChallenge, <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查证书固定</span></span><br><span class="line">        <span class="keyword">if</span> isCertificatePinned(serverTrust: serverTrust) &#123;</span><br><span class="line">            <span class="keyword">let</span> credential <span class="operator">=</span> <span class="type">URLCredential</span>(trust: serverTrust)</span><br><span class="line">            completionHandler(.useCredential, credential)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            completionHandler(.cancelAuthenticationChallenge, <span class="literal">nil</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">isCertificatePinned</span>(<span class="params">serverTrust</span>: <span class="type">SecTrust</span>) -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> serverCertificate <span class="operator">=</span> <span class="type">SecTrustGetCertificateAtIndex</span>(serverTrust, <span class="number">0</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> serverCertificateData <span class="operator">=</span> <span class="type">SecCertificateCopyData</span>(serverCertificate)</span><br><span class="line">        <span class="keyword">let</span> data <span class="operator">=</span> <span class="type">CFDataGetBytePtr</span>(serverCertificateData)</span><br><span class="line">        <span class="keyword">let</span> size <span class="operator">=</span> <span class="type">CFDataGetLength</span>(serverCertificateData)</span><br><span class="line">        <span class="keyword">let</span> serverCertData <span class="operator">=</span> <span class="type">Data</span>(bytes: data<span class="operator">!</span>, count: size)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="type">CertificatePinning</span>.pinnedCertificates.contains(serverCertData)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SSL-Pinning绕过技术"><a href="#SSL-Pinning绕过技术" class="headerlink" title="SSL Pinning绕过技术"></a>SSL Pinning绕过技术</h2><h3 id="Frida-Hook绕过"><a href="#Frida-Hook绕过" class="headerlink" title="Frida Hook绕过"></a>Frida Hook绕过</h3><h4 id="Android-SSL-Pinning绕过"><a href="#Android-SSL-Pinning绕过" class="headerlink" title="Android SSL Pinning绕过"></a>Android SSL Pinning绕过</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida脚本：绕过Android SSL Pinning</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bypass_android_ssl_pinning</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook X509TrustManager</span></span><br><span class="line">    <span class="keyword">var</span> X509TrustManager = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.net.ssl.X509TrustManager&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> X509Certificate = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.security.cert.X509Certificate&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook checkClientTrusted</span></span><br><span class="line">    X509TrustManager.<span class="property">checkClientTrusted</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">chain, authType</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] checkClientTrusted called&quot;</span>);</span><br><span class="line">        <span class="comment">// 直接返回，不进行验证</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook checkServerTrusted</span></span><br><span class="line">    X509TrustManager.<span class="property">checkServerTrusted</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">chain, authType</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] checkServerTrusted called&quot;</span>);</span><br><span class="line">        <span class="comment">// 直接返回，不进行验证</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook getAcceptedIssuers</span></span><br><span class="line">    X509TrustManager.<span class="property">getAcceptedIssuers</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] getAcceptedIssuers called&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&quot;java.security.cert.X509Certificate&quot;</span>, []);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook OkHttp的CertificatePinner</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">CertificatePinner</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.CertificatePinner&quot;</span>);</span><br><span class="line">        <span class="title class_">CertificatePinner</span>.<span class="property">check</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>, <span class="string">&quot;java.util.List&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">hostname, peerCertificates</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] CertificatePinner.check called for: &quot;</span> + hostname);</span><br><span class="line">            <span class="comment">// 直接返回，不进行证书固定检查</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] OkHttp CertificatePinner not found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook TrustKit</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">TrustKit</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.datatheorem.android.trustkit.TrustKit&quot;</span>);</span><br><span class="line">        <span class="title class_">TrustKit</span>.<span class="property">getInstance</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] TrustKit.getInstance called&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getInstance</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] TrustKit not found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="iOS-SSL-Pinning绕过"><a href="#iOS-SSL-Pinning绕过" class="headerlink" title="iOS SSL Pinning绕过"></a>iOS SSL Pinning绕过</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida脚本：绕过iOS SSL Pinning</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bypass_ios_ssl_pinning</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook SecTrustEvaluate</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">SecTrustEvaluate</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;Security&quot;</span>, <span class="string">&quot;SecTrustEvaluate&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">SecTrustEvaluate</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">SecTrustEvaluate</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] SecTrustEvaluate called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 强制返回成功</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Forcing SecTrustEvaluate to return success&quot;</span>);</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="title function_">ptr</span>(<span class="number">0</span>)); <span class="comment">// errSecSuccess</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook SecTrustEvaluateWithError (iOS 12+)</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">SecTrustEvaluateWithError</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;Security&quot;</span>, <span class="string">&quot;SecTrustEvaluateWithError&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">SecTrustEvaluateWithError</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">SecTrustEvaluateWithError</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] SecTrustEvaluateWithError called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 强制返回true</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Forcing SecTrustEvaluateWithError to return true&quot;</span>);</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="title function_">ptr</span>(<span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook NSURLSessionDelegate</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">NSURLSessionDelegate</span> = <span class="title class_">ObjC</span>.<span class="property">classes</span>.<span class="property">NSURLSessionDelegate</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">NSURLSessionDelegate</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> originalDidReceiveChallenge = <span class="title class_">NSURLSessionDelegate</span>[<span class="string">&#x27;- URLSession:didReceiveChallenge:completionHandler:&#x27;</span>];</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(originalDidReceiveChallenge.<span class="property">implementation</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] NSURLSessionDelegate didReceiveChallenge called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 修改completionHandler调用</span></span><br><span class="line">                <span class="keyword">var</span> completionHandler = args[<span class="number">4</span>];</span><br><span class="line">                <span class="keyword">var</span> block = <span class="keyword">new</span> <span class="title class_">ObjC</span>.<span class="title class_">Block</span>(completionHandler);</span><br><span class="line">                block.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">disposition, credential</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Modified completionHandler called&quot;</span>);</span><br><span class="line">                    <span class="comment">// 强制使用服务器证书</span></span><br><span class="line">                    block.<span class="title function_">implementation</span>(<span class="number">0</span>, credential); <span class="comment">// URLSessionAuthChallengeUseCredential</span></span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="证书替换绕过"><a href="#证书替换绕过" class="headerlink" title="证书替换绕过"></a>证书替换绕过</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python脚本：证书替换绕过</span></span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> cryptography <span class="keyword">import</span> x509</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CertificateReplacer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, target_host, target_port</span>):</span><br><span class="line">        <span class="variable language_">self</span>.target_host = target_host</span><br><span class="line">        <span class="variable language_">self</span>.target_port = target_port</span><br><span class="line">        <span class="variable language_">self</span>.original_cert = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.replacement_cert = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_server_certificate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取服务器证书&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 创建SSL上下文</span></span><br><span class="line">            context = ssl.create_default_context()</span><br><span class="line">            context.check_hostname = <span class="literal">False</span></span><br><span class="line">            context.verify_mode = ssl.CERT_NONE</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 连接服务器</span></span><br><span class="line">            <span class="keyword">with</span> socket.create_connection((<span class="variable language_">self</span>.target_host, <span class="variable language_">self</span>.target_port)) <span class="keyword">as</span> sock:</span><br><span class="line">                <span class="keyword">with</span> context.wrap_socket(sock, server_hostname=<span class="variable language_">self</span>.target_host) <span class="keyword">as</span> ssock:</span><br><span class="line">                    cert_der = ssock.getpeercert(binary_form=<span class="literal">True</span>)</span><br><span class="line">                    <span class="variable language_">self</span>.original_cert = x509.load_der_x509_certificate(cert_der, default_backend())</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">self</span>.original_cert</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;获取服务器证书失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_replacement_certificate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建替换证书&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">from</span> cryptography <span class="keyword">import</span> x509</span><br><span class="line">        <span class="keyword">from</span> cryptography.x509.oid <span class="keyword">import</span> NameOID</span><br><span class="line">        <span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> hashes, serialization</span><br><span class="line">        <span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="keyword">import</span> rsa</span><br><span class="line">        <span class="keyword">import</span> datetime</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成私钥</span></span><br><span class="line">        private_key = rsa.generate_private_key(</span><br><span class="line">            public_exponent=<span class="number">65537</span>,</span><br><span class="line">            key_size=<span class="number">2048</span>,</span><br><span class="line">            backend=default_backend()</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建证书</span></span><br><span class="line">        subject = issuer = x509.Name([</span><br><span class="line">            x509.NameAttribute(NameOID.COUNTRY_NAME, <span class="string">&quot;US&quot;</span>),</span><br><span class="line">            x509.NameAttribute(NameOID.STATE_OR_PROVINCE_NAME, <span class="string">&quot;CA&quot;</span>),</span><br><span class="line">            x509.NameAttribute(NameOID.LOCALITY_NAME, <span class="string">&quot;San Francisco&quot;</span>),</span><br><span class="line">            x509.NameAttribute(NameOID.ORGANIZATION_NAME, <span class="string">&quot;Test Company&quot;</span>),</span><br><span class="line">            x509.NameAttribute(NameOID.COMMON_NAME, <span class="variable language_">self</span>.target_host),</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        cert = x509.CertificateBuilder().subject_name(</span><br><span class="line">            subject</span><br><span class="line">        ).issuer_name(</span><br><span class="line">            issuer</span><br><span class="line">        ).public_key(</span><br><span class="line">            private_key.public_key()</span><br><span class="line">        ).serial_number(</span><br><span class="line">            x509.random_serial_number()</span><br><span class="line">        ).not_valid_before(</span><br><span class="line">            datetime.datetime.utcnow()</span><br><span class="line">        ).not_valid_after(</span><br><span class="line">            datetime.datetime.utcnow() + datetime.timedelta(days=<span class="number">365</span>)</span><br><span class="line">        ).add_extension(</span><br><span class="line">            x509.SubjectAlternativeName([</span><br><span class="line">                x509.DNSName(<span class="variable language_">self</span>.target_host),</span><br><span class="line">            ]),</span><br><span class="line">            critical=<span class="literal">False</span>,</span><br><span class="line">        ).sign(private_key, hashes.SHA256(), default_backend())</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.replacement_cert = cert</span><br><span class="line">        <span class="keyword">return</span> cert</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_certificate</span>(<span class="params">self, cert, filename</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存证书到文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(cert.public_bytes(serialization.Encoding.PEM))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_certificate</span>(<span class="params">self, filename</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从文件加载证书&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            cert_data = f.read()</span><br><span class="line">            <span class="keyword">return</span> x509.load_pem_x509_certificate(cert_data, default_backend())</span><br></pre></td></tr></table></figure><h2 id="进阶绕过技术"><a href="#进阶绕过技术" class="headerlink" title="进阶绕过技术"></a>进阶绕过技术</h2><h3 id="内存补丁绕过"><a href="#内存补丁绕过" class="headerlink" title="内存补丁绕过"></a>内存补丁绕过</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python脚本：内存补丁绕过SSL Pinning</span></span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] <span class="subst">&#123;message[<span class="string">&#x27;payload&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bypass_ssl_pinning_with_memory_patch</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;使用内存补丁绕过SSL Pinning&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取目标进程</span></span><br><span class="line">    device = frida.get_usb_device()</span><br><span class="line">    session = device.attach(<span class="string">&quot;com.example.app&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 注入脚本</span></span><br><span class="line">    script = session.create_script(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    // 内存补丁绕过SSL Pinning</span></span><br><span class="line"><span class="string">    function patch_ssl_verification() &#123;</span></span><br><span class="line"><span class="string">        // 查找证书验证函数</span></span><br><span class="line"><span class="string">        var verify_cert_addr = Module.findExportByName(&quot;libssl.so&quot;, &quot;SSL_CTX_set_verify&quot;);</span></span><br><span class="line"><span class="string">        if (verify_cert_addr) &#123;</span></span><br><span class="line"><span class="string">            console.log(&quot;[+] Found SSL_CTX_set_verify at: &quot; + verify_cert_addr);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            // 替换函数实现</span></span><br><span class="line"><span class="string">            Interceptor.replace(verify_cert_addr, new NativeCallback(function(ctx, mode, callback) &#123;</span></span><br><span class="line"><span class="string">                console.log(&quot;[+] SSL_CTX_set_verify called, disabling verification&quot;);</span></span><br><span class="line"><span class="string">                // 设置为不验证证书</span></span><br><span class="line"><span class="string">                return 0;</span></span><br><span class="line"><span class="string">            &#125;, &#x27;int&#x27;, [&#x27;pointer&#x27;, &#x27;int&#x27;, &#x27;pointer&#x27;]));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        // 查找证书固定检查函数</span></span><br><span class="line"><span class="string">        var pin_check_addr = Module.findExportByName(&quot;libssl.so&quot;, &quot;SSL_get_peer_certificate&quot;);</span></span><br><span class="line"><span class="string">        if (pin_check_addr) &#123;</span></span><br><span class="line"><span class="string">            console.log(&quot;[+] Found SSL_get_peer_certificate at: &quot; + pin_check_addr);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            // 替换函数实现</span></span><br><span class="line"><span class="string">            Interceptor.replace(pin_check_addr, new NativeCallback(function(ssl) &#123;</span></span><br><span class="line"><span class="string">                console.log(&quot;[+] SSL_get_peer_certificate called, returning null&quot;);</span></span><br><span class="line"><span class="string">                // 返回null，跳过证书检查</span></span><br><span class="line"><span class="string">                return ptr(0);</span></span><br><span class="line"><span class="string">            &#125;, &#x27;pointer&#x27;, [&#x27;pointer&#x27;]));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    // 执行补丁</span></span><br><span class="line"><span class="string">    patch_ssl_verification();</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">    script.load()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 保持脚本运行</span></span><br><span class="line">    sys.stdin.read()</span><br></pre></td></tr></table></figure><h3 id="网络层绕过"><a href="#网络层绕过" class="headerlink" title="网络层绕过"></a>网络层绕过</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python脚本：网络层SSL Pinning绕过</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SSLProxy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, local_port, remote_host, remote_port</span>):</span><br><span class="line">        <span class="variable language_">self</span>.local_port = local_port</span><br><span class="line">        <span class="variable language_">self</span>.remote_host = remote_host</span><br><span class="line">        <span class="variable language_">self</span>.remote_port = remote_port</span><br><span class="line">        <span class="variable language_">self</span>.server_socket = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_proxy</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;启动SSL代理&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        <span class="variable language_">self</span>.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.server_socket.bind((<span class="string">&#x27;localhost&#x27;</span>, <span class="variable language_">self</span>.local_port))</span><br><span class="line">        <span class="variable language_">self</span>.server_socket.listen(<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] SSL Proxy started on port <span class="subst">&#123;self.local_port&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            client_socket, addr = <span class="variable language_">self</span>.server_socket.accept()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] New connection from <span class="subst">&#123;addr&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 处理客户端连接</span></span><br><span class="line">            <span class="variable language_">self</span>.handle_client(client_socket)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_client</span>(<span class="params">self, client_socket</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理客户端连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 接收客户端数据</span></span><br><span class="line">            data = client_socket.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 解析TLS记录</span></span><br><span class="line">            tls_record = <span class="variable language_">self</span>.parse_tls_record(data)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 修改TLS记录</span></span><br><span class="line">            modified_data = <span class="variable language_">self</span>.modify_tls_record(tls_record)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 转发到目标服务器</span></span><br><span class="line">            server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">            server_socket.connect((<span class="variable language_">self</span>.remote_host, <span class="variable language_">self</span>.remote_port))</span><br><span class="line">            server_socket.send(modified_data)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 接收服务器响应</span></span><br><span class="line">            response = server_socket.recv(<span class="number">4096</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 修改服务器响应</span></span><br><span class="line">            modified_response = <span class="variable language_">self</span>.modify_server_response(response)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 转发给客户端</span></span><br><span class="line">            client_socket.send(modified_response)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 关闭连接</span></span><br><span class="line">            server_socket.close()</span><br><span class="line">            client_socket.close()</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] Error handling client: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            client_socket.close()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_tls_record</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析TLS记录&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(data) &lt; <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        content_type = data[<span class="number">0</span>]</span><br><span class="line">        version = struct.unpack(<span class="string">&#x27;&gt;H&#x27;</span>, data[<span class="number">1</span>:<span class="number">3</span>])[<span class="number">0</span>]</span><br><span class="line">        length = struct.unpack(<span class="string">&#x27;&gt;H&#x27;</span>, data[<span class="number">3</span>:<span class="number">5</span>])[<span class="number">0</span>]</span><br><span class="line">        payload = data[<span class="number">5</span>:<span class="number">5</span>+length]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;content_type&#x27;</span>: content_type,</span><br><span class="line">            <span class="string">&#x27;version&#x27;</span>: version,</span><br><span class="line">            <span class="string">&#x27;length&#x27;</span>: length,</span><br><span class="line">            <span class="string">&#x27;payload&#x27;</span>: payload</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">modify_tls_record</span>(<span class="params">self, tls_record</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;修改TLS记录&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> tls_record:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 修改版本号，强制使用TLS 1.0</span></span><br><span class="line">        tls_record[<span class="string">&#x27;version&#x27;</span>] = <span class="number">0x0301</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重新构造TLS记录</span></span><br><span class="line">        modified_data = struct.pack(<span class="string">&#x27;&gt;BHH&#x27;</span>, </span><br><span class="line">                                  tls_record[<span class="string">&#x27;content_type&#x27;</span>],</span><br><span class="line">                                  tls_record[<span class="string">&#x27;version&#x27;</span>],</span><br><span class="line">                                  tls_record[<span class="string">&#x27;length&#x27;</span>]) + tls_record[<span class="string">&#x27;payload&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> modified_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">modify_server_response</span>(<span class="params">self, response</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;修改服务器响应&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 这里可以修改服务器的证书响应</span></span><br><span class="line">        <span class="comment"># 例如：替换证书、修改证书链等</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    proxy = SSLProxy(<span class="number">8443</span>, <span class="string">&quot;example.com&quot;</span>, <span class="number">443</span>)</span><br><span class="line">    proxy.start_proxy()</span><br></pre></td></tr></table></figure><h2 id="检测与防护"><a href="#检测与防护" class="headerlink" title="检测与防护"></a>检测与防护</h2><h3 id="SSL-Pinning检测"><a href="#SSL-Pinning检测" class="headerlink" title="SSL Pinning检测"></a>SSL Pinning检测</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python脚本：检测SSL Pinning</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SSLPinningDetector</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, app_path</span>):</span><br><span class="line">        <span class="variable language_">self</span>.app_path = app_path</span><br><span class="line">        <span class="variable language_">self</span>.pinning_indicators = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_android_ssl_pinning</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测Android应用中的SSL Pinning&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检查APK文件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.app_path.endswith(<span class="string">&#x27;.apk&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.detect_apk_ssl_pinning()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查源代码</span></span><br><span class="line">        <span class="keyword">if</span> os.path.isdir(<span class="variable language_">self</span>.app_path):</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.detect_source_ssl_pinning()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_apk_ssl_pinning</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测APK中的SSL Pinning&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> zipfile</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> zipfile.ZipFile(<span class="variable language_">self</span>.app_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> apk:</span><br><span class="line">                <span class="comment"># 检查classes.dex</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;classes.dex&#x27;</span> <span class="keyword">in</span> apk.namelist():</span><br><span class="line">                    dex_data = apk.read(<span class="string">&#x27;classes.dex&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="variable language_">self</span>.scan_dex_for_pinning(dex_data):</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 检查资源文件</span></span><br><span class="line">                <span class="keyword">for</span> file_name <span class="keyword">in</span> apk.namelist():</span><br><span class="line">                    <span class="keyword">if</span> file_name.endswith(<span class="string">&#x27;.xml&#x27;</span>) <span class="keyword">or</span> file_name.endswith(<span class="string">&#x27;.json&#x27;</span>):</span><br><span class="line">                        file_data = apk.read(file_name)</span><br><span class="line">                        <span class="keyword">if</span> <span class="variable language_">self</span>.scan_resources_for_pinning(file_data):</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] Error analyzing APK: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">scan_dex_for_pinning</span>(<span class="params">self, dex_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;扫描DEX文件中的SSL Pinning代码&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 转换为字符串进行搜索</span></span><br><span class="line">        dex_str = dex_data.decode(<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># SSL Pinning相关字符串</span></span><br><span class="line">        pinning_strings = [</span><br><span class="line">            <span class="string">&#x27;CertificatePinner&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;TrustKit&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;SSLContext&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;X509TrustManager&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;checkServerTrusted&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;pinning&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;certificate&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sha256&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;public-key-pins&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        found_indicators = []</span><br><span class="line">        <span class="keyword">for</span> string <span class="keyword">in</span> pinning_strings:</span><br><span class="line">            <span class="keyword">if</span> string.lower() <span class="keyword">in</span> dex_str.lower():</span><br><span class="line">                found_indicators.append(string)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> found_indicators:</span><br><span class="line">            <span class="variable language_">self</span>.pinning_indicators.extend(found_indicators)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">scan_resources_for_pinning</span>(<span class="params">self, resource_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;扫描资源文件中的SSL Pinning配置&quot;&quot;&quot;</span></span><br><span class="line">        resource_str = resource_data.decode(<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查网络安全配置</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;network_security_config&#x27;</span> <span class="keyword">in</span> resource_str:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;pin-set&#x27;</span> <span class="keyword">in</span> resource_str <span class="keyword">or</span> <span class="string">&#x27;certificates&#x27;</span> <span class="keyword">in</span> resource_str:</span><br><span class="line">                <span class="variable language_">self</span>.pinning_indicators.append(<span class="string">&#x27;network_security_config&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查TrustKit配置</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;trustkit&#x27;</span> <span class="keyword">in</span> resource_str.lower():</span><br><span class="line">            <span class="variable language_">self</span>.pinning_indicators.append(<span class="string">&#x27;trustkit_config&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_source_ssl_pinning</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测源代码中的SSL Pinning&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(<span class="variable language_">self</span>.app_path):</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                <span class="keyword">if</span> file.endswith((<span class="string">&#x27;.java&#x27;</span>, <span class="string">&#x27;.kt&#x27;</span>, <span class="string">&#x27;.swift&#x27;</span>, <span class="string">&#x27;.m&#x27;</span>, <span class="string">&#x27;.h&#x27;</span>)):</span><br><span class="line">                    file_path = os.path.join(root, file)</span><br><span class="line">                    <span class="keyword">if</span> <span class="variable language_">self</span>.scan_source_file(file_path):</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">scan_source_file</span>(<span class="params">self, file_path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;扫描单个源文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 检查SSL Pinning相关代码</span></span><br><span class="line">                pinning_patterns = [</span><br><span class="line">                    <span class="string">r&#x27;CertificatePinner&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;TrustKit&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;SSLContext&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;X509TrustManager&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;checkServerTrusted&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;pinning&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;certificate.*pin&#x27;</span>,</span><br><span class="line">                    <span class="string">r&#x27;sha256.*pin&#x27;</span></span><br><span class="line">                ]</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> pattern <span class="keyword">in</span> pinning_patterns:</span><br><span class="line">                    <span class="keyword">if</span> re.search(pattern, content, re.IGNORECASE):</span><br><span class="line">                        <span class="variable language_">self</span>.pinning_indicators.append(<span class="string">f&quot;<span class="subst">&#123;file_path&#125;</span>: <span class="subst">&#123;pattern&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                        </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] Error scanning file <span class="subst">&#123;file_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_pinning_indicators</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取检测到的SSL Pinning指标&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.pinning_indicators</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    detector = SSLPinningDetector(<span class="string">&quot;app.apk&quot;</span>)</span><br><span class="line">    has_pinning = detector.detect_android_ssl_pinning()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> has_pinning:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] SSL Pinning detected!&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Indicators:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> indicator <span class="keyword">in</span> detector.get_pinning_indicators():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;indicator&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] No SSL Pinning detected&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>SSL&#x2F;TLS协议是现代网络安全的基础，理解其工作原理对于网络安全研究和渗透测试至关重要</p><p><strong>本文关键点</strong>：</p><ul><li><strong>协议深度</strong>：从TLS握手到证书验证的完整流程分析</li><li><strong>绕过技术</strong>：从Frida Hook到内存补丁的多种绕过方法</li></ul><p><strong>这篇内容和之前几篇网络安全基础内容都有关联以及一些补充，其中有不太理解的地方欢迎私聊一起探讨</strong></p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 协议 </tag>
            
            <tag> SSL/TLS </tag>
            
            <tag> 分析 </tag>
            
            <tag> 握手 </tag>
            
            <tag> 证书固定 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web应用代理检测机制：前端与后端的攻防博弈</title>
      <link href="/2025/09/03/article6_web_detection/"/>
      <url>/2025/09/03/article6_web_detection/</url>
      
        <content type="html"><![CDATA[<h2 id="Web代理检测的技术背景"><a href="#Web代理检测的技术背景" class="headerlink" title="Web代理检测的技术背景"></a>Web代理检测的技术背景</h2><h3 id="为什么Web应用需要检测代理？"><a href="#为什么Web应用需要检测代理？" class="headerlink" title="为什么Web应用需要检测代理？"></a>为什么Web应用需要检测代理？</h3><p>Web应用检测代理的主要原因：</p><ul><li><strong>反爬虫机制</strong>：防止自动化工具滥用API</li><li><strong>地理限制</strong>：确保用户来自特定地区</li><li><strong>安全防护</strong>：防止恶意流量和攻击</li><li><strong>数据统计</strong>：准确统计用户来源和访问量</li><li><strong>合规要求</strong>：满足某些法规对用户身份验证的要求</li></ul><p>接下来我将通过一些代码片段来简单剖析其中的一些原理和应对方法</p><span id="more"></span><h2 id="前端检测技术"><a href="#前端检测技术" class="headerlink" title="前端检测技术"></a>前端检测技术</h2><h3 id="1-JavaScript环境检测"><a href="#1-JavaScript环境检测" class="headerlink" title="1. JavaScript环境检测"></a>1. JavaScript环境检测</h3><h4 id="浏览器指纹识别"><a href="#浏览器指纹识别" class="headerlink" title="浏览器指纹识别"></a>浏览器指纹识别</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测浏览器环境是否异常</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">detectBrowserEnvironment</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> checks = &#123;</span><br><span class="line">        <span class="comment">// 检测WebDriver</span></span><br><span class="line">        <span class="attr">webdriver</span>: navigator.<span class="property">webdriver</span> === <span class="literal">true</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测自动化工具特征</span></span><br><span class="line">        <span class="attr">automation</span>: <span class="variable language_">window</span>.<span class="property">chrome</span> &amp;&amp; <span class="variable language_">window</span>.<span class="property">chrome</span>.<span class="property">runtime</span> &amp;&amp; <span class="variable language_">window</span>.<span class="property">chrome</span>.<span class="property">runtime</span>.<span class="property">onConnect</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测无头浏览器</span></span><br><span class="line">        <span class="attr">headless</span>: navigator.<span class="property">userAgent</span>.<span class="title function_">includes</span>(<span class="string">&#x27;HeadlessChrome&#x27;</span>),</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测Selenium</span></span><br><span class="line">        <span class="attr">selenium</span>: <span class="variable language_">window</span>.<span class="property">document</span>.<span class="property">documentElement</span>.<span class="title function_">getAttribute</span>(<span class="string">&#x27;selenium&#x27;</span>) !== <span class="literal">null</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测PhantomJS</span></span><br><span class="line">        <span class="attr">phantom</span>: <span class="variable language_">window</span>.<span class="property">callPhantom</span> !== <span class="literal">undefined</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测Puppeteer</span></span><br><span class="line">        <span class="attr">puppeteer</span>: <span class="variable language_">window</span>.<span class="property">navigator</span>.<span class="property">plugins</span>.<span class="property">length</span> === <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">values</span>(checks).<span class="title function_">some</span>(<span class="function"><span class="params">check</span> =&gt;</span> check === <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测代理相关特征</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">detectProxyFeatures</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> features = &#123;</span><br><span class="line">        <span class="comment">// 检测代理相关的HTTP头</span></span><br><span class="line">        <span class="attr">proxyHeaders</span>: <span class="title function_">detectProxyHeaders</span>(),</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测网络延迟异常</span></span><br><span class="line">        <span class="attr">networkLatency</span>: <span class="title function_">detectNetworkAnomaly</span>(),</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测IP地址特征</span></span><br><span class="line">        <span class="attr">ipFeatures</span>: <span class="title function_">detectIPFeatures</span>()</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> features;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="网络环境检测"><a href="#网络环境检测" class="headerlink" title="网络环境检测"></a>网络环境检测</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测网络延迟和连接特征</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">detectNetworkAnomaly</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> startTime = performance.<span class="title function_">now</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建测试请求</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;/api/ping&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;HEAD&#x27;</span>,</span><br><span class="line">        <span class="attr">cache</span>: <span class="string">&#x27;no-cache&#x27;</span></span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> latency = performance.<span class="title function_">now</span>() - startTime;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 代理通常会增加延迟</span></span><br><span class="line">        <span class="keyword">if</span> (latency &gt; <span class="number">1000</span>) &#123; <span class="comment">// 超过1秒</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;检测到异常网络延迟，可能存在代理&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测WebRTC泄露真实IP</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">detectWebRTCLeak</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> pc = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>(&#123;</span><br><span class="line">            <span class="attr">iceServers</span>: [&#123; <span class="attr">urls</span>: <span class="string">&#x27;stun:stun.l.google.com:19302&#x27;</span> &#125;]</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        pc.<span class="title function_">createDataChannel</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        pc.<span class="title function_">createOffer</span>().<span class="title function_">then</span>(<span class="function"><span class="params">offer</span> =&gt;</span> pc.<span class="title function_">setLocalDescription</span>(offer));</span><br><span class="line">        </span><br><span class="line">        pc.<span class="property">onicecandidate</span> = <span class="function">(<span class="params">ice</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ice.<span class="property">candidate</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> candidate = ice.<span class="property">candidate</span>.<span class="property">candidate</span>;</span><br><span class="line">                <span class="comment">// 检查是否泄露了真实IP</span></span><br><span class="line">                <span class="keyword">if</span> (candidate.<span class="title function_">includes</span>(<span class="string">&#x27;192.168.&#x27;</span>) || </span><br><span class="line">                    candidate.<span class="title function_">includes</span>(<span class="string">&#x27;10.&#x27;</span>) || </span><br><span class="line">                    candidate.<span class="title function_">includes</span>(<span class="string">&#x27;172.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebRTC泄露真实IP，可能存在代理&#x27;</span>);</span><br><span class="line">                    <span class="title function_">resolve</span>(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(<span class="literal">false</span>), <span class="number">3000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-Canvas指纹检测"><a href="#2-Canvas指纹检测" class="headerlink" title="2. Canvas指纹检测"></a>2. Canvas指纹检测</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Canvas指纹检测</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">detectCanvasFingerprint</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绘制特定图形</span></span><br><span class="line">    ctx.<span class="property">textBaseline</span> = <span class="string">&#x27;top&#x27;</span>;</span><br><span class="line">    ctx.<span class="property">font</span> = <span class="string">&#x27;14px Arial&#x27;</span>;</span><br><span class="line">    ctx.<span class="title function_">fillText</span>(<span class="string">&#x27;Canvas fingerprint test&#x27;</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取Canvas数据</span></span><br><span class="line">    <span class="keyword">const</span> fingerprint = canvas.<span class="title function_">toDataURL</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检测指纹是否异常（代理工具可能修改Canvas渲染）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">analyzeCanvasFingerprint</span>(fingerprint);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分析Canvas指纹</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">analyzeCanvasFingerprint</span>(<span class="params">fingerprint</span>) &#123;</span><br><span class="line">    <span class="comment">// 检查指纹长度和特征</span></span><br><span class="line">    <span class="keyword">if</span> (fingerprint.<span class="property">length</span> &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 异常短的指纹</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否包含代理工具的特定特征</span></span><br><span class="line">    <span class="keyword">const</span> proxySignatures = [</span><br><span class="line">        <span class="string">&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==&#x27;</span>,</span><br><span class="line">        <span class="comment">// 添加更多代理工具的签名</span></span><br><span class="line">    ];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> proxySignatures.<span class="title function_">some</span>(<span class="function"><span class="params">signature</span> =&gt;</span> fingerprint.<span class="title function_">includes</span>(signature));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-时间检测"><a href="#3-时间检测" class="headerlink" title="3. 时间检测"></a>3. 时间检测</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测时间异常</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">detectTimeAnomaly</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> checks = &#123;</span><br><span class="line">        <span class="comment">// 检测系统时间是否被修改</span></span><br><span class="line">        <span class="attr">systemTime</span>: <span class="title function_">detectSystemTimeManipulation</span>(),</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测时区是否异常</span></span><br><span class="line">        <span class="attr">timezone</span>: <span class="title function_">detectTimezoneAnomaly</span>(),</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测时间精度</span></span><br><span class="line">        <span class="attr">precision</span>: <span class="title function_">detectTimePrecision</span>()</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">values</span>(checks).<span class="title function_">some</span>(<span class="function"><span class="params">check</span> =&gt;</span> check === <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测系统时间是否被修改</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">detectSystemTimeManipulation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> serverTime = <span class="title function_">getServerTime</span>(); <span class="comment">// 从服务器获取时间</span></span><br><span class="line">    <span class="keyword">const</span> clientTime = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">    <span class="keyword">const</span> diff = <span class="title class_">Math</span>.<span class="title function_">abs</span>(serverTime - clientTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果时间差超过5分钟，可能存在时间修改</span></span><br><span class="line">    <span class="keyword">return</span> diff &gt; <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测时区异常</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">detectTimezoneAnomaly</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> timezone = <span class="title class_">Intl</span>.<span class="title class_">DateTimeFormat</span>().<span class="title function_">resolvedOptions</span>().<span class="property">timeZone</span>;</span><br><span class="line">    <span class="keyword">const</span> offset = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTimezoneOffset</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查时区是否与IP地理位置匹配</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">checkTimezoneConsistency</span>(timezone, offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="后端检测技术"><a href="#后端检测技术" class="headerlink" title="后端检测技术"></a>后端检测技术</h2><h3 id="1-HTTP头检测"><a href="#1-HTTP头检测" class="headerlink" title="1. HTTP头检测"></a>1. HTTP头检测</h3><h4 id="代理相关头部检测"><a href="#代理相关头部检测" class="headerlink" title="代理相关头部检测"></a>代理相关头部检测</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_proxy_headers</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检测代理相关的HTTP头&quot;&quot;&quot;</span></span><br><span class="line">    proxy_headers = &#123;</span><br><span class="line">        <span class="string">&#x27;via&#x27;</span>: request.headers.get(<span class="string">&#x27;Via&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;x_forwarded_for&#x27;</span>: request.headers.get(<span class="string">&#x27;X-Forwarded-For&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;x_forwarded_proto&#x27;</span>: request.headers.get(<span class="string">&#x27;X-Forwarded-Proto&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;x_real_ip&#x27;</span>: request.headers.get(<span class="string">&#x27;X-Real-IP&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;x_forwarded_host&#x27;</span>: request.headers.get(<span class="string">&#x27;X-Forwarded-Host&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;forwarded&#x27;</span>: request.headers.get(<span class="string">&#x27;Forwarded&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;client_ip&#x27;</span>: request.headers.get(<span class="string">&#x27;Client-IP&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;remote_addr&#x27;</span>: request.environ.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查是否有代理头</span></span><br><span class="line">    <span class="keyword">for</span> header_name, header_value <span class="keyword">in</span> proxy_headers.items():</span><br><span class="line">        <span class="keyword">if</span> header_value:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;检测到代理头 <span class="subst">&#123;header_name&#125;</span>: <span class="subst">&#123;header_value&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_x_forwarded_for</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;分析X-Forwarded-For头&quot;&quot;&quot;</span></span><br><span class="line">    xff = request.headers.get(<span class="string">&#x27;X-Forwarded-For&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> xff:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 解析IP列表</span></span><br><span class="line">    ips = [ip.strip() <span class="keyword">for</span> ip <span class="keyword">in</span> xff.split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查IP数量（代理链）</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(ips) &gt; <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;检测到代理链，IP数量: <span class="subst">&#123;<span class="built_in">len</span>(ips)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查IP格式</span></span><br><span class="line">    <span class="keyword">for</span> ip <span class="keyword">in</span> ips:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_valid_ip(ip):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;检测到异常IP格式: <span class="subst">&#123;ip&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_ip</span>(<span class="params">ip</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证IP地址格式&quot;&quot;&quot;</span></span><br><span class="line">    pattern = <span class="string">r&#x27;^(\d&#123;1,3&#125;\.)&#123;3&#125;\d&#123;1,3&#125;$&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> re.<span class="keyword">match</span>(pattern, ip) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure><h4 id="用户代理检测"><a href="#用户代理检测" class="headerlink" title="用户代理检测"></a>用户代理检测</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">detect_suspicious_user_agent</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检测可疑的User-Agent&quot;&quot;&quot;</span></span><br><span class="line">    user_agent = request.headers.get(<span class="string">&#x27;User-Agent&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检测自动化工具</span></span><br><span class="line">    automation_tools = [</span><br><span class="line">        <span class="string">&#x27;selenium&#x27;</span>, <span class="string">&#x27;webdriver&#x27;</span>, <span class="string">&#x27;phantomjs&#x27;</span>, <span class="string">&#x27;puppeteer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;headlesschrome&#x27;</span>, <span class="string">&#x27;chromedriver&#x27;</span>, <span class="string">&#x27;geckodriver&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> tool <span class="keyword">in</span> automation_tools:</span><br><span class="line">        <span class="keyword">if</span> tool.lower() <span class="keyword">in</span> user_agent.lower():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;检测到自动化工具: <span class="subst">&#123;tool&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检测代理工具</span></span><br><span class="line">    proxy_tools = [</span><br><span class="line">        <span class="string">&#x27;proxy&#x27;</span>, <span class="string">&#x27;vpn&#x27;</span>, <span class="string">&#x27;tunnel&#x27;</span>, <span class="string">&#x27;socks&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> tool <span class="keyword">in</span> proxy_tools:</span><br><span class="line">        <span class="keyword">if</span> tool.lower() <span class="keyword">in</span> user_agent.lower():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;检测到代理工具: <span class="subst">&#123;tool&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><h3 id="2-IP地址检测"><a href="#2-IP地址检测" class="headerlink" title="2. IP地址检测"></a>2. IP地址检测</h3><h4 id="IP地理位置检测"><a href="#IP地理位置检测" class="headerlink" title="IP地理位置检测"></a>IP地理位置检测</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_ip_geolocation</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检测IP地理位置&quot;&quot;&quot;</span></span><br><span class="line">    client_ip = get_client_ip()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用IP地理位置服务</span></span><br><span class="line">    geo_services = [</span><br><span class="line">        <span class="string">&#x27;http://ip-api.com/json/&#123;&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;https://ipapi.co/&#123;&#125;/json/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;https://freegeoip.app/json/&#123;&#125;&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> service_url <span class="keyword">in</span> geo_services:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.get(service_url.<span class="built_in">format</span>(client_ip), timeout=<span class="number">5</span>)</span><br><span class="line">            geo_data = response.json()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查地理位置是否合理</span></span><br><span class="line">            <span class="keyword">if</span> is_suspicious_location(geo_data):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;检测到可疑地理位置: <span class="subst">&#123;geo_data&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;地理位置检测失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_suspicious_location</span>(<span class="params">geo_data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;判断地理位置是否可疑&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 检查是否来自数据中心</span></span><br><span class="line">    <span class="keyword">if</span> geo_data.get(<span class="string">&#x27;org&#x27;</span>, <span class="string">&#x27;&#x27;</span>).lower() <span class="keyword">in</span> [<span class="string">&#x27;amazon&#x27;</span>, <span class="string">&#x27;google&#x27;</span>, <span class="string">&#x27;microsoft&#x27;</span>, <span class="string">&#x27;digitalocean&#x27;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查是否来自VPN/代理服务商</span></span><br><span class="line">    vpn_keywords = [<span class="string">&#x27;vpn&#x27;</span>, <span class="string">&#x27;proxy&#x27;</span>, <span class="string">&#x27;hosting&#x27;</span>, <span class="string">&#x27;datacenter&#x27;</span>]</span><br><span class="line">    org = geo_data.get(<span class="string">&#x27;org&#x27;</span>, <span class="string">&#x27;&#x27;</span>).lower()</span><br><span class="line">    <span class="keyword">for</span> keyword <span class="keyword">in</span> vpn_keywords:</span><br><span class="line">        <span class="keyword">if</span> keyword <span class="keyword">in</span> org:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><h4 id="IP黑名单检测"><a href="#IP黑名单检测" class="headerlink" title="IP黑名单检测"></a>IP黑名单检测</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_ip_blacklist</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查IP黑名单&quot;&quot;&quot;</span></span><br><span class="line">    client_ip = get_client_ip()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 代理IP数据库</span></span><br><span class="line">    proxy_ips = load_proxy_database()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> client_ip <span class="keyword">in</span> proxy_ips:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;IP在黑名单中: <span class="subst">&#123;client_ip&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查IP段</span></span><br><span class="line">    <span class="keyword">for</span> ip_range <span class="keyword">in</span> proxy_ips:</span><br><span class="line">        <span class="keyword">if</span> is_ip_in_range(client_ip, ip_range):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;IP在代理IP段中: <span class="subst">&#123;client_ip&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_proxy_database</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;加载代理IP数据库&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 这里可以从文件或数据库加载代理IP列表</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">&#x27;1.2.3.4&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;5.6.7.8&#x27;</span>,</span><br><span class="line">        <span class="comment"># 更多代理IP...</span></span><br><span class="line">    ]</span><br></pre></td></tr></table></figure><h3 id="3-行为检测"><a href="#3-行为检测" class="headerlink" title="3. 行为检测"></a>3. 行为检测</h3><h4 id="访问模式分析"><a href="#访问模式分析" class="headerlink" title="访问模式分析"></a>访问模式分析</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_access_pattern</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;分析访问模式&quot;&quot;&quot;</span></span><br><span class="line">    client_ip = get_client_ip()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查访问频率</span></span><br><span class="line">    <span class="keyword">if</span> is_high_frequency_access(client_ip):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;检测到高频访问: <span class="subst">&#123;client_ip&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查访问时间模式</span></span><br><span class="line">    <span class="keyword">if</span> is_automated_access_pattern(client_ip):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;检测到自动化访问模式: <span class="subst">&#123;client_ip&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查请求头一致性</span></span><br><span class="line">    <span class="keyword">if</span> is_inconsistent_headers(client_ip):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;检测到不一致的请求头: <span class="subst">&#123;client_ip&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_high_frequency_access</span>(<span class="params">ip</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查是否高频访问&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 这里可以实现基于Redis或数据库的频率限制</span></span><br><span class="line">    <span class="comment"># 例如：每分钟超过60次请求</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_automated_access_pattern</span>(<span class="params">ip</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查是否自动化访问模式&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 检查请求间隔是否过于规律</span></span><br><span class="line">    <span class="comment"># 检查是否缺少人类行为特征</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><h2 id="绕过技术详解"><a href="#绕过技术详解" class="headerlink" title="绕过技术详解"></a>绕过技术详解</h2><h3 id="1-前端绕过技术"><a href="#1-前端绕过技术" class="headerlink" title="1. 前端绕过技术"></a>1. 前端绕过技术</h3><h4 id="浏览器环境伪装"><a href="#浏览器环境伪装" class="headerlink" title="浏览器环境伪装"></a>浏览器环境伪装</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪装浏览器环境</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">disguiseBrowserEnvironment</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 移除webdriver标识</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(navigator, <span class="string">&#x27;webdriver&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="literal">undefined</span></span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 伪装插件</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(navigator, <span class="string">&#x27;plugins&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] <span class="comment">// 模拟5个插件</span></span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 伪装语言</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(navigator, <span class="string">&#x27;languages&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> [<span class="string">&#x27;zh-CN&#x27;</span>, <span class="string">&#x27;zh&#x27;</span>, <span class="string">&#x27;en&#x27;</span>]</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 伪装屏幕分辨率</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(screen, <span class="string">&#x27;width&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="number">1920</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(screen, <span class="string">&#x27;height&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="number">1080</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 禁用WebRTC</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">disableWebRTC</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 重写RTCPeerConnection</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">RTCPeerConnection</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;WebRTC is disabled&#x27;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Canvas指纹伪造"><a href="#Canvas指纹伪造" class="headerlink" title="Canvas指纹伪造"></a>Canvas指纹伪造</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪造Canvas指纹</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">forgeCanvasFingerprint</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> originalToDataURL = <span class="title class_">HTMLCanvasElement</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toDataURL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">HTMLCanvasElement</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toDataURL</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 返回正常的指纹数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==&#x27;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-后端绕过技术"><a href="#2-后端绕过技术" class="headerlink" title="2. 后端绕过技术"></a>2. 后端绕过技术</h3><h4 id="请求头伪造"><a href="#请求头伪造" class="headerlink" title="请求头伪造"></a>请求头伪造</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">forge_headers</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;伪造请求头&quot;&quot;&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9,en;q=0.8&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate, br&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Sec-Fetch-Dest&#x27;</span>: <span class="string">&#x27;document&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Sec-Fetch-Mode&#x27;</span>: <span class="string">&#x27;navigate&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Sec-Fetch-Site&#x27;</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 移除代理相关头部</span></span><br><span class="line">    <span class="comment"># 不设置X-Forwarded-For等头部</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> headers</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rotate_user_agents</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;轮换User-Agent&quot;&quot;&quot;</span></span><br><span class="line">    user_agents = [</span><br><span class="line">        <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    <span class="keyword">return</span> random.choice(user_agents)</span><br></pre></td></tr></table></figure><h4 id="代理池技术"><a href="#代理池技术" class="headerlink" title="代理池技术"></a>代理池技术</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProxyPool</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.proxies = [</span><br><span class="line">            &#123;<span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://proxy1:port&#x27;</span>, <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://proxy1:port&#x27;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://proxy2:port&#x27;</span>, <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://proxy2:port&#x27;</span>&#125;,</span><br><span class="line">            <span class="comment"># 更多代理...</span></span><br><span class="line">        ]</span><br><span class="line">        <span class="variable language_">self</span>.current_proxy = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_random_proxy</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取随机代理&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> random.choice(<span class="variable language_">self</span>.proxies)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rotate_proxy</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;轮换代理&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.current_proxy = <span class="variable language_">self</span>.get_random_proxy()</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.current_proxy</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_request</span>(<span class="params">self, url, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;使用代理发送请求&quot;&quot;&quot;</span></span><br><span class="line">        proxy = <span class="variable language_">self</span>.rotate_proxy()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.get(url, proxies=proxy, **kwargs)</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;代理请求失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 尝试下一个代理</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.make_request(url, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">proxy_pool = ProxyPool()</span><br><span class="line">response = proxy_pool.make_request(<span class="string">&#x27;https://example.com&#x27;</span>, headers=forge_headers())</span><br></pre></td></tr></table></figure><h3 id="3-进阶绕过技术"><a href="#3-进阶绕过技术" class="headerlink" title="3. 进阶绕过技术"></a>3. 进阶绕过技术</h3><h4 id="浏览器自动化绕过"><a href="#浏览器自动化绕过" class="headerlink" title="浏览器自动化绕过"></a>浏览器自动化绕过</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_stealth_driver</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;创建隐蔽的浏览器驱动&quot;&quot;&quot;</span></span><br><span class="line">    options = Options()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加反检测选项</span></span><br><span class="line">    options.add_argument(<span class="string">&#x27;--disable-blink-features=AutomationControlled&#x27;</span>)</span><br><span class="line">    options.add_experimental_option(<span class="string">&quot;excludeSwitches&quot;</span>, [<span class="string">&quot;enable-automation&quot;</span>])</span><br><span class="line">    options.add_experimental_option(<span class="string">&#x27;useAutomationExtension&#x27;</span>, <span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设置用户代理</span></span><br><span class="line">    options.add_argument(<span class="string">&#x27;--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    driver = webdriver.Chrome(options=options)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 执行反检测脚本</span></span><br><span class="line">    driver.execute_script(<span class="string">&quot;Object.defineProperty(navigator, &#x27;webdriver&#x27;, &#123;get: () =&gt; undefined&#125;)&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> driver</span><br></pre></td></tr></table></figure><h4 id="分布式请求"><a href="#分布式请求" class="headerlink" title="分布式请求"></a>分布式请求</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">distributed_request</span>(<span class="params">url, proxy_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;分布式请求&quot;&quot;&quot;</span></span><br><span class="line">    tasks = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> proxy <span class="keyword">in</span> proxy_list:</span><br><span class="line">        task = make_async_request(url, proxy)</span><br><span class="line">        tasks.append(task)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 并发执行请求</span></span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回成功的结果</span></span><br><span class="line">    <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(result, Exception):</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">make_async_request</span>(<span class="params">url, proxy</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;异步请求&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, proxy=proxy) <span class="keyword">as</span> response:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">await</span> response.text()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure><h2 id="检测与绕过的对抗演进"><a href="#检测与绕过的对抗演进" class="headerlink" title="检测与绕过的对抗演进"></a>检测与绕过的对抗演进</h2><h3 id="检测技术演进"><a href="#检测技术演进" class="headerlink" title="检测技术演进"></a>检测技术演进</h3><p><strong>第一代检测</strong>：</p><ul><li>简单的User-Agent检测</li><li>基本的IP黑名单</li><li>简单的频率限制</li></ul><p><strong>第二代检测</strong>：</p><ul><li>浏览器指纹识别</li><li>行为模式分析</li><li>地理位置验证</li></ul><p><strong>第三代检测</strong>：</p><ul><li>机器学习检测</li><li>实时行为分析</li><li>多维度综合判断</li></ul><h3 id="绕过技术演进"><a href="#绕过技术演进" class="headerlink" title="绕过技术演进"></a>绕过技术演进</h3><p><strong>第一代绕过</strong>：</p><ul><li>简单的User-Agent伪造</li><li>基础代理使用</li><li>请求头修改</li></ul><p><strong>第二代绕过</strong>：</p><ul><li>浏览器环境伪装</li><li>代理池技术</li><li>分布式请求</li></ul><p><strong>第三代绕过</strong>：</p><ul><li>深度浏览器伪装</li><li>智能代理选择</li><li>行为模拟</li></ul><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>Web应用代理检测与绕过技术也是一个不断演进的攻防对抗过程，同样这篇文章总结也还是大体的冰山一角，实际应用场景中会有更多情况。</p><p><strong>本文关键点</strong>：</p><ul><li><strong>多层检测</strong>：前端JavaScript检测与后端服务器检测机制简要分析</li><li><strong>技术演进</strong>：从简单检测到智能分析，从基础绕过到深度伪装，实际开发过程中的具体场景具体分析</li></ul>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代理 </tag>
            
            <tag> VPN </tag>
            
            <tag> Web </tag>
            
            <tag> 攻防 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS代理检测与绕过技术：与Android的对比</title>
      <link href="/2025/09/02/article5_ios_detection/"/>
      <url>/2025/09/02/article5_ios_detection/</url>
      
        <content type="html"><![CDATA[<h2 id="iOS-vs-Android：检测机制对比"><a href="#iOS-vs-Android：检测机制对比" class="headerlink" title="iOS vs Android：检测机制对比"></a>iOS vs Android：检测机制对比</h2><h3 id="系统架构差异"><a href="#系统架构差异" class="headerlink" title="系统架构差异"></a>系统架构差异</h3><p><strong>iOS系统特点</strong>：</p><ul><li><strong>沙盒机制</strong>：应用运行在严格的沙盒环境中</li><li><strong>系统API限制</strong>：网络配置API相对封闭</li><li><strong>证书管理</strong>：系统级证书固定和验证</li><li><strong>越狱检测</strong>：多重越狱状态检测机制<span id="more"></span><strong>Android系统特点</strong>：</li><li><strong>开放生态</strong>：更多系统级API可访问</li><li><strong>权限模型</strong>：基于权限的网络访问控制</li><li><strong>Root检测</strong>：相对简单的Root状态检测</li><li><strong>系统属性</strong>：可直接访问系统配置</li></ul><h3 id="检测点对比表"><a href="#检测点对比表" class="headerlink" title="检测点对比表"></a>检测点对比表</h3><table><thead><tr><th>检测维度</th><th>iOS检测方法</th><th>Android检测方法</th><th>绕过难度</th></tr></thead><tbody><tr><td><strong>系统代理</strong></td><td>CFNetwork代理设置、NSURLSession配置</td><td>ConnectivityManager、Proxy.getDefaultHost()</td><td>iOS更难</td></tr><tr><td><strong>VPN检测</strong></td><td>NWPathMonitor、Network.framework</td><td>NetworkCapabilities.TRANSPORT_VPN</td><td>iOS更难</td></tr><tr><td><strong>证书检测</strong></td><td>SecTrustEvaluate、SSL Pinning</td><td>X509TrustManager、Certificate Pinning</td><td>相当</td></tr><tr><td><strong>网络接口</strong></td><td>getifaddrs、ifconfig</td><td>NetworkInterface、ifconfig</td><td>iOS更难</td></tr><tr><td><strong>抓包检测</strong></td><td>证书链验证、SNI检测</td><td>证书验证、代理头检测</td><td>iOS更难</td></tr><tr><td><strong>越狱检测</strong></td><td>文件系统、API调用、沙盒检查</td><td>Root文件、su命令、系统属性</td><td>iOS更难</td></tr></tbody></table><h2 id="iOS代理检测原理深度解析"><a href="#iOS代理检测原理深度解析" class="headerlink" title="iOS代理检测原理深度解析"></a>iOS代理检测原理深度解析</h2><h3 id="1-系统代理检测"><a href="#1-系统代理检测" class="headerlink" title="1. 系统代理检测"></a>1. 系统代理检测</h3><h4 id="CFNetwork代理检测"><a href="#CFNetwork代理检测" class="headerlink" title="CFNetwork代理检测"></a>CFNetwork代理检测</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Network</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProxyDetector</span> &#123;</span><br><span class="line">    <span class="comment">// 检测系统HTTP代理设置</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">detectSystemProxy</span>() -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> proxySettings <span class="operator">=</span> <span class="type">CFNetworkCopySystemProxySettings</span>()</span><br><span class="line">        <span class="keyword">let</span> proxyDict <span class="operator">=</span> proxySettings<span class="operator">?</span>.takeRetainedValue() <span class="keyword">as?</span> [<span class="type">String</span>: <span class="keyword">Any</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> httpProxy <span class="operator">=</span> proxyDict<span class="operator">?</span>[<span class="string">&quot;HTTPProxy&quot;</span>] <span class="keyword">as?</span> <span class="type">String</span>,</span><br><span class="line">           <span class="operator">!</span>httpProxy.isEmpty &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;检测到HTTP代理: <span class="subst">\(httpProxy)</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> httpsProxy <span class="operator">=</span> proxyDict<span class="operator">?</span>[<span class="string">&quot;HTTPSProxy&quot;</span>] <span class="keyword">as?</span> <span class="type">String</span>,</span><br><span class="line">           <span class="operator">!</span>httpsProxy.isEmpty &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;检测到HTTPS代理: <span class="subst">\(httpsProxy)</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检测SOCKS代理</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">detectSOCKSProxy</span>() -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> proxySettings <span class="operator">=</span> <span class="type">CFNetworkCopySystemProxySettings</span>()</span><br><span class="line">        <span class="keyword">let</span> proxyDict <span class="operator">=</span> proxySettings<span class="operator">?</span>.takeRetainedValue() <span class="keyword">as?</span> [<span class="type">String</span>: <span class="keyword">Any</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> socksProxy <span class="operator">=</span> proxyDict<span class="operator">?</span>[<span class="string">&quot;SOCKSProxy&quot;</span>] <span class="keyword">as?</span> <span class="type">String</span>,</span><br><span class="line">           <span class="operator">!</span>socksProxy.isEmpty &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;检测到SOCKS代理: <span class="subst">\(socksProxy)</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="NSURLSession代理检测"><a href="#NSURLSession代理检测" class="headerlink" title="NSURLSession代理检测"></a>NSURLSession代理检测</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">URLSessionProxyDetector</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">detectProxyInURLSession</span>() -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> config <span class="operator">=</span> <span class="type">URLSessionConfiguration</span>.default</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查代理配置</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> proxyDict <span class="operator">=</span> config.connectionProxyDictionary &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;检测到URLSession代理配置: <span class="subst">\(proxyDict)</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查是否使用了自定义代理</span></span><br><span class="line">        <span class="keyword">if</span> config.httpProxy <span class="operator">!=</span> <span class="literal">nil</span> <span class="operator">||</span> config.httpsProxy <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;检测到HTTP/HTTPS代理&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-VPN和隧道检测"><a href="#2-VPN和隧道检测" class="headerlink" title="2. VPN和隧道检测"></a>2. VPN和隧道检测</h3><h4 id="Network-framework检测"><a href="#Network-framework检测" class="headerlink" title="Network.framework检测"></a>Network.framework检测</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Network</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VPNDetector</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> monitor <span class="operator">=</span> <span class="type">NWPathMonitor</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">detectVPN</span>() -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> isVPNConnected <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">        </span><br><span class="line">        monitor.pathUpdateHandler <span class="operator">=</span> &#123; path <span class="keyword">in</span></span><br><span class="line">            <span class="comment">// 检查网络接口类型</span></span><br><span class="line">            <span class="keyword">for</span> interface <span class="keyword">in</span> path.availableInterfaces &#123;</span><br><span class="line">                <span class="keyword">if</span> interface.type <span class="operator">==</span> .wifi <span class="operator">||</span> interface.type <span class="operator">==</span> .cellular &#123;</span><br><span class="line">                    <span class="comment">// 检查是否有VPN接口</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.hasVPNInterface() &#123;</span><br><span class="line">                        isVPNConnected <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;检测到VPN连接&quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> queue <span class="operator">=</span> <span class="type">DispatchQueue</span>(label: <span class="string">&quot;VPNMonitor&quot;</span>)</span><br><span class="line">        monitor.start(queue: queue)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> isVPNConnected</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">hasVPNInterface</span>() -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> ifaddr: <span class="type">UnsafeMutablePointer</span>&lt;ifaddrs&gt;?</span><br><span class="line">        <span class="keyword">guard</span> getifaddrs(<span class="operator">&amp;</span>ifaddr) <span class="operator">==</span> <span class="number">0</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">false</span> &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> current <span class="operator">=</span> ifaddr</span><br><span class="line">        <span class="keyword">while</span> current <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> interface <span class="operator">=</span> current<span class="operator">!</span>.pointee</span><br><span class="line">            <span class="keyword">let</span> name <span class="operator">=</span> <span class="type">String</span>(cString: interface.ifa_name)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查常见的VPN接口名称</span></span><br><span class="line">            <span class="keyword">if</span> name.hasPrefix(<span class="string">&quot;utun&quot;</span>) <span class="operator">||</span> name.hasPrefix(<span class="string">&quot;ipsec&quot;</span>) <span class="operator">||</span> </span><br><span class="line">               name.hasPrefix(<span class="string">&quot;ppp&quot;</span>) <span class="operator">||</span> name.hasPrefix(<span class="string">&quot;tun&quot;</span>) &#123;</span><br><span class="line">                freeifaddrs(ifaddr)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            current <span class="operator">=</span> interface.ifa_next</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        freeifaddrs(ifaddr)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-证书和抓包检测"><a href="#3-证书和抓包检测" class="headerlink" title="3. 证书和抓包检测"></a>3. 证书和抓包检测</h3><h4 id="SSL-Pinning检测"><a href="#SSL-Pinning检测" class="headerlink" title="SSL Pinning检测"></a>SSL Pinning检测</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Security</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CertificateDetector</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">detectCertificatePinning</span>() -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="comment">// 检查是否有自定义的证书验证逻辑</span></span><br><span class="line">        <span class="keyword">let</span> session <span class="operator">=</span> <span class="type">URLSession</span>(configuration: .default)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通过反射检查是否有自定义的URLSessionDelegate</span></span><br><span class="line">        <span class="keyword">let</span> mirror <span class="operator">=</span> <span class="type">Mirror</span>(reflecting: session)</span><br><span class="line">        <span class="keyword">for</span> child <span class="keyword">in</span> mirror.children &#123;</span><br><span class="line">            <span class="keyword">if</span> child.label <span class="operator">==</span> <span class="string">&quot;delegate&quot;</span> <span class="operator">&amp;&amp;</span> child.value <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;检测到自定义URLSessionDelegate，可能存在证书固定&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检测证书链异常</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">detectCertificateChainAnomaly</span>() -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="comment">// 这里可以检查证书链中的中间证书</span></span><br><span class="line">        <span class="comment">// 抓包工具通常会插入自己的CA证书</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SNI检测"><a href="#SNI检测" class="headerlink" title="SNI检测"></a>SNI检测</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SNIDetector</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">detectSNIManipulation</span>() -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="comment">// 检查SNI字段是否被修改</span></span><br><span class="line">        <span class="comment">// 抓包工具可能会修改SNI字段</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-网络接口检测"><a href="#4-网络接口检测" class="headerlink" title="4. 网络接口检测"></a>4. 网络接口检测</h3><h4 id="网络接口分析"><a href="#网络接口分析" class="headerlink" title="网络接口分析"></a>网络接口分析</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkInterfaceDetector</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">analyzeNetworkInterfaces</span>() -&gt; [<span class="type">String</span>: <span class="keyword">Any</span>] &#123;</span><br><span class="line">        <span class="keyword">var</span> interfaces: [<span class="type">String</span>: <span class="keyword">Any</span>] <span class="operator">=</span> [:]</span><br><span class="line">        <span class="keyword">var</span> ifaddr: <span class="type">UnsafeMutablePointer</span>&lt;ifaddrs&gt;?</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> getifaddrs(<span class="operator">&amp;</span>ifaddr) <span class="operator">==</span> <span class="number">0</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> interfaces</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> current <span class="operator">=</span> ifaddr</span><br><span class="line">        <span class="keyword">while</span> current <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> interface <span class="operator">=</span> current<span class="operator">!</span>.pointee</span><br><span class="line">            <span class="keyword">let</span> name <span class="operator">=</span> <span class="type">String</span>(cString: interface.ifa_name)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> interface.ifa_addr <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> family <span class="operator">=</span> interface.ifa_addr.pointee.sa_family</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> family <span class="operator">==</span> <span class="type">UInt8</span>(<span class="type">AF_INET</span>) <span class="operator">||</span> family <span class="operator">==</span> <span class="type">UInt8</span>(<span class="type">AF_INET6</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> hostname <span class="operator">=</span> [<span class="type">CChar</span>](repeating: <span class="number">0</span>, count: <span class="type">Int</span>(<span class="type">NI_MAXHOST</span>))</span><br><span class="line">                    getnameinfo(interface.ifa_addr, socklen_t(interface.ifa_addr.pointee.sa_len),</span><br><span class="line">                               <span class="operator">&amp;</span>hostname, socklen_t(hostname.count),</span><br><span class="line">                               <span class="literal">nil</span>, <span class="number">0</span>, <span class="type">NI_NUMERICHOST</span>)</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">let</span> address <span class="operator">=</span> <span class="type">String</span>(cString: hostname)</span><br><span class="line">                    interfaces[name] <span class="operator">=</span> [</span><br><span class="line">                        <span class="string">&quot;address&quot;</span>: address,</span><br><span class="line">                        <span class="string">&quot;family&quot;</span>: family,</span><br><span class="line">                        <span class="string">&quot;flags&quot;</span>: interface.ifa_flags</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            current <span class="operator">=</span> interface.ifa_next</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        freeifaddrs(ifaddr)</span><br><span class="line">        <span class="keyword">return</span> interfaces</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-Hook绕过技术"><a href="#Frida-Hook绕过技术" class="headerlink" title="Frida Hook绕过技术"></a>Frida Hook绕过技术</h2><h3 id="1-Hook-CFNetwork代理检测"><a href="#1-Hook-CFNetwork代理检测" class="headerlink" title="1. Hook CFNetwork代理检测"></a>1. Hook CFNetwork代理检测</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hook CFNetwork代理设置获取</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookCFNetworkProxy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook CFNetworkCopySystemProxySettings</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">CFNetworkCopySystemProxySettings</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;CFNetwork&quot;</span>, <span class="string">&quot;CFNetworkCopySystemProxySettings&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">CFNetworkCopySystemProxySettings</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">CFNetworkCopySystemProxySettings</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] CFNetworkCopySystemProxySettings called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 返回空的代理设置</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Returning empty proxy settings&quot;</span>);</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="title function_">ptr</span>(<span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook CFNetworkCopyProxiesForURL</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">CFNetworkCopyProxiesForURL</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;CFNetwork&quot;</span>, <span class="string">&quot;CFNetworkCopyProxiesForURL&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">CFNetworkCopyProxiesForURL</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">CFNetworkCopyProxiesForURL</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] CFNetworkCopyProxiesForURL called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 返回空数组</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Returning empty proxy array&quot;</span>);</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="title function_">ptr</span>(<span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-Hook-Network-framework"><a href="#2-Hook-Network-framework" class="headerlink" title="2. Hook Network.framework"></a>2. Hook Network.framework</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hook NWPathMonitor</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookNWPathMonitor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Hook NWPathMonitor的pathUpdateHandler</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">NWPathMonitor</span> = <span class="title class_">ObjC</span>.<span class="property">classes</span>.<span class="property">NWPathMonitor</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">NWPathMonitor</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> originalSetPathUpdateHandler = <span class="title class_">NWPathMonitor</span>[<span class="string">&#x27;- setPathUpdateHandler:&#x27;</span>];</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(originalSetPathUpdateHandler.<span class="property">implementation</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] NWPathMonitor setPathUpdateHandler called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 可以在这里修改pathUpdateHandler的行为</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-Hook证书验证"><a href="#3-Hook证书验证" class="headerlink" title="3. Hook证书验证"></a>3. Hook证书验证</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hook SecTrustEvaluate</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookSecTrustEvaluate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">SecTrustEvaluate</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;Security&quot;</span>, <span class="string">&quot;SecTrustEvaluate&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">SecTrustEvaluate</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">SecTrustEvaluate</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] SecTrustEvaluate called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 强制返回成功</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Forcing SecTrustEvaluate to return success&quot;</span>);</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="title function_">ptr</span>(<span class="number">0</span>)); <span class="comment">// errSecSuccess</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook SecTrustEvaluateWithError (iOS 12+)</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">SecTrustEvaluateWithError</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;Security&quot;</span>, <span class="string">&quot;SecTrustEvaluateWithError&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">SecTrustEvaluateWithError</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">SecTrustEvaluateWithError</span>, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] SecTrustEvaluateWithError called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 强制返回true</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Forcing SecTrustEvaluateWithError to return true&quot;</span>);</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="title function_">ptr</span>(<span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-Hook网络接口检测"><a href="#4-Hook网络接口检测" class="headerlink" title="4. Hook网络接口检测"></a>4. Hook网络接口检测</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hook getifaddrs</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookGetifaddrs</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> getifaddrs = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc&quot;</span>, <span class="string">&quot;getifaddrs&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (getifaddrs) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(getifaddrs, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] getifaddrs called&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 可以在这里修改返回的网络接口信息</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] getifaddrs returned: &quot;</span> + retval);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="越狱环境下的高级绕过"><a href="#越狱环境下的高级绕过" class="headerlink" title="越狱环境下的高级绕过"></a>越狱环境下的高级绕过</h2><h3 id="1-使用Substrate-Hook"><a href="#1-使用Substrate-Hook" class="headerlink" title="1. 使用Substrate Hook"></a>1. 使用Substrate Hook</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用Substrate Hook CFNetwork</span></span><br><span class="line">%hook <span class="built_in">NSURLSessionConfiguration</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)connectionProxyDictionary &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;[+] NSURLSessionConfiguration connectionProxyDictionary called&quot;</span>);</span><br><span class="line">    <span class="comment">// 返回空字典，隐藏代理设置</span></span><br><span class="line">    <span class="keyword">return</span> @&#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%hook <span class="built_in">NSURLSession</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request </span><br><span class="line">                            completionHandler:(<span class="type">void</span> (^)(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;[+] NSURLSession dataTaskWithRequest called&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br></pre></td></tr></table></figure><h3 id="2-使用Theos开发Tweak"><a href="#2-使用Theos开发Tweak" class="headerlink" title="2. 使用Theos开发Tweak"></a>2. 使用Theos开发Tweak</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tweak.x</span></span><br><span class="line">%hook <span class="built_in">NSURLSessionConfiguration</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)connectionProxyDictionary &#123;</span><br><span class="line">    <span class="comment">// 隐藏代理配置</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%hook NWPathMonitor</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setPathUpdateHandler:(<span class="type">void</span> (^)(NWPath *path))handler &#123;</span><br><span class="line">    <span class="comment">// 修改pathUpdateHandler，隐藏VPN检测</span></span><br><span class="line">    %orig;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br></pre></td></tr></table></figure><h3 id="3-系统级修改"><a href="#3-系统级修改" class="headerlink" title="3. 系统级修改"></a>3. 系统级修改</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改系统代理设置文件</span></span><br><span class="line"><span class="comment"># /var/preferences/SystemConfiguration/preferences.plist</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用plutil修改代理设置</span></span><br><span class="line">plutil -p /var/preferences/SystemConfiguration/preferences.plist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接删除代理相关配置</span></span><br><span class="line"><span class="built_in">rm</span> -f /var/preferences/SystemConfiguration/preferences.plist</span><br></pre></td></tr></table></figure><h2 id="非越狱环境下的绕过策略"><a href="#非越狱环境下的绕过策略" class="headerlink" title="非越狱环境下的绕过策略"></a>非越狱环境下的绕过策略</h2><h3 id="1-使用Shadowrocket等工具"><a href="#1-使用Shadowrocket等工具" class="headerlink" title="1. 使用Shadowrocket等工具"></a>1. 使用Shadowrocket等工具</h3><p><strong>Shadowrocket配置</strong>：</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[General]</span><br><span class="line"><span class="comment"># 启用增强模式</span></span><br><span class="line">enhanced-mode = <span class="literal">true</span></span><br><span class="line"><span class="comment"># 隐藏VPN标识</span></span><br><span class="line"><span class="literal">hide</span>-vpn-<span class="keyword">icon</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment"># 使用系统代理</span></span><br><span class="line">use-<span class="params">system</span>-proxy = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Rule]</span><br><span class="line"><span class="comment"># 绕过检测规则</span></span><br><span class="line">DOMAIN-SUFFIX,example.com,DIRECT</span><br></pre></td></tr></table></figure><h3 id="2-使用Quantumult-X"><a href="#2-使用Quantumult-X" class="headerlink" title="2. 使用Quantumult X"></a>2. 使用Quantumult X</h3><p><strong>Quantumult X配置</strong>：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[general]</span></span><br><span class="line"><span class="comment"># 启用增强模式</span></span><br><span class="line"><span class="attr">enhanced-mode</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment"># 隐藏VPN标识</span></span><br><span class="line"><span class="attr">hide-vpn-icon</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[policy]</span></span><br><span class="line"><span class="comment"># 绕过策略</span></span><br><span class="line"><span class="attr">static</span>=bypass, direct, img-url=https://example.com/icon.png</span><br></pre></td></tr></table></figure><h3 id="3-使用Surge"><a href="#3-使用Surge" class="headerlink" title="3. 使用Surge"></a>3. 使用Surge</h3><p><strong>Surge配置</strong>：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">General</span>]</span><br><span class="line"><span class="meta"># 启用增强模式</span></span><br><span class="line">enhanced-mode = <span class="literal">true</span></span><br><span class="line"><span class="meta"># 隐藏VPN标识</span></span><br><span class="line">hide-vpn-icon = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">Rule</span>]</span><br><span class="line"><span class="meta"># 绕过检测</span></span><br><span class="line">DOMAIN-SUFFIX,example.com,DIRECT</span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>iOS代理检测与绕过技术相比Android更加复杂，需要更深入的系统知识和更高级的技术手段。理解检测原理，掌握绕过技术，是移动安全研究的重要技能。</p><p><strong>本文关键点</strong>：</p><ul><li><strong>系统差异</strong>：iOS的封闭生态使得检测更加隐蔽，绕过更加困难</li><li><strong>技术演进</strong>：从简单Hook到系统级修改，技术手段不断升级</li></ul>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 安全 </tag>
            
            <tag> 代理 </tag>
            
            <tag> VPN </tag>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>高级绕过技术：iptables与透明代理</title>
      <link href="/2025/08/30/article4_iptables_transparent/"/>
      <url>/2025/08/30/article4_iptables_transparent/</url>
      
        <content type="html"><![CDATA[<h2 id="iptables基础原理"><a href="#iptables基础原理" class="headerlink" title="iptables基础原理"></a>iptables基础原理</h2><h3 id="什么是iptables？"><a href="#什么是iptables？" class="headerlink" title="什么是iptables？"></a>什么是iptables？</h3><p><strong>iptables</strong>简单来说就是Linux内核中Netfilter框架的一个”控制面板”。它就像网络世界的”交通警察”，可以控制哪些数据包能通过，哪些不能通过，以及数据包应该往哪里走。</p><p>在Android系统中，由于基于Linux内核，同样可以使用iptables进行网络控制。</p><h3 id="Netfilter架构"><a href="#Netfilter架构" class="headerlink" title="Netfilter架构"></a>Netfilter架构</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">用户空间：iptables命令</span><br><span class="line">    ↓</span><br><span class="line">内核空间：Netfilter框架</span><br><span class="line">    ↓</span><br><span class="line">网络数据包处理</span><br></pre></td></tr></table></figure><span id="more"></span><p><strong>Netfilter功能</strong>：</p><ul><li><strong>数据包地址转换（NAT）</strong>：就像给数据包换个”身份证”</li><li><strong>数据包内容修改</strong>：可以修改数据包的内容</li><li><strong>数据包过滤</strong>：决定哪些数据包能通过</li><li><strong>连接跟踪</strong>：记录网络连接的状态</li></ul><h3 id="iptables在OSI模型中的位置"><a href="#iptables在OSI模型中的位置" class="headerlink" title="iptables在OSI模型中的位置"></a>iptables在OSI模型中的位置</h3><p>iptables主要工作在OSI的第二层和第三层之间，这意味着：</p><ul><li><strong>比VPN协议的工作层次更低</strong>：VPN通常在第三层工作</li><li><strong>能够拦截和修改网络层的数据包</strong>：在数据包进入应用层之前就进行处理</li><li><strong>可以实现透明代理功能</strong>：客户端完全感知不到代理的存在</li></ul><p><strong>通俗理解</strong>：就像在高速公路的收费站工作，比在市区路口指挥交通的层次更低，但控制力更强。</p><h2 id="透明代理技术"><a href="#透明代理技术" class="headerlink" title="透明代理技术"></a>透明代理技术</h2><h3 id="透明代理定义"><a href="#透明代理定义" class="headerlink" title="透明代理定义"></a>透明代理定义</h3><p><strong>透明代理（Transparent Proxy）</strong>是一种网络代理技术，客户端无需配置代理设置，所有流量自动通过代理服务器转发。简单来说，就是”偷偷地”把所有流量都经过代理，但用户完全感觉不到。</p><h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">客户端 → 路由器/防火墙 → 代理服务器 → 目标服务器</span><br></pre></td></tr></table></figure><p>就像你开车去某个地方，路上有个”隐形收费站”，你感觉不到它的存在，但你的车实际上经过了那里。</p><h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ul><li><strong>无感知</strong>：客户端无需配置，就像什么都没发生一样</li><li><strong>强制使用</strong>：所有流量必须经过代理，无法绕过</li><li><strong>难以检测</strong>：应用层无法感知代理存在，因为检测代码在更高层</li><li><strong>系统级</strong>：绕过应用层的检测机制，因为工作在更底层</li></ul><h2 id="ProxyDroid工具详解（也有其他的工具，比如TransProxy等，果子用习惯这个，就推了）"><a href="#ProxyDroid工具详解（也有其他的工具，比如TransProxy等，果子用习惯这个，就推了）" class="headerlink" title="ProxyDroid工具详解（也有其他的工具，比如TransProxy等，果子用习惯这个，就推了）"></a>ProxyDroid工具详解（也有其他的工具，比如TransProxy等，果子用习惯这个，就推了）</h2><h3 id="工具介绍"><a href="#工具介绍" class="headerlink" title="工具介绍"></a>工具介绍</h3><p><strong>ProxyDroid</strong>是Android平台上基于iptables的透明代理工具，可以实现系统级的流量转发。它就像给Android系统装了一个”隐形代理器”。</p><h3 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h3><ul><li><strong>基于iptables规则</strong>：在系统底层进行流量控制</li><li><strong>支持HTTP&#x2F;HTTPS&#x2F;SOCKS代理</strong>：多种代理协议支持</li><li><strong>可选择特定应用进行代理</strong>：可以只代理某些应用</li><li><strong>无需root权限（部分功能）</strong>：某些功能不需要root权限</li></ul><h3 id="配置步骤详解"><a href="#配置步骤详解" class="headerlink" title="配置步骤详解"></a>配置步骤详解</h3><p><img src="https://sanshiok.com/img/20231220/20231220091156.png" alt="ProxyDroid配置界面"></p><p><em>图5：ProxyDroid工具配置界面</em></p><h4 id="第一步：安装ProxyDroid"><a href="#第一步：安装ProxyDroid" class="headerlink" title="第一步：安装ProxyDroid"></a>第一步：安装ProxyDroid</h4><ol><li>下载APK文件</li><li>允许安装未知来源应用</li><li>安装完成后打开应用</li></ol><h4 id="第二步：配置代理服务器"><a href="#第二步：配置代理服务器" class="headerlink" title="第二步：配置代理服务器"></a>第二步：配置代理服务器</h4><ol><li><strong>代理类型选择</strong>：HTTP、HTTPS、SOCKS</li><li><strong>服务器信息填写</strong>：代理服务器地址、端口、用户名&#x2F;密码</li><li><strong>认证设置</strong>：如需要认证，勾选”需要认证”</li></ol><h4 id="第三步：选择代理模式"><a href="#第三步：选择代理模式" class="headerlink" title="第三步：选择代理模式"></a>第三步：选择代理模式</h4><ol><li><strong>全局代理</strong>：所有网络流量都经过代理</li><li><strong>应用选择代理</strong>：只代理选定的应用</li><li><strong>规则配置</strong>：基于域名、IP等条件选择代理</li></ol><h4 id="第四步：启用代理服务"><a href="#第四步：启用代理服务" class="headerlink" title="第四步：启用代理服务"></a>第四步：启用代理服务</h4><ol><li>点击”启动”按钮</li><li>如果提示需要root权限，授予权限</li><li>观察状态指示器，确认代理已启动</li></ol><h2 id="为什么iptables能够绕过检测？"><a href="#为什么iptables能够绕过检测？" class="headerlink" title="为什么iptables能够绕过检测？"></a>为什么iptables能够绕过检测？</h2><h3 id="技术原理分析（再次啰嗦一下，会懵的可以看看以前的文章哈哈—OSI七层模型）"><a href="#技术原理分析（再次啰嗦一下，会懵的可以看看以前的文章哈哈—OSI七层模型）" class="headerlink" title="技术原理分析（再次啰嗦一下，会懵的可以看看以前的文章哈哈—OSI七层模型）"></a>技术原理分析（再次啰嗦一下，会懵的可以看看以前的文章哈哈—OSI七层模型）</h3><p>基于OSI七层模型，iptables的工作机制：</p><ol><li><strong>网络层拦截</strong>：在IP数据包级别进行拦截，比应用层低很多</li><li><strong>传输层重定向</strong>：修改TCP&#x2F;UDP端口信息，在数据包进入应用之前就处理</li><li><strong>应用层透明</strong>：上层应用无法感知底层变化，因为检测代码在更高层</li></ol><h3 id="绕过机制图解"><a href="#绕过机制图解" class="headerlink" title="绕过机制图解"></a>绕过机制图解</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">应用层检测 → 检测代理设置、VPN接口</span><br><span class="line">传输层检测 → 检测端口、连接状态</span><br><span class="line">网络层检测 → 检测<span class="built_in">IP</span>地址、路由表</span><br><span class="line">数据链路层 → iptables在此层工作 ← 绕过成功！</span><br></pre></td></tr></table></figure><p><strong>通俗理解</strong>：就像小偷从地下室进入大楼，而保安只在大门口检查，当然发现不了！</p><h2 id="实际应用案例"><a href="#实际应用案例" class="headerlink" title="实际应用案例"></a>实际应用案例</h2><h3 id="案例1：双重检测绕过"><a href="#案例1：双重检测绕过" class="headerlink" title="案例1：双重检测绕过"></a>案例1：双重检测绕过</h3><p><strong>场景描述</strong>：某应用同时检测代理设置和VPN连接<br><strong>传统方法</strong>：Postern + Frida Hook<br><strong>成功率</strong>：60-70%<br><strong>iptables方法</strong>：ProxyDroid透明代理<br><strong>成功率</strong>：85-90%</p><p><strong>优势分析</strong>：</p><ul><li>应用层检测被完全绕过</li><li>系统级流量转发无法被应用感知</li><li>无需修改应用代码或Hook API</li><li>更加稳定可靠</li></ul><h3 id="案例2：高级检测绕过"><a href="#案例2：高级检测绕过" class="headerlink" title="案例2：高级检测绕过"></a>案例2：高级检测绕过</h3><p><strong>场景描述</strong>：应用使用多种检测方法</p><ul><li>ConnectivityManager检测</li><li>NetworkInterface检测</li><li>系统属性检测</li><li>网络能力检测</li></ul><p><strong>iptables优势</strong>：</p><ul><li><strong>统一解决方案</strong>：一种方法解决所有问题</li><li><strong>无需针对每种检测方法单独处理</strong>：省时省力</li><li><strong>系统级绕过，更加稳定</strong>：不会因为应用更新而失效</li></ul><h2 id="技术实现细节"><a href="#技术实现细节" class="headerlink" title="技术实现细节"></a>技术实现细节</h2><h3 id="iptables规则示例"><a href="#iptables规则示例" class="headerlink" title="iptables规则示例"></a>iptables规则示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建自定义链</span></span><br><span class="line">iptables -t nat -N PROXY_REDIRECT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加重定向规则</span></span><br><span class="line">iptables -t nat -A PROXY_REDIRECT -p tcp --dport 80 -j REDIRECT --to-port 8080</span><br><span class="line">iptables -t nat -A PROXY_REDIRECT -p tcp --dport 443 -j REDIRECT --to-port 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用到输出链</span></span><br><span class="line">iptables -t nat -A OUTPUT -j PROXY_REDIRECT</span><br></pre></td></tr></table></figure><p><strong>规则解释</strong>：</p><ul><li><code>-t nat</code>：指定使用NAT表</li><li><code>-N PROXY_REDIRECT</code>：创建名为PROXY_REDIRECT的自定义链</li><li><code>-p tcp</code>：指定TCP协议</li><li><code>--dport 80,443</code>：指定目标端口（HTTP和HTTPS）</li><li><code>-j REDIRECT</code>：执行重定向动作</li><li><code>--to-port 8080</code>：重定向到本地8080端口</li></ul><h3 id="代理服务器配置"><a href="#代理服务器配置" class="headerlink" title="代理服务器配置"></a>代理服务器配置</h3><p>如果你想要自己搭建代理服务器，这里有一个简单的Python示例（注意：这只是一个基础示例，实际使用时需要考虑安全性和性能）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_client</span>(<span class="params">client_socket</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理客户端连接&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 读取客户端请求</span></span><br><span class="line">        request = client_socket.recv(<span class="number">4096</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解析目标地址（简化版）</span></span><br><span class="line">        lines = request.decode().split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        first_line = lines[<span class="number">0</span>]</span><br><span class="line">        method, url, version = first_line.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 连接目标服务器</span></span><br><span class="line">        target_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        target_socket.connect((<span class="string">&#x27;目标服务器&#x27;</span>, <span class="number">80</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 转发数据</span></span><br><span class="line">        target_socket.send(request)</span><br><span class="line">        response = target_socket.recv(<span class="number">4096</span>)</span><br><span class="line">        client_socket.send(response)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;处理请求时出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 关闭连接</span></span><br><span class="line">        client_socket.close()</span><br><span class="line">        target_socket.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_proxy_server</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;启动代理服务器&quot;&quot;&quot;</span></span><br><span class="line">    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    server.bind((<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">8080</span>))</span><br><span class="line">    server.listen(<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;代理服务器启动在端口8080...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        client, addr = server.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;接受连接来自: <span class="subst">&#123;addr&#125;</span>&quot;</span>)</span><br><span class="line">        client_handler = threading.Thread(target=handle_client, args=(client,))</span><br><span class="line">        client_handler.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    start_proxy_server()</span><br></pre></td></tr></table></figure><h2 id="常见问题与解决方案"><a href="#常见问题与解决方案" class="headerlink" title="常见问题与解决方案"></a>常见问题与解决方案</h2><h3 id="问题1：代理不生效"><a href="#问题1：代理不生效" class="headerlink" title="问题1：代理不生效"></a>问题1：代理不生效</h3><p><strong>可能原因</strong>：iptables规则未正确应用、代理服务器未启动、端口冲突、权限不足<br><strong>解决方案</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查iptables规则</span></span><br><span class="line">iptables -t nat -L -n -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查端口占用</span></span><br><span class="line">netstat -tlnp | grep 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查代理服务器状态</span></span><br><span class="line">ps aux | grep proxy</span><br></pre></td></tr></table></figure><h3 id="问题2：性能问题"><a href="#问题2：性能问题" class="headerlink" title="问题2：性能问题"></a>问题2：性能问题</h3><p><strong>可能原因</strong>：代理服务器性能瓶颈、iptables规则过于复杂、网络延迟增加<br><strong>优化方法</strong>：使用连接池、启用TCP复用、优化iptables规则顺序、使用本地代理服务器</p><h3 id="问题3：兼容性问题"><a href="#问题3：兼容性问题" class="headerlink" title="问题3：兼容性问题"></a>问题3：兼容性问题</h3><p><strong>可能原因</strong>：Android版本不兼容、设备架构不支持、系统限制、权限问题<br><strong>解决方案</strong>：测试不同Android版本、使用兼容性模式、降级到稳定版本、检查设备支持</p><h2 id="高级技巧与优化"><a href="#高级技巧与优化" class="headerlink" title="高级技巧与优化"></a>高级技巧与优化</h2><h3 id="1-选择性代理"><a href="#1-选择性代理" class="headerlink" title="1. 选择性代理"></a>1. 选择性代理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只对特定应用进行代理</span></span><br><span class="line">iptables -t nat -A OUTPUT -m owner --uid-owner com.example.app -j PROXY_REDIRECT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只对特定用户进行代理</span></span><br><span class="line">iptables -t nat -A OUTPUT -m owner --uid-owner 1000 -j PROXY_REDIRECT</span><br></pre></td></tr></table></figure><h3 id="2-协议过滤"><a href="#2-协议过滤" class="headerlink" title="2. 协议过滤"></a>2. 协议过滤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只代理HTTP/HTTPS流量</span></span><br><span class="line">iptables -t nat -A PROXY_REDIRECT -p tcp --dport 80,443 -j REDIRECT --to-port 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排除特定端口</span></span><br><span class="line">iptables -t nat -A PROXY_REDIRECT -p tcp --dport 80,443 -m multiport --dports 80,443 -j REDIRECT --to-port 8080</span><br></pre></td></tr></table></figure><h3 id="3-负载均衡"><a href="#3-负载均衡" class="headerlink" title="3. 负载均衡"></a>3. 负载均衡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多个代理服务器负载均衡</span></span><br><span class="line">iptables -t nat -A PROXY_REDIRECT -p tcp --dport 80 -m statistic --mode nth --every 2 -j REDIRECT --to-port 8080</span><br><span class="line">iptables -t nat -A PROXY_REDIRECT -p tcp --dport 80 -j REDIRECT --to-port 8081</span><br></pre></td></tr></table></figure><h2 id="掌握资源推荐"><a href="#掌握资源推荐" class="headerlink" title="掌握资源推荐"></a>掌握资源推荐</h2><h3 id="技术文档"><a href="#技术文档" class="headerlink" title="技术文档"></a>技术文档</h3><ul><li><a href="https://developer.android.com/">Android开发者文档</a>：官方开发文档</li><li><a href="https://frida.re/docs/">Frida官方文档</a>：Frida使用指南</li><li><a href="https://netfilter.org/documentation/">iptables官方文档</a>：iptables规则配置</li></ul><h3 id="开源工具"><a href="#开源工具" class="headerlink" title="开源工具"></a>开源工具</h3><ul><li><a href="https://github.com/EasyLazyBean/VProxid">VProxid</a>：Android代理工具</li><li><a href="https://github.com/frida/frida">Frida</a>：动态插桩工具</li><li><a href="https://portswigger.net/burp">Burp Suite</a>：Web安全测试工具</li></ul><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>部分内容用了AI结合网上的示例总结，概念都比较常规，没有一一引用</p><p>iptables和透明代理技术代表了Android代理检测绕过的较高水平，它们通过系统级的流量控制，实现了对应用层检测的部分绕过。</p><p><strong>本文关键要点</strong>：</p><ol><li><strong>底层优势</strong>：iptables工作在OSI模型的低层，难以被上层检测</li><li><strong>透明代理</strong>：客户端无感知，强制所有流量通过代理</li><li><strong>系统级控制</strong>：绕过应用层的各种检测机制</li></ol><hr><p><em>后面就不写这个下一篇了，好像和上班一样有压力哈哈哈哈哈</em></p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> iptables </tag>
            
            <tag> 透明代理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android代理检测与绕过技术：攻防对抗的艺术</title>
      <link href="/2025/08/29/article3_android_detection/"/>
      <url>/2025/08/29/article3_android_detection/</url>
      
        <content type="html"><![CDATA[<h2 id="Android代理检测原理"><a href="#Android代理检测原理" class="headerlink" title="Android代理检测原理"></a>Android代理检测原理</h2><h3 id="检测机制概述"><a href="#检测机制概述" class="headerlink" title="检测机制概述"></a>检测机制概述</h3><p>Android系统提供了多种API来检测网络配置状态，开发者可以利用这些API来识别用户是否使用了代理或VPN：</p><ul><li><strong>ConnectivityManager</strong>：检测网络连接状态和代理设置</li><li><strong>NetworkInterface</strong>：检测网络接口信息</li><li><strong>系统属性</strong>：检测DNS服务器等系统配置</li><li><strong>网络能力</strong>：检测网络传输类型</li></ul><span id="more"></span><h3 id="为什么需要检测？"><a href="#为什么需要检测？" class="headerlink" title="为什么需要检测？"></a>为什么需要检测？</h3><p>应用开发者检测代理和VPN的主要原因：</p><ul><li><strong>防止数据泄露</strong>：避免敏感信息被截获</li><li><strong>反爬虫机制</strong>：防止自动化工具滥用API</li><li><strong>地理限制</strong>：确保用户来自特定地区</li><li><strong>安全审计</strong>：符合企业安全策略要求</li></ul><p><strong>通俗理解</strong>：就像商家不想让你用”代购”一样，他们希望直接和你交易，而不是通过中间人。</p><h2 id="常见的检测方法"><a href="#常见的检测方法" class="headerlink" title="常见的检测方法"></a>常见的检测方法</h2><h3 id="1-ConnectivityManager检测"><a href="#1-ConnectivityManager检测" class="headerlink" title="1. ConnectivityManager检测"></a>1. ConnectivityManager检测</h3><h4 id="代理检测"><a href="#代理检测" class="headerlink" title="代理检测"></a>代理检测</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isProxySet</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">ConnectivityManager</span> <span class="variable">cm</span> <span class="operator">=</span> (ConnectivityManager) </span><br><span class="line">        context.getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">    <span class="type">NetworkInfo</span> <span class="variable">activeNetwork</span> <span class="operator">=</span> cm.getActiveNetworkInfo();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (activeNetwork != <span class="literal">null</span> &amp;&amp; activeNetwork.isConnected()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">proxyHost</span> <span class="operator">=</span> android.net.Proxy.getDefaultHost();</span><br><span class="line">        <span class="keyword">return</span> (proxyHost != <span class="literal">null</span> &amp;&amp; proxyHost.length() &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>检测原理</strong>：这个检测方法会检查系统是否设置了代理服务器，如果设置了就返回true。</p><h4 id="VPN检测"><a href="#VPN检测" class="headerlink" title="VPN检测"></a>VPN检测</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isVpnConnected</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">ConnectivityManager</span> <span class="variable">cm</span> <span class="operator">=</span> (ConnectivityManager) </span><br><span class="line">        context.getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">        Network[] networks = cm.getAllNetworks();</span><br><span class="line">        <span class="keyword">for</span> (Network network : networks) &#123;</span><br><span class="line">            <span class="type">NetworkCapabilities</span> <span class="variable">capabilities</span> <span class="operator">=</span> cm.getNetworkCapabilities(network);</span><br><span class="line">            <span class="keyword">if</span> (capabilities != <span class="literal">null</span> &amp;&amp; capabilities.hasTransport(</span><br><span class="line">                NetworkCapabilities.TRANSPORT_VPN)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>检测原理</strong>：这个方法会遍历所有网络连接，检查是否有VPN类型的连接。</p><h3 id="2-NetworkInterface检测"><a href="#2-NetworkInterface检测" class="headerlink" title="2. NetworkInterface检测"></a>2. NetworkInterface检测</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isVpnConnected</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Enumeration&lt;NetworkInterface&gt; networkInterfaces = </span><br><span class="line">            NetworkInterface.getNetworkInterfaces();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (networkInterfaces.hasMoreElements()) &#123;</span><br><span class="line">            <span class="type">NetworkInterface</span> <span class="variable">networkInterface</span> <span class="operator">=</span> networkInterfaces.nextElement();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (networkInterface.isUp() &amp;&amp; </span><br><span class="line">                networkInterface.isVirtual() &amp;&amp; </span><br><span class="line">                !networkInterface.isLoopback()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 检测到VPN接口</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>检测原理</strong>：这个方法会检查网络接口，寻找虚拟接口（如tun、ppp等），这些通常是VPN创建的。</p><h2 id="绕过技术详解"><a href="#绕过技术详解" class="headerlink" title="绕过技术详解"></a>绕过技术详解</h2><h3 id="1-基础VPN模式软件"><a href="#1-基础VPN模式软件" class="headerlink" title="1. 基础VPN模式软件"></a>1. 基础VPN模式软件</h3><h4 id="Postern-简单易用的代理工具"><a href="#Postern-简单易用的代理工具" class="headerlink" title="Postern - 简单易用的代理工具"></a>Postern - 简单易用的代理工具</h4><p><strong>特点</strong>：传播广泛，上手简单，适合新手<br><strong>下载地址</strong>：<a href="https://apkpure.com/postern/com.tunnelworkshop.postern">https://apkpure.com/postern/com.tunnelworkshop.postern</a></p><p><img src="https://sanshiok.com/img/20231220/20231220090849.png" alt="Postern主界面"></p><p><img src="https://sanshiok.com/img/20231220/20231220090932.png" alt="Postern配置界面"></p><p><em>图2-3：Postern工具的主界面和配置界面</em></p><p><strong>使用步骤</strong>：</p><ol><li><strong>下载安装</strong>：从官网下载APK文件并安装</li><li><strong>添加代理</strong>：点击”+”号添加新的代理配置</li><li><strong>配置参数</strong>：选择代理类型、填写服务器信息</li><li><strong>启用代理</strong>：点击开关启用代理服务</li><li><strong>配置规则</strong>：选择哪些应用使用代理</li></ol><p><strong>优势</strong>：界面友好，配置简单，支持多种代理协议</p><h4 id="VProxid-Android平台的Proxifier替代工具"><a href="#VProxid-Android平台的Proxifier替代工具" class="headerlink" title="VProxid - Android平台的Proxifier替代工具"></a>VProxid - Android平台的Proxifier替代工具</h4><p><strong>特点</strong>：Android平台的Proxifier替代工具，功能强大<br><strong>下载地址</strong>：<a href="https://github.com/EasyLazyBean/VProxid">https://github.com/EasyLazyBean/VProxid</a></p><p><img src="https://sanshiok.com/img/20231220/20231220091009.png" alt="VProxid界面"></p><p><em>图4：VProxid工具界面</em></p><p><strong>使用步骤</strong>：</p><ol><li><strong>安装应用</strong>：下载并安装VProxid</li><li><strong>配置代理服务器</strong>：设置代理类型、服务器地址和端口</li><li><strong>选择应用</strong>：勾选需要代理的应用</li><li><strong>启用代理</strong>：启动代理服务</li></ol><p><strong>优势</strong>：可以为每个应用设置不同代理，配合Burp Suite使用效果更佳</p><h3 id="2-使用Frida进行代码Hook（这里粗略介绍一下，深入的用法后面再组织文章整）"><a href="#2-使用Frida进行代码Hook（这里粗略介绍一下，深入的用法后面再组织文章整）" class="headerlink" title="2. 使用Frida进行代码Hook（这里粗略介绍一下，深入的用法后面再组织文章整）"></a>2. 使用Frida进行代码Hook（这里粗略介绍一下，深入的用法后面再组织文章整）</h3><h4 id="什么是Frida？"><a href="#什么是Frida？" class="headerlink" title="什么是Frida？"></a>什么是Frida？</h4><p><strong>Frida</strong>是一个动态插桩工具，可以在运行时修改应用程序的行为。简单来说，就是可以在应用运行的时候”偷梁换柱”，把检测函数的结果改成我们想要的值。</p><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><ol><li><strong>安装Python</strong>：确保系统已安装Python 3.6+</li><li><strong>安装Frida</strong>：<code>pip install frida-tools</code></li><li><strong>下载Frida-server</strong>：从官网下载对应Android版本的frida-server</li><li><strong>推送frida-server</strong>：<code>adb push frida-server /data/local/tmp/</code></li><li><strong>启动frida-server</strong>：<code>adb shell &quot;chmod 755 /data/local/tmp/frida-server &amp;&amp; /data/local/tmp/frida-server &amp;&quot;</code></li></ol><h4 id="绕过ConnectivityManager检测"><a href="#绕过ConnectivityManager检测" class="headerlink" title="绕过ConnectivityManager检测"></a>绕过ConnectivityManager检测</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bypassConnectivityManager</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">ConnectivityManager</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.net.ConnectivityManager&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title class_">ConnectivityManager</span>.<span class="property">getNetworkInfo</span>.<span class="title function_">overload</span>(<span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">type</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooked getNetworkInfo, type: &quot;</span> + type);</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">getNetworkInfo</span>(type);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (type == <span class="number">17</span>) &#123; <span class="comment">// VPN类型</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Bypassing VPN detection&quot;</span>);</span><br><span class="line">                <span class="comment">// 可以返回WiFi或移动网络状态</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="绕过NetworkInterface检测"><a href="#绕过NetworkInterface检测" class="headerlink" title="绕过NetworkInterface检测"></a>绕过NetworkInterface检测</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bypassNetworkInterface</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">NetworkInterface</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.net.NetworkInterface&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title class_">NetworkInterface</span>.<span class="property">getAll</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> interfaces = <span class="variable language_">this</span>.<span class="title function_">getAll</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; interfaces.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> ni = interfaces[i];</span><br><span class="line">                <span class="keyword">var</span> name = ni.<span class="property">name</span>.<span class="property">value</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (name.<span class="title function_">indexOf</span>(<span class="string">&quot;tun&quot;</span>) &gt;= <span class="number">0</span> || name.<span class="title function_">indexOf</span>(<span class="string">&quot;ppp&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    ni.<span class="property">name</span>.<span class="property">value</span> = <span class="string">&quot;wlan0&quot;</span>;</span><br><span class="line">                    ni.<span class="property">displayName</span>.<span class="property">value</span> = <span class="string">&quot;wlan0&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> interfaces;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-高级绕过技术"><a href="#3-高级绕过技术" class="headerlink" title="3. 高级绕过技术"></a>3. 高级绕过技术</h3><h4 id="系统设置修改"><a href="#系统设置修改" class="headerlink" title="系统设置修改"></a>系统设置修改</h4><p><strong>方法1：通过设置菜单</strong></p><ol><li>进入”设置” → “Wi-Fi”</li><li>长按当前Wi-Fi网络</li><li>选择”修改网络”</li><li>勾选”显示高级选项”</li><li>设置代理为”手动”</li><li>填写代理服务器信息</li></ol><p><strong>方法2：通过ADB命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置HTTP代理</span></span><br><span class="line">adb shell settings put global http_proxy 192.168.1.100:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除代理设置</span></span><br><span class="line">adb shell settings put global http_proxy :0</span><br></pre></td></tr></table></figure><h2 id="检测绕过策略总结"><a href="#检测绕过策略总结" class="headerlink" title="检测绕过策略总结"></a>检测绕过策略总结</h2><h3 id="分层绕过策略"><a href="#分层绕过策略" class="headerlink" title="分层绕过策略"></a>分层绕过策略</h3><p>基于OSI七层模型，我们可以采用以下策略：</p><ol><li><strong>应用层检测</strong>：使用Frida Hook相关API</li><li><strong>传输层检测</strong>：使用VPN模式软件</li><li><strong>网络层检测</strong>：使用iptables进行流量转发</li><li><strong>数据链路层检测</strong>：修改网络接口信息</li></ol><h3 id="工具选择建议"><a href="#工具选择建议" class="headerlink" title="工具选择建议"></a>工具选择建议</h3><ul><li><strong>简单场景</strong>：Postern或VProxid</li><li><strong>复杂检测</strong>：Frida + 自定义脚本</li><li><strong>系统级绕过</strong>：ProxyDroid + iptables</li><li><strong>组合使用</strong>：多种工具结合使用</li></ul><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>Android代理检测与绕过技术是一个不断演进的攻防对抗过程。理解检测原理，学习绕过技术，是每个“安全测试人员”的必备技能。</p><p><strong>本文关键点</strong>：</p><ol><li><strong>分层理解</strong>：基于OSI模型分析理解检测机制</li><li><strong>工具选择</strong>：根据检测复杂度选择合适的工具（工具太多，我写的是我常用的几个）</li><li><strong>持续掌握</strong>：检测技术在不断更新，需要持续掌握</li></ol><hr><p><em>下一篇我们将深入探讨高级绕过技术：iptables与透明代理，看看如何在系统底层”偷天换日”</em></p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> 安全 </tag>
            
            <tag> 代理 </tag>
            
            <tag> VPN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>代理与VPN技术解析：网络安全中的双刃剑</title>
      <link href="/2025/08/28/article2_proxy_vpn/"/>
      <url>/2025/08/28/article2_proxy_vpn/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是代理（Proxy）？"><a href="#什么是代理（Proxy）？" class="headerlink" title="什么是代理（Proxy）？"></a>什么是代理（Proxy）？</h2><h3 id="代理的定义"><a href="#代理的定义" class="headerlink" title="代理的定义"></a>代理的定义</h3><p><strong>代理（Proxy）</strong>简单来说就是一种”中间人”服务。当你想要访问某个网站时，不是直接连接，而是先连接到代理服务器，然后由代理服务器帮你访问目标网站。</p><h3 id="代理的工作原理"><a href="#代理的工作原理" class="headerlink" title="代理的工作原理"></a>代理的工作原理</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">你的电脑 → 代理服务器 → 目标网站</span><br></pre></td></tr></table></figure><span id="more"></span><p>就像你让朋友帮你买东西一样：</p><ol><li>你告诉朋友（代理服务器）要买什么</li><li>朋友去商店（目标网站）帮你买</li><li>朋友把东西（数据）带回来给你</li></ol><h3 id="代理的类型和介绍"><a href="#代理的类型和介绍" class="headerlink" title="代理的类型和介绍"></a>代理的类型和介绍</h3><h4 id="HTTP代理"><a href="#HTTP代理" class="headerlink" title="HTTP代理"></a>HTTP代理</h4><ul><li><strong>适用场景</strong>：Web浏览、简单网页访问</li><li><strong>常用工具</strong>：<ul><li><strong>Burp Suite</strong>：专业的安全测试工具，内置HTTP代理功能</li><li><strong>Fiddler</strong>：免费的HTTP调试代理工具</li><li><strong>Charles</strong>：跨平台的HTTP代理工具，界面友好</li></ul></li></ul><h4 id="HTTPS代理-（HTTP-SSL-TLS）"><a href="#HTTPS代理-（HTTP-SSL-TLS）" class="headerlink" title="HTTPS代理 （HTTP + SSL&#x2F;TLS）"></a>HTTPS代理 （HTTP + SSL&#x2F;TLS）</h4><ul><li><strong>适用场景</strong>：加密网站访问、安全传输</li><li><strong>常用工具</strong>：<ul><li><strong>Burp Suite Pro</strong>：支持HTTPS拦截和修改</li><li><strong>mitmproxy</strong>：开源的交互式HTTPS代理工具</li><li><strong>OWASP ZAP</strong>：免费的Web应用安全测试工具</li></ul></li></ul><h4 id="SOCKS代理"><a href="#SOCKS代理" class="headerlink" title="SOCKS代理"></a>SOCKS代理</h4><ul><li><strong>适用场景</strong>：支持多种协议，功能全面</li><li><strong>常用工具</strong>：<ul><li><strong>Proxifier</strong>：Windows平台的专业代理工具</li><li><strong>VProxid</strong>：Android平台的Proxifier替代工具</li><li><strong>Shadowsocks</strong>：轻量级的SOCKS5代理工具</li></ul></li></ul><h4 id="透明代理"><a href="#透明代理" class="headerlink" title="透明代理"></a>透明代理</h4><ul><li><strong>适用场景</strong>：企业网络、客户端无感知</li><li><strong>常用工具</strong>：<ul><li><strong>Squid</strong>：开源的Web代理缓存服务器</li><li><strong>Nginx</strong>：高性能的HTTP服务器，可配置为反向代理</li><li><strong>HAProxy</strong>：高可用性负载均衡器和代理服务器</li></ul></li></ul><h3 id="代理协议深度解析"><a href="#代理协议深度解析" class="headerlink" title="代理协议深度解析"></a>代理协议深度解析</h3><h4 id="HTTP代理的CONNECT方法"><a href="#HTTP代理的CONNECT方法" class="headerlink" title="HTTP代理的CONNECT方法"></a>HTTP代理的CONNECT方法</h4><p>HTTP代理使用CONNECT方法建立隧道连接，特别适用于HTTPS：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CONNECT</span> <span class="string">example.com:443</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>example.com:443</span><br><span class="line"><span class="attribute">Proxy-Authorization</span><span class="punctuation">: </span>Basic dXNlcjpwYXNz</span><br></pre></td></tr></table></figure><h4 id="SOCKS4-vs-SOCKS5"><a href="#SOCKS4-vs-SOCKS5" class="headerlink" title="SOCKS4 vs SOCKS5"></a>SOCKS4 vs SOCKS5</h4><ul><li><strong>SOCKS4</strong>：仅支持TCP，无认证</li><li><strong>SOCKS5</strong>：支持TCP&#x2F;UDP，支持多种认证方式，支持IPv6</li></ul><h4 id="代理认证机制"><a href="#代理认证机制" class="headerlink" title="代理认证机制"></a>代理认证机制</h4><ul><li><strong>Basic认证</strong>：用户名密码Base64编码（不安全）</li><li><strong>Digest认证</strong>：使用MD5哈希（相对安全）</li><li><strong>NTLM认证</strong>：Windows域认证</li></ul><h2 id="什么是VPN（Virtual-Private-Network）？"><a href="#什么是VPN（Virtual-Private-Network）？" class="headerlink" title="什么是VPN（Virtual Private Network）？"></a>什么是VPN（Virtual Private Network）？</h2><h3 id="VPN的定义"><a href="#VPN的定义" class="headerlink" title="VPN的定义"></a>VPN的定义</h3><p><strong>VPN（虚拟专用网络）</strong>就像在公共网络上建立了一条私密的”隧道”。所有通过这条隧道传输的数据都会被加密，外人无法看到你在做什么。</p><h3 id="VPN的工作原理"><a href="#VPN的工作原理" class="headerlink" title="VPN的工作原理"></a>VPN的工作原理</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">你的电脑 → VPN客户端 → VPN服务器 → 目标网站</span><br></pre></td></tr></table></figure><p>就像你通过一条秘密通道去银行一样：</p><ul><li><strong>隧道技术</strong>：在公共网络上创建专用通道</li><li><strong>加密传输</strong>：所有数据都经过加密处理</li><li><strong>身份认证</strong>：确保只有授权用户才能访问</li></ul><h3 id="VPN的类型和介绍"><a href="#VPN的类型和介绍" class="headerlink" title="VPN的类型和介绍"></a>VPN的类型和介绍</h3><h4 id="远程访问VPN"><a href="#远程访问VPN" class="headerlink" title="远程访问VPN"></a>远程访问VPN</h4><ul><li><strong>适用场景</strong>：远程办公、个人隐私保护</li><li><strong>常用工具</strong>：<ul><li><strong>OpenVPN</strong>：开源、安全、跨平台</li><li><strong>WireGuard</strong>：新一代高性能VPN协议</li><li><strong>NordVPN</strong>：商业VPN服务，用户友好</li></ul></li></ul><h4 id="站点到站点VPN"><a href="#站点到站点VPN" class="headerlink" title="站点到站点VPN"></a>站点到站点VPN</h4><ul><li><strong>适用场景</strong>：企业分支机构互联</li><li><strong>常用工具</strong>：<ul><li><strong>IPsec</strong>：企业级标准，安全性高</li><li><strong>Cisco AnyConnect</strong>：思科企业级VPN解决方案</li><li><strong>Fortinet FortiGate</strong>：企业级防火墙和VPN设备</li></ul></li></ul><h4 id="移动VPN"><a href="#移动VPN" class="headerlink" title="移动VPN"></a>移动VPN</h4><ul><li><strong>适用场景</strong>：移动设备安全连接</li><li><strong>常用工具</strong>：<ul><li><strong>IKEv2</strong>：移动设备友好，支持快速重连</li><li><strong>L2TP&#x2F;IPsec</strong>：结合了PPTP和IPsec的优点</li><li><strong>Android内置VPN</strong>：系统自带的VPN功能</li></ul></li></ul><h3 id="VPN协议深度解析"><a href="#VPN协议深度解析" class="headerlink" title="VPN协议深度解析"></a>VPN协议深度解析</h3><h4 id="OpenVPN的TLS握手"><a href="#OpenVPN的TLS握手" class="headerlink" title="OpenVPN的TLS握手"></a>OpenVPN的TLS握手</h4><ol><li><strong>客户端Hello</strong>：支持的加密套件、随机数</li><li><strong>服务器Hello</strong>：选择的加密套件、随机数</li><li><strong>证书交换</strong>：服务器证书、客户端证书（可选）</li><li><strong>密钥交换</strong>：生成会话密钥</li><li><strong>完成握手</strong>：验证握手完整性</li></ol><h4 id="WireGuard的现代加密"><a href="#WireGuard的现代加密" class="headerlink" title="WireGuard的现代加密"></a>WireGuard的现代加密</h4><ul><li><strong>Curve25519</strong>：椭圆曲线密钥交换</li><li><strong>ChaCha20</strong>：流密码加密</li><li><strong>Poly1305</strong>：消息认证码</li><li><strong>BLAKE2s</strong>：哈希函数</li></ul><h4 id="IPsec的IKE协议"><a href="#IPsec的IKE协议" class="headerlink" title="IPsec的IKE协议"></a>IPsec的IKE协议</h4><ul><li><strong>IKEv1</strong>：两阶段协商（主模式+快速模式）</li><li><strong>IKEv2</strong>：单阶段协商，支持MOBIKE（移动性）</li></ul><h2 id="代理与VPN的区别对比"><a href="#代理与VPN的区别对比" class="headerlink" title="代理与VPN的区别对比"></a>代理与VPN的区别对比</h2><h3 id="协议层面差异（之前的文章有提前讲ISO七层模型，有点懵的往前翻翻）"><a href="#协议层面差异（之前的文章有提前讲ISO七层模型，有点懵的往前翻翻）" class="headerlink" title="协议层面差异（之前的文章有提前讲ISO七层模型，有点懵的往前翻翻）"></a>协议层面差异（之前的文章有提前讲ISO七层模型，有点懵的往前翻翻）</h3><table><thead><tr><th>特性</th><th>VPN</th><th>代理</th></tr></thead><tbody><tr><td><strong>工作层次</strong></td><td>第2-3层（数据链路层和网络层）</td><td>第7层（应用层）</td></tr><tr><td><strong>协议支持</strong></td><td>支持所有协议和端口</td><td>仅支持特定协议</td></tr><tr><td><strong>流量范围</strong></td><td>转发所有网络流量</td><td>仅转发应用层流量</td></tr></tbody></table><p><strong>通俗理解</strong>：VPN就像给你的整个网络连接都套上了一层保护罩，而代理只是给特定的应用（比如浏览器）加了个”中转站”。</p><h3 id="功能特性对比"><a href="#功能特性对比" class="headerlink" title="功能特性对比"></a>功能特性对比</h3><table><thead><tr><th>功能</th><th>VPN</th><th>代理</th></tr></thead><tbody><tr><td><strong>加密级别</strong></td><td>端到端加密</td><td>通常不加密</td></tr><tr><td><strong>匿名性</strong></td><td>完全隐藏真实IP</td><td>部分隐藏真实IP</td></tr><tr><td><strong>速度影响</strong></td><td>可能影响所有网络活动</td><td>仅影响代理流量</td></tr><tr><td><strong>配置复杂度</strong></td><td>相对复杂</td><td>相对简单</td></tr><tr><td><strong>成本</strong></td><td>通常较高</td><td>通常较低</td></tr></tbody></table><h2 id="实际应用场景"><a href="#实际应用场景" class="headerlink" title="实际应用场景"></a>实际应用场景</h2><h3 id="代理的应用场景"><a href="#代理的应用场景" class="headerlink" title="代理的应用场景"></a>代理的应用场景</h3><h4 id="Web爬虫"><a href="#Web爬虫" class="headerlink" title="Web爬虫"></a>Web爬虫</h4><ul><li><strong>用途</strong>：绕过IP限制和反爬虫机制（这个大家都知道，就是为了防止被网站封禁）</li><li><strong>技术要点</strong>：代理池轮换、User-Agent伪装、请求频率控制</li></ul><h4 id="内容访问"><a href="#内容访问" class="headerlink" title="内容访问"></a>内容访问</h4><ul><li><strong>用途</strong>：访问地理限制的内容（如墙内网站）</li><li><strong>技术要点</strong>：地理位置伪装、CDN节点选择</li></ul><h4 id="安全审计"><a href="#安全审计" class="headerlink" title="安全审计"></a>安全审计</h4><ul><li><strong>用途</strong>：监控和过滤网络流量（企业里，监控员工的网络行为，防止泄露公司的敏感数据）</li><li><strong>技术要点</strong>：流量分析、内容过滤、行为监控</li></ul><h4 id="游戏加速器"><a href="#游戏加速器" class="headerlink" title="游戏加速器"></a>游戏加速器</h4><ul><li><strong>用途</strong>：降低游戏延迟，提升游戏体验</li><li><strong>技术要点</strong>：节点优化、协议优化、智能路由</li></ul><h3 id="VPN的应用场景"><a href="#VPN的应用场景" class="headerlink" title="VPN的应用场景"></a>VPN的应用场景</h3><h4 id="远程办公"><a href="#远程办公" class="headerlink" title="远程办公"></a>远程办公</h4><ul><li><strong>用途</strong>：安全访问企业内网（同样企业内的安全软件，如某深和某T等）</li><li><strong>技术要点</strong>：双因素认证、访问控制、审计日志</li></ul><h4 id="数据保护"><a href="#数据保护" class="headerlink" title="数据保护"></a>数据保护</h4><ul><li><strong>用途</strong>：保护敏感数据传输</li><li><strong>技术要点</strong>：端到端加密、密钥管理、证书验证</li></ul><h4 id="企业级解决方案"><a href="#企业级解决方案" class="headerlink" title="企业级解决方案"></a>企业级解决方案</h4><ul><li><strong>用途</strong>：分支机构互联、云服务访问</li><li><strong>技术要点</strong>：负载均衡、故障转移、监控告警</li></ul><h2 id="Burp-Suite-Proxifier-工具简单介绍一下"><a href="#Burp-Suite-Proxifier-工具简单介绍一下" class="headerlink" title="Burp Suite + Proxifier 工具简单介绍一下"></a>Burp Suite + Proxifier 工具简单介绍一下</h2><h3 id="Burp-Suite使用入门"><a href="#Burp-Suite使用入门" class="headerlink" title="Burp Suite使用入门"></a>Burp Suite使用入门</h3><p>Burp Suite是Web安全测试的”瑞士军刀”：</p><p><strong>主要功能模块</strong>：</p><ul><li><strong>Proxy</strong>：拦截和修改HTTP&#x2F;HTTPS请求</li><li><strong>Spider</strong>：自动爬取网站内容</li><li><strong>Scanner</strong>：自动安全漏洞扫描</li><li><strong>Repeater</strong>：重复发送和修改请求</li><li><strong>Intruder</strong>：自动化攻击测试</li></ul><h4 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h4><ol><li><strong>启动Burp Suite</strong>：下载并安装后启动</li><li><strong>配置代理</strong>：默认监听127.0.0.1:8080</li><li><strong>浏览器设置</strong>：将浏览器代理设置为127.0.0.1:8080</li><li><strong>安装证书</strong>：访问<a href="http://burp/cert%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85%E8%AF%81%E4%B9%A6">http://burp/cert下载并安装证书</a></li></ol><h3 id="Proxifier使用入门"><a href="#Proxifier使用入门" class="headerlink" title="Proxifier使用入门"></a>Proxifier使用入门</h3><p>Proxifier是Windows平台的专业代理工具：</p><h4 id="基本配置-1"><a href="#基本配置-1" class="headerlink" title="基本配置"></a>基本配置</h4><ol><li><strong>添加代理服务器</strong>：填写代理服务器地址和端口</li><li><strong>配置代理规则</strong>：选择哪些应用使用代理</li><li><strong>测试连接</strong>：验证代理是否工作正常</li></ol><h4 id="高级功能"><a href="#高级功能" class="headerlink" title="高级功能"></a>高级功能</h4><ul><li><strong>应用级代理</strong>：为不同应用设置不同代理</li><li><strong>规则配置</strong>：基于域名、IP等条件选择代理</li><li><strong>连接监控</strong>：实时查看代理连接状态</li></ul><h2 id="性能优化技巧"><a href="#性能优化技巧" class="headerlink" title="性能优化技巧"></a>性能优化技巧</h2><h3 id="代理连接池管理"><a href="#代理连接池管理" class="headerlink" title="代理连接池管理"></a>代理连接池管理</h3><ul><li><strong>连接复用</strong>：减少TCP连接建立开销</li><li><strong>连接池大小</strong>：根据并发需求调整</li><li><strong>超时设置</strong>：避免连接长时间占用</li></ul><h3 id="VPN隧道优化"><a href="#VPN隧道优化" class="headerlink" title="VPN隧道优化"></a>VPN隧道优化</h3><ul><li><strong>MTU调整</strong>：避免分片，提升传输效率</li><li><strong>压缩算法</strong>：减少数据传输量</li><li><strong>协议选择</strong>：根据网络环境选择最优协议</li></ul><h3 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h3><ul><li><strong>轮询</strong>：简单均衡，适合服务器性能相近</li><li><strong>权重</strong>：根据服务器性能分配流量</li><li><strong>最少连接</strong>：优先选择连接数少的服务器</li></ul><h2 id="检测与反检测"><a href="#检测与反检测" class="headerlink" title="检测与反检测"></a>检测与反检测</h2><h3 id="代理检测方法"><a href="#代理检测方法" class="headerlink" title="代理检测方法"></a>代理检测方法</h3><ul><li><strong>HTTP头检测</strong>：检查Via、X-Forwarded-For等头</li><li><strong>IP地址检测</strong>：检查是否来自代理服务器</li><li><strong>行为分析</strong>：分析访问模式是否异常</li></ul><h3 id="VPN流量特征"><a href="#VPN流量特征" class="headerlink" title="VPN流量特征"></a>VPN流量特征</h3><ul><li><strong>协议特征</strong>：OpenVPN、IPsec等协议特征</li><li><strong>端口特征</strong>：常见VPN端口（1194、500、4500等）</li><li><strong>加密特征</strong>：加密流量的随机性特征</li></ul><h3 id="绕过技术"><a href="#绕过技术" class="headerlink" title="绕过技术"></a>绕过技术</h3><ul><li><strong>协议混淆</strong>：伪装成正常流量</li><li><strong>端口伪装</strong>：使用常见端口（80、443等）</li><li><strong>流量分散</strong>：将流量分散到多个连接</li></ul><h2 id="安全风险与防护"><a href="#安全风险与防护" class="headerlink" title="安全风险与防护"></a>安全风险与防护</h2><h3 id="代理的安全风险"><a href="#代理的安全风险" class="headerlink" title="代理的安全风险"></a>代理的安全风险</h3><ul><li><strong>数据泄露</strong>：代理服务器可能记录用户数据</li><li><strong>中间人攻击</strong>：恶意代理可能截获通信</li><li><strong>身份暴露</strong>：某些代理可能泄露真实IP</li></ul><h3 id="VPN的安全风险"><a href="#VPN的安全风险" class="headerlink" title="VPN的安全风险"></a>VPN的安全风险</h3><ul><li><strong>日志记录</strong>：VPN提供商可能记录用户活动</li><li><strong>DNS泄露</strong>：可能暴露真实DNS查询</li><li><strong>恶意软件</strong>：某些免费VPN可能包含恶意代码</li></ul><h3 id="安全防护建议"><a href="#安全防护建议" class="headerlink" title="安全防护建议"></a>安全防护建议</h3><ol><li><strong>选择可信服务商</strong>：避免使用来源不明的代理或VPN</li><li><strong>启用加密传输</strong>：优先选择支持加密的服务</li><li><strong>定期更新软件</strong>：及时修复安全漏洞</li><li><strong>监控网络活动</strong>：注意异常的网络行为</li><li><strong>使用多重防护</strong>：结合多种安全技术</li></ol><h3 id="工具特性对比表"><a href="#工具特性对比表" class="headerlink" title="工具特性对比表"></a>工具特性对比表</h3><table><thead><tr><th>工具</th><th>适用场景</th><th>成功率</th><th>配置难度</th><th>稳定性</th><th>推荐指数</th></tr></thead><tbody><tr><td><strong>Burp Suite</strong></td><td>Web安全测试</td><td>95%+</td><td>中等</td><td>高</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>Proxifier</strong></td><td>Windows应用代理</td><td>90%+</td><td>简单</td><td>高</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>OpenVPN</strong></td><td>企业级VPN</td><td>85%+</td><td>困难</td><td>高</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>WireGuard</strong></td><td>新一代VPN</td><td>90%+</td><td>中等</td><td>高</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>VProxid</strong></td><td>Android代理</td><td>85%+</td><td>中等</td><td>高</td><td>⭐⭐⭐⭐</td></tr></tbody></table><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>代理和VPN都是重要的网络技术，它们在网络安全、隐私保护、内容访问等方面发挥着重要作用。相信做安全和爬虫的朋友，都有过代理和VPN的使用经验。在企业里也有一些安全软件也是运用了其中的原理对大家的网络和安全进行管控，比如某深和某T等等。</p><p><strong>本文关键点</strong>：VPN工作在较低的网络层次，能够转发所有流量；而代理工作在应用层，仅能处理特定协议的流量。</p><hr><p><em>下一篇会分享Android代理检测与绕过技术，看看如何在移动设备上玩转这些工具</em></p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络 </tag>
            
            <tag> 安全 </tag>
            
            <tag> 代理 </tag>
            
            <tag> VPN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSI七层模型详解</title>
      <link href="/2025/08/27/art001/"/>
      <url>/2025/08/27/art001/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是OSI七层模型？"><a href="#什么是OSI七层模型？" class="headerlink" title="什么是OSI七层模型？"></a>什么是OSI七层模型？</h2><p>简单来说，<strong>OSI七层模型</strong>就是国际标准化组织（ISO）制定的一个网络通信标准。它把网络通信过程分成了七个层次，每一层都有自己特定的”工作职责”。</p><p>想象一下，网络通信就像快递送包裹一样，需要经过多个环节：打包、贴标签、装车、运输、卸货、分拣、最后送到收件人手里。每一层就相当于一个环节，各司其职。</p><span id="more"></span><h2 id="七层模型详解"><a href="#七层模型详解" class="headerlink" title="七层模型详解"></a>七层模型详解</h2><p><img src="https://sanshiok.com/img/20231219/20231219092430.png" alt="OSI七层模型详解"></p><p><em>图1：OSI七层模型各层功能及对应的协议、设备对照表</em></p><p><strong>说明</strong>：这张图展示了OSI七层模型中每一层的具体功能、对应的协议和设备，帮助我们更好地理解网络通信的分层结构。</p><h3 id="第7层：应用层（Application-Layer）"><a href="#第7层：应用层（Application-Layer）" class="headerlink" title="第7层：应用层（Application Layer）"></a>第7层：应用层（Application Layer）</h3><p><strong>功能</strong>：为用户提供网络服务接口<br><strong>协议</strong>：HTTP、HTTPS、FTP、SMTP、DNS等<br><strong>设备</strong>：应用程序、Web浏览器、邮件客户端<br><strong>作用</strong>：直接与用户交互，提供各种网络应用服务</p><p><strong>通俗理解</strong>：这一层就像我们平时使用的各种APP，比如微信、淘宝、浏览器等。它们直接和我们打交道，我们点击什么，它们就执行什么。</p><h3 id="第6层：表示层（Presentation-Layer）"><a href="#第6层：表示层（Presentation-Layer）" class="headerlink" title="第6层：表示层（Presentation Layer）"></a>第6层：表示层（Presentation Layer）</h3><p><strong>功能</strong>：处理数据格式转换、加密和压缩<br><strong>协议</strong>：SSL&#x2F;TLS、JPEG、MPEG等<br><strong>作用</strong>：确保数据能够被正确解释和处理</p><p><strong>重要知识点</strong>：HTTPS协议实际上是HTTP+SSL的组合</p><ul><li>SSL工作在表示层，负责数据加密</li><li>HTTP工作在应用层，负责数据传输</li><li>数据封装是自下而上的过程</li></ul><p><strong>通俗理解</strong>：这一层就像翻译官，负责把数据转换成对方能理解的格式。比如把中文翻译成英文，或者把明文加密成密文。</p><h3 id="第5层：会话层（Session-Layer）"><a href="#第5层：会话层（Session-Layer）" class="headerlink" title="第5层：会话层（Session Layer）"></a>第5层：会话层（Session Layer）</h3><p><strong>功能</strong>：建立、管理和终止会话<br><strong>协议</strong>：NetBIOS、RPC等<br><strong>作用</strong>：协调不同设备之间的通信和同步</p><p><strong>通俗理解</strong>：这一层就像会议主持人，负责安排会议的开始、进行和结束，确保大家能有序地交流。</p><h3 id="第4层：传输层（Transport-Layer）"><a href="#第4层：传输层（Transport-Layer）" class="headerlink" title="第4层：传输层（Transport Layer）"></a>第4层：传输层（Transport Layer）</h3><p><strong>功能</strong>：提供端到端的数据传输服务<br><strong>协议</strong>：TCP、UDP<br><strong>作用</strong>：确保数据的可靠性和完整性</p><p><strong>通俗理解</strong>：这一层就像快递员，负责把数据包从发送方安全地送到接收方。TCP就像顺丰，保证不丢件；UDP就像普通快递，速度快但可能丢件。</p><h3 id="第3层：网络层（Network-Layer）"><a href="#第3层：网络层（Network-Layer）" class="headerlink" title="第3层：网络层（Network Layer）"></a>第3层：网络层（Network Layer）</h3><p><strong>功能</strong>：处理数据包的路由和寻址<br><strong>协议</strong>：IP、ICMP、ARP等<br><strong>设备</strong>：路由器<br><strong>作用</strong>：确定数据在网络中的最佳传输路径</p><p><strong>通俗理解</strong>：这一层就像导航系统，负责规划从A点到B点的最佳路线，告诉数据包应该往哪个方向走。</p><h3 id="第2层：数据链路层（Data-Link-Layer）"><a href="#第2层：数据链路层（Data-Link-Layer）" class="headerlink" title="第2层：数据链路层（Data Link Layer）"></a>第2层：数据链路层（Data Link Layer）</h3><p><strong>功能</strong>：在直接连接的设备间传输数据帧<br><strong>协议</strong>：以太网、WiFi、PPP等<br><strong>设备</strong>：交换机、网桥<br><strong>作用</strong>：处理错误检测和纠正</p><p><strong>通俗理解</strong>：这一层就像小区内的道路，负责在相邻设备之间传输数据，比如从你家到邻居家的网络连接。</p><h3 id="第1层：物理层（Physical-Layer）"><a href="#第1层：物理层（Physical-Layer）" class="headerlink" title="第1层：物理层（Physical Layer）"></a>第1层：物理层（Physical Layer）</h3><p><strong>功能</strong>：处理物理连接和传输介质<br><strong>设备</strong>：网卡、电缆、光纤、无线设备<br><strong>作用</strong>：将数字信号转换为物理信号进行传输</p><p><strong>通俗理解</strong>：这一层就像实际的马路、电线、光纤等物理设施，是网络通信的物质基础。</p><h2 id="数据封装过程"><a href="#数据封装过程" class="headerlink" title="数据封装过程"></a>数据封装过程</h2><p>数据在网络传输过程中的封装遵循”自下而上”的原则，就像搭积木一样，从底层开始一层层往上搭：</p><ol><li><strong>应用层</strong>：生成原始数据（比如你要发送的微信消息）</li><li><strong>表示层</strong>：添加加密、压缩等处理（把消息加密）</li><li><strong>会话层</strong>：建立会话标识（标记这是哪次对话）</li><li><strong>传输层</strong>：添加端口号信息（标记发送到哪个端口）</li><li><strong>网络层</strong>：添加IP地址信息（标记发送到哪个IP）</li><li><strong>数据链路层</strong>：添加MAC地址信息（标记发送到哪个网卡）</li><li><strong>物理层</strong>：转换为电信号或光信号（通过网线或WiFi发送）</li></ol><h2 id="网络安全启示"><a href="#网络安全启示" class="headerlink" title="网络安全启示"></a>网络安全启示</h2><p>理解OSI七层模型对网络安全有什么帮助呢？</p><ul><li><strong>分层防护</strong>：每一层都可以实施相应的安全措施，就像每层楼都有不同的防盗门</li><li><strong>攻击定位</strong>：通过分析攻击特征，可以快速定位到具体的网络层次，就像知道小偷是从哪层楼进来的</li><li><strong>绕过策略</strong>：如果上层有检测机制，可以在下层进行绕过，这就是我们后续要掌握的核心技术！</li></ul><h2 id="实际应用场景"><a href="#实际应用场景" class="headerlink" title="实际应用场景"></a>实际应用场景</h2><p>在Android应用开发中，开发者经常在不同层次添加安全检测：</p><ul><li><strong>应用层</strong>：API调用频率限制（防止你刷屏）</li><li><strong>传输层</strong>：SSL证书验证（确保连接安全）</li><li><strong>网络层</strong>：IP地址白名单（只允许特定地区访问）</li><li><strong>数据链路层</strong>：MAC地址绑定（绑定特定设备）</li></ul><h2 id="网络配置实践：OSI七层命令相关"><a href="#网络配置实践：OSI七层命令相关" class="headerlink" title="网络配置实践：OSI七层命令相关"></a>网络配置实践：OSI七层命令相关</h2><p>上面是来源网络和AI相关的理论常识，现在通过一些简单的网络配置命令，更好地认识OSI七层模型在实际网络中的作用。</p><h3 id="物理层和数据链路层实践"><a href="#物理层和数据链路层实践" class="headerlink" title="物理层和数据链路层实践"></a>物理层和数据链路层实践</h3><h4 id="查看网络接口信息"><a href="#查看网络接口信息" class="headerlink" title="查看网络接口信息"></a>查看网络接口信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows系统</span></span><br><span class="line">ipconfig /all</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux/macOS系统</span></span><br><span class="line">ifconfig</span><br><span class="line"><span class="comment"># 或者使用新命令</span></span><br><span class="line">ip addr show</span><br></pre></td></tr></table></figure><p><strong>命令解释</strong>：这个命令可以查看所有网络接口的详细信息，包括：</p><ul><li>网卡名称（如eth0、wlan0）</li><li>MAC地址（物理地址）</li><li>IP地址和子网掩码</li><li>网络状态（UP&#x2F;DOWN）</li></ul><h4 id="检查网络连接状态"><a href="#检查网络连接状态" class="headerlink" title="检查网络连接状态"></a>检查网络连接状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows系统</span></span><br><span class="line">netsh interface show interface</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux/macOS系统</span></span><br><span class="line">ip <span class="built_in">link</span> show</span><br></pre></td></tr></table></figure><p><strong>实践目标</strong>：认识物理层和数据链路层的作用，观察网络接口的物理状态。</p><h3 id="网络层实践"><a href="#网络层实践" class="headerlink" title="网络层实践"></a>网络层实践</h3><h4 id="查看IP地址配置"><a href="#查看IP地址配置" class="headerlink" title="查看IP地址配置"></a>查看IP地址配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows系统</span></span><br><span class="line">ipconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux/macOS系统</span></span><br><span class="line">ip addr</span><br></pre></td></tr></table></figure><h4 id="测试网络连通性"><a href="#测试网络连通性" class="headerlink" title="测试网络连通性"></a>测试网络连通性</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试到目标主机的连通性</span></span><br><span class="line">ping 8.8.8.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试到域名的连通性</span></span><br><span class="line">ping www.baidu.com</span><br></pre></td></tr></table></figure><p><strong>命令解释</strong>：<code>ping</code>命令使用ICMP协议（网络层），可以：</p><ul><li>测试网络连通性</li><li>测量网络延迟</li><li>检查网络丢包情况</li></ul><h4 id="查看路由表"><a href="#查看路由表" class="headerlink" title="查看路由表"></a>查看路由表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows系统</span></span><br><span class="line">route <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux/macOS系统</span></span><br><span class="line">route -n</span><br><span class="line"><span class="comment"># 或者使用新命令</span></span><br><span class="line">ip route show</span><br></pre></td></tr></table></figure><p><strong>实践目标</strong>：认识网络层如何决定数据包的传输路径。</p><h3 id="传输层实践"><a href="#传输层实践" class="headerlink" title="传输层实践"></a>传输层实践</h3><h4 id="查看端口使用情况"><a href="#查看端口使用情况" class="headerlink" title="查看端口使用情况"></a>查看端口使用情况</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows系统</span></span><br><span class="line">netstat -an</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux/macOS系统</span></span><br><span class="line">netstat -tuln</span><br><span class="line"><span class="comment"># 或者使用新命令</span></span><br><span class="line">ss -tuln</span><br></pre></td></tr></table></figure><p><strong>命令解释</strong>：这些命令可以查看：</p><ul><li>哪些端口正在监听</li><li>哪些端口正在使用</li><li>TCP和UDP连接状态</li></ul><h4 id="测试特定端口连通性"><a href="#测试特定端口连通性" class="headerlink" title="测试特定端口连通性"></a>测试特定端口连通性</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试Web服务器端口</span></span><br><span class="line">telnet www.baidu.com 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用nc命令（Linux/macOS）</span></span><br><span class="line">nc -zv www.baidu.com 80</span><br></pre></td></tr></table></figure><p><strong>实践目标</strong>：认识传输层如何管理端到端的连接。</p><h3 id="应用层实践"><a href="#应用层实践" class="headerlink" title="应用层实践"></a>应用层实践</h3><h4 id="测试DNS解析"><a href="#测试DNS解析" class="headerlink" title="测试DNS解析"></a>测试DNS解析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows系统</span></span><br><span class="line">nslookup www.baidu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux/macOS系统</span></span><br><span class="line">dig www.baidu.com</span><br><span class="line"><span class="comment"># 或者使用</span></span><br><span class="line">host www.baidu.com</span><br></pre></td></tr></table></figure><p><strong>命令解释</strong>：DNS是应用层协议，负责将域名转换为IP地址。</p><h4 id="测试HTTP连接"><a href="#测试HTTP连接" class="headerlink" title="测试HTTP连接"></a>测试HTTP连接</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用curl测试Web服务</span></span><br><span class="line">curl -I http://www.baidu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用wget</span></span><br><span class="line">wget --spider http://www.baidu.com</span><br></pre></td></tr></table></figure><p><strong>实践目标</strong>：认识应用层协议如何工作。</p><h3 id="网络故障排查实践"><a href="#网络故障排查实践" class="headerlink" title="网络故障排查实践"></a>网络故障排查实践</h3><h4 id="分层排查网络问题"><a href="#分层排查网络问题" class="headerlink" title="分层排查网络问题"></a>分层排查网络问题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一步：检查物理连接</span></span><br><span class="line">ping 127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二步：检查本地网络</span></span><br><span class="line">ping 192.168.1.1  <span class="comment"># 假设这是你的路由器IP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三步：检查外网连接</span></span><br><span class="line">ping 8.8.8.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第四步：检查DNS解析</span></span><br><span class="line">nslookup www.baidu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第五步：检查应用服务</span></span><br><span class="line">curl http://www.baidu.com</span><br></pre></td></tr></table></figure><p><strong>排查逻辑</strong>：按照OSI七层模型，从底层到高层逐步排查：</p><ol><li><strong>物理层</strong>：检查网线、WiFi连接</li><li><strong>数据链路层</strong>：检查网卡状态</li><li><strong>网络层</strong>：检查IP配置和路由</li><li><strong>传输层</strong>：检查端口和连接</li><li><strong>应用层</strong>：检查具体服务</li></ol><h3 id="高级网络配置"><a href="#高级网络配置" class="headerlink" title="高级网络配置"></a>高级网络配置</h3><h4 id="配置静态IP地址"><a href="#配置静态IP地址" class="headerlink" title="配置静态IP地址"></a>配置静态IP地址</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows系统（管理员权限）</span></span><br><span class="line">netsh interface ip <span class="built_in">set</span> address <span class="string">&quot;以太网&quot;</span> static 192.168.1.100 255.255.255.0 192.168.1.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux系统</span></span><br><span class="line"><span class="built_in">sudo</span> ip addr add 192.168.1.100/24 dev eth0</span><br><span class="line"><span class="built_in">sudo</span> ip route add default via 192.168.1.1</span><br></pre></td></tr></table></figure><h4 id="配置DNS服务器"><a href="#配置DNS服务器" class="headerlink" title="配置DNS服务器"></a>配置DNS服务器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows系统</span></span><br><span class="line">netsh interface ip <span class="built_in">set</span> dns <span class="string">&quot;以太网&quot;</span> static 8.8.8.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux系统</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/resolv.conf</span><br></pre></td></tr></table></figure><h3 id="常见问题解决"><a href="#常见问题解决" class="headerlink" title="常见问题解决"></a>常见问题解决</h3><h4 id="问题1：网络连接失败"><a href="#问题1：网络连接失败" class="headerlink" title="问题1：网络连接失败"></a>问题1：网络连接失败</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查网络接口状态</span></span><br><span class="line">ip <span class="built_in">link</span> show</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启网络接口</span></span><br><span class="line"><span class="built_in">sudo</span> ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 down</span><br><span class="line"><span class="built_in">sudo</span> ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 up</span><br></pre></td></tr></table></figure><h4 id="问题2：DNS解析失败"><a href="#问题2：DNS解析失败" class="headerlink" title="问题2：DNS解析失败"></a>问题2：DNS解析失败</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更换DNS服务器</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 114.114.114.114&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用Google DNS</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/resolv.conf</span><br></pre></td></tr></table></figure><h4 id="问题3：路由问题"><a href="#问题3：路由问题" class="headerlink" title="问题3：路由问题"></a>问题3：路由问题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看路由表</span></span><br><span class="line">ip route show</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加默认路由</span></span><br><span class="line"><span class="built_in">sudo</span> ip route add default via 192.168.1.1</span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>OSI七层模型虽然听起来复杂，但其实就是一个网络通信的”工作分工表”。认识每一层的功能，不仅有助于我们排查网络问题，更是进行网络安全分析和渗透测试的必备知识。</p><p><strong>本文的一个关键点</strong>：数据封装是自下而上的，上层检测可以在下层绕过。这个原理就像”道高一尺，魔高一丈”，检测技术在不断升级，我们的绕过技术也要跟着升级！</p>]]></content>
      
      
      <categories>
          
          <category> 网络协议 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络 </tag>
            
            <tag> 协议 </tag>
            
            <tag> 模型 </tag>
            
            <tag> 详解 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android Root工具原理深度解析：从Magisk到KernelSU的技术演进</title>
      <link href="/2025/08/15/article9_android_root_tools/"/>
      <url>/2025/08/15/article9_android_root_tools/</url>
      
        <content type="html"><![CDATA[<h2 id="Root工具发展历程"><a href="#Root工具发展历程" class="headerlink" title="Root工具发展历程"></a>Root工具发展历程</h2><h3 id="历史演进时间线"><a href="#历史演进时间线" class="headerlink" title="历史演进时间线"></a>历史演进时间线</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2008</span><span class="string">年：Android</span> <span class="number">1.0</span><span class="string">发布，Root概念出现</span></span><br><span class="line"><span class="number">2009</span><span class="string">年：Superuser.apk诞生，最早的Root管理工具</span></span><br><span class="line"><span class="number">2010</span><span class="string">年：SuperSU发布，成为主流Root方案</span></span><br><span class="line"><span class="number">2012</span><span class="string">年：Chainfire开发CF-Auto-Root</span></span><br><span class="line"><span class="number">2014</span><span class="string">年：KingRoot发布，基于漏洞利用的Root方案</span></span><br><span class="line"><span class="number">2016</span><span class="string">年：Magisk发布，引入模块化Root概念</span></span><br><span class="line"><span class="number">2017</span><span class="string">年：LineageOS</span> <span class="string">Superuser，开源Root管理</span></span><br><span class="line"><span class="number">2018</span><span class="string">年：MagiskHide发布，绕过SafetyNet检测</span></span><br><span class="line"><span class="number">2021</span><span class="string">年：KernelSU发布，基于内核的Root方案</span></span><br><span class="line"><span class="number">2022</span><span class="string">年：APatch发布，Magisk的现代化替代品</span></span><br><span class="line"><span class="number">2023</span><span class="string">年：KernelSU分支发展，支持更多设备</span></span><br></pre></td></tr></table></figure><span id="more"></span><h3 id="技术发展特点"><a href="#技术发展特点" class="headerlink" title="技术发展特点"></a>技术发展特点</h3><ul><li><strong>早期阶段</strong>：直接修改系统文件，破坏系统完整性</li><li><strong>中期阶段</strong>：通过Hook系统调用实现权限提升</li><li><strong>现代阶段</strong>：模块化设计，保持系统完整性</li><li><strong>最新阶段</strong>：内核级实现，性能和安全并重</li></ul><h2 id="传统Root工具原理分析"><a href="#传统Root工具原理分析" class="headerlink" title="传统Root工具原理分析"></a>传统Root工具原理分析</h2><h3 id="SuperSU技术原理"><a href="#SuperSU技术原理" class="headerlink" title="SuperSU技术原理"></a>SuperSU技术原理</h3><h4 id="1-核心架构"><a href="#1-核心架构" class="headerlink" title="1. 核心架构"></a>1. 核心架构</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">用户空间应用层</span><br><span class="line">    ↓</span><br><span class="line">SuperSU<span class="selector-class">.apk</span> (权限管理界面)</span><br><span class="line">    ↓</span><br><span class="line">su二进制文件 (权限提升工具)</span><br><span class="line">    ↓</span><br><span class="line">daemonsu守护进程 (权限控制核心)</span><br><span class="line">    ↓</span><br><span class="line">Linux内核 (系统调用层)</span><br></pre></td></tr></table></figure><h4 id="2-权限提升机制"><a href="#2-权限提升机制" class="headerlink" title="2. 权限提升机制"></a>2. 权限提升机制</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// su二进制文件核心逻辑</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="comment">// 检查调用者权限</span></span><br><span class="line">    <span class="keyword">if</span> (check_caller_permission() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取目标用户ID</span></span><br><span class="line">    <span class="type">uid_t</span> target_uid = get_target_uid(argv[<span class="number">1</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过setuid系统调用提升权限</span></span><br><span class="line">    <span class="keyword">if</span> (setuid(<span class="number">0</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 执行目标命令</span></span><br><span class="line">        execv(target_command, target_args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-守护进程实现"><a href="#3-守护进程实现" class="headerlink" title="3. 守护进程实现"></a>3. 守护进程实现</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// daemonsu守护进程核心代码</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">daemon_main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建socket监听权限请求</span></span><br><span class="line">    <span class="type">int</span> server_fd = create_unix_socket(<span class="string">&quot;/data/su/su&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 接受权限请求</span></span><br><span class="line">        <span class="type">int</span> client_fd = accept(server_fd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理权限请求</span></span><br><span class="line">        handle_su_request(client_fd);</span><br><span class="line">        </span><br><span class="line">        close(client_fd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_su_request</span><span class="params">(<span class="type">int</span> client_fd)</span> &#123;</span><br><span class="line">    <span class="comment">// 读取请求数据</span></span><br><span class="line">    <span class="type">su_request_t</span> request;</span><br><span class="line">    read(client_fd, &amp;request, <span class="keyword">sizeof</span>(request));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查权限策略</span></span><br><span class="line">    <span class="keyword">if</span> (check_policy(request.uid, request.command) == ALLOW) &#123;</span><br><span class="line">        <span class="comment">// 授权执行</span></span><br><span class="line">        grant_permission(client_fd, request);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 拒绝执行</span></span><br><span class="line">        deny_permission(client_fd, request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="KingRoot技术原理"><a href="#KingRoot技术原理" class="headerlink" title="KingRoot技术原理"></a>KingRoot技术原理</h3><h4 id="1-漏洞利用机制"><a href="#1-漏洞利用机制" class="headerlink" title="1. 漏洞利用机制"></a>1. 漏洞利用机制</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KingRoot漏洞利用示例</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">exploit_vulnerability</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 利用Android系统漏洞</span></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/dev/ashmem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造恶意数据触发漏洞</span></span><br><span class="line">    <span class="type">char</span> exploit_data[<span class="number">1024</span>];</span><br><span class="line">    <span class="built_in">memset</span>(exploit_data, <span class="number">0x41</span>, <span class="keyword">sizeof</span>(exploit_data));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过ioctl触发提权</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd, ASHMEM_SET_NAME, exploit_data) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 成功获取Root权限</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-多漏洞利用策略"><a href="#2-多漏洞利用策略" class="headerlink" title="2. 多漏洞利用策略"></a>2. 多漏洞利用策略</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># KingRoot漏洞检测脚本</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_vulnerabilities</span>():</span><br><span class="line">    vulnerabilities = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检测CVE-2014-3153 (Towelroot)</span></span><br><span class="line">    <span class="keyword">if</span> check_cve_2014_3153():</span><br><span class="line">        vulnerabilities.append(<span class="string">&quot;CVE-2014-3153&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检测CVE-2015-3636 (PingPongRoot)</span></span><br><span class="line">    <span class="keyword">if</span> check_cve_2015_3636():</span><br><span class="line">        vulnerabilities.append(<span class="string">&quot;CVE-2015-3636&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检测CVE-2016-5195 (Dirty COW)</span></span><br><span class="line">    <span class="keyword">if</span> check_cve_2016_5195():</span><br><span class="line">        vulnerabilities.append(<span class="string">&quot;CVE-2016-5195&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> vulnerabilities</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_cve_2014_3153</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检测Towelroot漏洞&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 尝试利用futex漏洞</span></span><br><span class="line">        <span class="keyword">import</span> ctypes</span><br><span class="line">        libc = ctypes.CDLL(<span class="string">&quot;libc.so&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构造futex调用</span></span><br><span class="line">        futex_addr = <span class="number">0x40000000</span></span><br><span class="line">        libc.futex(futex_addr, <span class="number">0x80</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否成功提权</span></span><br><span class="line">        <span class="keyword">return</span> getuid() == <span class="number">0</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><h2 id="现代Root工具原理分析"><a href="#现代Root工具原理分析" class="headerlink" title="现代Root工具原理分析"></a>现代Root工具原理分析</h2><h3 id="Magisk技术原理"><a href="#Magisk技术原理" class="headerlink" title="Magisk技术原理"></a>Magisk技术原理</h3><h4 id="1-系统完整性保护"><a href="#1-系统完整性保护" class="headerlink" title="1. 系统完整性保护"></a>1. 系统完整性保护</h4><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">传统<span class="built_in">Root</span>方案：</span><br><span class="line">系统分区被修改 → 无法通过<span class="variable">SafetyNet</span>检测</span><br><span class="line"></span><br><span class="line"><span class="variable">Magisk</span>方案：</span><br><span class="line">系统分区保持原样 → 通过<span class="variable">Hook</span>机制实现<span class="built_in">Root</span></span><br><span class="line">    ↓</span><br><span class="line"><span class="variable">Magisk</span>模块注入 → 运行时修改系统行为</span><br><span class="line">    ↓</span><br><span class="line"><span class="variable">Zygote</span>进程<span class="variable">Hook</span> → 影响所有应用进程</span><br></pre></td></tr></table></figure><h4 id="2-核心实现机制"><a href="#2-核心实现机制" class="headerlink" title="2. 核心实现机制"></a>2. 核心实现机制</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Magisk核心Hook实现</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">magisk_hook_init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化Magisk环境</span></span><br><span class="line">    <span class="keyword">if</span> (init_magisk_env() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook关键系统调用</span></span><br><span class="line">    hook_syscall(__NR_openat, magisk_openat);</span><br><span class="line">    hook_syscall(__NR_faccessat, magisk_faccessat);</span><br><span class="line">    hook_syscall(__NR_stat, magisk_stat);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook Zygote进程</span></span><br><span class="line">    hook_zygote_process();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook openat系统调用</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">magisk_openat</span><span class="params">(<span class="type">int</span> dirfd, <span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags, <span class="type">mode_t</span> mode)</span> &#123;</span><br><span class="line">    <span class="comment">// 检查是否为su命令</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(pathname, <span class="string">&quot;su&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 重定向到Magisk的su</span></span><br><span class="line">        <span class="keyword">return</span> original_openat(dirfd, <span class="string">&quot;/data/adb/magisk/su&quot;</span>, flags, mode);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否为系统文件</span></span><br><span class="line">    <span class="keyword">if</span> (is_system_file(pathname)) &#123;</span><br><span class="line">        <span class="comment">// 应用Magisk模块修改</span></span><br><span class="line">        <span class="keyword">return</span> apply_magisk_modules(pathname);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 正常调用原始函数</span></span><br><span class="line">    <span class="keyword">return</span> original_openat(dirfd, pathname, flags, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-模块系统实现"><a href="#3-模块系统实现" class="headerlink" title="3. 模块系统实现"></a>3. 模块系统实现</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Magisk模块加载机制</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">load_magisk_module</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *module_path)</span> &#123;</span><br><span class="line">    <span class="comment">// 解析模块配置</span></span><br><span class="line">    <span class="type">module_info_t</span> *info = parse_module_prop(module_path);</span><br><span class="line">    <span class="keyword">if</span> (!info) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载模块脚本</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;post_fs_data) &#123;</span><br><span class="line">        execute_script(info-&gt;post_fs_data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 应用模块修改</span></span><br><span class="line">    apply_module_modifications(info);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册模块服务</span></span><br><span class="line">    register_module_services(info);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块修改应用</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">apply_module_modifications</span><span class="params">(<span class="type">module_info_t</span> *info)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; info-&gt;mod_count; i++) &#123;</span><br><span class="line">        <span class="type">module_mod_t</span> *mod = &amp;info-&gt;mods[i];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (mod-&gt;type) &#123;</span><br><span class="line">            <span class="keyword">case</span> MOD_TYPE_FILE:</span><br><span class="line">                <span class="comment">// 文件替换</span></span><br><span class="line">                replace_file(mod-&gt;target, mod-&gt;source);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> MOD_TYPE_PROP:</span><br><span class="line">                <span class="comment">// 属性修改</span></span><br><span class="line">                set_prop(mod-&gt;key, mod-&gt;value);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> MOD_TYPE_SERVICE:</span><br><span class="line">                <span class="comment">// 服务修改</span></span><br><span class="line">                modify_service(mod-&gt;service_name, mod-&gt;modifications);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="KernelSU技术原理"><a href="#KernelSU技术原理" class="headerlink" title="KernelSU技术原理"></a>KernelSU技术原理</h3><h4 id="1-内核级Root实现"><a href="#1-内核级Root实现" class="headerlink" title="1. 内核级Root实现"></a>1. 内核级Root实现</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KernelSU内核模块核心代码</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">kernelsu_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化KernelSU</span></span><br><span class="line">    <span class="keyword">if</span> (init_kernelsu() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册系统调用Hook</span></span><br><span class="line">    register_syscall_hooks();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建proc文件系统接口</span></span><br><span class="line">    create_proc_interface();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统调用Hook实现</span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">kernelsu_syscall_hook</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> syscall_nr = regs-&gt;orig_ax;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (syscall_nr) &#123;</span><br><span class="line">        <span class="keyword">case</span> __NR_openat:</span><br><span class="line">            <span class="keyword">return</span> kernelsu_openat(regs);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> __NR_execve:</span><br><span class="line">            <span class="keyword">return</span> kernelsu_execve(regs);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> __NR_access:</span><br><span class="line">            <span class="keyword">return</span> kernelsu_access(regs);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> original_syscall(regs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-权限管理机制"><a href="#2-权限管理机制" class="headerlink" title="2. 权限管理机制"></a>2. 权限管理机制</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KernelSU权限检查</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kernelsu_check_permission</span><span class="params">(<span class="type">uid_t</span> uid, <span class="type">const</span> <span class="type">char</span> *command)</span> &#123;</span><br><span class="line">    <span class="comment">// 检查用户是否在允许列表中</span></span><br><span class="line">    <span class="keyword">if</span> (!is_user_allowed(uid)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查命令是否被允许</span></span><br><span class="line">    <span class="keyword">if</span> (!is_command_allowed(command)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查时间限制</span></span><br><span class="line">    <span class="keyword">if</span> (!is_time_allowed()) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> PERMISSION_GRANTED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 权限提升实现</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kernelsu_elevate_privilege</span><span class="params">(<span class="type">uid_t</span> target_uid)</span> &#123;</span><br><span class="line">    <span class="comment">// 检查当前进程权限</span></span><br><span class="line">    <span class="keyword">if</span> (current-&gt;cred-&gt;uid.val != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EPERM;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 修改目标进程的凭据</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new_cred</span> =</span> prepare_creds();</span><br><span class="line">    <span class="keyword">if</span> (!new_cred) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置Root权限</span></span><br><span class="line">    new_cred-&gt;uid.val = <span class="number">0</span>;</span><br><span class="line">    new_cred-&gt;gid.val = <span class="number">0</span>;</span><br><span class="line">    new_cred-&gt;euid.val = <span class="number">0</span>;</span><br><span class="line">    new_cred-&gt;egid.val = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 应用新凭据</span></span><br><span class="line">    commit_creds(new_cred);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="APatch技术原理"><a href="#APatch技术原理" class="headerlink" title="APatch技术原理"></a>APatch技术原理</h3><h4 id="1-现代化Magisk替代品"><a href="#1-现代化Magisk替代品" class="headerlink" title="1. 现代化Magisk替代品"></a>1. 现代化Magisk替代品</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// APatch核心实现</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">apatch_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化APatch环境</span></span><br><span class="line">    <span class="keyword">if</span> (init_apatch_env() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册模块系统</span></span><br><span class="line">    register_module_system();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启用安全增强</span></span><br><span class="line">    enable_security_enhancements();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块加载机制</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">apatch_load_module</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *module_path)</span> &#123;</span><br><span class="line">    <span class="comment">// 验证模块签名</span></span><br><span class="line">    <span class="keyword">if</span> (!verify_module_signature(module_path)) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载模块配置</span></span><br><span class="line">    <span class="type">module_config_t</span> *config = parse_module_config(module_path);</span><br><span class="line">    <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 应用模块修改</span></span><br><span class="line">    <span class="keyword">return</span> apply_module_changes(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-安全增强特性"><a href="#2-安全增强特性" class="headerlink" title="2. 安全增强特性"></a>2. 安全增强特性</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// APatch安全增强</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">enable_security_enhancements</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 启用SELinux增强</span></span><br><span class="line">    <span class="keyword">if</span> (enable_selinux_enhancement() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启用内存保护</span></span><br><span class="line">    <span class="keyword">if</span> (enable_memory_protection() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启用反调试保护</span></span><br><span class="line">    <span class="keyword">if</span> (enable_anti_debug() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="KernelSU分支分析"><a href="#KernelSU分支分析" class="headerlink" title="KernelSU分支分析"></a>KernelSU分支分析</h3><h4 id="1-官方KernelSU"><a href="#1-官方KernelSU" class="headerlink" title="1. 官方KernelSU"></a>1. 官方KernelSU</h4><p><strong>特点</strong>：</p><ul><li>基于内核模块实现</li><li>支持Android 4.14+</li><li>完整的权限管理系统</li><li>活跃的社区支持</li></ul><p><strong>技术实现</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方KernelSU核心特性</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kernelsu_ops</span> <span class="title">official_ops</span> =</span> &#123;</span><br><span class="line">    .check_permission = kernelsu_check_permission,</span><br><span class="line">    .grant_permission = kernelsu_grant_permission,</span><br><span class="line">    .revoke_permission = kernelsu_revoke_permission,</span><br><span class="line">    .get_uid_list = kernelsu_get_uid_list,</span><br><span class="line">    .is_uid_granted = kernelsu_is_uid_granted</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="2-KernelSU-Mod"><a href="#2-KernelSU-Mod" class="headerlink" title="2. KernelSU-Mod"></a>2. KernelSU-Mod</h4><p><strong>特点</strong>：</p><ul><li>官方KernelSU的修改版本</li><li>增加更多自定义功能</li><li>支持更多设备</li><li>提供更多配置选项</li></ul><p><strong>增强功能</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KernelSU-Mod增强功能</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kernelsu_mod_ops</span> <span class="title">mod_ops</span> =</span> &#123;</span><br><span class="line">    .check_permission = kernelsu_mod_check_permission,</span><br><span class="line">    .grant_permission = kernelsu_mod_grant_permission,</span><br><span class="line">    .revoke_permission = kernelsu_mod_revoke_permission,</span><br><span class="line">    .get_uid_list = kernelsu_mod_get_uid_list,</span><br><span class="line">    .is_uid_granted = kernelsu_mod_is_uid_granted,</span><br><span class="line">    <span class="comment">// 新增功能</span></span><br><span class="line">    .set_auto_grant = kernelsu_mod_set_auto_grant,</span><br><span class="line">    .set_timeout = kernelsu_mod_set_timeout,</span><br><span class="line">    .set_log_level = kernelsu_mod_set_log_level</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="3-KernelSU-Android"><a href="#3-KernelSU-Android" class="headerlink" title="3. KernelSU-Android"></a>3. KernelSU-Android</h4><p><strong>特点</strong>：</p><ul><li>针对Android 12+优化</li><li>更好的SELinux支持</li><li>改进的权限管理</li><li>增强的安全性</li></ul><p><strong>Android 12+优化</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Android 12+优化实现</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">kernelsu_android12_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 适配Android 12的SELinux策略</span></span><br><span class="line">    <span class="keyword">if</span> (adapt_selinux_policy() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 适配新的权限模型</span></span><br><span class="line">    <span class="keyword">if</span> (adapt_permission_model() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启用新的安全特性</span></span><br><span class="line">    <span class="keyword">if</span> (enable_new_security_features() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LineageOS-Superuser"><a href="#LineageOS-Superuser" class="headerlink" title="LineageOS Superuser"></a>LineageOS Superuser</h3><h4 id="1-开源Root管理"><a href="#1-开源Root管理" class="headerlink" title="1. 开源Root管理"></a>1. 开源Root管理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LineageOS Superuser实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LineageOSSuperuser</span> <span class="keyword">extends</span> <span class="title class_">Superuser</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkPermission</span><span class="params">(<span class="type">int</span> uid, String command)</span> &#123;</span><br><span class="line">        <span class="comment">// 基于策略的权限检查</span></span><br><span class="line">        <span class="type">Policy</span> <span class="variable">policy</span> <span class="operator">=</span> getPolicyForUid(uid);</span><br><span class="line">        <span class="keyword">if</span> (policy == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> policy.isCommandAllowed(command);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">grantPermission</span><span class="params">(<span class="type">int</span> uid, String command)</span> &#123;</span><br><span class="line">        <span class="comment">// 记录权限授予</span></span><br><span class="line">        logPermissionGrant(uid, command);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新策略</span></span><br><span class="line">        updatePolicy(uid, command, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-集成特性"><a href="#2-集成特性" class="headerlink" title="2. 集成特性"></a>2. 集成特性</h4><ul><li>与LineageOS深度集成</li><li>支持多用户环境</li><li>完整的日志记录</li><li>开源透明</li></ul><h3 id="其他Root工具"><a href="#其他Root工具" class="headerlink" title="其他Root工具"></a>其他Root工具</h3><h4 id="1-CF-Auto-Root"><a href="#1-CF-Auto-Root" class="headerlink" title="1. CF-Auto-Root"></a>1. CF-Auto-Root</h4><p><strong>特点</strong>：</p><ul><li>针对特定设备的一键Root</li><li>基于漏洞利用</li><li>支持设备广泛</li><li>操作简单</li></ul><p><strong>技术原理</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CF-Auto-Root漏洞利用</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cf_auto_root_exploit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 利用设备特定漏洞</span></span><br><span class="line">    <span class="keyword">if</span> (exploit_device_vulnerability() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取Root权限</span></span><br><span class="line">    <span class="keyword">if</span> (gain_root_access() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 安装SuperSU</span></span><br><span class="line">    <span class="keyword">if</span> (install_supersu() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-KingRoot"><a href="#2-KingRoot" class="headerlink" title="2. KingRoot"></a>2. KingRoot</h4><p><strong>特点</strong>：</p><ul><li>基于多漏洞利用</li><li>支持设备广泛</li><li>一键Root操作</li><li>商业化运营</li></ul><p><strong>多漏洞利用</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KingRoot多漏洞利用策略</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kingroot_exploit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 尝试多个漏洞</span></span><br><span class="line">    <span class="type">int</span> exploits[] = &#123;</span><br><span class="line">        CVE_2014_3153,  <span class="comment">// Towelroot</span></span><br><span class="line">        CVE_2015_3636,  <span class="comment">// PingPongRoot</span></span><br><span class="line">        CVE_2016_5195,  <span class="comment">// Dirty COW</span></span><br><span class="line">        CVE_2017_0781,  <span class="comment">// BlueBorne</span></span><br><span class="line">        CVE_2018_9445   <span class="comment">// 其他漏洞</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(exploits)/<span class="keyword">sizeof</span>(exploits[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (try_exploit(exploits[i]) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// 成功</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;  <span class="comment">// 失败</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Root工具技术对比"><a href="#Root工具技术对比" class="headerlink" title="Root工具技术对比"></a>Root工具技术对比</h2><h3 id="技术架构对比"><a href="#技术架构对比" class="headerlink" title="技术架构对比"></a>技术架构对比</h3><table><thead><tr><th>特性</th><th>SuperSU</th><th>Magisk</th><th>APatch</th><th>KernelSU</th><th>KernelSU-Mod</th><th>LineageOS Superuser</th></tr></thead><tbody><tr><td><strong>实现层级</strong></td><td>用户空间</td><td>用户空间+内核</td><td>用户空间+内核</td><td>内核空间</td><td>内核空间</td><td>用户空间</td></tr><tr><td><strong>系统完整性</strong></td><td>破坏</td><td>保持</td><td>保持</td><td>保持</td><td>保持</td><td>破坏</td></tr><tr><td><strong>模块化支持</strong></td><td>无</td><td>完整</td><td>完整</td><td>部分</td><td>部分</td><td>无</td></tr><tr><td><strong>SafetyNet绕过</strong></td><td>不支持</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td><td>不支持</td></tr><tr><td><strong>性能影响</strong></td><td>中等</td><td>低</td><td>低</td><td>最低</td><td>最低</td><td>中等</td></tr><tr><td><strong>稳定性</strong></td><td>高</td><td>高</td><td>高</td><td>最高</td><td>最高</td><td>高</td></tr><tr><td><strong>安全性</strong></td><td>中等</td><td>高</td><td>最高</td><td>高</td><td>高</td><td>中等</td></tr><tr><td><strong>易用性</strong></td><td>高</td><td>高</td><td>高</td><td>中等</td><td>中等</td><td>高</td></tr><tr><td><strong>社区支持</strong></td><td>停止</td><td>活跃</td><td>活跃</td><td>活跃</td><td>中等</td><td>活跃</td></tr><tr><td><strong>设备兼容性</strong></td><td>广泛</td><td>广泛</td><td>广泛</td><td>有限</td><td>有限</td><td>广泛</td></tr></tbody></table><h3 id="详细优缺点分析"><a href="#详细优缺点分析" class="headerlink" title="详细优缺点分析"></a>详细优缺点分析</h3><h4 id="SuperSU"><a href="#SuperSU" class="headerlink" title="SuperSU"></a>SuperSU</h4><p><strong>优点</strong>：</p><ul><li>成熟稳定，经过长期验证</li><li>设备兼容性极佳</li><li>操作简单，用户友好</li><li>权限管理功能完善</li><li>支持多用户环境</li></ul><p><strong>缺点</strong>：</p><ul><li>破坏系统完整性</li><li>无法通过SafetyNet检测</li><li>不支持模块化扩展</li><li>开发已停止，无更新</li><li>安全性相对较低</li></ul><p><strong>适用场景</strong>：</p><ul><li>老旧设备Root</li><li>对系统完整性要求不高</li><li>需要简单稳定的Root方案</li></ul><h4 id="Magisk"><a href="#Magisk" class="headerlink" title="Magisk"></a>Magisk</h4><p><strong>优点</strong>：</p><ul><li>保持系统完整性</li><li>支持模块化扩展</li><li>可以绕过SafetyNet检测</li><li>活跃的社区支持</li><li>功能丰富，可定制性强</li></ul><p><strong>缺点</strong>：</p><ul><li>学习成本较高</li><li>模块管理复杂</li><li>某些设备兼容性问题</li><li>依赖Zygote进程Hook</li><li>可能被检测和绕过</li></ul><p><strong>适用场景</strong>：</p><ul><li>需要保持系统完整性</li><li>需要模块化功能</li><li>需要绕过安全检测</li><li>对功能扩展有要求</li></ul><h4 id="APatch"><a href="#APatch" class="headerlink" title="APatch"></a>APatch</h4><p><strong>优点</strong>：</p><ul><li>基于Magisk的现代化改进</li><li>增强的安全特性</li><li>更好的SELinux支持</li><li>改进的模块系统</li><li>更稳定的性能</li></ul><p><strong>缺点</strong>：</p><ul><li>相对较新，稳定性待验证</li><li>社区支持有限</li><li>文档不够完善</li><li>某些功能可能不兼容</li></ul><p><strong>适用场景</strong>：</p><ul><li>需要最新安全特性</li><li>对性能有较高要求</li><li>愿意尝试新技术</li><li>需要更好的安全保护</li></ul><h4 id="KernelSU"><a href="#KernelSU" class="headerlink" title="KernelSU"></a>KernelSU</h4><p><strong>优点</strong>：</p><ul><li>内核级实现，性能最佳</li><li>极高的稳定性</li><li>难以被检测和绕过</li><li>资源占用最少</li><li>安全性最高</li></ul><p><strong>缺点</strong>：</p><ul><li>需要内核源码支持</li><li>设备兼容性有限</li><li>安装和配置复杂</li><li>调试困难</li><li>对内核版本有要求</li></ul><p><strong>适用场景</strong>：</p><ul><li>对性能要求极高</li><li>需要最高安全性</li><li>有技术能力维护</li><li>支持的内核版本</li></ul><h4 id="KernelSU-Mod"><a href="#KernelSU-Mod" class="headerlink" title="KernelSU-Mod"></a>KernelSU-Mod</h4><p><strong>优点</strong>：</p><ul><li>基于KernelSU的增强版本</li><li>更多自定义功能</li><li>支持更多设备</li><li>提供更多配置选项</li><li>改进的用户体验</li></ul><p><strong>缺点</strong>：</p><ul><li>非官方版本，稳定性待验证</li><li>更新可能不及时</li><li>某些功能可能不稳定</li><li>社区支持有限</li></ul><p><strong>适用场景</strong>：</p><ul><li>需要KernelSU的增强功能</li><li>对自定义配置有要求</li><li>愿意使用非官方版本</li><li>有技术能力处理问题</li></ul><h4 id="LineageOS-Superuser-1"><a href="#LineageOS-Superuser-1" class="headerlink" title="LineageOS Superuser"></a>LineageOS Superuser</h4><p><strong>优点</strong>：</p><ul><li>完全开源透明</li><li>与LineageOS深度集成</li><li>支持多用户环境</li><li>完整的日志记录</li><li>社区驱动开发</li></ul><p><strong>缺点</strong>：</p><ul><li>仅适用于LineageOS</li><li>功能相对简单</li><li>不支持模块化</li><li>无法绕过安全检测</li><li>设备支持有限</li></ul><p><strong>适用场景</strong>：</p><ul><li>使用LineageOS系统</li><li>需要开源解决方案</li><li>对透明度有要求</li><li>不需要复杂功能</li></ul><h3 id="性能对比测试"><a href="#性能对比测试" class="headerlink" title="性能对比测试"></a>性能对比测试</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Root工具性能测试脚本</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RootToolPerformanceTest</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.results = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_startup_time</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;测试启动时间&quot;&quot;&quot;</span></span><br><span class="line">        tools = [<span class="string">&#x27;supersu&#x27;</span>, <span class="string">&#x27;magisk&#x27;</span>, <span class="string">&#x27;apatch&#x27;</span>, <span class="string">&#x27;kernelsu&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> tool <span class="keyword">in</span> tools:</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            <span class="comment"># 模拟启动Root工具</span></span><br><span class="line">            <span class="variable language_">self</span>.simulate_tool_startup(tool)</span><br><span class="line">            end_time = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.results[tool] = &#123;</span><br><span class="line">                <span class="string">&#x27;startup_time&#x27;</span>: end_time - start_time</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_memory_usage</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;测试内存使用&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> tool <span class="keyword">in</span> <span class="variable language_">self</span>.results.keys():</span><br><span class="line">            <span class="comment"># 获取内存使用情况</span></span><br><span class="line">            memory_usage = psutil.virtual_memory().percent</span><br><span class="line">            <span class="variable language_">self</span>.results[tool][<span class="string">&#x27;memory_usage&#x27;</span>] = memory_usage</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_permission_check_speed</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;测试权限检查速度&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> tool <span class="keyword">in</span> <span class="variable language_">self</span>.results.keys():</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            <span class="comment"># 模拟权限检查</span></span><br><span class="line">            <span class="variable language_">self</span>.simulate_permission_check(tool)</span><br><span class="line">            end_time = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.results[tool][<span class="string">&#x27;permission_check_time&#x27;</span>] = end_time - start_time</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_report</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成性能报告&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Root工具性能对比报告&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> tool, metrics <span class="keyword">in</span> <span class="variable language_">self</span>.results.items():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n<span class="subst">&#123;tool.upper()&#125;</span>:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  启动时间: <span class="subst">&#123;metrics[<span class="string">&#x27;startup_time&#x27;</span>]:<span class="number">.3</span>f&#125;</span>s&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  内存使用: <span class="subst">&#123;metrics[<span class="string">&#x27;memory_usage&#x27;</span>]:<span class="number">.1</span>f&#125;</span>%&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  权限检查: <span class="subst">&#123;metrics[<span class="string">&#x27;permission_check_time&#x27;</span>]:<span class="number">.3</span>f&#125;</span>s&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="安全性对比分析"><a href="#安全性对比分析" class="headerlink" title="安全性对比分析"></a>安全性对比分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Root工具安全性分析</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RootToolSecurityAnalyzer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.security_metrics = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_security_level</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析安全级别&quot;&quot;&quot;</span></span><br><span class="line">        tools = &#123;</span><br><span class="line">            <span class="string">&#x27;SuperSU&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;system_integrity&#x27;</span>: <span class="string">&#x27;Low&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;detection_resistance&#x27;</span>: <span class="string">&#x27;Low&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;permission_control&#x27;</span>: <span class="string">&#x27;Medium&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;audit_logging&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;overall_security&#x27;</span>: <span class="string">&#x27;Medium&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;Magisk&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;system_integrity&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;detection_resistance&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;permission_control&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;audit_logging&#x27;</span>: <span class="string">&#x27;Medium&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;overall_security&#x27;</span>: <span class="string">&#x27;High&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;APatch&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;system_integrity&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;detection_resistance&#x27;</span>: <span class="string">&#x27;Very High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;permission_control&#x27;</span>: <span class="string">&#x27;Very High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;audit_logging&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;overall_security&#x27;</span>: <span class="string">&#x27;Very High&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;KernelSU&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;system_integrity&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;detection_resistance&#x27;</span>: <span class="string">&#x27;Very High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;permission_control&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;audit_logging&#x27;</span>: <span class="string">&#x27;Medium&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;overall_security&#x27;</span>: <span class="string">&#x27;Very High&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;KernelSU-Mod&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;system_integrity&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;detection_resistance&#x27;</span>: <span class="string">&#x27;Very High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;permission_control&#x27;</span>: <span class="string">&#x27;Very High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;audit_logging&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;overall_security&#x27;</span>: <span class="string">&#x27;Very High&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;LineageOS Superuser&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;system_integrity&#x27;</span>: <span class="string">&#x27;Low&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;detection_resistance&#x27;</span>: <span class="string">&#x27;Low&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;permission_control&#x27;</span>: <span class="string">&#x27;Medium&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;audit_logging&#x27;</span>: <span class="string">&#x27;High&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;overall_security&#x27;</span>: <span class="string">&#x27;Medium&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> tools</span><br></pre></td></tr></table></figure><h3 id="选择建议"><a href="#选择建议" class="headerlink" title="选择建议"></a>选择建议</h3><h4 id="1-根据需求选择"><a href="#1-根据需求选择" class="headerlink" title="1. 根据需求选择"></a>1. 根据需求选择</h4><p><strong>新手用户推荐</strong>：</p><ul><li><strong>SuperSU</strong>：简单稳定，适合入门</li><li><strong>Magisk</strong>：功能丰富，学习成本适中</li></ul><p><strong>高级用户推荐</strong>：</p><ul><li><strong>APatch</strong>：最新技术，安全特性丰富</li><li><strong>KernelSU</strong>：性能最佳，安全性最高</li></ul><p><strong>开发者推荐</strong>：</p><ul><li><strong>KernelSU-Mod</strong>：自定义功能多</li><li><strong>LineageOS Superuser</strong>：开源透明</li></ul><h4 id="2-根据设备选择"><a href="#2-根据设备选择" class="headerlink" title="2. 根据设备选择"></a>2. 根据设备选择</h4><p><strong>老旧设备（Android 7-9）</strong>：</p><ul><li>优先选择：SuperSU</li><li>备选方案：Magisk</li></ul><p><strong>现代设备（Android 10-12）</strong>：</p><ul><li>优先选择：Magisk</li><li>备选方案：APatch</li></ul><p><strong>最新设备（Android 13+）</strong>：</p><ul><li>优先选择：KernelSU</li><li>备选方案：APatch</li></ul><h4 id="3-根据用途选择"><a href="#3-根据用途选择" class="headerlink" title="3. 根据用途选择"></a>3. 根据用途选择</h4><p><strong>日常使用</strong>：</p><ul><li>推荐：Magisk</li><li>理由：功能全面，社区支持好</li></ul><p><strong>安全研究</strong>：</p><ul><li>推荐：KernelSU</li><li>理由：难以检测，安全性高</li></ul><p><strong>系统定制</strong>：</p><ul><li>推荐：APatch</li><li>理由：模块化支持好</li></ul><p><strong>学习研究</strong>：</p><ul><li>推荐：LineageOS Superuser</li><li>理由：开源透明，易于理解</li></ul><h2 id="Root检测与防护"><a href="#Root检测与防护" class="headerlink" title="Root检测与防护"></a>Root检测与防护</h2><h3 id="Root检测技术"><a href="#Root检测技术" class="headerlink" title="Root检测技术"></a>Root检测技术</h3><h4 id="1-传统检测方法"><a href="#1-传统检测方法" class="headerlink" title="1. 传统检测方法"></a>1. 传统检测方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Android Root检测代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RootDetector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRooted</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> checkSuFiles() || </span><br><span class="line">               checkSuCommands() || </span><br><span class="line">               checkRootApps() || </span><br><span class="line">               checkRootProps();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkSuFiles</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] suPaths = &#123;</span><br><span class="line">            <span class="string">&quot;/system/app/Superuser.apk&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/sbin/su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/system/bin/su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/system/xbin/su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/data/local/xbin/su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/data/local/bin/su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/system/sd/xbin/su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/system/bin/failsafe/su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/data/local/su&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String path : suPaths) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">File</span>(path).exists()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkSuCommands</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;which su&quot;</span>);</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream())</span><br><span class="line">            );</span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> reader.readLine();</span><br><span class="line">            <span class="keyword">return</span> line != <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkRootApps</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] rootApps = &#123;</span><br><span class="line">            <span class="string">&quot;com.noshufou.android.su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.noshufou.android.su.elite&quot;</span>,</span><br><span class="line">            <span class="string">&quot;eu.chainfire.supersu&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.koushikdutta.superuser&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.thirdparty.superuser&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.yellowes.su&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.topjohnwu.magisk&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> context.getPackageManager();</span><br><span class="line">        <span class="keyword">for</span> (String app : rootApps) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pm.getPackageInfo(app, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// 应用不存在</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkRootProps</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] rootProps = &#123;</span><br><span class="line">            <span class="string">&quot;ro.debuggable&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ro.secure&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ro.build.selinux&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String prop : rootProps) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> SystemProperties.get(prop, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;0&quot;</span>.equals(value)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-现代检测方法"><a href="#2-现代检测方法" class="headerlink" title="2. 现代检测方法"></a>2. 现代检测方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 现代Root检测技术</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModernRootDetector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRooted</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> checkMagisk() || </span><br><span class="line">               checkKernelSU() || </span><br><span class="line">               checkAPatch() || </span><br><span class="line">               checkRuntimeDetection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkMagisk</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检测Magisk特征</span></span><br><span class="line">        <span class="keyword">if</span> (checkMagiskProps()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (checkMagiskFiles()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (checkMagiskModules()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkMagiskProps</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] magiskProps = &#123;</span><br><span class="line">            <span class="string">&quot;ro.magisk.version&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ro.boot.magisk&quot;</span>,</span><br><span class="line">            <span class="string">&quot;persist.magisk.version&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String prop : magiskProps) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> SystemProperties.get(prop, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!value.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkRuntimeDetection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 运行时检测Root行为</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 尝试执行需要Root权限的操作</span></span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;su -c id&quot;</span>);</span><br><span class="line">            process.waitFor();</span><br><span class="line">            <span class="keyword">return</span> process.exitValue() == <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Root防护策略"><a href="#Root防护策略" class="headerlink" title="Root防护策略"></a>Root防护策略</h3><h4 id="1-应用级防护"><a href="#1-应用级防护" class="headerlink" title="1. 应用级防护"></a>1. 应用级防护</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 应用级Root防护</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RootProtection</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enableRootProtection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检测Root环境</span></span><br><span class="line">        <span class="keyword">if</span> (isRooted()) &#123;</span><br><span class="line">            <span class="comment">// 拒绝运行</span></span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启用反调试</span></span><br><span class="line">        enableAntiDebug();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启用完整性检查</span></span><br><span class="line">        enableIntegrityCheck();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启用运行时检测</span></span><br><span class="line">        enableRuntimeDetection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enableAntiDebug</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检测调试器</span></span><br><span class="line">        <span class="keyword">if</span> (Debug.isDebuggerConnected()) &#123;</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测Hook框架</span></span><br><span class="line">        <span class="keyword">if</span> (isHookFrameworkDetected()) &#123;</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enableIntegrityCheck</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检查应用签名</span></span><br><span class="line">        <span class="keyword">if</span> (!verifyAppSignature()) &#123;</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查应用完整性</span></span><br><span class="line">        <span class="keyword">if</span> (!verifyAppIntegrity()) &#123;</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enableRuntimeDetection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 定期检测Root状态</span></span><br><span class="line">        <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();</span><br><span class="line">        timer.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isRooted()) &#123;</span><br><span class="line">                    System.exit(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">5000</span>); <span class="comment">// 每5秒检测一次</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-系统级防护"><a href="#2-系统级防护" class="headerlink" title="2. 系统级防护"></a>2. 系统级防护</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 系统级Root防护</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">root_protection_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 注册安全模块</span></span><br><span class="line">    register_security_module(&amp;root_protection_ops);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启用内核级检测</span></span><br><span class="line">    enable_kernel_root_detection();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启用实时监控</span></span><br><span class="line">    enable_realtime_monitoring();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">root_protection_check_permission</span><span class="params">(<span class="type">uid_t</span> uid, <span class="type">const</span> <span class="type">char</span> *command)</span> &#123;</span><br><span class="line">    <span class="comment">// 检查是否为Root相关命令</span></span><br><span class="line">    <span class="keyword">if</span> (is_root_command(command)) &#123;</span><br><span class="line">        <span class="comment">// 记录安全事件</span></span><br><span class="line">        log_security_event(uid, command);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查权限策略</span></span><br><span class="line">        <span class="keyword">if</span> (!is_permission_granted(uid, command)) &#123;</span><br><span class="line">            <span class="keyword">return</span> -EPERM;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="未来发展趋势"><a href="#未来发展趋势" class="headerlink" title="未来发展趋势"></a>未来发展趋势</h2><h3 id="技术发展方向"><a href="#技术发展方向" class="headerlink" title="技术发展方向"></a>技术发展方向</h3><h4 id="1-硬件级安全"><a href="#1-硬件级安全" class="headerlink" title="1. 硬件级安全"></a>1. 硬件级安全</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 硬件级Root防护</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hardware_root_protection_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 利用TrustZone技术</span></span><br><span class="line">    <span class="keyword">if</span> (enable_trustzone_protection() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 利用Secure Boot</span></span><br><span class="line">    <span class="keyword">if</span> (enable_secure_boot() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 利用硬件安全模块</span></span><br><span class="line">    <span class="keyword">if</span> (enable_hsm_protection() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-机器学习检测"><a href="#2-机器学习检测" class="headerlink" title="2. 机器学习检测"></a>2. 机器学习检测</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 机器学习Root检测</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MLRootDetector</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.model = <span class="variable language_">self</span>.load_model()</span><br><span class="line">        <span class="variable language_">self</span>.features = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_features</span>(<span class="params">self, app_info</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提取应用特征&quot;&quot;&quot;</span></span><br><span class="line">        features = &#123;</span><br><span class="line">            <span class="string">&#x27;permission_count&#x27;</span>: <span class="built_in">len</span>(app_info[<span class="string">&#x27;permissions&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;suspicious_permissions&#x27;</span>: <span class="variable language_">self</span>.count_suspicious_permissions(app_info),</span><br><span class="line">            <span class="string">&#x27;network_usage&#x27;</span>: app_info[<span class="string">&#x27;network_usage&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;file_access_pattern&#x27;</span>: <span class="variable language_">self</span>.analyze_file_access(app_info),</span><br><span class="line">            <span class="string">&#x27;system_call_pattern&#x27;</span>: <span class="variable language_">self</span>.analyze_system_calls(app_info)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_root_behavior</span>(<span class="params">self, features</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;预测Root行为&quot;&quot;&quot;</span></span><br><span class="line">        prediction = <span class="variable language_">self</span>.model.predict([features])</span><br><span class="line">        <span class="keyword">return</span> prediction[<span class="number">0</span>] &gt; <span class="number">0.5</span></span><br></pre></td></tr></table></figure><h3 id="安全建议"><a href="#安全建议" class="headerlink" title="安全建议"></a>安全建议</h3><h4 id="1-开发者建议"><a href="#1-开发者建议" class="headerlink" title="1. 开发者建议"></a>1. 开发者建议</h4><ul><li><strong>最小权限原则</strong>：只请求必要的权限</li><li><strong>代码混淆</strong>：使用代码混淆技术保护关键逻辑</li><li><strong>完整性检查</strong>：定期检查应用完整性</li><li><strong>运行时检测</strong>：实时检测Root环境</li></ul><h4 id="2-用户建议"><a href="#2-用户建议" class="headerlink" title="2. 用户建议"></a>2. 用户建议</h4><ul><li><strong>谨慎Root</strong>：了解Root的风险和后果</li><li><strong>选择可靠工具</strong>：使用经过验证的Root工具</li><li><strong>定期更新</strong>：保持系统和Root工具的更新</li><li><strong>备份数据</strong>：Root前备份重要数据</li></ul><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>Android Root工具的发展反映了移动安全技术的不断演进。从早期的简单权限提升到现代的模块化设计，Root工具在功能性和安全性之间找到了更好的平衡。</p><p><strong>本文关键点</strong>：</p><ul><li><strong>技术深度</strong>：从底层原理到实现细节的完整分析</li><li><strong>对比分析</strong>：不同Root工具的技术特点和优劣势</li><li><strong>安全防护</strong>：提供全面的检测和防护策略</li></ul><p><strong>学习建议</strong>：</p><ul><li>深入理解Linux内核和Android系统架构</li><li>掌握系统调用和进程管理机制</li><li>关注移动安全技术的最新发展</li><li>遵守法律法规，仅用于安全研究</li></ul><hr><p><em>关注我们，获取更多移动安全技术深度解析！</em><br><em>点赞、收藏、转发，让更多人受益！</em></p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Root </tag>
            
            <tag> 工具原理 </tag>
            
            <tag> 深度解析 </tag>
            
            <tag> 传统 </tag>
            
            <tag> 现代 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网络协议深度解析：从HTTP到QUIC的演进之路</title>
      <link href="/2025/08/15/network_basics_article/"/>
      <url>/2025/08/15/network_basics_article/</url>
      
        <content type="html"><![CDATA[<h2 id="网络协议的发展脉络"><a href="#网络协议的发展脉络" class="headerlink" title="网络协议的发展脉络"></a>网络协议的发展脉络</h2><p>网络协议就像人类语言的进化史，从简单的交流到复杂的表达，不断适应着时代的需求。</p><p><strong>协议演进时间线</strong>：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1991</span>年：HTTP/<span class="number">1</span>.<span class="number">0</span> 诞生</span><br><span class="line"><span class="attribute">1997</span>年：HTTP/<span class="number">1</span>.<span class="number">1</span> 标准化</span><br><span class="line"><span class="attribute">2009</span>年：SPDY 协议提出</span><br><span class="line"><span class="attribute">2015</span>年：HTTP/<span class="number">2</span> 正式发布</span><br><span class="line"><span class="attribute">2022</span>年：HTTP/<span class="number">3</span> 成为标准</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="HTTP-1-1：经典但有限制"><a href="#HTTP-1-1：经典但有限制" class="headerlink" title="HTTP&#x2F;1.1：经典但有限制"></a>HTTP&#x2F;1.1：经典但有限制</h2><h3 id="HTTP-1-1的核心特性"><a href="#HTTP-1-1的核心特性" class="headerlink" title="HTTP&#x2F;1.1的核心特性"></a>HTTP&#x2F;1.1的核心特性</h3><p><strong>请求-响应模型</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">客户端 → 发送请求 → 服务器</span><br><span class="line">客户端 ← 接收响应 ← 服务器</span><br></pre></td></tr></table></figure><p><strong>关键特点</strong>：</p><ul><li><strong>文本协议</strong>：人类可读的请求和响应格式</li><li><strong>无状态</strong>：每个请求都是独立的</li><li><strong>持久连接</strong>：Connection: keep-alive</li><li><strong>管道化</strong>：可以发送多个请求而不等待响应</li></ul><h3 id="HTTP-1-1的局限性"><a href="#HTTP-1-1的局限性" class="headerlink" title="HTTP&#x2F;1.1的局限性"></a>HTTP&#x2F;1.1的局限性</h3><p><strong>队头阻塞问题</strong></p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">请求<span class="number">1</span> → 服务器处理中...</span><br><span class="line">请求<span class="number">2</span> → 等待请求<span class="number">1</span>完成</span><br><span class="line">请求<span class="number">3</span> → 等待请求<span class="number">1</span>完成</span><br></pre></td></tr></table></figure><p><strong>资源浪费</strong></p><ul><li>每个请求都需要完整的HTTP头部</li><li>无法主动推送资源</li><li>连接数限制（浏览器通常限制6-8个并发连接）</li></ul><h2 id="HTTP-2：多路复用的革命"><a href="#HTTP-2：多路复用的革命" class="headerlink" title="HTTP&#x2F;2：多路复用的革命"></a>HTTP&#x2F;2：多路复用的革命</h2><h3 id="HTTP-2的核心改进"><a href="#HTTP-2的核心改进" class="headerlink" title="HTTP&#x2F;2的核心改进"></a>HTTP&#x2F;2的核心改进</h3><p><strong>二进制分帧层</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">HTTP</span>/<span class="number">1</span>.<span class="number">1</span>: 文本格式</span><br><span class="line"><span class="attribute">HTTP</span>/<span class="number">2</span>:   二进制格式 + 帧结构</span><br></pre></td></tr></table></figure><p><strong>多路复用</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">请求<span class="number">1</span> → 流<span class="number">1</span> → 服务器</span><br><span class="line">请求<span class="number">2</span> → 流<span class="number">2</span> → 服务器  (并行处理)</span><br><span class="line">请求<span class="number">3</span> → 流<span class="number">3</span> → 服务器</span><br></pre></td></tr></table></figure><p><strong>服务器推送</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">客户端请求: <span class="keyword">GET</span> /<span class="keyword">index</span>.html</span><br><span class="line">服务器响应: <span class="keyword">index</span>.html + style.css + script.js</span><br></pre></td></tr></table></figure><h3 id="HTTP-2的技术细节"><a href="#HTTP-2的技术细节" class="headerlink" title="HTTP&#x2F;2的技术细节"></a>HTTP&#x2F;2的技术细节</h3><p><strong>帧类型</strong></p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">DATA:</span> 数据帧</span><br><span class="line"><span class="symbol">HEADERS:</span> 头部帧</span><br><span class="line"><span class="symbol">PRIORITY:</span> 优先级帧</span><br><span class="line"><span class="symbol">RST_STREAM:</span> 重置流帧</span><br><span class="line"><span class="symbol">SETTINGS:</span> 设置帧</span><br><span class="line"><span class="symbol">PUSH_PROMISE:</span> 推送承诺帧</span><br><span class="line"><span class="symbol">PING:</span> 心跳帧</span><br><span class="line"><span class="symbol">GOAWAY:</span> 关闭连接帧</span><br></pre></td></tr></table></figure><p><strong>头部压缩（HPACK）</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">静态表: 常用头部字段预定义</span></span><br><span class="line"><span class="section">动态表: 运行时构建的头部字段表</span></span><br><span class="line"><span class="section">Huffman编码: 进一步压缩头部数据</span></span><br></pre></td></tr></table></figure><h2 id="HTTP-3：基于QUIC的未来"><a href="#HTTP-3：基于QUIC的未来" class="headerlink" title="HTTP&#x2F;3：基于QUIC的未来"></a>HTTP&#x2F;3：基于QUIC的未来</h2><h3 id="QUIC协议的核心特性"><a href="#QUIC协议的核心特性" class="headerlink" title="QUIC协议的核心特性"></a>QUIC协议的核心特性</h3><p><strong>基于UDP</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">HTTP</span>/<span class="number">1</span>.<span class="number">1</span>: TCP + TLS + HTTP</span><br><span class="line"><span class="attribute">HTTP</span>/<span class="number">2</span>:   TCP + TLS + HTTP/<span class="number">2</span></span><br><span class="line"><span class="attribute">HTTP</span>/<span class="number">3</span>:   UDP + QUIC + HTTP/<span class="number">3</span></span><br></pre></td></tr></table></figure><p><strong>0-RTT连接建立</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">首次连接: 1-RTT (1个往返时间)</span></span><br><span class="line"><span class="section">重连:     0-RTT (无需握手)</span></span><br></pre></td></tr></table></figure><p><strong>连接迁移</strong></p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">WiFi → 4G</span><span class="punctuation">:</span> <span class="string">连接ID保持不变</span></span><br><span class="line"><span class="attribute">IP变化</span><span class="punctuation">:</span> <span class="string">   无需重新建立连接</span></span><br></pre></td></tr></table></figure><h3 id="HTTP-3的优势"><a href="#HTTP-3的优势" class="headerlink" title="HTTP&#x2F;3的优势"></a>HTTP&#x2F;3的优势</h3><p><strong>解决队头阻塞</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">TCP层阻塞: HTTP/2仍有此问题</span></span><br><span class="line"><span class="section">UDP层:     QUIC完全解决队头阻塞</span></span><br></pre></td></tr></table></figure><p><strong>更好的移动网络支持</strong></p><ul><li>网络切换时保持连接</li><li>更快的连接建立</li><li>更好的拥塞控制</li></ul><h2 id="协议对比分析"><a href="#协议对比分析" class="headerlink" title="协议对比分析"></a>协议对比分析</h2><h3 id="性能对比"><a href="#性能对比" class="headerlink" title="性能对比"></a>性能对比</h3><table><thead><tr><th>特性</th><th>HTTP&#x2F;1.1</th><th>HTTP&#x2F;2</th><th>HTTP&#x2F;3</th></tr></thead><tbody><tr><td><strong>连接建立</strong></td><td>1-RTT</td><td>1-RTT</td><td>0-RTT</td></tr><tr><td><strong>多路复用</strong></td><td>有限</td><td>完全支持</td><td>完全支持</td></tr><tr><td><strong>服务器推送</strong></td><td>不支持</td><td>支持</td><td>支持</td></tr><tr><td><strong>头部压缩</strong></td><td>无</td><td>HPACK</td><td>QPACK</td></tr><tr><td><strong>队头阻塞</strong></td><td>存在</td><td>TCP层存在</td><td>完全解决</td></tr><tr><td><strong>移动网络</strong></td><td>一般</td><td>一般</td><td>优秀</td></tr></tbody></table><h3 id="实际应用场景"><a href="#实际应用场景" class="headerlink" title="实际应用场景"></a>实际应用场景</h3><p><strong>HTTP&#x2F;1.1适用场景</strong></p><ul><li>简单的API服务</li><li>资源较少的网站</li><li>需要最大兼容性的场景</li></ul><p><strong>HTTP&#x2F;2适用场景</strong></p><ul><li>现代Web应用</li><li>资源丰富的网站</li><li>需要服务器推送的场景</li></ul><p><strong>HTTP&#x2F;3适用场景</strong></p><ul><li>移动应用</li><li>高延迟网络环境</li><li>需要最佳性能的场景</li></ul><h2 id="协议检测与识别"><a href="#协议检测与识别" class="headerlink" title="协议检测与识别"></a>协议检测与识别</h2><h3 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h3><p><strong>HTTP版本检测</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用curl检测</span></span><br><span class="line">curl -I --http2 https://example.com</span><br><span class="line">curl -I --http3 https://example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用浏览器开发者工具</span></span><br><span class="line">Network → Protocol列显示HTTP版本</span><br></pre></td></tr></table></figure><p><strong>协议特征分析</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 抓包分析</span></span><br><span class="line">tcpdump -i eth0 -w http_traffic.pcap</span><br><span class="line">wireshark http_traffic.pcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析特征</span></span><br><span class="line">HTTP/1.1: 文本格式，Connection头</span><br><span class="line">HTTP/2:   二进制帧，SETTINGS帧</span><br><span class="line">HTTP/3:   UDP包，QUIC握手</span><br></pre></td></tr></table></figure><h3 id="安全分析应用"><a href="#安全分析应用" class="headerlink" title="安全分析应用"></a>安全分析应用</h3><p><strong>协议升级检测</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_http_version</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 尝试HTTP/2</span></span><br><span class="line">        response = requests.get(url, headers=&#123;<span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;Upgrade, HTTP2-Settings&#x27;</span>&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;HTTP/2&#x27;</span> <span class="keyword">in</span> response.headers.get(<span class="string">&#x27;Upgrade&#x27;</span>, <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;HTTP/2&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查HTTP/1.1特征</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;keep-alive&#x27;</span> <span class="keyword">in</span> response.headers.get(<span class="string">&#x27;Connection&#x27;</span>, <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;HTTP/1.1&#x27;</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Unknown&#x27;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;Error: <span class="subst">&#123;e&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="实际开发中的应用"><a href="#实际开发中的应用" class="headerlink" title="实际开发中的应用"></a>实际开发中的应用</h2><h3 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h3><p><strong>Nginx HTTP&#x2F;2配置</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">ssl_certificate</span> /path/to/cert.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /path/to/key.pem;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># HTTP/2推送</span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">http2_push</span> /style.css;</span><br><span class="line">        <span class="attribute">http2_push</span> /script.js;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Apache HTTP&#x2F;2配置</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">LoadModule</span> http2_module modules/mod_http2.so</span><br><span class="line"></span><br><span class="line"><span class="section">&lt;VirtualHost *<span class="number">:443</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerName</span> example.com</span><br><span class="line">    <span class="attribute">Protocols</span> h2 http/<span class="number">1</span>.<span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启用HTTP/2推送</span></span><br><span class="line">    <span class="attribute">H2Push</span> <span class="literal">on</span></span><br><span class="line">    <span class="attribute">H2PushResource</span> /style.css</span><br><span class="line">    <span class="attribute">H2PushResource</span> /script.js</span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure><h3 id="客户端优化"><a href="#客户端优化" class="headerlink" title="客户端优化"></a>客户端优化</h3><p><strong>HTTP&#x2F;2客户端实现</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">http2_client</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> httpx.AsyncClient(http2=<span class="literal">True</span>) <span class="keyword">as</span> client:</span><br><span class="line">        <span class="comment"># 并发请求</span></span><br><span class="line">        tasks = [</span><br><span class="line">            client.get(<span class="string">&#x27;https://api.example.com/data1&#x27;</span>),</span><br><span class="line">            client.get(<span class="string">&#x27;https://api.example.com/data2&#x27;</span>),</span><br><span class="line">            client.get(<span class="string">&#x27;https://api.example.com/data3&#x27;</span>)</span><br><span class="line">        ]</span><br><span class="line">        responses = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">        <span class="keyword">return</span> responses</span><br></pre></td></tr></table></figure><h2 id="性能测试与优化"><a href="#性能测试与优化" class="headerlink" title="性能测试与优化"></a>性能测试与优化</h2><h3 id="基准测试"><a href="#基准测试" class="headerlink" title="基准测试"></a>基准测试</h3><p><strong>使用wrk进行性能测试</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HTTP/1.1测试</span></span><br><span class="line">wrk -t12 -c400 -d30s http://example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP/2测试</span></span><br><span class="line">wrk -t12 -c400 -d30s --http2 https://example.com</span><br></pre></td></tr></table></figure><p><strong>性能指标对比</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">HTTP</span>/<span class="number">1</span>.<span class="number">1</span>: <span class="number">1000</span> req/s, 延迟 <span class="number">50</span>ms</span><br><span class="line"><span class="attribute">HTTP</span>/<span class="number">2</span>:   <span class="number">3000</span> req/s, 延迟 <span class="number">30</span>ms</span><br><span class="line"><span class="attribute">HTTP</span>/<span class="number">3</span>:   <span class="number">4000</span> req/s, 延迟 <span class="number">20</span>ms</span><br></pre></td></tr></table></figure><h3 id="优化策略"><a href="#优化策略" class="headerlink" title="优化策略"></a>优化策略</h3><p><strong>HTTP&#x2F;2优化</strong></p><ul><li>减少域名分片</li><li>优化资源加载顺序</li><li>合理使用服务器推送</li></ul><p><strong>HTTP&#x2F;3优化</strong></p><ul><li>优化UDP缓冲区</li><li>调整拥塞控制算法</li><li>监控连接迁移</li></ul><h2 id="安全考虑"><a href="#安全考虑" class="headerlink" title="安全考虑"></a>安全考虑</h2><h3 id="协议安全特性"><a href="#协议安全特性" class="headerlink" title="协议安全特性"></a>协议安全特性</h3><p><strong>TLS集成</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">HTTP</span>/<span class="number">1</span>.<span class="number">1</span>: 可选TLS</span><br><span class="line"><span class="attribute">HTTP</span>/<span class="number">2</span>:   强制TLS（除了localhost）</span><br><span class="line"><span class="attribute">HTTP</span>/<span class="number">3</span>:   内置TLS <span class="number">1</span>.<span class="number">3</span></span><br></pre></td></tr></table></figure><p><strong>攻击面分析</strong></p><ul><li><strong>HTTP&#x2F;1.1</strong>：请求走私、响应分割</li><li><strong>HTTP&#x2F;2</strong>：流重置攻击、头部炸弹</li><li><strong>HTTP&#x2F;3</strong>：UDP放大攻击、连接迁移攻击</li></ul><h3 id="防护措施"><a href="#防护措施" class="headerlink" title="防护措施"></a>防护措施</h3><p><strong>请求验证</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">validate_http_request</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="comment"># 检查请求大小</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(request.body) &gt; MAX_BODY_SIZE:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Request body too large&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查头部数量</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(request.headers) &gt; MAX_HEADERS:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Too many headers&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><h2 id="未来发展趋势"><a href="#未来发展趋势" class="headerlink" title="未来发展趋势"></a>未来发展趋势</h2><h3 id="新兴协议"><a href="#新兴协议" class="headerlink" title="新兴协议"></a>新兴协议</h3><p><strong>WebTransport</strong></p><ul><li>基于HTTP&#x2F;3的实时通信协议</li><li>支持双向流和不可靠传输</li><li>适用于游戏、实时协作等场景</li></ul><p><strong>HTTP&#x2F;4展望</strong></p><ul><li>可能基于WebTransport</li><li>更好的实时性支持</li><li>更强的安全性</li></ul><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>网络协议的演进反映了互联网技术的不断进步。从HTTP&#x2F;1.1的简单可靠，到HTTP&#x2F;2的多路复用，再到HTTP&#x2F;3的QUIC创新，每一次升级都带来了性能和安全性的提升。</p><p><strong>本文关键点</strong>：</p><ul><li><strong>协议选择</strong>：根据应用场景选择合适的HTTP版本以及可变的应用协议</li><li><strong>协议演进</strong>：从HTTP到QUIC的变革之路，未来可见的新兴趋势</li></ul>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 深度解析 </tag>
            
            <tag> 网络协议 </tag>
            
            <tag> HTTP </tag>
            
            <tag> QUIC </tag>
            
            <tag> 演进之路 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World!</title>
      <link href="/2025/07/15/hello-world/"/>
      <url>/2025/07/15/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><span id="more"></span><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      <categories>
          
          <category> 测试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hello World </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
